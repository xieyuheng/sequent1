<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2016-04-17 Sun 13:45 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title></title>
<meta name="generator" content="Org-mode" />
<meta name="author" content="XIE Yuheng" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
	     margin-bottom: .2em; }
  .subtitle { text-align: center;
	      font-size: medium;
	      font-weight: bold;
	      margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
	    padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<link rel="stylesheet" href="css/worg.css" type="text/css" media="screen" />
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
	displayAlign: "center",
	displayIndent: "0em",

	"HTML-CSS": { scale: 100,
			linebreaks: { automatic: "false" },
			webFont: "TeX"
		       },
	SVG: {scale: 100,
	      linebreaks: { automatic: "false" },
	      font: "TeX"},
	NativeMML: {scale: 100},
	TeX: { equationNumbers: {autoNumber: "AMS"},
	       MultLineWidth: "85%",
	       TagSide: "right",
	       TagIndent: ".8em"
	     }
});
</script>
<script type="text/javascript"
	src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org9751ffa">1. <span class="done todo">todo</span> </a></li>
<li><a href="#org72f2c78">2. <span class="todo note">note</span> </a>
<ul>
<li><a href="#orgabc4853">2.1. formal-form</a></li>
<li><a href="#orgf37bb75">2.2. form</a></li>
<li><a href="#org8627a1f">2.3. env</a></li>
<li><a href="#orgf7530f2">2.4. data</a></li>
<li><a href="#org6083f34">2.5. store</a></li>
<li><a href="#orgfc2ab02">2.6. top</a></li>
</ul>
</li>
<li><a href="#org18a43e1">3. helper</a>
<ul>
<li><a href="#orgb03f8ca">3.1. match</a>
<ul>
<li><a href="#orgf1bcdef">3.1.1. <span class="todo note">note</span> </a></li>
<li><a href="#org2fa0c91">3.1.2. match</a></li>
<li><a href="#orge423680">3.1.3. <span class="done test">test</span> </a></li>
</ul>
</li>
<li><a href="#orga9ee7bb">3.2. list</a></li>
<li><a href="#orgc6a2d4c">3.3. string</a></li>
<li><a href="#orge9ce271">3.4. cat &amp; orz</a>
<ul>
<li><a href="#org58a9db6">3.4.1. cat</a></li>
<li><a href="#orgbe52569">3.4.2. orz</a></li>
<li><a href="#orgfa489c4">3.4.3. <span class="done test">test</span> </a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgb341f3d">4. parse</a>
<ul>
<li><a href="#orgc1b7920">4.1. parse/arrow</a></li>
<li><a href="#org6bcc0f7">4.2. parse/cedent</a></li>
<li><a href="#orge856499">4.3. parse/dispatch</a></li>
<li><a href="#org110842a">4.4. parse/var</a></li>
<li><a href="#org8b2f40f">4.5. <span class="done test">test</span> </a></li>
</ul>
</li>
<li><a href="#org914a8e1">5. pass1</a>
<ul>
<li><a href="#org870511d">5.1. <span class="todo note">note</span> scope</a></li>
<li><a href="#org183b914">5.2. pass1/arrow</a></li>
<li><a href="#org6ad2892">5.3. pass1/cedent</a></li>
<li><a href="#orgaaad6b5">5.4. pass1/dispatch</a></li>
<li><a href="#org1e28fed">5.5. pass1/var</a></li>
<li><a href="#orge2fb6ae">5.6. pass1/bind</a></li>
<li><a href="#org4a3ba5a">5.7. <span class="done test">test</span> </a></li>
</ul>
</li>
<li><a href="#org3b32028">6. apply</a>
<ul>
<li><a href="#orgdc64f14">6.1. env</a></li>
<li><a href="#org299e869">6.2. id</a></li>
<li><a href="#orgded6416">6.3. apply/arrow</a></li>
<li><a href="#org2883888">6.4. apply/cedent</a></li>
<li><a href="#orga9e4c83">6.5. apply/dispatch</a></li>
<li><a href="#orgcc978dd">6.6. apply/literal-arrow</a></li>
<li><a href="#orgc819d84">6.7. apply/var</a></li>
<li><a href="#orgeb9b06c">6.8. apply/name</a></li>
<li><a href="#org4d3ff43">6.9. apply/name/function</a></li>
<li><a href="#orgc20c10c">6.10. apply/arrow-list</a></li>
<li><a href="#orgf2a255e">6.11. apply/arrow-list/filter</a></li>
<li><a href="#org732dfb9">6.12. apply/arity</a></li>
<li><a href="#orgd4c3711">6.13. apply/bind</a></li>
<li><a href="#org7cb556">6.14. <span class="todo _gt__lt__gt__lt__gt__lt_">&gt;&lt;&gt;&lt;&gt;&lt;</span> bs/[extend|find|walk|deep]</a></li>
</ul>
</li>
<li><a href="#org7cc7a88">7. unify</a>
<ul>
<li><a href="#org2a2a1ad">7.1. <span class="todo _">記</span> </a></li>
<li><a href="#org7de4718">7.2. <span class="todo note">note</span> unify-report</a></li>
<li><a href="#orga72a4d3">7.3. unify</a></li>
<li><a href="#org92df029">7.4. unify/list</a></li>
<li><a href="#org234f5ac">7.5. var/eq</a></li>
<li><a href="#orge7191ec">7.6. <span class="todo _gt__lt__gt__lt__gt__lt_">&gt;&lt;&gt;&lt;&gt;&lt;</span> unify/dispatch</a></li>
<li><a href="#orgcdbe30d">7.7. <span class="todo _gt__lt__gt__lt__gt__lt_">&gt;&lt;&gt;&lt;&gt;&lt;</span> unify/trunk/trunk</a></li>
<li><a href="#orgc31f647">7.8. <span class="todo _gt__lt__gt__lt__gt__lt_">&gt;&lt;&gt;&lt;&gt;&lt;</span> unify/trunk/data</a></li>
</ul>
</li>
<li><a href="#org390e26d">8. eva</a>
<ul>
<li><a href="#orga2bc678">8.1. eva</a></li>
<li><a href="#org3f71dc9">8.2. parse/top</a></li>
<li><a href="#org52ccdd4">8.3. parse/top/dt-body</a></li>
<li><a href="#org95f83b8">8.4. <span class="done test">test</span> </a></li>
<li><a href="#orgd52455e">8.5. eva/top</a></li>
<li><a href="#org6d4d6a0">8.6. eva/dt</a></li>
<li><a href="#org6a1c41c">8.7. eva/dt/data-constructor &amp; eva/dt/data-constructor-list</a></li>
<li><a href="#org41f409b">8.8. <span class="todo _gt__lt__gt__lt__gt__lt_">&gt;&lt;&gt;&lt;&gt;&lt;</span> formal-arrow-&gt;arity &amp; arrow-&gt;arity &amp; arrow-list-&gt;arity</a></li>
<li><a href="#orgc32a5a4">8.9. eva/df</a></li>
</ul>
</li>
<li><a href="#org3c88d94">9. check</a>
<ul>
<li><a href="#orgfacd087">9.1. <span class="todo note">note</span> check-report</a></li>
<li><a href="#org17fc074">9.2. check</a></li>
<li><a href="#orgb3046af">9.3. check/arrow</a></li>
<li><a href="#orge4b0c40">9.4. type-apply/cedent</a></li>
<li><a href="#org375f60b">9.5. <span class="todo _gt__lt__gt__lt__gt__lt_">&gt;&lt;&gt;&lt;&gt;&lt;</span> type-apply/dispatch</a></li>
<li><a href="#orgbfd06a0">9.6. type-apply/var</a></li>
<li><a href="#orgc619abe">9.7. type-apply/name</a></li>
<li><a href="#org4cb3972">9.8. <span class="todo _gt__lt_">&gt;&lt;</span> type-apply/literal-arrow</a></li>
<li><a href="#orgb2ef5eb">9.9. <span class="todo _gt__lt_">&gt;&lt;</span> type-apply/bind</a></li>
<li><a href="#org5743a00">9.10. <span class="todo _gt__lt_">&gt;&lt;</span> typeof</a></li>
</ul>
</li>
<li><a href="#org2365f7c">10. sequent</a></li>
<li><a href="#org6777ac8">11. <span class="done test">test</span> </a>
<ul>
<li><a href="#orgabaa16e">11.1. natural</a></li>
<li><a href="#org4e677b5">11.2. list</a></li>
<li><a href="#orgf7ee93">11.3. vector</a></li>
</ul>
</li>
</ul>
</div>
</div>
<ul class="org-ul">
<li><p>sequent calculus as dependent type system of functional language</p></li>

<li><p>a prototype interpreter</p></li>

<li><p>XIE Yuheng created</p></li></ul>

<div id="outline-container-org9751ffa" class="outline-2">
<h2 id="org9751ffa"><span class="section-number-2">1</span> <span class="done todo">todo</span> </h2>
<div class="outline-text-2" id="text-1">
<ul class="org-ul">
<li><p>improve the interface to get rid of 'unify-point and '(commit-point)</p></li>

<li><p>success should track the path</p><p>when fail path can be used in report</p></li>

<li><p>refactoring</p><p>those labels</p><p>those local helper functions</p></li>

<li><p>proper tail-call</p></li></ul>
</div>
</div>

<div id="outline-container-org72f2c78" class="outline-2">
<h2 id="org72f2c78"><span class="section-number-2">2</span> <span class="todo note">note</span> </h2>
<div class="outline-text-2" id="text-2">
</div><div id="outline-container-orgabc4853" class="outline-3">
<h3 id="orgabc4853"><span class="section-number-3">2.1</span> formal-form</h3>
<div class="outline-text-3" id="text-2-1">
<ul class="org-ul">
<li><p>formal-arrow = (formal-cedent formal-cedent)</p></li>
<li><p>formal-cedent = (formal-form &#x2026;)</p></li>
<li><p>formal-form =</p><p><ul class="org-ul"></p><p><li><p>('v formal-var)</p></li></p><p><li><p>('n formal-name)</p></li></p><p><li><p>('a formal-arrow)</p></li></p><p><li><p>('b formal-bind)</p></li></ul></p></li>
<li><p>formal-var = (symbol level)</p></li>
<li><p>formal-name = symbol</p></li>
<li><p>formal-bind = ((formal-var &#x2026;) formal-cedent live?)</p></li></ul>
</div>
</div>

<div id="outline-container-orgf37bb75" class="outline-3">
<h3 id="orgf37bb75"><span class="section-number-3">2.2</span> form</h3>
<div class="outline-text-3" id="text-2-2">
<ul class="org-ul">
<li><p>arrow = (cedent cedent)</p></li>
<li><p>cedent = (form &#x2026;)</p></li>
<li><p>form =</p><p><ul class="org-ul"></p><p><li><p>('var var)</p></li></p><p><li><p>('name name)</p></li></p><p><li><p>('arrow arrow)</p></li></p><p><li><p>('bind bind)</p></li></ul></p></li>
<li><p>var = (id level)</p></li>
<li><p>name = symbol</p></li>
<li><p>bind = ((var &#x2026;) cedent live?)</p></li>
<li><p>id = #(symbol ls)</p></li></ul>
</div>
</div>

<div id="outline-container-org8627a1f" class="outline-3">
<h3 id="org8627a1f"><span class="section-number-3">2.3</span> env</h3>
<div class="outline-text-3" id="text-2-3">
<ul class="org-ul">
<li><p>env = (ds bs ns)</p></li>
<li><p>ds = (data &#x2026;)</p></li>
<li><p>bs = ((id . ls) &#x2026;)</p><p><ul class="org-ul"></p><p><li><p>ls = ((level . data) &#x2026;)</p></li></ul></p></li>
<li><p>ns = ((name . store) &#x2026;)</p></li></ul>
</div>
</div>

<div id="outline-container-orgf7530f2" class="outline-3">
<h3 id="orgf7530f2"><span class="section-number-3">2.4</span> data</h3>
<div class="outline-text-3" id="text-2-4">
<ul class="org-ul">
<li><p>data =</p><p><ul class="org-ul"></p><p><li><p>('var var)</p></li></p><p><li><p>('arrow arrow)</p></li></p><p><li><p>('cons (name (data &#x2026;)))</p></li></p><p><li><p>('trunk ((arrow &#x2026;) (data &#x2026;)))</p></li></ul></p></li></ul>
</div>
</div>

<div id="outline-container-org6083f34" class="outline-3">
<h3 id="org6083f34"><span class="section-number-3">2.5</span> store</h3>
<div class="outline-text-3" id="text-2-5">
<ul class="org-ul">
<li><p>store =</p><p><ul class="org-ul"></p><p><li><p>('function function)</p></li></p><p><li><p>('type-constructor type-constructor)</p></li></p><p><li><p>('data-constructor data-constructor)</p></li></ul></p></li>
<li><p>function = (formal-arrow arity (formal-arrow &#x2026;))</p></li>
<li><p>type-constructor = (formal-arrow arity (name &#x2026;))</p></li>
<li><p>data-constructor = (formal-arrow arity name)</p></li>
<li><p>arity = number</p></li></ul>
</div>
</div>

<div id="outline-container-orgfc2ab02" class="outline-3">
<h3 id="orgfc2ab02"><span class="section-number-3">2.6</span> top</h3>
<div class="outline-text-3" id="text-2-6">
<ul class="org-ul">
<li><p>top =</p><p><ul class="org-ul"></p><p><li><p>('dt type-definition)</p></li></p><p><li><p>('df function-definition)</p></li></p><p><li><p>('ap formal-arrow)</p></li></ul></p></li>
<li><p>type-definition =</p><p>((formal-name formal-arrow) ((formal-name formal-arrow) &#x2026;))</p></li>
<li><p>function-definition =</p><p>((formal-name formal-arrow) (formal-arrow &#x2026;))</p></li></ul>
</div>
</div>
</div>

<div id="outline-container-org18a43e1" class="outline-2">
<h2 id="org18a43e1"><span class="section-number-2">3</span> helper</h2>
<div class="outline-text-2" id="text-3">
</div><div id="outline-container-orgb03f8ca" class="outline-3">
<h3 id="orgb03f8ca"><span class="section-number-3">3.1</span> match</h3>
<div class="outline-text-3" id="text-3-1">
</div><div id="outline-container-orgf1bcdef" class="outline-4">
<h4 id="orgf1bcdef"><span class="section-number-4">3.1.1</span> <span class="todo note">note</span> </h4>
<div class="outline-text-4" id="text-3-1-1">
<ul class="org-ul">
<li><p><p></p><p>synopsis</p><p>(match expression</p><p>  (pattern  action+)</p><p>  &#x2026;)</p><p></p></p><p></p><p><p></p><p>or</p><p>(match expression</p><p>  pattern =&gt; expression</p><p>  pattern =&gt; expression</p><p>  &#x2026;)</p><p></p></p><p></p><p><p></p><p>pattern</p><p></p></p><p><ul class="org-ul"></p><p><li><p>constant                ;egs  1, #\x, #c(1.0 1.1)</p></li></p><p><li><p>symbol                  ;matches anything</p></li></p><p><li><p>'anything               ;must be EQUAL</p></li></p><p><li><p>(pattern = pattern)     ;both patterns must match</p></li></p><p><li><p>(#'function pattern)    ;predicate test</p></li></p><p><li><p>(pattern . pattern)     ;cons cell</p></li></ul></p></li>

<li><p>example</p><p>(match item</p><p>    (('if e1 e2 e3) 'if-then-else)                          ;(1)</p><p>    ((#'oddp k)     'an-odd-integer)                        ;(2)</p><p>    (((#'treep tree) = (hd . tl))   'something-else)        ;(3)</p><p>    (other          'anything-else))                        ;(4)</p></li>

<li><p>note</p><p><ul class="org-ul"></p><p><li><p>Each pattern is tested in turn.  The first match is taken.</p></li></p><p><li><p>If no pattern matches, an error is signalled.</p></li></p><p><li><p>Constant patterns (things X for which (CONSTANTP X) is true, i.e.</p><p>numbers, strings, characters, etc.) match things which are EQUAL.</p></li></p><p><li><p>Quoted patterns (which are CONSTANTP) are constants.</p></li></p><p><li><p>Symbols match anything. The symbol is bound to the matched item</p><p>for the execution of the actions.</p><p>For example, (match '(1 2 3) (1 . X) =&gt; X)</p><p>returns (2 3) because X is bound to the cdr of the candidate.</p></li></p><p><li><p>The two pattern match (p1 = p2) can be used to name parts</p><p>of the matched structure.  For example, (ALL = (HD . TL))</p><p>matches a cons cell. ALL is bound to the cons cell, HD to its car</p><p>and TL to its tail.</p></li></p><p><li><p>A predicate test applies the predicate to the item being matched.</p><p>If the predicate returns NIL then the match fails.</p><p>If it returns truth, then the nested pattern is matched.  This is</p><p>often just a symbol like K in the example.</p></li></p><p><li><p>Care should be taken with the domain values for predicate matches.</p><p>If, in the above eg, item is not an integer, an error would occur</p><p>during the test.  A safer pattern would be</p><p>(#'integerp (#'oddp k))</p><p>This would only test for oddness of the item was an integer.</p></li></p><p><li><p>A single symbol will match anything so it can be used as a default</p><p>case, like OTHER above.</p></li></ul></p></li></ul>
</div>
</div>

<div id="outline-container-org2fa0c91" class="outline-4">
<h4 id="org2fa0c91"><span class="section-number-4">3.1.2</span> match</h4>
<div class="outline-text-4" id="text-3-1-2">
<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #f92672; font-weight: bold;">defmacro</span> <span style="color: #a6e22e;">match</span> (expression <span style="color: #66d9ef; font-weight: bold;">&amp;rest</span> patterns)
  (<span style="color: #f92672; font-weight: bold;">let*</span> ((<span style="color: #f92672; font-weight: bold;">do-let</span> (not (atom expression)))
         (key    (<span style="color: #f92672; font-weight: bold;">if</span> do-let (gensym) expression))
         (cbody  (expand-select-patterns key patterns))
         (cform  `(<span style="color: #f92672; font-weight: bold;">cond</span> . ,cbody)))
    (<span style="color: #f92672; font-weight: bold;">if</span> do-let
        `(<span style="color: #f92672; font-weight: bold;">let</span> ((,key ,expression)) ,cform)
        cform)))

(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">expand-select-patterns</span> (key patterns)
  (<span style="color: #f92672; font-weight: bold;">if</span> (eq (second patterns) '=&gt;)
      (expand-select-patterns-style-2 key patterns)
      (expand-select-patterns-style-1 key patterns)))

(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">expand-select-patterns-style-1</span> (key patterns)
  (<span style="color: #f92672; font-weight: bold;">if</span> (null patterns)
      `((T (<span style="color: #d33682; font-weight: bold;">error</span> <span style="color: #e6db74;">"Case select pattern match failure on ~S"</span> ,key)))
      (<span style="color: #f92672; font-weight: bold;">let</span> ((pattern  (caar patterns))
            (actions  (cdar patterns))
            (rest     (cdr patterns)) )
        (<span style="color: #f92672; font-weight: bold;">let</span>  ((test       (compile-select-test key pattern))
               (bindings   (compile-select-bindings key pattern actions)))
          `(,(<span style="color: #f92672; font-weight: bold;">if</span> bindings  `(,test (<span style="color: #f92672; font-weight: bold;">let</span> ,bindings . ,actions))
                 `(,test . ,actions))
             . ,(<span style="color: #f92672; font-weight: bold;">if</span> (eq test t)
                    nil
                    (expand-select-patterns-style-1 key rest)))))))

(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">expand-select-patterns-style-2</span> (key patterns)
  (<span style="color: #f92672; font-weight: bold;">if</span> (null patterns)
      `((T (<span style="color: #d33682; font-weight: bold;">error</span> <span style="color: #e6db74;">"Case select pattern match failure on ~S"</span> ,key)))
      (<span style="color: #f92672; font-weight: bold;">let</span> ((pattern  (first patterns))
            (arrow    (<span style="color: #f92672; font-weight: bold;">if</span> (or (&lt; (length patterns) 3)
                              (not (eq (second patterns) '=&gt;)))
                          (<span style="color: #d33682; font-weight: bold;">error</span> <span style="color: #e6db74;">"Illegal patterns: ~S"</span> patterns)))
            (actions  (list (third patterns)))
            (rest     (cdddr patterns)))
        (<span style="color: #f92672; font-weight: bold;">let</span>  ((test       (compile-select-test key pattern))
               (bindings   (compile-select-bindings key pattern actions)))
          `(,(<span style="color: #f92672; font-weight: bold;">if</span> bindings  `(,test (<span style="color: #f92672; font-weight: bold;">let</span> ,bindings . ,actions))
                 `(,test . ,actions))
             . ,(<span style="color: #f92672; font-weight: bold;">if</span> (eq test t)
                    nil
                    (expand-select-patterns-style-2 key rest)))))))


(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">compile-select-test</span> (key pattern)
  (<span style="color: #f92672; font-weight: bold;">let</span>  ((tests (remove-if
                 #'(<span style="color: #f92672; font-weight: bold;">lambda</span> (item) (eq item t))
                 (compile-select-tests key pattern))))
    (<span style="color: #f92672; font-weight: bold;">cond</span>
      <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">note AND does this anyway, but this allows us to tell if</span>
      <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">the pattern will always match.</span>
      ((null tests)           t)
      ((= (length tests) 1)   (car tests))
      (T                      `(and . ,tests)))))


(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">compile-select-tests</span> (key pattern)
  (<span style="color: #f92672; font-weight: bold;">cond</span> ((constantp pattern)
         `((,(<span style="color: #f92672; font-weight: bold;">cond</span> ((numberp pattern) 'eql)
                   ((symbolp pattern) 'eq)
                   (T                'equal))
             ,key ,pattern)))

        ((symbolp pattern) '(T))
        ((select-double-match? pattern)
         (append
          (compile-select-tests key (first pattern))
          (compile-select-tests key (third pattern))))
        ((select-predicate? pattern)
         (append
          `((,(second (first pattern)) ,key))
          (compile-select-tests key (second pattern))))
        ((consp pattern)
         (append
          `((consp ,key))
          (compile-select-tests (!cs-car key) (car
                                               pattern))
          (compile-select-tests (!cs-cdr key) (cdr
                                               pattern))))
        ('T         (<span style="color: #d33682; font-weight: bold;">error</span> <span style="color: #e6db74;">"Illegal select pattern: ~S"</span> pattern))))

(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">compile-select-bindings</span> (key pattern action)
  (<span style="color: #f92672; font-weight: bold;">cond</span> ((constantp pattern) '())
        ((symbolp pattern)
         (<span style="color: #f92672; font-weight: bold;">if</span> (select!-in-tree pattern action) `((,pattern ,key))
             '()))
        ((select-double-match? pattern)
         (append
          (compile-select-bindings key (first pattern) action)
          (compile-select-bindings key (third pattern)
                                   action)))
        ((select-predicate? pattern)
         (compile-select-bindings key (second pattern)
                                  action))
        ((consp pattern)
         (append
          (compile-select-bindings (!cs-car key) (car pattern)
                                   action)
          (compile-select-bindings (!cs-cdr key) (cdr pattern)
                                   action)))))

(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">select!-in-tree</span> (atom tree)
  (or (eq atom tree)
      (<span style="color: #f92672; font-weight: bold;">if</span> (consp tree)
          (or (select!-in-tree atom (car tree))
              (select!-in-tree atom (cdr tree))))))

(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">select-double-match?</span> (pattern)
  <span style="color: #FF8888;">;;  </span><span style="color: #FF8888;">(&lt;pattern&gt; = &lt;pattern&gt;)</span>
  (and (consp pattern) (consp (cdr pattern)) (consp (cddr pattern))
       (null (cdddr pattern))
       (eq (second pattern) '=)))

(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">select-predicate?</span> (pattern)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">((function &lt;f&gt;) &lt;pattern&gt;)</span>
  (and    (consp pattern)
          (consp (cdr pattern))
          (null (cddr pattern))
          (consp (first pattern))
          (consp (cdr (first pattern)))
          (null (cddr (first pattern)))
          (eq (caar pattern) 'function)))

(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">!cs-car</span> (exp)
  (!cs-car/cdr
   'car exp
   '((car . caar)    (cdr . cadr)    (caar . caaar)  (cadr . caadr)
     (cdar . cadar)  (cddr . caddr)
     (caaar . caaaar)    (caadr . caaadr)    (cadar . caadar)
     (caddr . caaddr)    (cdaar . cadaar)    (cdadr . cadadr)
     (cddar . caddar)    (cdddr . cadddr))))

(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">!cs-cdr</span> (exp)
  (!cs-car/cdr
   'cdr exp
   '((car . cdar)    (cdr . cddr)    (caar . cdaar)  (cadr . cdadr)
     (cdar . cddar)  (cddr . cdddr)
     (caaar . cdaaar)    (caadr . cdaadr)    (cadar . cdadar)
     (caddr . cdaddr)    (cdaar . cddaar)    (cdadr . cddadr)
     (cddar . cdddar)    (cdddr . cddddr))))

(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">!cs-car/cdr</span> (op exp table)
  (<span style="color: #f92672; font-weight: bold;">if</span> (and (consp exp) (= (length exp) 2))
      (<span style="color: #f92672; font-weight: bold;">let</span> ((replacement  (assoc (car exp) table)))
        (<span style="color: #f92672; font-weight: bold;">if</span> replacement
            `(,(cdr replacement) ,(second exp))
            `(,op ,exp)))
      `(,op ,exp)))

<span style="color: #FF8888;">;; </span><span style="color: #FF8888;">(setf c1 '(match x (a 1) (b 2 3 4)))</span>
<span style="color: #FF8888;">;; </span><span style="color: #FF8888;">(setf c2 '(match (car y)</span>
<span style="color: #FF8888;">;;            </span><span style="color: #FF8888;">(1 (print 100) 101) (2 200) ("hello" 5) (:x 20) (else (1+</span>
<span style="color: #FF8888;">;;                                                                   </span><span style="color: #FF8888;">else))))</span>
<span style="color: #FF8888;">;; </span><span style="color: #FF8888;">(setf c3 '(match (caddr y)</span>
<span style="color: #FF8888;">;;            </span><span style="color: #FF8888;">((all = (x y)) (list x y all))</span>
<span style="color: #FF8888;">;;            </span><span style="color: #FF8888;">((a '= b)      (list 'assign a b))</span>
<span style="color: #FF8888;">;;            </span><span style="color: #FF8888;">((#'oddp k)     (1+ k))))</span>

<span style="color: #FF8888;">;;</span>
<span style="color: #FF8888;">;;  </span><span style="color: #FF8888;">IN macro</span>
<span style="color: #FF8888;">;;</span>
<span style="color: #FF8888;">;;  </span><span style="color: #FF8888;">(IN exp LET pat1 = exp1</span>
<span style="color: #FF8888;">;;              </span><span style="color: #FF8888;">pat2 = exp2</span>
<span style="color: #FF8888;">;;              </span><span style="color: #FF8888;">...)</span>
<span style="color: #FF8888;">;;</span>
<span style="color: #FF8888;">;;  </span><span style="color: #FF8888;">(IN exp LET* pat1 = exp1</span>
<span style="color: #FF8888;">;;               </span><span style="color: #FF8888;">pat2 = exp2</span>
<span style="color: #FF8888;">;;               </span><span style="color: #FF8888;">...)</span>
<span style="color: #FF8888;">;;</span>

(<span style="color: #f92672; font-weight: bold;">defmacro</span> <span style="color: #a6e22e;">in</span> (<span style="color: #66d9ef; font-weight: bold;">&amp;rest</span> form)
  (<span style="color: #f92672; font-weight: bold;">match</span> form
    (exp 'let . pats) =&gt;
    (<span style="color: #f92672; font-weight: bold;">let*</span> ((exps   (select-in-let-parts pats 'exp))
           (pats   (select-in-let-parts pats 'pat))
           (vars   (mapcar #'(<span style="color: #f92672; font-weight: bold;">lambda</span> (x) (gensym)) exps)))
      `(<span style="color: #f92672; font-weight: bold;">let</span> ,(mapcar #'list vars exps)
         ,(reduce
           #'(<span style="color: #f92672; font-weight: bold;">lambda</span> (var-pat subselection)
               (<span style="color: #f92672; font-weight: bold;">let</span> ((var  (first var-pat))
                     (pat  (second var-pat)))
                 `(<span style="color: #f92672; font-weight: bold;">match</span> ,var
                    ,pat =&gt; ,subselection
                    else =&gt; (<span style="color: #d33682; font-weight: bold;">error</span> <span style="color: #e6db74;">"IN-LET type error: ~S</span>
<span style="color: #e6db74;">doesnt match ~S"</span> ,var ',pat))))
           (mapcar #'list vars pats)
           <span style="color: #a6e22e;">:from-end</span> t
           <span style="color: #a6e22e;">:initial-value</span> exp)))
    (exp 'let*)         =&gt; exp
    (exp 'let* pat '= patexp . pats)  =&gt;
    (<span style="color: #f92672; font-weight: bold;">let</span> ((var (gensym)))
      `(<span style="color: #f92672; font-weight: bold;">let</span> ((,var ,patexp))
         (<span style="color: #f92672; font-weight: bold;">match</span> ,var
           ,pat =&gt; (in ,exp let* . ,pats)
           else =&gt; (<span style="color: #d33682; font-weight: bold;">error</span> <span style="color: #e6db74;">"IN-LET type error: ~S doesnt match</span>
<span style="color: #e6db74;">~S"</span> ,var ',pat))))
    else                =&gt;
    (<span style="color: #d33682; font-weight: bold;">error</span> <span style="color: #e6db74;">"Illegal IN form ~S"</span> form)))

(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">select-in-let-parts</span> (pats part)
  (<span style="color: #f92672; font-weight: bold;">match</span> pats
    nil =&gt; nil
    (pat '= exp . rest) =&gt;
    (cons (<span style="color: #f92672; font-weight: bold;">match</span> part
            'exp =&gt; exp
            'pat =&gt; pat)
          (select-in-let-parts rest part))
    other =&gt;
    (<span style="color: #d33682; font-weight: bold;">error</span> <span style="color: #e6db74;">"Illegal LET form(s): ~S"</span> pats)))

<span style="color: #FF8888;">;; </span><span style="color: #FF8888;">(setf eg1 '(in (list h1 h2 t1 t2)</span>
<span style="color: #FF8888;">;;             </span><span style="color: #FF8888;">let</span>
<span style="color: #FF8888;">;;             </span><span style="color: #FF8888;">(h1 . t1) = (foo x)</span>
<span style="color: #FF8888;">;;             </span><span style="color: #FF8888;">(h2 . t2) = (bar y)))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orge423680" class="outline-4">
<h4 id="orge423680"><span class="section-number-4">3.1.3</span> <span class="done test">test</span> </h4>
<div class="outline-text-4" id="text-3-1-3">
<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">fact</span> (n)
  (<span style="color: #f92672; font-weight: bold;">match</span> n
    '0 =&gt; 1
    n =&gt; (* n (fact (1- n)))))

(fact 10)

(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">eval-expr</span> (x)
  (<span style="color: #f92672; font-weight: bold;">match</span> x
    ('add x y) =&gt; (+ (eval-expr x) (eval-expr y))
    ('sub x y) =&gt; (- (eval-expr x) (eval-expr y))
    ('mul x y) =&gt; (* (eval-expr x) (eval-expr y))
    ('div x y) =&gt; (/ (eval-expr x) (eval-expr y))
    v =&gt; v))

(eval-expr '(add 1 2))
(eval-expr '(add 1 (add 2 3)))

(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">my-append</span> (a b)
  (<span style="color: #f92672; font-weight: bold;">match</span> a
    () =&gt; b
    (hd . tl) =&gt; (cons hd (my-append tl b))))

(my-append '(1 2 3) '(4 5 6))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orga9ee7bb" class="outline-3">
<h3 id="orga9ee7bb"><span class="section-number-3">3.2</span> list</h3>
<div class="outline-text-3" id="text-3-2">
<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">left-of</span> (s l)
  (<span style="color: #f92672; font-weight: bold;">cond</span> ((eq s (car l)) '())
        (<span style="color: #a6e22e;">:else</span> (cons (car l) (left-of s (cdr l))))))

(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">right-of</span> (s l)
  (<span style="color: #f92672; font-weight: bold;">cond</span> ((eq s (car l)) (cdr l))
        (<span style="color: #a6e22e;">:else</span> (right-of s (cdr l)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc6a2d4c" class="outline-3">
<h3 id="orgc6a2d4c"><span class="section-number-3">3.3</span> string</h3>
<div class="outline-text-3" id="text-3-3">
<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">find-char</span> (char string <span style="color: #66d9ef; font-weight: bold;">&amp;key</span> (curser 0))
  (<span style="color: #f92672; font-weight: bold;">if</span> (&gt;= curser (length string))
      nil
      (<span style="color: #f92672; font-weight: bold;">let</span> ((char0 (subseq string curser (+ 1 curser))))
        (<span style="color: #f92672; font-weight: bold;">if</span> (equal char char0)
            curser
            (find-char char string <span style="color: #a6e22e;">:curser</span> (+ 1 curser))))))
</pre>
</div>
</div>
</div>

<div id="outline-container-orge9ce271" class="outline-3">
<h3 id="orge9ce271"><span class="section-number-3">3.4</span> cat &amp; orz</h3>
<div class="outline-text-3" id="text-3-4">
</div><div id="outline-container-org58a9db6" class="outline-4">
<h4 id="org58a9db6"><span class="section-number-4">3.4.1</span> cat</h4>
<div class="outline-text-4" id="text-3-4-1">
<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #FF8888;">;; </span><span style="color: #FF8888;">(cat (:to *standard-output*)</span>
<span style="color: #FF8888;">;;   </span><span style="color: #FF8888;">("~A" 123)</span>
<span style="color: #FF8888;">;;   </span><span style="color: #FF8888;">("~A" 456))</span>
<span style="color: #FF8888;">;; </span><span style="color: #FF8888;">==&gt;</span>
<span style="color: #FF8888;">;; </span><span style="color: #FF8888;">(concatenate</span>
<span style="color: #FF8888;">;;  </span><span style="color: #FF8888;">'string</span>
<span style="color: #FF8888;">;;  </span><span style="color: #FF8888;">(format *standard-output* "~A" 123)</span>
<span style="color: #FF8888;">;;  </span><span style="color: #FF8888;">(format *standard-output* "~A" 456))</span>

<span style="color: #FF8888;">;; </span><span style="color: #FF8888;">(defmacro cat</span>
<span style="color: #FF8888;">;;     </span><span style="color: #FF8888;">((&amp;key (to nil))</span>
<span style="color: #FF8888;">;;      </span><span style="color: #FF8888;">&amp;body form/list-of-list)</span>
<span style="color: #FF8888;">;;   </span><span style="color: #FF8888;">(let* ((form/list-of-list/2</span>
<span style="color: #FF8888;">;;           </span><span style="color: #FF8888;">(mapcar (lambda (list) (append `(format ,to) list))</span>
<span style="color: #FF8888;">;;                   </span><span style="color: #FF8888;">form/list-of-list))</span>
<span style="color: #FF8888;">;;          </span><span style="color: #FF8888;">(form/final (append '(concatenate (quote string))</span>
<span style="color: #FF8888;">;;                              </span><span style="color: #FF8888;">form/list-of-list/2)))</span>
<span style="color: #FF8888;">;;     </span><span style="color: #FF8888;">form/final))</span>

(<span style="color: #f92672; font-weight: bold;">defmacro</span> <span style="color: #a6e22e;">cat</span>
    ((<span style="color: #66d9ef; font-weight: bold;">&amp;key</span> (to nil)
           (trim '())
           prefix
           postfix
           letter)
     <span style="color: #66d9ef; font-weight: bold;">&amp;body</span> form/list-of-list)
  (<span style="color: #f92672; font-weight: bold;">let*</span> ((form/list-of-list/2
          (<span style="color: #f92672; font-weight: bold;">apply</span> (<span style="color: #f92672; font-weight: bold;">function</span> append)
                 (mapcar (<span style="color: #f92672; font-weight: bold;">lambda</span> (list)
                           (list prefix
                                 (list 'string-trim trim
                                       (append '(format nil) list))
                                 postfix))
                         form/list-of-list)))
         (form/list-of-list/3
          (append '(concatenate (<span style="color: #f92672; font-weight: bold;">quote</span> string))
                  form/list-of-list/2))
         (form/final
          (<span style="color: #f92672; font-weight: bold;">cond</span> ((equal letter <span style="color: #a6e22e;">:big</span>)
                 (list 'string-upcase form/list-of-list/3))
                ((equal letter <span style="color: #a6e22e;">:small</span>)
                 (list 'string-downcase form/list-of-list/3))
                ((equal letter nil)
                 form/list-of-list/3)
                (<span style="color: #a6e22e;">:else</span>
                 (<span style="color: #d33682; font-weight: bold;">error</span> <span style="color: #e6db74;">"the argument :letter of (cat) must be :big or :small or nil"</span>)))))
    `(<span style="color: #f92672; font-weight: bold;">let</span> ((string-for-return ,form/final))
       (format ,to <span style="color: #e6db74;">"~A"</span> string-for-return)
       string-for-return)))

<span style="color: #FF8888;">;; </span><span style="color: #FF8888;">(cat (:to *standard-output*</span>
<span style="color: #FF8888;">;;           </span><span style="color: #FF8888;">:trim '(#\Space)</span>
<span style="color: #FF8888;">;;           </span><span style="color: #FF8888;">:prefix "* "</span>
<span style="color: #FF8888;">;;           </span><span style="color: #FF8888;">:postfix (cat () ("~%")))</span>
<span style="color: #FF8888;">;;   </span><span style="color: #FF8888;">("~A" "      123   ")</span>
<span style="color: #FF8888;">;;   </span><span style="color: #FF8888;">("~A" "   456   "))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbe52569" class="outline-4">
<h4 id="orgbe52569"><span class="section-number-4">3.4.2</span> orz</h4>
<div class="outline-text-4" id="text-3-4-2">
<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #f92672; font-weight: bold;">defmacro</span> <span style="color: #a6e22e;">orz</span>
    ((<span style="color: #66d9ef; font-weight: bold;">&amp;key</span> (to nil)
           (trim '())
           prefix
           postfix
           letter)
     <span style="color: #66d9ef; font-weight: bold;">&amp;body</span> form/list-of-list)
  `(<span style="color: #d33682; font-weight: bold;">error</span> (<span style="color: #f92672; font-weight: bold;">cat</span> (<span style="color: #a6e22e;">:to</span> ,to
                    <span style="color: #a6e22e;">:trim</span> ,trim
                    <span style="color: #a6e22e;">:prefix</span> ,prefix
                    <span style="color: #a6e22e;">:postfix</span> ,postfix
                    <span style="color: #a6e22e;">:letter</span> ,letter)
            ,@form/list-of-list)))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgfa489c4" class="outline-4">
<h4 id="orgfa489c4"><span class="section-number-4">3.4.3</span> <span class="done test">test</span> </h4>
<div class="outline-text-4" id="text-3-4-3">
<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #f92672; font-weight: bold;">cat</span> ()
  (<span style="color: #e6db74;">"~A"</span> 123)
  (<span style="color: #e6db74;">"~A"</span> 456))
<span style="color: #FF8888;">;; </span><span style="color: #FF8888;">==&gt; "123456"</span>

<span style="color: #FF8888;">;; </span><span style="color: #FF8888;">(cat ()</span>
<span style="color: #FF8888;">;;   </span><span style="color: #FF8888;">("~A" 123)</span>
<span style="color: #FF8888;">;;   </span><span style="color: #FF8888;">("~A" 456))</span>

<span style="color: #FF8888;">;; </span><span style="color: #FF8888;">(cat (:to *standard-output*)</span>
<span style="color: #FF8888;">;;   </span><span style="color: #FF8888;">("~%")</span>
<span style="color: #FF8888;">;;   </span><span style="color: #FF8888;">("~A~%" 123)</span>
<span style="color: #FF8888;">;;   </span><span style="color: #FF8888;">("~A~%" 456))</span>

<span style="color: #FF8888;">;; </span><span style="color: #FF8888;">(let ((x 123))</span>
<span style="color: #FF8888;">;;   </span><span style="color: #FF8888;">(cat (:to *standard-output*)</span>
<span style="color: #FF8888;">;;     </span><span style="color: #FF8888;">("~A~%" x)))</span>
</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-orgb341f3d" class="outline-2">
<h2 id="orgb341f3d"><span class="section-number-2">4</span> parse</h2>
<div class="outline-text-2" id="text-4">
</div><div id="outline-container-orgc1b7920" class="outline-3">
<h3 id="orgc1b7920"><span class="section-number-3">4.1</span> parse/arrow</h3>
<div class="outline-text-3" id="text-4-1">
<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">parse/arrow</span> (s)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">sexp-arrow -&gt; formal-arrow</span>
  (list (parse/cedent 0 (left-of '-&gt; s))
          (parse/cedent 0 (right-of '-&gt; s))))
</pre>
</div>
</div>
</div>

<div id="outline-container-org6bcc0f7" class="outline-3">
<h3 id="org6bcc0f7"><span class="section-number-3">4.2</span> parse/cedent</h3>
<div class="outline-text-3" id="text-4-2">
<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">parse/cedent</span> (default-level s)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">default-level, sexp-cedent -&gt; formal-cedent</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> s
    () =&gt; ()
    (h . r) =&gt; (cons (parse/dispatch default-level h)
                     (parse/cedent default-level r))))
</pre>
</div>
</div>
</div>

<div id="outline-container-orge856499" class="outline-3">
<h3 id="orge856499"><span class="section-number-3">4.3</span> parse/dispatch</h3>
<div class="outline-text-3" id="text-4-3">
<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">parse/dispatch</span> (default-level v)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">default-level, sexp-form -&gt; formal-form</span>
  (<span style="color: #f92672; font-weight: bold;">flet</span> ((var? (v) (keywordp v))
         (name? (v) (and (symbolp v) (not (keywordp v))))
         (arrow? (v) (and (listp v) (member '-&gt; v)))
         (im-bind? (v) (and (listp v) (member <span style="color: #a6e22e;">:&gt;</span> v)))
         (ex-bind? (v) (and (listp v) (member '@ v))))
    (<span style="color: #f92672; font-weight: bold;">cond</span> ((var? v) (list 'v (parse/var default-level v)))
          ((name? v) (list 'n v))
          ((arrow? v) (list 'a (parse/arrow v)))
          ((im-bind? v) (list 'b
                              (list (parse/cedent 1 (left-of <span style="color: #a6e22e;">:&gt;</span> v))
                                    (parse/cedent 0 (right-of <span style="color: #a6e22e;">:&gt;</span> v))
                                    nil)))
          ((ex-bind? v) (list 'b
                              (list (parse/cedent 1 (left-of '@ v))
                                    (parse/cedent 0 (right-of '@ v))
                                    <span style="color: #a6e22e;">:true</span>))))))
</pre>
</div>
</div>
</div>

<div id="outline-container-org110842a" class="outline-3">
<h3 id="org110842a"><span class="section-number-3">4.4</span> parse/var</h3>
<div class="outline-text-3" id="text-4-4">
<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">parse/var</span> (default-level v)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">default-level, keyword -&gt; formal-var</span>
  (<span style="color: #f92672; font-weight: bold;">let*</span> ((string (symbol-name v))
         (cursor (find-char <span style="color: #e6db74;">"^"</span> string)))
    (<span style="color: #f92672; font-weight: bold;">if</span> cursor
        (list (intern (subseq string 0 cursor) <span style="color: #a6e22e;">:keyword</span>)
              (parse-integer string
                             <span style="color: #a6e22e;">:start</span> (+ 1 cursor)
                             <span style="color: #a6e22e;">:junk-allowed</span> t
                             <span style="color: #a6e22e;">:radix</span> 10))
        (list v default-level))))
</pre>
</div>
</div>
</div>

<div id="outline-container-org8b2f40f" class="outline-3">
<h3 id="org8b2f40f"><span class="section-number-3">4.5</span> <span class="done test">test</span> </h3>
<div class="outline-text-3" id="text-4-5">
<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #d33682; font-weight: bold;">assert</span>
 (equal

  (list
   (parse/arrow '(natural natural -&gt; natural))
   (parse/arrow '(natural natural -&gt; (natural natural -&gt; natural) natural))
   (parse/arrow '(<span style="color: #a6e22e;">:m</span> zero -&gt; <span style="color: #a6e22e;">:m</span>))
   (parse/arrow '(<span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> succ -&gt; <span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> recur succ))

   (parse/arrow '((<span style="color: #a6e22e;">:t</span> <span style="color: #a6e22e;">:&gt;</span> type) <span style="color: #a6e22e;">:t</span> -&gt; type))

   (parse/arrow '((<span style="color: #a6e22e;">:t</span> @ type) <span style="color: #a6e22e;">:t</span> -&gt; type))
   (parse/arrow '((<span style="color: #a6e22e;">:t^2</span> <span style="color: #a6e22e;">:&gt;</span> type) <span style="color: #a6e22e;">:t</span> -&gt; type))
   (parse/arrow '((<span style="color: #a6e22e;">:t1</span> <span style="color: #a6e22e;">:t2^2</span> <span style="color: #a6e22e;">:t3^0</span> <span style="color: #a6e22e;">:&gt;</span> j k) <span style="color: #a6e22e;">:t</span> -&gt; type))
   (parse/arrow '((<span style="color: #a6e22e;">:t^2</span> @ type) <span style="color: #a6e22e;">:t</span> -&gt; type)))



  '((((n natural) (n natural)) ((n natural)))
    (((n natural) (n natural)) ((a (((n natural) (n natural)) ((n natural)))) (n natural)))
    (((v (<span style="color: #a6e22e;">:m</span> 0)) (n zero)) ((v (<span style="color: #a6e22e;">:m</span> 0))))
    (((v (<span style="color: #a6e22e;">:m</span> 0)) (v (<span style="color: #a6e22e;">:n</span> 0)) (n succ)) ((v (<span style="color: #a6e22e;">:m</span> 0)) (v (<span style="color: #a6e22e;">:n</span> 0)) (n recur) (n succ)))

    (((b (((v (<span style="color: #a6e22e;">:t</span> 1))) ((n type)) nil)) (v (<span style="color: #a6e22e;">:t</span> 0))) ((n type)))

    (((b (((v (<span style="color: #a6e22e;">:t</span> 1))) ((n type)) <span style="color: #a6e22e;">:true</span>)) (v (<span style="color: #a6e22e;">:t</span> 0))) ((n type)))
    (((b (((v (<span style="color: #a6e22e;">:t</span> 2))) ((n type)) nil)) (v (<span style="color: #a6e22e;">:t</span> 0))) ((n type)))
    (((b (((v (<span style="color: #a6e22e;">:t1</span> 1)) (v (<span style="color: #a6e22e;">:t2</span> 2)) (v (<span style="color: #a6e22e;">:t3</span> 0))) ((n j) (n k)) nil)) (v (<span style="color: #a6e22e;">:t</span> 0))) ((n type)))
    (((b (((v (<span style="color: #a6e22e;">:t</span> 2))) ((n type)) <span style="color: #a6e22e;">:true</span>)) (v (<span style="color: #a6e22e;">:t</span> 0))) ((n type))))))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org914a8e1" class="outline-2">
<h2 id="org914a8e1"><span class="section-number-2">5</span> pass1</h2>
<div class="outline-text-2" id="text-5">
</div><div id="outline-container-org870511d" class="outline-3">
<h3 id="org870511d"><span class="section-number-3">5.1</span> <span class="todo note">note</span> scope</h3>
<div class="outline-text-3" id="text-5-1">
<ul class="org-ul">
<li><p>scope is handled by pass1</p></li></ul>
</div>
</div>

<div id="outline-container-org183b914" class="outline-3">
<h3 id="org183b914"><span class="section-number-3">5.2</span> pass1/arrow</h3>
<div class="outline-text-3" id="text-5-2">
<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">pass1/arrow</span> (f s)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">formal-arrow, scope -&gt; arrow</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> f
    (fac fsc) =&gt;
    (<span style="color: #f92672; font-weight: bold;">match</span> (pass1/cedent fac s)
      (ac s0) =&gt;
      (<span style="color: #f92672; font-weight: bold;">match</span> (pass1/cedent fsc s0)
        (sc s1) =&gt;
        (list ac sc)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-org6ad2892" class="outline-3">
<h3 id="org6ad2892"><span class="section-number-3">5.3</span> pass1/cedent</h3>
<div class="outline-text-3" id="text-5-3">
<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">pass1/cedent</span> (f s)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">formal-cedent, scope -&gt; (cedent scope)</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> f
    () =&gt; (list () s)
    (h . r) =&gt;
    (<span style="color: #f92672; font-weight: bold;">match</span> (pass1/dispatch h s)
      (v s0) =&gt;
      (<span style="color: #f92672; font-weight: bold;">match</span> (pass1/cedent r s0)
        (c s1) =&gt;
        (list (cons v c) s1)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgaaad6b5" class="outline-3">
<h3 id="orgaaad6b5"><span class="section-number-3">5.4</span> pass1/dispatch</h3>
<div class="outline-text-3" id="text-5-4">
<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">pass1/dispatch</span> (f s)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">formal-form, scope -&gt; (form scope)</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> f
    ('v v) =&gt; (pass1/var v s)
    ('n n) =&gt; (list (list 'name n) s)
    ('a a) =&gt; (list (list 'arrow (pass1/arrow a s)) s)
    ('b b) =&gt; (pass1/bind b s)))
</pre>
</div>
</div>
</div>

<div id="outline-container-org1e28fed" class="outline-3">
<h3 id="org1e28fed"><span class="section-number-3">5.5</span> pass1/var</h3>
<div class="outline-text-3" id="text-5-5">
<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">pass1/var</span> (v s)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">formal-var, scope -&gt; (var scope)</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> v
    (symbol level) =&gt;
    (<span style="color: #f92672; font-weight: bold;">let</span> ((found (assoc symbol s <span style="color: #a6e22e;">:test</span> #'eq)))
      (<span style="color: #f92672; font-weight: bold;">if</span> found
          (<span style="color: #f92672; font-weight: bold;">let</span> ((old (cdr found)))
            (list (list 'var (list old level)) s))
          (<span style="color: #f92672; font-weight: bold;">let</span> ((new (vector symbol ())))
            (list (list 'var (list new level))
                  (cons (cons symbol new) s)))))))
</pre>
</div>
</div>
</div>

<div id="outline-container-orge2fb6ae" class="outline-3">
<h3 id="orge2fb6ae"><span class="section-number-3">5.6</span> pass1/bind</h3>
<div class="outline-text-3" id="text-5-6">
<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">pass1/bind</span> (b s)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">formal-bind, scope -&gt; (bind scope)</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> b
    (fvs fc live?) =&gt;
    (<span style="color: #f92672; font-weight: bold;">match</span> (pass1/cedent fvs s)
      (vs s0) =&gt;
      (<span style="color: #f92672; font-weight: bold;">match</span> (pass1/cedent fc s0)
        <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">this means vars in fvs can occur in fc</span>
        (c s1) =&gt;
        (list (list 'bind (list vs c live?)) s1)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-org4a3ba5a" class="outline-3">
<h3 id="org4a3ba5a"><span class="section-number-3">5.7</span> <span class="done test">test</span> </h3>
<div class="outline-text-3" id="text-5-7">
<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #d33682; font-weight: bold;">assert</span>
 (equalp

  (list
   (pass1/arrow
    (parse/arrow '(natural natural -&gt; natural))
    ())
   (pass1/arrow
    (parse/arrow '(natural natural -&gt; (natural natural -&gt; natural) natural))
    ())
   (pass1/arrow
    (parse/arrow '(<span style="color: #a6e22e;">:m</span> zero -&gt; <span style="color: #a6e22e;">:m</span>))
    ())
   (pass1/arrow
    (parse/arrow '(<span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> succ -&gt; <span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> recur succ))
    ())
   (pass1/arrow
    (parse/arrow '((<span style="color: #a6e22e;">:t</span> <span style="color: #a6e22e;">:&gt;</span> type) <span style="color: #a6e22e;">:t</span> -&gt; type))
    ())
   (pass1/arrow
    (parse/arrow '((<span style="color: #a6e22e;">:t</span> @ type) <span style="color: #a6e22e;">:t</span> -&gt; type))
    ())
   (pass1/arrow
    (parse/arrow '((<span style="color: #a6e22e;">:t^2</span> <span style="color: #a6e22e;">:&gt;</span> type) <span style="color: #a6e22e;">:t</span> -&gt; type))
    ())
   (pass1/arrow
    (parse/arrow '((<span style="color: #a6e22e;">:t1</span> <span style="color: #a6e22e;">:t2^2</span> <span style="color: #a6e22e;">:t3^0</span> <span style="color: #a6e22e;">:&gt;</span> j k) <span style="color: #a6e22e;">:t</span> -&gt; type))
    ())
   (pass1/arrow
    (parse/arrow '((<span style="color: #a6e22e;">:t^2</span> @ type) <span style="color: #a6e22e;">:t</span> -&gt; type))
    ())
   (pass1/arrow
    (parse/arrow '(<span style="color: #a6e22e;">:t</span> (<span style="color: #a6e22e;">:t</span> -&gt; <span style="color: #a6e22e;">:t</span>) -&gt; (<span style="color: #a6e22e;">:t</span> -&gt; (<span style="color: #a6e22e;">:t</span> -&gt; <span style="color: #a6e22e;">:t</span>) <span style="color: #a6e22e;">:t</span>) type))
    ()))

  '((((name natural) (name natural)) ((name natural)))
    (((name natural) (name natural)) ((arrow (((name natural) (name natural)) ((name natural)))) (name natural)))
    (((var (#(<span style="color: #a6e22e;">:m</span> nil) 0)) (name zero)) ((var (#(<span style="color: #a6e22e;">:m</span> nil) 0))))
    (((var (#(<span style="color: #a6e22e;">:m</span> nil) 0)) (var (#(<span style="color: #a6e22e;">:n</span> nil) 0)) (name succ)) ((var (#(<span style="color: #a6e22e;">:m</span> nil) 0)) (var (#(<span style="color: #a6e22e;">:n</span> nil) 0)) (name recur) (name succ)))
    (((bind (((var (#(<span style="color: #a6e22e;">:t</span> nil) 1))) ((name type)) nil)) (var (#(<span style="color: #a6e22e;">:t</span> nil) 0))) ((name type)))
    (((bind (((var (#(<span style="color: #a6e22e;">:t</span> nil) 1))) ((name type)) <span style="color: #a6e22e;">:true</span>)) (var (#(<span style="color: #a6e22e;">:t</span> nil) 0))) ((name type)))
    (((bind (((var (#(<span style="color: #a6e22e;">:t</span> nil) 2))) ((name type)) nil)) (var (#(<span style="color: #a6e22e;">:t</span> nil) 0))) ((name type)))
    (((bind (((var (#(<span style="color: #a6e22e;">:t1</span> nil) 1)) (var (#(<span style="color: #a6e22e;">:t2</span> nil) 2)) (var (#(<span style="color: #a6e22e;">:t3</span> nil) 0))) ((name j) (name k)) nil)) (var (#(<span style="color: #a6e22e;">:t</span> nil) 0))) ((name type)))
    (((bind (((var (#(<span style="color: #a6e22e;">:t</span> nil) 2))) ((name type)) <span style="color: #a6e22e;">:true</span>)) (var (#(<span style="color: #a6e22e;">:t</span> nil) 0))) ((name type)))
    (((var (#(<span style="color: #a6e22e;">:t</span> nil) 0)) (arrow (((var (#(<span style="color: #a6e22e;">:t</span> nil) 0))) ((var (#(<span style="color: #a6e22e;">:t</span> nil) 0)))))) ((arrow (((var (#(<span style="color: #a6e22e;">:t</span> nil) 0))) ((arrow (((var (#(<span style="color: #a6e22e;">:t</span> nil) 0))) ((var (#(<span style="color: #a6e22e;">:t</span> nil) 0))))) (var (#(<span style="color: #a6e22e;">:t</span> nil) 0))))) (name type))))))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org3b32028" class="outline-2">
<h2 id="org3b32028"><span class="section-number-2">6</span> apply</h2>
<div class="outline-text-2" id="text-6">
</div><div id="outline-container-orgdc64f14" class="outline-3">
<h3 id="orgdc64f14"><span class="section-number-3">6.1</span> env</h3>
<div class="outline-text-3" id="text-6-1">
<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">env-&gt;ds</span> (e) (car e))
(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">env-&gt;bs</span> (e) (cadr e))
(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">env-&gt;ns</span> (e) (caddr e))
</pre>
</div>
</div>
</div>

<div id="outline-container-org299e869" class="outline-3">
<h3 id="org299e869"><span class="section-number-3">6.2</span> id</h3>
<div class="outline-text-3" id="text-6-2">
<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">id-&gt;ls</span> (id)
  (svref id 1))

(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">id/commit!</span> (id ls)
  (setf (svref id 1)
        (append (svref id 1) ls)))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgded6416" class="outline-3">
<h3 id="orgded6416"><span class="section-number-3">6.3</span> apply/arrow</h3>
<div class="outline-text-3" id="text-6-3">
<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">apply/arrow</span> (a e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">arrow, env -&gt; env or nil</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> e
    (ds bs ns) =&gt;
    (<span style="color: #f92672; font-weight: bold;">match</span> a
      (ac sc) =&gt;
      (<span style="color: #f92672; font-weight: bold;">match</span> (unify
              (apply/cedent
               ac
               (list (cons 'unify-point ds)
                     (cons '(commit-point) bs)
                     ns)))
        (<span style="color: #a6e22e;">:fail</span> _) =&gt; nil
        (<span style="color: #a6e22e;">:success</span> e1)
        =&gt; (<span style="color: #f92672; font-weight: bold;">let</span> ((e2 (apply/cedent sc e1)))
             (<span style="color: #f92672; font-weight: bold;">match</span> e2
               (ds2 bs2 ns2) =&gt;
               (<span style="color: #f92672; font-weight: bold;">labels</span> ((recur (l) <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">side-effect on var</span>
                          (<span style="color: #f92672; font-weight: bold;">cond</span> ((equal '(commit-point) (car l))
                                 (cdr l))
                                (<span style="color: #a6e22e;">:else</span>
                                 (<span style="color: #f92672; font-weight: bold;">let*</span> ((pair (car l))
                                        (id (car pair))
                                        (ls (cdr pair)))
                                   (id/commit! id ls)
                                   (recur (cdr l)))))))
                 (list ds2 (recur bs2) ns2))))))))
</pre>
</div>
</div>
</div>

<div id="outline-container-org2883888" class="outline-3">
<h3 id="org2883888"><span class="section-number-3">6.4</span> apply/cedent</h3>
<div class="outline-text-3" id="text-6-4">
<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">apply/cedent</span> (c e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">cedent, env -&gt; env</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> c
    () =&gt; e
    (h . r) =&gt; (apply/cedent r (apply/dispatch h e))))
</pre>
</div>
</div>
</div>

<div id="outline-container-orga9e4c83" class="outline-3">
<h3 id="orga9e4c83"><span class="section-number-3">6.5</span> apply/dispatch</h3>
<div class="outline-text-3" id="text-6-5">
<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">apply/dispatch</span> (f e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">form, env -&gt; env</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> f
    ('var v) =&gt; (apply/var v e)
    ('name n) =&gt; (apply/name n e)
    ('arrow a) =&gt; (apply/literal-arrow a e)
    ('bind b) =&gt; (apply/bind b e)))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgcc978dd" class="outline-3">
<h3 id="orgcc978dd"><span class="section-number-3">6.6</span> apply/literal-arrow</h3>
<div class="outline-text-3" id="text-6-6">
<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">apply/literal-arrow</span> (a e)
  (<span style="color: #f92672; font-weight: bold;">match</span> e
    (ds bs ns) =&gt;
    (list (cons (list 'arrow a)
                ds)
          bs
          ns)))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc819d84" class="outline-3">
<h3 id="orgc819d84"><span class="section-number-3">6.7</span> apply/var</h3>
<div class="outline-text-3" id="text-6-7">
<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">apply/var</span> (v e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">var, env -&gt; env</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> e
    (ds bs ns) =&gt;
    (list (cons (bs/deep bs (list 'var v)) ds)
          bs
          ns)))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgeb9b06c" class="outline-3">
<h3 id="orgeb9b06c"><span class="section-number-3">6.8</span> apply/name</h3>
<div class="outline-text-3" id="text-6-8">
<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">apply/name</span> (n e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">name, env -&gt; env</span>
  (<span style="color: #f92672; font-weight: bold;">let</span> ((found (assoc n (env-&gt;ns e) <span style="color: #a6e22e;">:test</span> #'eq)))
    (<span style="color: #f92672; font-weight: bold;">if</span> (not found)
        (<span style="color: #f92672; font-weight: bold;">orz</span> ()
          (<span style="color: #e6db74;">"apply/name unknow name : ~a~%"</span> n))
        (<span style="color: #f92672; font-weight: bold;">let</span> ((store (cdr found)))
          (<span style="color: #f92672; font-weight: bold;">match</span> store
            ('function f)
            =&gt; (apply/name/function f e)
            ('type-constructor (formal-arrow arity data-name-list))
            =&gt; (apply/arity n arity e)
            ('data-constructor (formal-arrow arity type-name))
            =&gt; (apply/arity n arity e))))))
</pre>
</div>
</div>
</div>

<div id="outline-container-org4d3ff43" class="outline-3">
<h3 id="org4d3ff43"><span class="section-number-3">6.9</span> apply/name/function</h3>
<div class="outline-text-3" id="text-6-9">
<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">apply/name/function</span> (f e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">function, env -&gt; env</span>
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">need to do a pass1 here</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> e
    (ds bs ns) =&gt;
    (<span style="color: #f92672; font-weight: bold;">match</span> f
      (formal-arrow arity formal-arrow-list) =&gt;
      (apply/arrow-list (mapcar (<span style="color: #f92672; font-weight: bold;">lambda</span> (x) (pass1/arrow x ()))
                                formal-arrow-list)
                        e))))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc20c10c" class="outline-3">
<h3 id="orgc20c10c"><span class="section-number-3">6.10</span> apply/arrow-list</h3>
<div class="outline-text-3" id="text-6-10">
<ul class="org-ul">
<li><p>trunk maybe be created here</p></li></ul>

<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">apply/arrow-list</span> (arrow-list e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">arrow-list, env -&gt; env or nil</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> e
    (ds bs ns) =&gt;
    (<span style="color: #f92672; font-weight: bold;">let*</span> ((arity (arrow-list-&gt;arity arrow-list e))
           (data-list (subseq ds 0 arity))
           (arrow-list (apply/arrow-list/filter arrow-list data-list e)))
      (<span style="color: #f92672; font-weight: bold;">match</span> arrow-list
        () =&gt; (<span style="color: #f92672; font-weight: bold;">orz</span> ()
                (<span style="color: #e6db74;">"apply/arrow-list no match~%"</span>)
                (<span style="color: #e6db74;">"  arrow-list : ~a~%"</span> arrow-list)
                (<span style="color: #e6db74;">"  data-list : ~a~%"</span> data-list))
        (a) =&gt; (apply/arrow a e)
        (a1 a2 . _) =&gt;
        (list (cons (list 'trunk
                          (list arrow-list
                                data-list))
                    (subseq ds arity))
              bs
              ns)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf2a255e" class="outline-3">
<h3 id="orgf2a255e"><span class="section-number-3">6.11</span> apply/arrow-list/filter</h3>
<div class="outline-text-3" id="text-6-11">
<ul class="org-ul">
<li><p>no commit should be made here</p></li></ul>

<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">apply/arrow-list/filter</span> (arrow-list data-list e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">arrow-list, data-list, env -&gt; arrow-list</span>
  (<span style="color: #f92672; font-weight: bold;">if</span> (eq () arrow-list)
      ()
      (<span style="color: #f92672; font-weight: bold;">match</span> e
        (ds bs ns) =&gt;
        (<span style="color: #f92672; font-weight: bold;">match</span> (car arrow-list)
          (ac sc) =&gt;
          (<span style="color: #f92672; font-weight: bold;">match</span> (unify
                  (apply/cedent
                   ac
                   (list (cons 'unify-point
                               (append data-list ds))
                         bs
                         ns)))
            (<span style="color: #a6e22e;">:fail</span> _)
            =&gt; (apply/arrow-list/filter (cdr arrow-list) data-list e)
            (<span style="color: #a6e22e;">:success</span> e1)
            =&gt; (cons (car arrow-list)
                     (apply/arrow-list/filter (cdr arrow-list) data-list e)))))))
</pre>
</div>
</div>
</div>

<div id="outline-container-org732dfb9" class="outline-3">
<h3 id="org732dfb9"><span class="section-number-3">6.12</span> apply/arity</h3>
<div class="outline-text-3" id="text-6-12">
<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">apply/arity</span> (n arity e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">name, arity, env -&gt; env</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> e
    (ds bs ns) =&gt;
    (list (cons (list 'cons
                      (list n (subseq ds 0 arity)))
                (subseq ds arity))
          bs
          ns)))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd4c3711" class="outline-3">
<h3 id="orgd4c3711"><span class="section-number-3">6.13</span> apply/bind</h3>
<div class="outline-text-3" id="text-6-13">
<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">apply/bind</span> (b e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">bind, env -&gt; env</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> b
    (vs c live?) =&gt;
    (<span style="color: #f92672; font-weight: bold;">match</span> (apply/cedent c e)
      ((d1 . r1) bs1 ns1) =&gt;
      (<span style="color: #f92672; font-weight: bold;">labels</span> ((recur (vs e)
                 (<span style="color: #f92672; font-weight: bold;">match</span> (list vs e)
                   (() _) =&gt; e
                   ((v . r) (ds bs ns)) =&gt;
                   (recur r (list (<span style="color: #f92672; font-weight: bold;">if</span> live?
                                      (cons d1 ds)
                                      ds)
                                  (bs/extend 1 bs v d1)
                                  ns)))))
        (recur vs e)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-org7cb556" class="outline-3">
<h3 id="org7cb556"><span class="section-number-3">6.14</span> <span class="todo _gt__lt__gt__lt__gt__lt_">&gt;&lt;&gt;&lt;&gt;&lt;</span> bs/[extend|find|walk|deep]</h3>
<div class="outline-text-3" id="text-6-14">
<ul class="org-ul">
<li><p><p></p><p>當需要 level n+1 時</p><p>如果只有 level n 其實也是可以的</p><p></p></p><p><ul class="org-ul"></p><p><li><p>用 typeof</p></li></ul></p><p><p></p><p>但是這些信息可能只有在 unify 時纔會用到</p><p>所以現在不處理</p><p></p></p></li>

<li><p>default-level is handled here</p></li></ul>

<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">bs/find</span> (bs v)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">bs, var -&gt; data or nil</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> v
    (id level) =&gt;
    (<span style="color: #f92672; font-weight: bold;">let*</span> ((level (<span style="color: #f92672; font-weight: bold;">if</span> (eq level nil)
                      0
                      level))
           (found/commit (assoc level (id-&gt;ls id) <span style="color: #a6e22e;">:test</span> #'eq)))
      (<span style="color: #f92672; font-weight: bold;">if</span> found/commit
          (cdr found/commit)
          (<span style="color: #f92672; font-weight: bold;">let*</span> ((found/ls (assoc id bs <span style="color: #a6e22e;">:test</span> #'eq))
                 (found/bind
                  (<span style="color: #f92672; font-weight: bold;">if</span> found/ls
                      (assoc level (cdr found/ls) <span style="color: #a6e22e;">:test</span> #'eq)
                      nil)))
            (<span style="color: #f92672; font-weight: bold;">if</span> found/bind
                (cdr found/bind)
                nil))))))

(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">bs/walk</span> (bs d)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">bs, data -&gt; data</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> d
    ('var v) =&gt; (<span style="color: #f92672; font-weight: bold;">let</span> ((found (bs/find bs v)))
                  (<span style="color: #f92672; font-weight: bold;">if</span> found
                      (bs/walk bs found)
                      d))
    (else e) =&gt; d))

(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">bs/deep</span> (bs d)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">bs, data -&gt; data</span>
  (<span style="color: #f92672; font-weight: bold;">let</span> ((d (bs/walk bs d)))
    (<span style="color: #f92672; font-weight: bold;">match</span> d
      ('var v) =&gt; d
      ('arrow a) =&gt; d
      ('cons (name ds))
      =&gt; (list 'cons
               (list name
                     (mapcar (<span style="color: #f92672; font-weight: bold;">lambda</span> (x) (bs/deep bs x))
                             ds)))
      ('trunk (arrow-list ds))
      =&gt; (list 'trunk
               (list arrow-list
                     (mapcar (<span style="color: #f92672; font-weight: bold;">lambda</span> (x) (bs/deep bs x))
                             ds))))))

(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">bs/extend</span> (default-level bs v d)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">bs var data -&gt; bs</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> v
    (id level) =&gt;
    (<span style="color: #f92672; font-weight: bold;">let*</span> ((level (<span style="color: #f92672; font-weight: bold;">if</span> (eq nil level)
                      default-level
                      level))
           (found/ls (assoc id bs <span style="color: #a6e22e;">:test</span> #'eq)))
      (<span style="color: #f92672; font-weight: bold;">if</span> found/ls
          (substitute (cons id (cons (cons level d)
                                     (cdr found/ls)))
                      (<span style="color: #f92672; font-weight: bold;">lambda</span> (pair) (eq (car pair) id))
                      bs)
          (cons (cons id (list (cons level d)))
                bs)))))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org7cc7a88" class="outline-2">
<h2 id="org7cc7a88"><span class="section-number-2">7</span> unify</h2>
<div class="outline-text-2" id="text-7">
</div><div id="outline-container-org2a2a1ad" class="outline-3">
<h3 id="org2a2a1ad"><span class="section-number-3">7.1</span> <span class="todo _">記</span> </h3>
<div class="outline-text-3" id="text-7-1">
<ul class="org-ul">
<li><p>unify 即 核心等詞</p></li>

<li><p><p></p><p>當兩個都是 trunk 時</p><p>有兩種 判斷相等的方式</p><p></p></p><p><ol class="org-ol"></p><p><li>trunk 待作用函數相同 並且 data-list 也相同</li></p><p><li>其中一 trunk 可以計算 然後依舊 非兩個 trunk 的情形來判斷相等</li></ol></p><p><p></p><p>看來等詞是有很多細節的</p><p>可能實現得越細越好</p><p></p></p></li></ul>
</div>
</div>

<div id="outline-container-org7de4718" class="outline-3">
<h3 id="org7de4718"><span class="section-number-3">7.2</span> <span class="todo note">note</span> unify-report</h3>
<div class="outline-text-3" id="text-7-2">
<ul class="org-ul">
<li><p>unify-report =</p><p><ul class="org-ul"></p><p><li><p>(:fail unify-report)</p></li></p><p><li><p>(:success env)</p></li></ul></p></li></ul>
</div>
</div>

<div id="outline-container-orga72a4d3" class="outline-3">
<h3 id="orga72a4d3"><span class="section-number-3">7.3</span> unify</h3>
<div class="outline-text-3" id="text-7-3">
<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">unify</span> (e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">env -&gt; unify-report</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> e
    (ds bs ns) =&gt;
    (<span style="color: #f92672; font-weight: bold;">let*</span> ((l1 (left-of 'unify-point ds))
           (tmp (right-of 'unify-point ds))
           (len (length l1))
           (l2 (subseq tmp 0 len))
           (ds1 (subseq tmp len)))
      (unify/list l1 l2
                  (list <span style="color: #a6e22e;">:success</span> (list ds1 bs ns))))))
</pre>
</div>
</div>
</div>

<div id="outline-container-org92df029" class="outline-3">
<h3 id="org92df029"><span class="section-number-3">7.4</span> unify/list</h3>
<div class="outline-text-3" id="text-7-4">
<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">unify/list</span> (l1 l2 unify-report)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">data list, data list, unify-report -&gt; unify-report</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> unify-report
    (<span style="color: #a6e22e;">:fail</span> report) =&gt; unify-report
    (<span style="color: #a6e22e;">:success</span> e) =&gt;
    (<span style="color: #f92672; font-weight: bold;">if</span> (eq () l1)
        unify-report
        (unify/list (cdr l1) (cdr l2)
                    (unify/dispatch (car l1) (car l2) e)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-org234f5ac" class="outline-3">
<h3 id="org234f5ac"><span class="section-number-3">7.5</span> var/eq</h3>
<div class="outline-text-3" id="text-7-5">
<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">var/eq</span> (v1 v2)
  (<span style="color: #f92672; font-weight: bold;">match</span> (list v1 v2)
    ((id1 level1) (id2 level2)) =&gt;
    (and (eq id1 id2)
         (eq level1 level2))))
</pre>
</div>
</div>
</div>

<div id="outline-container-orge7191ec" class="outline-3">
<h3 id="orge7191ec"><span class="section-number-3">7.6</span> <span class="todo _gt__lt__gt__lt__gt__lt_">&gt;&lt;&gt;&lt;&gt;&lt;</span> unify/dispatch</h3>
<div class="outline-text-3" id="text-7-6">
<ul class="org-ul">
<li><p>需要檢查 type</p></li></ul>

<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">unify/dispatch</span> (d1 d2 e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">data, data, env -&gt; unify-report</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> e
    (ds bs ns) =&gt;
    (<span style="color: #f92672; font-weight: bold;">let</span> ((d1 (bs/walk bs d1))
          (d2 (bs/walk bs d2)))
      <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">walk then if it is var it will be fresh</span>
      (<span style="color: #f92672; font-weight: bold;">match</span> (list d1 d2)
        (('var v1) ('var v2))
        =&gt; (<span style="color: #f92672; font-weight: bold;">if</span> (var/eq v1 v2)
               (list <span style="color: #a6e22e;">:success</span> e)
               (list <span style="color: #a6e22e;">:success</span>
                     (list ds (bs/extend 0 bs v1 d2) ns)))
        (('var v) d)
        =&gt; (list <span style="color: #a6e22e;">:success</span>
                 (list ds (bs/extend 0 bs v d) ns))
        (d ('var v))
        =&gt; (list <span style="color: #a6e22e;">:success</span>
                 (list ds (bs/extend 0 bs v d) ns))
        (('arrow a1) ('arrow a2))
        =&gt; (<span style="color: #f92672; font-weight: bold;">if</span> (equal a1 a2)
               (list <span style="color: #a6e22e;">:success</span>
                     (list ds bs ns))
               (list <span style="color: #a6e22e;">:fail</span>
                     (list
                      `(unify/dispatch (<span style="color: #a6e22e;">:d1</span> ,d1)
                                       (<span style="color: #a6e22e;">:d2</span> ,d2)))))
        (('arrow a) _)
        =&gt; (list <span style="color: #a6e22e;">:fail</span>
                 (list
                  `(unify/dispatch (<span style="color: #a6e22e;">:d1</span> ,d1)
                                   (<span style="color: #a6e22e;">:d2</span> ,d2))))
        (_ ('arrow a))
        =&gt; (list <span style="color: #a6e22e;">:fail</span>
                 (list
                  `(unify/dispatch (<span style="color: #a6e22e;">:d1</span> ,d1)
                                   (<span style="color: #a6e22e;">:d2</span> ,d2))))
        (('cons (name1 data-list1)) ('cons (name2 data-list2)))
        =&gt; (<span style="color: #f92672; font-weight: bold;">if</span> (eq name1 name2)
               (unify/list data-list1 data-list2 (list <span style="color: #a6e22e;">:success</span> e))
               (list <span style="color: #a6e22e;">:fail</span>
                     (list
                      `(unify/dispatch (<span style="color: #a6e22e;">:d1</span> ,d1)
                                       (<span style="color: #a6e22e;">:d2</span> ,d2)))))
        (('trunk trunk1) ('trunk trunk2)) =&gt; (unify/trunk/trunk trunk1 trunk2 e)
        (d ('trunk trunk)) =&gt; (unify/trunk/data trunk d e)
        (('trunk trunk) d) =&gt; (unify/trunk/data trunk d e)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgcdbe30d" class="outline-3">
<h3 id="orgcdbe30d"><span class="section-number-3">7.7</span> <span class="todo _gt__lt__gt__lt__gt__lt_">&gt;&lt;&gt;&lt;&gt;&lt;</span> unify/trunk/trunk</h3>
<div class="outline-text-3" id="text-7-7">
<ul class="org-ul">
<li><p>the use of equalp is not safe</p></li></ul>

<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">unify/trunk/trunk</span> (trunk1 trunk2 e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">trunk, trunk, env -&gt; unify-report</span>
  (<span style="color: #f92672; font-weight: bold;">cat</span> () (<span style="color: #e6db74;">"here unify/trunk/trunk ~%"</span>))
  (<span style="color: #f92672; font-weight: bold;">match</span> (list trunk1 trunk2 e)
    ((arrow-list1 data-list1) (arrow-list2 data-list2) (ds bs ns)) =&gt;
    (<span style="color: #f92672; font-weight: bold;">if</span> (equalp arrow-list1 arrow-list2)
        <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">the use of equalp is not safe</span>
        (unify/list data-list1 data-list2 (list <span style="color: #a6e22e;">:success</span> e))
        (<span style="color: #f92672; font-weight: bold;">match</span> (unify/trunk/data trunk1 (list 'trunk trunk2) e)
          (<span style="color: #a6e22e;">:success</span> e1) =&gt; (list <span style="color: #a6e22e;">:success</span> e1)
          (<span style="color: #a6e22e;">:fail</span> _) =&gt;
          (unify/trunk/data trunk2 (list 'trunk trunk1) e)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc31f647" class="outline-3">
<h3 id="orgc31f647"><span class="section-number-3">7.8</span> <span class="todo _gt__lt__gt__lt__gt__lt_">&gt;&lt;&gt;&lt;&gt;&lt;</span> unify/trunk/data</h3>
<div class="outline-text-3" id="text-7-8">
<ul class="org-ul">
<li><p>trunk can only return one data</p></li></ul>

<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">unify/trunk/data</span> (trunk d e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">trunk, data, env -&gt; unify-report</span>
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">where data is not trunk</span>
  (<span style="color: #f92672; font-weight: bold;">cat</span> () (<span style="color: #e6db74;">"here unify/trunk/data ~%"</span>))
  (<span style="color: #f92672; font-weight: bold;">match</span> e
    (ds bs ns) =&gt;
    (<span style="color: #f92672; font-weight: bold;">match</span> trunk
      (arrow-list data-list) =&gt;
      (<span style="color: #f92672; font-weight: bold;">let</span> ((data-list1 (mapcar (<span style="color: #f92672; font-weight: bold;">lambda</span> (x) (bs/deep bs x))
                                data-list)))
        (<span style="color: #f92672; font-weight: bold;">match</span> (apply/arrow-list/filter arrow-list data-list1 e)
          ()
          =&gt; (list <span style="color: #a6e22e;">:fail</span>
                   (list
                    `(unify/dispatch
                      (<span style="color: #a6e22e;">:trunk-filter-to</span> ())
                      (<span style="color: #a6e22e;">:trunk</span> ,trunk)
                      (<span style="color: #a6e22e;">:data</span> ,d))))
          (a)
          =&gt; (<span style="color: #f92672; font-weight: bold;">match</span> (apply/arrow a (list data-list1 bs ns))
               ((h . _) bs1 ns1)
               =&gt; (unify/dispatch d h (list ds bs1 ns1)))
          (a1 a2 . _)
          =&gt; (list <span style="color: #a6e22e;">:fail</span>
                   (list
                    `(unify/dispatch
                      (<span style="color: #a6e22e;">:trunk-filter-to</span>
                       (<span style="color: #a6e22e;">:arrow-list</span>
                        ,(apply/arrow-list/filter arrow-list data-list1 e))
                       (<span style="color: #a6e22e;">:data-list1</span> ,data-list1)
                       (<span style="color: #a6e22e;">:old-data-list</span> ,data-list))
                      (<span style="color: #a6e22e;">:trunk</span> ,trunk)
                      (<span style="color: #a6e22e;">:data</span> ,d)))))))))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org390e26d" class="outline-2">
<h2 id="org390e26d"><span class="section-number-2">8</span> eva</h2>
<div class="outline-text-2" id="text-8">
</div><div id="outline-container-orga2bc678" class="outline-3">
<h3 id="orga2bc678"><span class="section-number-3">8.1</span> eva</h3>
<div class="outline-text-3" id="text-8-1">
<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">eva</span> (l e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">sexp-top list, env -&gt; env</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> l
    () =&gt; e
    (h . r) =&gt; (eva r (eva/top (parse/top h) e))))
</pre>
</div>
</div>
</div>

<div id="outline-container-org3f71dc9" class="outline-3">
<h3 id="org3f71dc9"><span class="section-number-3">8.2</span> parse/top</h3>
<div class="outline-text-3" id="text-8-2">
<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">parse/top</span> (s)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">sexp-top -&gt; top</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> s
    ('dt name sexp-arrow . body)
    =&gt; (list 'dt
             (list (list name (parse/arrow sexp-arrow))
                   (parse/top/dt-body body)))
    ('df name sexp-arrow . sexp-arrow-list)
    =&gt; (list 'df
             (list (list name (parse/arrow sexp-arrow))
                   (mapcar #'parse/arrow sexp-arrow-list)))
    ('ap sexp-arrow)
    =&gt; (list 'ap (parse/arrow sexp-arrow))))
</pre>
</div>
</div>
</div>

<div id="outline-container-org52ccdd4" class="outline-3">
<h3 id="org52ccdd4"><span class="section-number-3">8.3</span> parse/top/dt-body</h3>
<div class="outline-text-3" id="text-8-3">
<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">parse/top/dt-body</span> (body)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">sexp-top-dt-body -&gt; ((formal-name formal-arrow) ...)</span>
  (<span style="color: #f92672; font-weight: bold;">cond</span> ((eq () body) ())
        ((eq () (cdr body))
         (<span style="color: #f92672; font-weight: bold;">orz</span> ()
           (<span style="color: #e6db74;">"parse/top/dt-body wrong body : body"</span>)))
        (<span style="color: #a6e22e;">:else</span>
         (cons (list (car body) (parse/arrow (cadr body)))
               (parse/top/dt-body (cddr body))))))
</pre>
</div>
</div>
</div>

<div id="outline-container-org95f83b8" class="outline-3">
<h3 id="org95f83b8"><span class="section-number-3">8.4</span> <span class="done test">test</span> </h3>
<div class="outline-text-3" id="text-8-4">
<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #d33682; font-weight: bold;">assert</span>
 (equal

  (mapcar
   #'parse/top
   '((dt natural (-&gt; type)
      zero (-&gt; natural)
      succ (natural -&gt; natural))

     (df add (natural natural -&gt; natural)
      (<span style="color: #a6e22e;">:m</span> zero -&gt; <span style="color: #a6e22e;">:m</span>)
      (<span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> succ -&gt; <span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> recur succ))

     (df mul (natural natural -&gt; natural)
      (<span style="color: #a6e22e;">:m</span> zero -&gt; zero)
      (<span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> succ -&gt; <span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> recur <span style="color: #a6e22e;">:m</span> add))

     (ap (-&gt;
          zero succ
          zero succ succ
          add))))

  '((dt ((natural (nil ((n type)))) ((zero (nil ((n natural)))) (succ (((n natural)) ((n natural)))))))
    (df ((add (((n natural) (n natural)) ((n natural)))) ((((v (<span style="color: #a6e22e;">:m</span> 0)) (n zero)) ((v (<span style="color: #a6e22e;">:m</span> 0)))) (((v (<span style="color: #a6e22e;">:m</span> 0)) (v (<span style="color: #a6e22e;">:n</span> 0)) (n succ)) ((v (<span style="color: #a6e22e;">:m</span> 0)) (v (<span style="color: #a6e22e;">:n</span> 0)) (n recur) (n succ))))))
    (df ((mul (((n natural) (n natural)) ((n natural)))) ((((v (<span style="color: #a6e22e;">:m</span> 0)) (n zero)) ((n zero))) (((v (<span style="color: #a6e22e;">:m</span> 0)) (v (<span style="color: #a6e22e;">:n</span> 0)) (n succ)) ((v (<span style="color: #a6e22e;">:m</span> 0)) (v (<span style="color: #a6e22e;">:n</span> 0)) (n recur) (v (<span style="color: #a6e22e;">:m</span> 0)) (n add))))))
    (ap (nil ((n zero) (n succ) (n zero) (n succ) (n succ) (n add)))))))


(<span style="color: #d33682; font-weight: bold;">assert</span>
 (equal

  (mapcar
   #'parse/top
   '((dt vector ((<span style="color: #a6e22e;">:t</span> <span style="color: #a6e22e;">:&gt;</span> type) number <span style="color: #a6e22e;">:t</span> -&gt; type)
      null (-&gt; zero <span style="color: #a6e22e;">:t</span> vector)
      cons (<span style="color: #a6e22e;">:n</span> <span style="color: #a6e22e;">:t</span> vector <span style="color: #a6e22e;">:t</span> -&gt; <span style="color: #a6e22e;">:n</span> succ <span style="color: #a6e22e;">:t</span> vector))

     (df map (<span style="color: #a6e22e;">:n</span> <span style="color: #a6e22e;">:t1</span> vector (<span style="color: #a6e22e;">:t1</span> -&gt; <span style="color: #a6e22e;">:t2</span>) -&gt; <span style="color: #a6e22e;">:n</span> <span style="color: #a6e22e;">:t2</span> vector)
      (null <span style="color: #a6e22e;">:f</span> -&gt; null)
      (<span style="color: #a6e22e;">:l</span> <span style="color: #a6e22e;">:e</span> cons <span style="color: #a6e22e;">:f</span> -&gt; <span style="color: #a6e22e;">:e</span> <span style="color: #a6e22e;">:f</span> apply <span style="color: #a6e22e;">:l</span> <span style="color: #a6e22e;">:f</span> map cons))

     (df append (<span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:t</span> vector <span style="color: #a6e22e;">:n</span> <span style="color: #a6e22e;">:t</span> vector -&gt; <span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> add <span style="color: #a6e22e;">:t</span> vector)
      (null <span style="color: #a6e22e;">:l</span> -&gt; <span style="color: #a6e22e;">:l</span>)
      (<span style="color: #a6e22e;">:l</span> <span style="color: #a6e22e;">:e</span> cons <span style="color: #a6e22e;">:l1</span> -&gt; <span style="color: #a6e22e;">:l</span> <span style="color: #a6e22e;">:l1</span> append <span style="color: #a6e22e;">:e</span> cons))))

  '((dt ((vector (((b (((v (<span style="color: #a6e22e;">:t</span> 1))) ((n type)) nil)) (n number) (v (<span style="color: #a6e22e;">:t</span> 0))) ((n type)))) ((null (nil ((n zero) (v (<span style="color: #a6e22e;">:t</span> 0)) (n vector)))) (cons (((v (<span style="color: #a6e22e;">:n</span> 0)) (v (<span style="color: #a6e22e;">:t</span> 0)) (n vector) (v (<span style="color: #a6e22e;">:t</span> 0))) ((v (<span style="color: #a6e22e;">:n</span> 0)) (n succ) (v (<span style="color: #a6e22e;">:t</span> 0)) (n vector)))))))
    (df ((map (((v (<span style="color: #a6e22e;">:n</span> 0)) (v (<span style="color: #a6e22e;">:t1</span> 0)) (n vector) (a (((v (<span style="color: #a6e22e;">:t1</span> 0))) ((v (<span style="color: #a6e22e;">:t2</span> 0)))))) ((v (<span style="color: #a6e22e;">:n</span> 0)) (v (<span style="color: #a6e22e;">:t2</span> 0)) (n vector)))) ((((n null) (v (<span style="color: #a6e22e;">:f</span> 0))) ((n null))) (((v (<span style="color: #a6e22e;">:l</span> 0)) (v (<span style="color: #a6e22e;">:e</span> 0)) (n cons) (v (<span style="color: #a6e22e;">:f</span> 0))) ((v (<span style="color: #a6e22e;">:e</span> 0)) (v (<span style="color: #a6e22e;">:f</span> 0)) (n apply) (v (<span style="color: #a6e22e;">:l</span> 0)) (v (<span style="color: #a6e22e;">:f</span> 0)) (n map) (n cons))))))
    (df ((append (((v (<span style="color: #a6e22e;">:m</span> 0)) (v (<span style="color: #a6e22e;">:t</span> 0)) (n vector) (v (<span style="color: #a6e22e;">:n</span> 0)) (v (<span style="color: #a6e22e;">:t</span> 0)) (n vector)) ((v (<span style="color: #a6e22e;">:m</span> 0)) (v (<span style="color: #a6e22e;">:n</span> 0)) (n add) (v (<span style="color: #a6e22e;">:t</span> 0)) (n vector)))) ((((n null) (v (<span style="color: #a6e22e;">:l</span> 0))) ((v (<span style="color: #a6e22e;">:l</span> 0)))) (((v (<span style="color: #a6e22e;">:l</span> 0)) (v (<span style="color: #a6e22e;">:e</span> 0)) (n cons) (v (<span style="color: #a6e22e;">:l1</span> 0))) ((v (<span style="color: #a6e22e;">:l</span> 0)) (v (<span style="color: #a6e22e;">:l1</span> 0)) (n append) (v (<span style="color: #a6e22e;">:e</span> 0)) (n cons)))))))))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd52455e" class="outline-3">
<h3 id="orgd52455e"><span class="section-number-3">8.5</span> eva/top</h3>
<div class="outline-text-3" id="text-8-5">
<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">eva/top</span> (top e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">top, env -&gt; env</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> top
    ('dt type-definition) =&gt; (eva/dt type-definition e)
    ('df function-definition) =&gt; (eva/df function-definition e)
    ('ap formal-arrow) =&gt; (apply/arrow (pass1/arrow formal-arrow ()) e)))
</pre>
</div>
</div>
</div>

<div id="outline-container-org6d4d6a0" class="outline-3">
<h3 id="org6d4d6a0"><span class="section-number-3">8.6</span> eva/dt</h3>
<div class="outline-text-3" id="text-8-6">
<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">eva/dt</span> (type-definition e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">type-definition -&gt; env</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> e
    (ds bs ns) =&gt;
    (<span style="color: #f92672; font-weight: bold;">match</span> type-definition
      ((n a) l) =&gt;
      (<span style="color: #f92672; font-weight: bold;">let*</span> ((name-list
              (mapcar #'car l))
             (arity
              (formal-arrow-&gt;arity a e))
             (ns1
              (cons (cons n
                          (list 'type-constructor
                                (list a
                                      arity
                                      name-list)))
                    ns)))
        (eva/dt/data-constructor-list n l (list ds bs ns1))))))
</pre>
</div>
</div>
</div>

<div id="outline-container-org6a1c41c" class="outline-3">
<h3 id="org6a1c41c"><span class="section-number-3">8.7</span> eva/dt/data-constructor &amp; eva/dt/data-constructor-list</h3>
<div class="outline-text-3" id="text-8-7">
<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">eva/dt/data-constructor</span> (type-name data-constructor e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">type-name, data-constructor, env -&gt; env</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> e
    (ds bs ns) =&gt;
    (<span style="color: #f92672; font-weight: bold;">match</span> data-constructor
      (n a) =&gt;
      (list ds
            bs
            (cons (cons n
                        (list 'data-constructor
                              (list a
                                    (formal-arrow-&gt;arity a e)
                                    type-name)))
                  ns)))))

(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">eva/dt/data-constructor-list</span> (type-name l e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">type-name, data-constructor-list, env -&gt; env</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> l
    () =&gt; e
    (h . r) =&gt;
    (eva/dt/data-constructor-list
     type-name r
     (eva/dt/data-constructor type-name h e))))
</pre>
</div>
</div>
</div>

<div id="outline-container-org41f409b" class="outline-3">
<h3 id="org41f409b"><span class="section-number-3">8.8</span> <span class="todo _gt__lt__gt__lt__gt__lt_">&gt;&lt;&gt;&lt;&gt;&lt;</span> formal-arrow-&gt;arity &amp; arrow-&gt;arity &amp; arrow-list-&gt;arity</h3>
<div class="outline-text-3" id="text-8-8">
<ul class="org-ul">
<li><p>這裏假設了 antecedent 的計算中不會出現返回多個參數的 trunk</p><p>因爲每個 trunk 被計爲一個 data</p><p>但是其實返回多值的 trunk 應該被計爲多個 data</p></li>

<li><p>也就是說 arity 這個 meta data 是不完全的</p><p>完全的 arity 應該是包括返回值個數的</p></li>

<li><p>但是在初期的實驗中我講不用到返回多值的函數</p><p>初期實驗成功後再來修改這個錯誤</p></li></ul>

<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">formal-arrow-&gt;arity</span> (formal-arrow e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">formal-arrow, env -&gt; arity</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> e
    (ds bs ns) =&gt;
    (arrow-&gt;arity (pass1/arrow formal-arrow ()) e)))

(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">arrow-&gt;arity</span> (a e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">arrow, env -&gt; arity</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> e
    (ds bs ns) =&gt;
    (<span style="color: #f92672; font-weight: bold;">match</span> a
      (antecedent succedent) =&gt;
      (<span style="color: #f92672; font-weight: bold;">match</span> (apply/cedent antecedent
                           (list () bs ns))
        (ds1 bs1 ns1) =&gt;
        (length ds1)))))

(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">arrow-list-&gt;arity</span> (l e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">arrow-list, env -&gt; arity</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> l
    (h . _) =&gt; (arrow-&gt;arity h e)))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc32a5a4" class="outline-3">
<h3 id="orgc32a5a4"><span class="section-number-3">8.9</span> eva/df</h3>
<div class="outline-text-3" id="text-8-9">
<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">eva/df</span> (function-definition e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">function-definition -&gt; env</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> e
    (ds bs ns) =&gt;
    (<span style="color: #f92672; font-weight: bold;">match</span> function-definition
      ((n a) l) =&gt;
      (<span style="color: #f92672; font-weight: bold;">let</span> ((ns1 (cons (cons n
                             (list 'function
                                   (list a
                                         (formal-arrow-&gt;arity a e)
                                         l)))
                       ns)))
        (<span style="color: #f92672; font-weight: bold;">match</span> (check a l (list ds bs ns1))
          <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">note that the bs of the env</span>
          <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">returned by check is not clean</span>
          (<span style="color: #a6e22e;">:success</span> e1) =&gt; (list ds bs ns1)
          (<span style="color: #a6e22e;">:fail</span> check-report) =&gt;
          (<span style="color: #f92672; font-weight: bold;">orz</span> ()
            (<span style="color: #e6db74;">"eva/df fail to define : ~a~%"</span> function-definition)
            (<span style="color: #e6db74;">"check-report : ~a"</span> check-report)))))))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org3c88d94" class="outline-2">
<h2 id="org3c88d94"><span class="section-number-2">9</span> check</h2>
<div class="outline-text-2" id="text-9">
</div><div id="outline-container-orgfacd087" class="outline-3">
<h3 id="orgfacd087"><span class="section-number-3">9.1</span> <span class="todo note">note</span> check-report</h3>
<div class="outline-text-3" id="text-9-1">
<ul class="org-ul">
<li><p>check-report =</p><p>(:fail check-report)</p><p>(:success env)</p></li></ul>
</div>
</div>

<div id="outline-container-org17fc074" class="outline-3">
<h3 id="org17fc074"><span class="section-number-3">9.2</span> check</h3>
<div class="outline-text-3" id="text-9-2">
<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">check</span> (type-formal-arrow l e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">type-formal-arrow, formal-arrow list, env -&gt; check-report</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> l
    () =&gt; (list <span style="color: #a6e22e;">:success</span> e)
    (h . r) =&gt;
    (<span style="color: #f92672; font-weight: bold;">match</span> (check/arrow type-formal-arrow h e)
      (<span style="color: #a6e22e;">:success</span> e) =&gt; (check type-formal-arrow r e)
      (<span style="color: #a6e22e;">:fail</span> check-report) =&gt; (list <span style="color: #a6e22e;">:fail</span> check-report))))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb3046af" class="outline-3">
<h3 id="orgb3046af"><span class="section-number-3">9.3</span> check/arrow</h3>
<div class="outline-text-3" id="text-9-3">
<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">check/arrow</span> (type-formal-arrow a e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">type-formal-arrow, formal-arrow, env -&gt; check-report</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> (pass1/arrow type-formal-arrow ())
    (tac tsc) =&gt;
    (<span style="color: #f92672; font-weight: bold;">match</span> (apply/cedent tac e)
      (ds0 bs0 ns0) =&gt;
      (<span style="color: #f92672; font-weight: bold;">match</span> (pass1/arrow a ())
        (ac sc) =&gt;
        (<span style="color: #f92672; font-weight: bold;">match</span> (unify
                (type-apply/cedent
                 ac
                 (list (cons 'unify-point ds0)
                       bs0
                       ns0)))
          (<span style="color: #a6e22e;">:fail</span> report)
          =&gt; (list <span style="color: #a6e22e;">:fail</span>
                   (cons `(check/arrow
                           (<span style="color: #a6e22e;">:type-antecedent</span> ,tac)
                           (<span style="color: #a6e22e;">:antecedent</span> ,ac))
                         report))
          (<span style="color: #a6e22e;">:success</span> e1)
          =&gt; (<span style="color: #f92672; font-weight: bold;">let*</span> ((e2 (type-apply/cedent sc e1)))
               (<span style="color: #f92672; font-weight: bold;">match</span> e2
                 (ds2 bs2 ns2) =&gt;
                 (<span style="color: #f92672; font-weight: bold;">match</span> (unify
                         (apply/cedent
                          tsc
                          (list (cons 'unify-point ds2)
                                bs2
                                ns2)))
                   (<span style="color: #a6e22e;">:success</span> e) =&gt; (list <span style="color: #a6e22e;">:success</span> e)
                   (<span style="color: #a6e22e;">:fail</span> report)
                   =&gt; (list <span style="color: #a6e22e;">:fail</span>
                            (cons `(check/arrow
                                    (<span style="color: #a6e22e;">:type-succedent</span> ,tsc)
                                    (<span style="color: #a6e22e;">:succedent</span> ,sc))
                                  report))))))))))
</pre>
</div>
</div>
</div>

<div id="outline-container-orge4b0c40" class="outline-3">
<h3 id="orge4b0c40"><span class="section-number-3">9.4</span> type-apply/cedent</h3>
<div class="outline-text-3" id="text-9-4">
<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">type-apply/cedent</span> (c e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">cedent, env -&gt; env</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> c
    () =&gt; e
    (h . r) =&gt; (type-apply/cedent r (type-apply/dispatch h e))))
</pre>
</div>
</div>
</div>

<div id="outline-container-org375f60b" class="outline-3">
<h3 id="org375f60b"><span class="section-number-3">9.5</span> <span class="todo _gt__lt__gt__lt__gt__lt_">&gt;&lt;&gt;&lt;&gt;&lt;</span> type-apply/dispatch</h3>
<div class="outline-text-3" id="text-9-5">
<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">type-apply/dispatch</span> (f e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">form, env -&gt; env</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> f
    ('var v) =&gt; (type-apply/var v e)
    ('name n) =&gt; (type-apply/name n e)
    ('arrow a) =&gt; <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">(type-apply/literal-arrow a e)</span>
    (<span style="color: #f92672; font-weight: bold;">orz</span> ()
      (<span style="color: #e6db74;">"type-apply/dispatch can not type-apply literal-arrow for now"</span>))
    ('bind b) =&gt; <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">(type-apply/bind b e)</span>
    (<span style="color: #f92672; font-weight: bold;">orz</span> ()
      (<span style="color: #e6db74;">"type-apply/dispatch can not type-apply bind for now"</span>))))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbfd06a0" class="outline-3">
<h3 id="orgbfd06a0"><span class="section-number-3">9.6</span> type-apply/var</h3>
<div class="outline-text-3" id="text-9-6">
<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">type-apply/var</span> (v e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">var, env -&gt; env</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> v
    (id level) =&gt;
    (apply/var (<span style="color: #f92672; font-weight: bold;">if</span> (eq level nil)
                   (list id 1)
                   (list id (+ 1 level)))
               e)))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc619abe" class="outline-3">
<h3 id="orgc619abe"><span class="section-number-3">9.7</span> type-apply/name</h3>
<div class="outline-text-3" id="text-9-7">
<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #f92672; font-weight: bold;">defun</span> <span style="color: #a6e22e;">type-apply/name</span> (n e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">name, env -&gt; env</span>
  (<span style="color: #f92672; font-weight: bold;">let</span> ((found (assoc n (env-&gt;ns e) <span style="color: #a6e22e;">:test</span> #'eq)))
    (<span style="color: #f92672; font-weight: bold;">if</span> (not found)
        (<span style="color: #f92672; font-weight: bold;">orz</span> ()
          (<span style="color: #e6db74;">"type-apply/name unknow name : ~a~%"</span> n))
        (<span style="color: #f92672; font-weight: bold;">let</span> ((store (cdr found)))
          (<span style="color: #f92672; font-weight: bold;">match</span> store
            (any-store (formal-arrow arity . _)) =&gt;
            (apply/arrow (pass1/arrow formal-arrow ()) e))))))
</pre>
</div>
</div>
</div>

<div id="outline-container-org4cb3972" class="outline-3">
<h3 id="org4cb3972"><span class="section-number-3">9.8</span> <span class="todo _gt__lt_">&gt;&lt;</span> type-apply/literal-arrow</h3>
</div>
<div id="outline-container-orgb2ef5eb" class="outline-3">
<h3 id="orgb2ef5eb"><span class="section-number-3">9.9</span> <span class="todo _gt__lt_">&gt;&lt;</span> type-apply/bind</h3>
</div>
<div id="outline-container-org5743a00" class="outline-3">
<h3 id="org5743a00"><span class="section-number-3">9.10</span> <span class="todo _gt__lt_">&gt;&lt;</span> typeof</h3>
</div>
</div>

<div id="outline-container-org2365f7c" class="outline-2">
<h2 id="org2365f7c"><span class="section-number-2">10</span> sequent</h2>
<div class="outline-text-2" id="text-10">
<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #f92672; font-weight: bold;">defmacro</span> <span style="color: #a6e22e;">sequent</span> (<span style="color: #66d9ef; font-weight: bold;">&amp;body</span> body)
  `(eva (<span style="color: #f92672; font-weight: bold;">quote</span> ,body)
       '(() () ())))
</pre>
</div>
</div>
</div>

<div id="outline-container-org6777ac8" class="outline-2">
<h2 id="org6777ac8"><span class="section-number-2">11</span> <span class="done test">test</span> </h2>
<div class="outline-text-2" id="text-11">
</div><div id="outline-container-orgabaa16e" class="outline-3">
<h3 id="orgabaa16e"><span class="section-number-3">11.1</span> natural</h3>
<div class="outline-text-3" id="text-11-1">
<div class="org-src-container">

<pre class="src src-lisp">(sequent

  (dt type (-&gt; type))

  (dt natural (-&gt; type)
      zero (-&gt; natural)
      succ (natural -&gt; natural))

  (df add (natural natural -&gt; natural)
      (<span style="color: #a6e22e;">:m</span> zero -&gt; <span style="color: #a6e22e;">:m</span>)
      (<span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> succ -&gt; <span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> add succ))

  (df mul (natural natural -&gt; natural)
      (<span style="color: #a6e22e;">:m</span> zero -&gt; zero)
      (<span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> succ -&gt; <span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> mul <span style="color: #a6e22e;">:m</span> add))

  (ap (-&gt;
       zero succ
       zero succ succ
       add))

  (ap (-&gt;
       zero succ succ
       zero succ succ
       mul))

  (ap (-&gt; mul)))
</pre>
</div>
</div>
</div>

<div id="outline-container-org4e677b5" class="outline-3">
<h3 id="org4e677b5"><span class="section-number-3">11.2</span> list</h3>
<div class="outline-text-3" id="text-11-2">
<div class="org-src-container">

<pre class="src src-lisp">(sequent

  (dt type (-&gt; type))

  (dt natural (-&gt; type)
      zero (-&gt; natural)
      succ (natural -&gt; natural))

  (df add (natural natural -&gt; natural)
      (<span style="color: #a6e22e;">:m</span> zero -&gt; <span style="color: #a6e22e;">:m</span>)
      (<span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> succ -&gt; <span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> add succ))

  (df mul (natural natural -&gt; natural)
      (<span style="color: #a6e22e;">:m</span> zero -&gt; zero)
      (<span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> succ -&gt; <span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> mul <span style="color: #a6e22e;">:m</span> add))

  (dt list ((<span style="color: #a6e22e;">:t</span> <span style="color: #a6e22e;">:&gt;</span> type) <span style="color: #a6e22e;">:t</span> -&gt; type)
      null (-&gt; <span style="color: #a6e22e;">:t</span> list)
      cons (<span style="color: #a6e22e;">:t</span> list <span style="color: #a6e22e;">:t</span> -&gt; <span style="color: #a6e22e;">:t</span> list))

  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">(df map (:t1 list (:t1 -&gt; :t2) -&gt; :t2 list)</span>
  <span style="color: #FF8888;">;;     </span><span style="color: #FF8888;">(null :f -&gt; null)</span>
  <span style="color: #FF8888;">;;     </span><span style="color: #FF8888;">(:l :e cons :f -&gt; :e :f apply :l :f map cons))</span>

  (df append (<span style="color: #a6e22e;">:t</span> list <span style="color: #a6e22e;">:t</span> list -&gt; <span style="color: #a6e22e;">:t1</span> list)
      (<span style="color: #a6e22e;">:l</span> null -&gt; <span style="color: #a6e22e;">:l</span>)
      (<span style="color: #a6e22e;">:l</span> <span style="color: #a6e22e;">:r</span> <span style="color: #a6e22e;">:e</span> cons -&gt; <span style="color: #a6e22e;">:l</span> <span style="color: #a6e22e;">:r</span> append <span style="color: #a6e22e;">:e</span> cons))

  (ap (-&gt;
       null
       zero cons
       zero cons
       zero cons
       null
       zero cons
       zero cons
       zero cons
       append)))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf7ee93" class="outline-3">
<h3 id="orgf7ee93"><span class="section-number-3">11.3</span> vector</h3>
<div class="outline-text-3" id="text-11-3">
<div class="org-src-container">

<pre class="src src-lisp">(sequent

  (dt type (-&gt; type))

  (dt natural (-&gt; type)
      zero (-&gt; natural)
      succ (natural -&gt; natural))

  (df add (natural natural -&gt; natural)
      (<span style="color: #a6e22e;">:m</span> zero -&gt; <span style="color: #a6e22e;">:m</span>)
      (<span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> succ -&gt; <span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> add succ))

  (df mul (natural natural -&gt; natural)
      (<span style="color: #a6e22e;">:m</span> zero -&gt; zero)
      (<span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> succ -&gt; <span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> mul <span style="color: #a6e22e;">:m</span> add))

  (dt vector ((<span style="color: #a6e22e;">:t</span> <span style="color: #a6e22e;">:&gt;</span> type) natural <span style="color: #a6e22e;">:t</span> -&gt; type)
      null (-&gt; zero <span style="color: #a6e22e;">:t</span> vector)
      cons (<span style="color: #a6e22e;">:n</span> <span style="color: #a6e22e;">:t</span> vector <span style="color: #a6e22e;">:t</span> -&gt; <span style="color: #a6e22e;">:n</span> succ <span style="color: #a6e22e;">:t</span> vector))

  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">(df map (:n :t1 vector (:t1 -&gt; :t2) -&gt; :n :t2 vector)</span>
  <span style="color: #FF8888;">;;     </span><span style="color: #FF8888;">(null :f -&gt; null)</span>
  <span style="color: #FF8888;">;;     </span><span style="color: #FF8888;">(:l :e cons :f -&gt; :e :f apply :l :f map cons))</span>

  (df append (<span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:t</span> vector <span style="color: #a6e22e;">:n</span> <span style="color: #a6e22e;">:t</span> vector -&gt; <span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> add <span style="color: #a6e22e;">:t</span> vector)
      (<span style="color: #a6e22e;">:l</span> null -&gt; <span style="color: #a6e22e;">:l</span>)
      (<span style="color: #a6e22e;">:l</span> <span style="color: #a6e22e;">:r</span> <span style="color: #a6e22e;">:e</span> cons -&gt; <span style="color: #a6e22e;">:l</span> <span style="color: #a6e22e;">:r</span> append <span style="color: #a6e22e;">:e</span> cons))

  (ap (-&gt;
       null
       zero cons
       zero cons
       zero cons
       null
       zero cons
       zero cons
       zero cons
       append)))
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: XIE Yuheng</p>
<p class="date">Created: 2016-04-17 Sun 13:45</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
