<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2016-04-25 Mon 13:47 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>sequent1</title>
<meta name="generator" content="Org-mode" />
<meta name="author" content="XIE Yuheng" />
<link rel="stylesheet" href="../asset/css/page.css" type="text/css" media="screen" />
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="preamble" class="status">
喪以不執 所執者喪 執喪相比 方死方生
</div>
<div id="content">
<h1 class="title">sequent1</h1>
<div id="table-of-contents">
<h2>overview</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgf50123f"><span class="done todo">todo</span> </a></li>
<li><a href="#orgd940f2a">helper</a>
<ul>
<li><a href="#orga5c38e3">pattern match</a></li>
<li><a href="#org1e4a4af">cat &amp; orz</a></li>
<li><a href="#org89977c8"><span class="done test">test</span> ing</a></li>
<li><a href="#org9907cd7">list</a></li>
<li><a href="#org47bd7d6">string</a></li>
</ul>
</li>
<li><a href="#orgf93b8d7"><span class="todo note">note</span> </a>
<ul>
<li><a href="#orgd75d5de">sequent</a></li>
<li><a href="#orgbce36df">form</a>
<ul>
<li><a href="#orgb3a2f27">form1</a></li>
<li><a href="#orgca03a13">form2</a></li>
<li><a href="#org46aa988">form3</a></li>
</ul>
</li>
<li><a href="#org8651be0">data</a></li>
<li><a href="#org43e2346">env</a></li>
<li><a href="#org5a922e1">meaning</a></li>
<li><a href="#orgdb9c31a">top</a>
<ul>
<li><a href="#orgc609c93">top1</a></li>
<li><a href="#orgf987a05">top2</a></li>
</ul>
</li>
<li><a href="#orga2e60de">report</a></li>
</ul>
</li>
<li><a href="#org5f4e4ee">pass</a>
<ul>
<li><a href="#org17f0341">pass1</a>
<ul>
<li><a href="#org2c417cc">pass1/arrow</a></li>
<li><a href="#orgce48b85">pass1/cedent</a></li>
<li><a href="#org769377f">predicates</a></li>
<li><a href="#org5cdd449">pass1</a></li>
<li><a href="#org97170dc">pass1/var</a></li>
<li><a href="#org7ac6833"><span class="done test">test</span> </a></li>
</ul>
</li>
<li><a href="#orgb9b0ec5">pass2</a>
<ul>
<li><a href="#orgcf80556">pass2/arrow</a></li>
<li><a href="#orga36b7e1">pass2/cedent</a></li>
<li><a href="#orge2559b8">pass2/lambda</a></li>
<li><a href="#orgbb05fda">pass2</a></li>
<li><a href="#orge74ef89">pass2/var</a></li>
<li><a href="#org3a0e61d">pass2/bind</a></li>
<li><a href="#orga640cb3"><span class="done test">test</span> </a></li>
</ul>
</li>
<li><a href="#orgb0c8ef7"><span class="todo _gt__lt_">&gt;&lt;</span> pass3</a></li>
</ul>
</li>
<li><a href="#orgd6bb63d">apply</a>
<ul>
<li><a href="#org3e56eb7">apply/arrow</a></li>
<li><a href="#orge43c321">apply/cedent</a></li>
<li><a href="#org288503b">apply/dispatch</a></li>
<li><a href="#org47c7d75">apply/literal-arrow</a></li>
<li><a href="#org1999fd7">apply/var</a></li>
<li><a href="#org8950dc1">apply/name</a></li>
<li><a href="#orgec51715">id-&gt;ls</a></li>
</ul>
</li>
<li><a href="#org2e5cc35">unify</a>
<ul>
<li><a href="#org901aee3"><span class="todo _gt__lt_">&gt;&lt;</span> unify</a></li>
</ul>
</li>
<li><a href="#org1950186"><span class="todo _gt__lt_">&gt;&lt;</span> eva</a></li>
<li><a href="#org2e1dae8"><span class="todo _gt__lt_">&gt;&lt;</span> check</a></li>
<li><a href="#org9dec86f"><span class="todo _gt__lt_">&gt;&lt;</span> type-apply</a></li>
<li><a href="#orgac897b6"><span class="todo _gt__lt_">&gt;&lt;</span> sequent</a></li>
<li><a href="#org1f70d1f"><span class="done test">test</span> </a>
<ul>
<li><a href="#org80e9a36">natural</a></li>
<li><a href="#org50eda05">list</a></li>
<li><a href="#org4b804d">vector</a></li>
</ul>
</li>
</ul>
</div>
</div>
<ul class="org-ul">
<li><p>a prototype interpreter for a functional language</p><p>which uses sequent calculus as dependent type system</p></li>

<li><p>XIE Yuheng created</p></li></ul>

<div id="outline-container-orgf50123f" class="outline-2">
<h2 id="orgf50123f"><span class="done todo">todo</span> </h2>
<div class="outline-text-2" id="text-orgf50123f">
<ul class="org-ul">
<li><p>data/print</p><p>different var should be print differently</p></li>

<li><p>check-type</p><p>infer-arity</p><p>check-cover</p><p>check-end</p></li></ul>
</div>
</div>

<div id="outline-container-orgd940f2a" class="outline-2">
<h2 id="orgd940f2a">helper</h2>
<div class="outline-text-2" id="text-orgd940f2a">
</div><div id="outline-container-orga5c38e3" class="outline-3">
<h3 id="orga5c38e3">pattern match</h3>
<div class="outline-text-3" id="text-orga5c38e3">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #FF8888;">;; </span><span style="color: #FF8888;">module system of guile</span>
<span style="color: #FF8888;">;; </span><span style="color: #FF8888;">using http://synthcode.com/scheme/match.scm</span>
(use-modules (ice-9 match))
</pre>
</div>
</div>
</div>

<div id="outline-container-org1e4a4af" class="outline-3">
<h3 id="org1e4a4af">cat &amp; orz</h3>
<div class="outline-text-3" id="text-org1e4a4af">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #FF8888;">;; </span><span style="color: #FF8888;">guile</span>
(<span style="color: #f92672; font-weight: bold;">define-syntax</span> <span style="color: #fd971f;">cat</span>
  (<span style="color: #f92672; font-weight: bold;">syntax-rules</span> ()
    [(cat (str . args))
     (format #t str . args)]
    [(cat (str . args) (str2 . args2) ...)
     (string-append
      (cat (str . args))
      (cat (str2 . args2) ...))]))

<span style="color: #FF8888;">;; </span><span style="color: #FF8888;">(define-syntax cat</span>
<span style="color: #FF8888;">;;   </span><span style="color: #FF8888;">(syntax-rules ()</span>
<span style="color: #FF8888;">;;     </span><span style="color: #FF8888;">[(cat (str . args))</span>
<span style="color: #FF8888;">;;      </span><span style="color: #FF8888;">(format str . args)]</span>
<span style="color: #FF8888;">;;     </span><span style="color: #FF8888;">[(cat (str . args) (str2 . args2) ...)</span>
<span style="color: #FF8888;">;;      </span><span style="color: #FF8888;">(string-append</span>
<span style="color: #FF8888;">;;       </span><span style="color: #FF8888;">(cat (str . args))</span>
<span style="color: #FF8888;">;;       </span><span style="color: #FF8888;">(cat (str2 . args2) ...))]))</span>

(<span style="color: #f92672; font-weight: bold;">define-syntax</span> <span style="color: #fd971f;">orz</span>
  (<span style="color: #f92672; font-weight: bold;">syntax-rules</span> ()
    [(<span style="color: #f92672; font-weight: bold;">orz</span> . body)
     (<span style="color: #f92672; font-weight: bold;">error</span> (cat . body))]))

(<span style="color: #f92672; font-weight: bold;">define-syntax</span> <span style="color: #fd971f;">note</span>
  (<span style="color: #f92672; font-weight: bold;">syntax-rules</span> ()
    [(<span style="color: #f92672; font-weight: bold;">note</span> . body)
     '()]))
</pre>
</div>
</div>
</div>

<div id="outline-container-org89977c8" class="outline-3">
<h3 id="org89977c8"><span class="done test">test</span> ing</h3>
<div class="outline-text-3" id="text-org89977c8">
<div class="org-src-container">

<pre class="src src-scheme">(use-modules (ice-9 pretty-print))

(<span style="color: #f92672; font-weight: bold;">define-syntax</span> <span style="color: #fd971f;">test</span>
  (<span style="color: #f92672; font-weight: bold;">syntax-rules</span> ()
    [(test b1 b2)
     (<span style="color: #f92672; font-weight: bold;">if</span> (equal? b1 b2)
       #t
       (<span style="color: #f92672; font-weight: bold;">let</span> ()
         (cat (<span style="color: #e6db74;">"\n"</span>))
         (cat (<span style="color: #e6db74;">"&lt;test-fail-report-begin&gt;\n"</span>))
         (cat (<span style="color: #e6db74;">"&lt;actual-form&gt; :\n"</span>))
         (pretty-print (<span style="color: #f92672; font-weight: bold;">quote</span> b1))
         (cat (<span style="color: #e6db74;">"&lt;actual-value&gt; :\n"</span>))
         (pretty-print b1)
         (cat (<span style="color: #e6db74;">"&lt;expect-form&gt; :\n"</span>))
         (pretty-print (<span style="color: #f92672; font-weight: bold;">quote</span> b2))
         (cat (<span style="color: #e6db74;">"&lt;expect-value&gt; :\n"</span>))
         (pretty-print b2)
         (<span style="color: #f92672; font-weight: bold;">orz</span> (<span style="color: #e6db74;">"&lt;test-fail-report-end&gt;\n"</span>))))]))
</pre>
</div>
</div>
</div>

<div id="outline-container-org9907cd7" class="outline-3">
<h3 id="org9907cd7">list</h3>
<div class="outline-text-3" id="text-org9907cd7">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">left-of</span> s l)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">sexp, list -&gt; list</span>
  (<span style="color: #f92672; font-weight: bold;">cond</span> [(equal? s (car l)) '()]
        [else (cons (car l) (left-of s (cdr l)))]))

(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">right-of</span> s l)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">sexp, list -&gt; list</span>
  (<span style="color: #f92672; font-weight: bold;">cond</span> [(equal? s (car l)) (cdr l)]
        [else (right-of s (cdr l))]))
</pre>
</div>
</div>
</div>

<div id="outline-container-org47bd7d6" class="outline-3">
<h3 id="org47bd7d6">string</h3>
<div class="outline-text-3" id="text-org47bd7d6">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">find-char</span> c s)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">char, string -&gt; curser or #f</span>
  (find-char/curser c s 0))

(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">find-char/curser</span> c s curser)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">char, string, curser -&gt; curser or #f</span>
  (<span style="color: #f92672; font-weight: bold;">if</span> (&gt;= curser (string-length s))
    #f
    (<span style="color: #f92672; font-weight: bold;">let</span> ([c0 (substring s curser (+ 1 curser))])
      (<span style="color: #f92672; font-weight: bold;">if</span> (equal? c c0)
        curser
        (find-char/curser c s (+ 1 curser))))))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgf93b8d7" class="outline-2">
<h2 id="orgf93b8d7"><span class="todo note">note</span> </h2>
<div class="outline-text-2" id="text-orgf93b8d7">
</div><div id="outline-container-orgd75d5de" class="outline-3">
<h3 id="orgd75d5de">sequent</h3>
<div class="outline-text-3" id="text-orgd75d5de">
<ul class="org-ul">
<li><p>sequent is arrow</p><p>which is the core data type of the language</p></li></ul>
</div>
</div>

<div id="outline-container-orgbce36df" class="outline-3">
<h3 id="orgbce36df">form</h3>
<div class="outline-text-3" id="text-orgbce36df">
</div><div id="outline-container-orgb3a2f27" class="outline-4">
<h4 id="orgb3a2f27">form1</h4>
<div class="outline-text-4" id="text-orgb3a2f27">
<ul class="org-ul">
<li><p>form1 =</p><p><ul class="org-ul"></p><p><li><p>form1/var =</p><p>:var</p><p>:var<sup>n</sup></p></li></p><p><li><p>form1/name =</p><p>name</p></li></p><p><li><p>form1/arrow =</p><p>(form1 &#x2026; -&gt; form1 &#x2026;)</p></li></p><p><li><p>form1/lambda =</p><p>(lambda form1/arrow</p><p>  form1/arrow</p><p>  &#x2026;)</p></li></p><p><li><p>form1/im-bind =</p><p>(form1/var &#x2026; : form1 &#x2026;)</p></li></p><p><li><p>form1/ex-bind =</p><p>(form1/var &#x2026; @ form1 &#x2026;)</p></li></ul></p></li></ul>
</div>
</div>

<div id="outline-container-orgca03a13" class="outline-4">
<h4 id="orgca03a13">form2</h4>
<div class="outline-text-4" id="text-orgca03a13">
<ul class="org-ul">
<li><p>form1 -pass1-&gt; form2</p><p>level of var is handled here</p></li>

<li><p>form2 =</p><p>('form2/var    (symbol level))</p><p>('form2/name   symbol)</p><p>('form2/arrow  ((form2 &#x2026;) (form2 &#x2026;)))</p><p>('form2/lambda (form2/arrow (form2/arrow &#x2026;)))</p><p>('form2/bind   ((form2/var &#x2026;) (form2 &#x2026;) leave?))</p></li>
<li><p>level = natural-number</p></li>
<li><p>leave? = 'leave | 'not-leave</p></li></ul>
</div>
</div>

<div id="outline-container-org46aa988" class="outline-4">
<h4 id="org46aa988">form3</h4>
<div class="outline-text-4" id="text-org46aa988">
<ul class="org-ul">
<li><p>form2 -pass2-&gt; form3</p><p>id of var is handled here</p></li>

<li><p>form3 =</p><p>('form3/var    (id level))</p><p>('form3/name   symbol)</p><p>('form3/arrow  ((form3 &#x2026;) (form3 &#x2026;)))</p><p>('form3/lambda (form3/arrow (form3/arrow &#x2026;)))</p><p>('form3/bind   ((form3/var &#x2026;) (form3 &#x2026;) leave?))</p></li>
<li><p>id = #(symbol ls)</p></li></ul>
</div>
</div>
</div>

<div id="outline-container-org8651be0" class="outline-3">
<h3 id="org8651be0">data</h3>
<div class="outline-text-3" id="text-org8651be0">
<ul class="org-ul">
<li><p>form3 -pass3-&gt; data</p><p>cons trunk multi proj are created here</p><p>arity is calculated here</p></li>

<li><p>data =</p><p>('var    (id level))</p><p>('cons   (name (data &#x2026;)))</p><p>('arrow  ((data &#x2026;) (data &#x2026;)))</p><p>('lambda (arrow arity (arrow &#x2026;)))</p><p>('trunk  (arrow arity (arrow &#x2026;) (data &#x2026;)))</p><p>('multi  (arrow arity (arrow &#x2026;) (data &#x2026;)))</p><p>('proj   var)</p></li>
<li><p>arity = (number number)</p></li></ul>
</div>
</div>

<div id="outline-container-org43e2346" class="outline-3">
<h3 id="org43e2346">env</h3>
<div class="outline-text-3" id="text-org43e2346">
<ul class="org-ul">
<li><p>env = (ds bs ns)</p></li>
<li><p>ds = (data &#x2026;)</p></li>
<li><p>bs = ((id . ls) &#x2026;)</p><p><ul class="org-ul"></p><p><li><p>ls = ((level . data) &#x2026;)</p></li></ul></p></li>
<li><p>ns = ((name . meaning) &#x2026;)</p></li></ul>
</div>
</div>

<div id="outline-container-org5a922e1" class="outline-3">
<h3 id="org5a922e1">meaning</h3>
<div class="outline-text-3" id="text-org5a922e1">
<ul class="org-ul">
<li><p>meaning =</p><p>('lambda    (arrow arity (arrow &#x2026;)))</p><p>('cons/type (arrow arity name (name &#x2026;)))</p><p>('cons/data (arrow arity name name))</p></li></ul>
</div>
</div>

<div id="outline-container-orgdb9c31a" class="outline-3">
<h3 id="orgdb9c31a">top</h3>
<div class="outline-text-3" id="text-orgdb9c31a">
</div><div id="outline-container-orgc609c93" class="outline-4">
<h4 id="orgc609c93">top1</h4>
<div class="outline-text-4" id="text-orgc609c93">
<ul class="org-ul">
<li><p>top1 =</p><p>('dt ((form1/name form1/arrow) ((form1/name form1/arrow) &#x2026;)))</p><p>('df ((form1/name form1/arrow) (form1/arrow &#x2026;)))</p><p>('ap form1/arrow)</p></li></ul>
</div>
</div>

<div id="outline-container-orgf987a05" class="outline-4">
<h4 id="orgf987a05">top2</h4>
<div class="outline-text-4" id="text-orgf987a05">
<ul class="org-ul">
<li><p>top2 =</p><p>('top2/dt ((form2/name form2/arrow) ((form2/name form2/arrow) &#x2026;)))</p><p>('top2/df ((form2/name form2/arrow) (form2/arrow &#x2026;)))</p><p>('top2/ap form2/arrow)</p></li></ul>
</div>
</div>
</div>

<div id="outline-container-orga2e60de" class="outline-3">
<h3 id="orga2e60de">report</h3>
<div class="outline-text-3" id="text-orga2e60de">
<ul class="org-ul">
<li><p>report =</p><p>('fail (info &#x2026;))</p><p>('success (info &#x2026;) env)</p></li>
<li><p>info = &lt;free&gt;</p></li></ul>
</div>
</div>
</div>

<div id="outline-container-org5f4e4ee" class="outline-2">
<h2 id="org5f4e4ee">pass</h2>
<div class="outline-text-2" id="text-org5f4e4ee">
</div><div id="outline-container-org17f0341" class="outline-3">
<h3 id="org17f0341">pass1</h3>
<div class="outline-text-3" id="text-org17f0341">
</div><div id="outline-container-org2c417cc" class="outline-4">
<h4 id="org2c417cc">pass1/arrow</h4>
<div class="outline-text-4" id="text-org2c417cc">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">pass1/arrow</span> default-level s)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">default-level, form1/arrow -&gt; form2/arrow</span>
  (list (pass1/cedent default-level (left-of '<span style="color: #66d9ef; font-weight: bold;">-&gt;</span> s))
        (pass1/cedent default-level (right-of '<span style="color: #66d9ef; font-weight: bold;">-&gt;</span> s))))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgce48b85" class="outline-4">
<h4 id="orgce48b85">pass1/cedent</h4>
<div class="outline-text-4" id="text-orgce48b85">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">pass1/cedent</span> default-level s)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">default-level, (form1 ...) -&gt; (form2 ...)</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> s
    ['() '()]
    [(h . r) (cons (pass1 default-level h)
                   (pass1/cedent default-level r))]))
</pre>
</div>
</div>
</div>

<div id="outline-container-org769377f" class="outline-4">
<h4 id="org769377f">predicates</h4>
<div class="outline-text-4" id="text-org769377f">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">form1/var?</span> v)
  (<span style="color: #f92672; font-weight: bold;">and</span> (symbol? v)
       (equal? <span style="color: #e6db74;">":"</span> (substring (symbol-&gt;string v) 0 1))))

(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">form1/name?</span> v)
  (<span style="color: #f92672; font-weight: bold;">and</span> (symbol? v)
       (not (eq? <span style="color: #e6db74;">":"</span> (substring (symbol-&gt;string v) 0 1)))))

(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">form1/arrow?</span> v)
  (<span style="color: #f92672; font-weight: bold;">and</span> (list? v)
       (member '<span style="color: #66d9ef; font-weight: bold;">-&gt;</span> v)))

(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">form1/lambda?</span> v)
  (<span style="color: #f92672; font-weight: bold;">and</span> (list? v)
       (eq? (car v) 'lambda)))

(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">form1/im-bind?</span> v)
  (<span style="color: #f92672; font-weight: bold;">and</span> (list? v)
       (member ': v)))

(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">form1/ex-bind?</span> v)
  (<span style="color: #f92672; font-weight: bold;">and</span> (list? v)
       (member '@ v)))
</pre>
</div>
</div>
</div>

<div id="outline-container-org5cdd449" class="outline-4">
<h4 id="org5cdd449">pass1</h4>
<div class="outline-text-4" id="text-org5cdd449">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">pass1</span> default-level v)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">default-level, form1 -&gt; form2</span>
  (<span style="color: #f92672; font-weight: bold;">cond</span> [(form1/var? v)
         (list 'form2/var
               (pass1/var default-level v))]
        [(form1/name? v)
         (list 'form2/name
               v)]
        [(form1/arrow? v)
         (list 'form2/arrow
               (pass1/arrow default-level v))]
        [(form1/lambda? v)
         (list 'form2/lambda
               (list (pass1/arrow default-level (cadr v))
                     (<span style="color: #f92672; font-weight: bold;">map</span> (<span style="color: #f92672; font-weight: bold;">lambda</span> (x) (pass1/arrow default-level x))
                       (cddr v))))]
        [(form1/im-bind? v)
         (list 'form2/bind
               (list (pass1/cedent 1 (left-of ': v))
                     (pass1/cedent 0 (right-of ': v))
                     'leave))]
        [(form1/ex-bind? v)
         (list 'form2/bind
               (list (pass1/cedent 1 (left-of '@ v))
                     (pass1/cedent 0 (right-of '@ v))
                     'not-leave))]
        [else
         (<span style="color: #f92672; font-weight: bold;">orz</span> (<span style="color: #e6db74;">"pass1 can not handle sexp-form:~a"</span> v))]))
</pre>
</div>
</div>
</div>

<div id="outline-container-org97170dc" class="outline-4">
<h4 id="org97170dc">pass1/var</h4>
<div class="outline-text-4" id="text-org97170dc">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">pass1/var</span> default-level v)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">default-level, symbol -&gt; form2/var</span>
  (<span style="color: #f92672; font-weight: bold;">let*</span> ([str (symbol-&gt;string v)]
         [cursor (find-char <span style="color: #e6db74;">"^"</span> str)])
    (<span style="color: #f92672; font-weight: bold;">if</span> cursor
      (list (string-&gt;symbol (substring str 0 cursor))
            (string-&gt;number (substring str (+ 1 cursor))))
      (list v default-level))))
</pre>
</div>
</div>
</div>

<div id="outline-container-org7ac6833" class="outline-4">
<h4 id="org7ac6833"><span class="done test">test</span> </h4>
<div class="outline-text-4" id="text-org7ac6833">
<div class="org-src-container">

<pre class="src src-scheme">(test
 (<span style="color: #f92672; font-weight: bold;">map</span> (<span style="color: #f92672; font-weight: bold;">lambda</span> (x) (pass1/arrow 0 x))
   '((natural natural <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> natural)
     (natural natural <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> (natural natural <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> natural) natural)
     (<span style="color: #a6e22e;">:m</span> zero <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #a6e22e;">:m</span>)
     (<span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> succ <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> recur succ)
     (<span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> succ <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> (<span style="color: #f92672; font-weight: bold;">lambda</span> (natural natural <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> natural)
                            (<span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> succ <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> recur succ)
                            (<span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> succ <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> recur succ)))
     ((<span style="color: #a6e22e;">:t</span> : type) <span style="color: #a6e22e;">:t</span> <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> type)
     ((<span style="color: #a6e22e;">:t</span> @ type) <span style="color: #a6e22e;">:t</span> <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> type)
     ((<span style="color: #a6e22e;">:t^2</span> : type) <span style="color: #a6e22e;">:t</span> <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> type)
     ((<span style="color: #a6e22e;">:t1</span> <span style="color: #a6e22e;">:t2^2</span> <span style="color: #a6e22e;">:t3^0</span> : j k) <span style="color: #a6e22e;">:t</span> <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> type)
     ((<span style="color: #a6e22e;">:t^2</span> @ type) <span style="color: #a6e22e;">:t</span> <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> type)))
 '((((form2/name natural) (form2/name natural))
    ((form2/name natural)))
   (((form2/name natural) (form2/name natural))
    ((form2/arrow (((form2/name natural) (form2/name natural)) ((form2/name natural)))) (form2/name natural)))
   (((form2/var (<span style="color: #a6e22e;">:m</span> 0)) (form2/name zero))
    ((form2/var (<span style="color: #a6e22e;">:m</span> 0))))
   (((form2/var (<span style="color: #a6e22e;">:m</span> 0)) (form2/var (<span style="color: #a6e22e;">:n</span> 0)) (form2/name succ))
    ((form2/var (<span style="color: #a6e22e;">:m</span> 0)) (form2/var (<span style="color: #a6e22e;">:n</span> 0)) (form2/name recur) (form2/name succ)))
   (((form2/var (<span style="color: #a6e22e;">:m</span> 0)) (form2/var (<span style="color: #a6e22e;">:n</span> 0)) (form2/name succ))
    ((form2/var (<span style="color: #a6e22e;">:m</span> 0)) (form2/var (<span style="color: #a6e22e;">:n</span> 0)) (form2/lambda ((((form2/name natural) (form2/name natural)) ((form2/name natural))) ((((form2/var (<span style="color: #a6e22e;">:m</span> 0)) (form2/var (<span style="color: #a6e22e;">:n</span> 0)) (form2/name succ)) ((form2/var (<span style="color: #a6e22e;">:m</span> 0)) (form2/var (<span style="color: #a6e22e;">:n</span> 0)) (form2/name recur) (form2/name succ))) (((form2/var (<span style="color: #a6e22e;">:m</span> 0)) (form2/var (<span style="color: #a6e22e;">:n</span> 0)) (form2/name succ)) ((form2/var (<span style="color: #a6e22e;">:m</span> 0)) (form2/var (<span style="color: #a6e22e;">:n</span> 0)) (form2/name recur) (form2/name succ))))))))
   (((form2/bind (((form2/var (<span style="color: #a6e22e;">:t</span> 1))) ((form2/name type)) leave)) (form2/var (<span style="color: #a6e22e;">:t</span> 0)))
    ((form2/name type)))
   (((form2/bind (((form2/var (<span style="color: #a6e22e;">:t</span> 1))) ((form2/name type)) not-leave)) (form2/var (<span style="color: #a6e22e;">:t</span> 0)))
    ((form2/name type)))
   (((form2/bind (((form2/var (<span style="color: #a6e22e;">:t</span> 2))) ((form2/name type)) leave)) (form2/var (<span style="color: #a6e22e;">:t</span> 0)))
    ((form2/name type)))
   (((form2/bind (((form2/var (<span style="color: #a6e22e;">:t1</span> 1)) (form2/var (<span style="color: #a6e22e;">:t2</span> 2)) (form2/var (<span style="color: #a6e22e;">:t3</span> 0))) ((form2/name j) (form2/name k)) leave)) (form2/var (<span style="color: #a6e22e;">:t</span> 0)))
    ((form2/name type)))
   (((form2/bind (((form2/var (<span style="color: #a6e22e;">:t</span> 2))) ((form2/name type)) not-leave)) (form2/var (<span style="color: #a6e22e;">:t</span> 0)))
    ((form2/name type)))))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgb9b0ec5" class="outline-3">
<h3 id="orgb9b0ec5">pass2</h3>
<div class="outline-text-3" id="text-orgb9b0ec5">
</div><div id="outline-container-orgcf80556" class="outline-4">
<h4 id="orgcf80556">pass2/arrow</h4>
<div class="outline-text-4" id="text-orgcf80556">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">pass2/arrow</span> a s)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">form2/arrow, scope -&gt; (form3/arrow scope)</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> a
    [(ac sc)
     (<span style="color: #f92672; font-weight: bold;">match</span> (pass2/cedent ac s)
       [(3ac s1)
        (<span style="color: #f92672; font-weight: bold;">match</span> (pass2/cedent sc s1)
          [(3sc s2)
           (list (list 3ac 3sc) s2)])])]))
</pre>
</div>
</div>
</div>

<div id="outline-container-orga36b7e1" class="outline-4">
<h4 id="orga36b7e1">pass2/cedent</h4>
<div class="outline-text-4" id="text-orga36b7e1">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">pass2/cedent</span> c s)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">(form2 ...), scope -&gt; ((form3 ...) scope)</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> c
    ['() (list '() s)]
    [(h . r)
     (<span style="color: #f92672; font-weight: bold;">match</span> (pass2 h s)
       [(3f s1)
        (<span style="color: #f92672; font-weight: bold;">match</span> (pass2/cedent r s1)
          [(3c s2)
           (list (cons 3f 3c) s2)])])]))
</pre>
</div>
</div>
</div>

<div id="outline-container-orge2559b8" class="outline-4">
<h4 id="orge2559b8">pass2/lambda</h4>
<div class="outline-text-4" id="text-orge2559b8">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">pass2/lambda</span> l s)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">form2/lambda, scope -&gt; (form3/lambda scope)</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> l
    [(a al)
     (list (list (pass2/arrow a s)
                 (<span style="color: #f92672; font-weight: bold;">map</span> (<span style="color: #f92672; font-weight: bold;">lambda</span> (x) (pass2/arrow x s))
                   al))
           s)]))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbb05fda" class="outline-4">
<h4 id="orgbb05fda">pass2</h4>
<div class="outline-text-4" id="text-orgbb05fda">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">pass2</span> f s)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">form2, scope -&gt; (form2 scope)</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> f
    [('form2/var v)
     (<span style="color: #f92672; font-weight: bold;">match</span> (pass2/var v s)
       [(v1 s1)
        (list (list 'form3/var v1) s1)])]
    [('form2/name n)
     (list (list 'form3/name n) s)]
    [('form2/arrow a)
     (<span style="color: #f92672; font-weight: bold;">match</span> (pass2/arrow a s)
       [(a1 s1)
        (list (list 'form3/arrow a1) s1)])]
    [('form2/lambda l)
     (<span style="color: #f92672; font-weight: bold;">match</span> (pass2/lambda l s)
       [(l1 s1)
        (list (list 'form3/lambda l1) s1)])]
    [('form2/bind b)
     (<span style="color: #f92672; font-weight: bold;">match</span> (pass2/bind b s)
       [(b1 s1)
        (list (list 'form3/bind b1) s1)])]))
</pre>
</div>
</div>
</div>

<div id="outline-container-orge74ef89" class="outline-4">
<h4 id="orge74ef89">pass2/var</h4>
<div class="outline-text-4" id="text-orge74ef89">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">pass2/var</span> v s)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">form2/var, scope -&gt; (form3/var scope)</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> v
    [(symbol level)
     (<span style="color: #f92672; font-weight: bold;">let</span> ([found (assq symbol s)])
       (<span style="color: #f92672; font-weight: bold;">if</span> found
         (<span style="color: #f92672; font-weight: bold;">let</span> ([old (cdr found)])
           (list (list old level)
                 s))
         (<span style="color: #f92672; font-weight: bold;">let</span> ([new (vector symbol '())])
           (list (list new level)
                 (cons (cons symbol new) s)))))]))
</pre>
</div>
</div>
</div>

<div id="outline-container-org3a0e61d" class="outline-4">
<h4 id="org3a0e61d">pass2/bind</h4>
<div class="outline-text-4" id="text-org3a0e61d">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">pass2/bind</span> b s)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">form2/bind, scope -&gt; (form3/bind scope)</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> b
    [(vs c leave?)
     (<span style="color: #f92672; font-weight: bold;">match</span> (pass2/cedent vs s)
       [(3vs s1)
        (<span style="color: #f92672; font-weight: bold;">match</span> (pass2/cedent c s1)
          <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">this means vars in vs can occur in c</span>
          [(3c s2)
           (list (list 3vs 3c leave?) s2)])])]))
</pre>
</div>
</div>
</div>

<div id="outline-container-orga640cb3" class="outline-4">
<h4 id="orga640cb3"><span class="done test">test</span> </h4>
<div class="outline-text-4" id="text-orga640cb3">
<div class="org-src-container">

<pre class="src src-scheme">(test
 (<span style="color: #f92672; font-weight: bold;">map</span> (<span style="color: #f92672; font-weight: bold;">lambda</span> (x) (pass2/arrow x '()))
   (<span style="color: #f92672; font-weight: bold;">map</span> (<span style="color: #f92672; font-weight: bold;">lambda</span> (x) (pass1/arrow 0 x))
     '((natural natural <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> natural)
       (natural natural <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> (natural natural <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> natural) natural)
       (<span style="color: #a6e22e;">:m</span> zero <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #a6e22e;">:m</span>)
       (<span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> succ <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> recur succ)
       (<span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> succ <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> (<span style="color: #f92672; font-weight: bold;">lambda</span> (natural natural <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> natural)
                              (<span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> succ <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> recur succ)
                              (<span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> succ <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> recur succ)))
       ((<span style="color: #a6e22e;">:t</span> : type) <span style="color: #a6e22e;">:t</span> <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> type)
       ((<span style="color: #a6e22e;">:t</span> @ type) <span style="color: #a6e22e;">:t</span> <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> type)
       ((<span style="color: #a6e22e;">:t^2</span> : type) <span style="color: #a6e22e;">:t</span> <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> type)
       ((<span style="color: #a6e22e;">:t1</span> <span style="color: #a6e22e;">:t2^2</span> <span style="color: #a6e22e;">:t3^0</span> : j k) <span style="color: #a6e22e;">:t</span> <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> type)
       ((<span style="color: #a6e22e;">:t^2</span> @ type) <span style="color: #a6e22e;">:t</span> <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> type))))
 '(((((form3/name natural) (form3/name natural)) ((form3/name natural))) ())
   ((((form3/name natural) (form3/name natural)) ((form3/arrow (((form3/name natural) (form3/name natural)) ((form3/name natural)))) (form3/name natural))) ())
   ((((form3/var (#(<span style="color: #a6e22e;">:m</span> ()) 0)) (form3/name zero)) ((form3/var (#(<span style="color: #a6e22e;">:m</span> ()) 0)))) ((<span style="color: #a6e22e;">:m</span> . #(<span style="color: #a6e22e;">:m</span> ()))))
   ((((form3/var (#(<span style="color: #a6e22e;">:m</span> ()) 0)) (form3/var (#(<span style="color: #a6e22e;">:n</span> ()) 0)) (form3/name succ)) ((form3/var (#(<span style="color: #a6e22e;">:m</span> ()) 0)) (form3/var (#(<span style="color: #a6e22e;">:n</span> ()) 0)) (form3/name recur) (form3/name succ))) ((<span style="color: #a6e22e;">:n</span> . #(<span style="color: #a6e22e;">:n</span> ())) (<span style="color: #a6e22e;">:m</span> . #(<span style="color: #a6e22e;">:m</span> ()))))
   ((((form3/var (#(<span style="color: #a6e22e;">:m</span> ()) 0)) (form3/var (#(<span style="color: #a6e22e;">:n</span> ()) 0)) (form3/name succ)) ((form3/var (#(<span style="color: #a6e22e;">:m</span> ()) 0)) (form3/var (#(<span style="color: #a6e22e;">:n</span> ()) 0)) (form3/lambda (((((form3/name natural) (form3/name natural)) ((form3/name natural))) ((<span style="color: #a6e22e;">:n</span> . #(<span style="color: #a6e22e;">:n</span> ())) (<span style="color: #a6e22e;">:m</span> . #(<span style="color: #a6e22e;">:m</span> ())))) (((((form3/var (#(<span style="color: #a6e22e;">:m</span> ()) 0)) (form3/var (#(<span style="color: #a6e22e;">:n</span> ()) 0)) (form3/name succ)) ((form3/var (#(<span style="color: #a6e22e;">:m</span> ()) 0)) (form3/var (#(<span style="color: #a6e22e;">:n</span> ()) 0)) (form3/name recur) (form3/name succ))) ((<span style="color: #a6e22e;">:n</span> . #(<span style="color: #a6e22e;">:n</span> ())) (<span style="color: #a6e22e;">:m</span> . #(<span style="color: #a6e22e;">:m</span> ())))) ((((form3/var (#(<span style="color: #a6e22e;">:m</span> ()) 0)) (form3/var (#(<span style="color: #a6e22e;">:n</span> ()) 0)) (form3/name succ)) ((form3/var (#(<span style="color: #a6e22e;">:m</span> ()) 0)) (form3/var (#(<span style="color: #a6e22e;">:n</span> ()) 0)) (form3/name recur) (form3/name succ))) ((<span style="color: #a6e22e;">:n</span> . #(<span style="color: #a6e22e;">:n</span> ())) (<span style="color: #a6e22e;">:m</span> . #(<span style="color: #a6e22e;">:m</span> ()))))))))) ((<span style="color: #a6e22e;">:n</span> . #(<span style="color: #a6e22e;">:n</span> ())) (<span style="color: #a6e22e;">:m</span> . #(<span style="color: #a6e22e;">:m</span> ()))))
   ((((form3/bind (((form3/var (#(<span style="color: #a6e22e;">:t</span> ()) 1))) ((form3/name type)) leave)) (form3/var (#(<span style="color: #a6e22e;">:t</span> ()) 0))) ((form3/name type))) ((<span style="color: #a6e22e;">:t</span> . #(<span style="color: #a6e22e;">:t</span> ()))))
   ((((form3/bind (((form3/var (#(<span style="color: #a6e22e;">:t</span> ()) 1))) ((form3/name type)) not-leave)) (form3/var (#(<span style="color: #a6e22e;">:t</span> ()) 0))) ((form3/name type))) ((<span style="color: #a6e22e;">:t</span> . #(<span style="color: #a6e22e;">:t</span> ()))))
   ((((form3/bind (((form3/var (#(<span style="color: #a6e22e;">:t</span> ()) 2))) ((form3/name type)) leave)) (form3/var (#(<span style="color: #a6e22e;">:t</span> ()) 0))) ((form3/name type))) ((<span style="color: #a6e22e;">:t</span> . #(<span style="color: #a6e22e;">:t</span> ()))))
   ((((form3/bind (((form3/var (#(<span style="color: #a6e22e;">:t1</span> ()) 1)) (form3/var (#(<span style="color: #a6e22e;">:t2</span> ()) 2)) (form3/var (#(<span style="color: #a6e22e;">:t3</span> ()) 0))) ((form3/name j) (form3/name k)) leave)) (form3/var (#(<span style="color: #a6e22e;">:t</span> ()) 0))) ((form3/name type))) ((<span style="color: #a6e22e;">:t</span> . #(<span style="color: #a6e22e;">:t</span> ())) (<span style="color: #a6e22e;">:t3</span> . #(<span style="color: #a6e22e;">:t3</span> ())) (<span style="color: #a6e22e;">:t2</span> . #(<span style="color: #a6e22e;">:t2</span> ())) (<span style="color: #a6e22e;">:t1</span> . #(<span style="color: #a6e22e;">:t1</span> ()))))
   ((((form3/bind (((form3/var (#(<span style="color: #a6e22e;">:t</span> ()) 2))) ((form3/name type)) not-leave)) (form3/var (#(<span style="color: #a6e22e;">:t</span> ()) 0))) ((form3/name type))) ((<span style="color: #a6e22e;">:t</span> . #(<span style="color: #a6e22e;">:t</span> ()))))))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgb0c8ef7" class="outline-3">
<h3 id="orgb0c8ef7"><span class="todo _gt__lt_">&gt;&lt;</span> pass3</h3>
</div>
</div>

<div id="outline-container-orgd6bb63d" class="outline-2">
<h2 id="orgd6bb63d">apply</h2>
<div class="outline-text-2" id="text-orgd6bb63d">
</div><div id="outline-container-org3e56eb7" class="outline-3">
<h3 id="org3e56eb7">apply/arrow</h3>
<div class="outline-text-3" id="text-org3e56eb7">
<ul class="org-ul">
<li><p>apply/arrow is the only function that do commit</p></li>

<li><p>it returns report instead of env or #f</p><p>because when calling it</p><p>it is more easy to forget to handle the #f returned</p></li></ul>

<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">apply/arrow</span> a e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">arrow, env -&gt; report</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> e
    [(ds bs ns)
     (<span style="color: #f92672; font-weight: bold;">match</span> a
       [(ac sc)
        (<span style="color: #f92672; font-weight: bold;">match</span> (unify (<span style="color: #f92672; font-weight: bold;">lambda</span> (e) (apply/cedent ac e))
                      (list ds
                            (cons '(commit-point) bs)
                            ns))
          [('fail info-list) ('fail info-list)]
          [('success info-list e1)
           (<span style="color: #f92672; font-weight: bold;">match</span> (apply/cedent sc e1)
             [(ds2 bs2 ns2)
              (list 'success info-list
                    (list ds2 (bs/commit! bs2) ns2))])])])]))

(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">bs/commit!</span> bs)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">bs -&gt; bs</span>
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">effect on part of bs</span>
  (<span style="color: #f92672; font-weight: bold;">cond</span> [(equal? '(commit-point) (car bs))
         (cdr bs)]
        [else
         (<span style="color: #f92672; font-weight: bold;">let*</span> ([pair (car bs)]
                [id (car pair)]
                [ls (cdr pair)])
           (id/commit! id ls)
           (bs/commit! (cdr bs)))]))

(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">id/commit!</span> id ls)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">id, ls -&gt; id</span>
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">effect on id</span>
  (<span style="color: #f92672; font-weight: bold;">let</span> ()
    (<span style="color: #f92672; font-weight: bold;">vector-set!</span> id (append ls (vector-ref id 1)))
    id))
</pre>
</div>
</div>
</div>

<div id="outline-container-orge43c321" class="outline-3">
<h3 id="orge43c321">apply/cedent</h3>
<div class="outline-text-3" id="text-orge43c321">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">apply/cedent</span> c e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">cedent, env -&gt; env</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> c
    ['() e]
    [(h . r) (apply/cedent r (apply/dispatch h e))]))
</pre>
</div>
</div>
</div>

<div id="outline-container-org288503b" class="outline-3">
<h3 id="org288503b">apply/dispatch</h3>
<div class="outline-text-3" id="text-org288503b">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">apply/dispatch</span> f e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">form, env -&gt; env</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> f
    [('var v) (apply/var v e)]
    [('name n) (apply/name n e)]
    [('arrow a) (apply/literal-arrow a e)]
    [('bind b) (apply/bind b e)]))
</pre>
</div>
</div>
</div>

<div id="outline-container-org47c7d75" class="outline-3">
<h3 id="org47c7d75">apply/literal-arrow</h3>
</div>

<div id="outline-container-org1999fd7" class="outline-3">
<h3 id="org1999fd7">apply/var</h3>
</div>

<div id="outline-container-org8950dc1" class="outline-3">
<h3 id="org8950dc1">apply/name</h3>
</div>

<div id="outline-container-orgec51715" class="outline-3">
<h3 id="orgec51715">id-&gt;ls</h3>
<div class="outline-text-3" id="text-orgec51715">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">id-&gt;ls</span> id)
  (vector-ref id 1))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org2e5cc35" class="outline-2">
<h2 id="org2e5cc35">unify</h2>
<div class="outline-text-2" id="text-org2e5cc35">
</div><div id="outline-container-org901aee3" class="outline-3">
<h3 id="org901aee3"><span class="todo _gt__lt_">&gt;&lt;</span> unify</h3>
<div class="outline-text-3" id="text-org901aee3">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">unify</span> e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">(env -&gt; env), env -&gt; unify-report</span>
  )
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org1950186" class="outline-2">
<h2 id="org1950186"><span class="todo _gt__lt_">&gt;&lt;</span> eva</h2>
</div>

<div id="outline-container-org2e1dae8" class="outline-2">
<h2 id="org2e1dae8"><span class="todo _gt__lt_">&gt;&lt;</span> check</h2>
</div>

<div id="outline-container-org9dec86f" class="outline-2">
<h2 id="org9dec86f"><span class="todo _gt__lt_">&gt;&lt;</span> type-apply</h2>
</div>

<div id="outline-container-orgac897b6" class="outline-2">
<h2 id="orgac897b6"><span class="todo _gt__lt_">&gt;&lt;</span> sequent</h2>
</div>

<div id="outline-container-org1f70d1f" class="outline-2">
<h2 id="org1f70d1f"><span class="done test">test</span> </h2>
<div class="outline-text-2" id="text-org1f70d1f">
</div><div id="outline-container-org80e9a36" class="outline-3">
<h3 id="org80e9a36">natural</h3>
<div class="outline-text-3" id="text-org80e9a36">
<div class="org-src-container">

<pre class="src src-scheme">(sequent

  (dt type (<span style="color: #66d9ef; font-weight: bold;">-&gt;</span> type))

  (dt natural (<span style="color: #66d9ef; font-weight: bold;">-&gt;</span> type)
      zero (<span style="color: #66d9ef; font-weight: bold;">-&gt;</span> natural)
      succ (natural <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> natural))

  (df add (natural natural <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> natural)
      (<span style="color: #a6e22e;">:m</span> zero <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #a6e22e;">:m</span>)
      (<span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> succ <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> add succ))

  (df mul (natural natural <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> natural)
      (<span style="color: #a6e22e;">:m</span> zero <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> zero)
      (<span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> succ <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> mul <span style="color: #a6e22e;">:m</span> add))

  (ap (<span style="color: #66d9ef; font-weight: bold;">-&gt;</span>
       zero succ
       zero succ succ
       add))

  (ap (<span style="color: #66d9ef; font-weight: bold;">-&gt;</span>
       zero succ succ
       zero succ succ
       mul))

  (ap (<span style="color: #66d9ef; font-weight: bold;">-&gt;</span> mul)))
</pre>
</div>
</div>
</div>

<div id="outline-container-org50eda05" class="outline-3">
<h3 id="org50eda05">list</h3>
<div class="outline-text-3" id="text-org50eda05">
<div class="org-src-container">

<pre class="src src-scheme">(sequent

  (dt type (<span style="color: #66d9ef; font-weight: bold;">-&gt;</span> type))

  (dt natural (<span style="color: #66d9ef; font-weight: bold;">-&gt;</span> type)
      zero (<span style="color: #66d9ef; font-weight: bold;">-&gt;</span> natural)
      succ (natural <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> natural))

  (df add (natural natural <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> natural)
      (<span style="color: #a6e22e;">:m</span> zero <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #a6e22e;">:m</span>)
      (<span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> succ <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> add succ))

  (df mul (natural natural <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> natural)
      (<span style="color: #a6e22e;">:m</span> zero <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> zero)
      (<span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> succ <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> mul <span style="color: #a6e22e;">:m</span> add))

  (dt list ((<span style="color: #a6e22e;">:t</span> : type) <span style="color: #a6e22e;">:t</span> <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> type)
      null (<span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #a6e22e;">:t</span> list)
      cons (<span style="color: #a6e22e;">:t</span> list <span style="color: #a6e22e;">:t</span> <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #a6e22e;">:t</span> list))

  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">(df map (:t1 list (:t1 -&gt; :t2) -&gt; :t2 list)</span>
  <span style="color: #FF8888;">;;     </span><span style="color: #FF8888;">(null :f -&gt; null)</span>
  <span style="color: #FF8888;">;;     </span><span style="color: #FF8888;">(:l :e cons :f -&gt; :e :f apply :l :f map cons))</span>

  (df append (<span style="color: #a6e22e;">:t</span> list <span style="color: #a6e22e;">:t</span> list <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #a6e22e;">:t1</span> list)
      (<span style="color: #a6e22e;">:l</span> null <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #a6e22e;">:l</span>)
      (<span style="color: #a6e22e;">:l</span> <span style="color: #a6e22e;">:r</span> <span style="color: #a6e22e;">:e</span> cons <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #a6e22e;">:l</span> <span style="color: #a6e22e;">:r</span> append <span style="color: #a6e22e;">:e</span> cons))

  (ap (<span style="color: #66d9ef; font-weight: bold;">-&gt;</span>
       null
       zero cons
       zero cons
       zero cons
       null
       zero cons
       zero cons
       zero cons
       append)))
</pre>
</div>
</div>
</div>

<div id="outline-container-org4b804d" class="outline-3">
<h3 id="org4b804d">vector</h3>
<div class="outline-text-3" id="text-org4b804d">
<div class="org-src-container">

<pre class="src src-scheme">(sequent

  (dt type (<span style="color: #66d9ef; font-weight: bold;">-&gt;</span> type))

  (dt natural (<span style="color: #66d9ef; font-weight: bold;">-&gt;</span> type)
      zero (<span style="color: #66d9ef; font-weight: bold;">-&gt;</span> natural)
      succ (natural <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> natural))

  (df add (natural natural <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> natural)
      (<span style="color: #a6e22e;">:m</span> zero <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #a6e22e;">:m</span>)
      (<span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> succ <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> add succ))

  (df mul (natural natural <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> natural)
      (<span style="color: #a6e22e;">:m</span> zero <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> zero)
      (<span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> succ <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> mul <span style="color: #a6e22e;">:m</span> add))

  (dt vector ((<span style="color: #a6e22e;">:t</span> : type) natural <span style="color: #a6e22e;">:t</span> <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> type)
      null (<span style="color: #66d9ef; font-weight: bold;">-&gt;</span> zero <span style="color: #a6e22e;">:t</span> vector)
      cons (<span style="color: #a6e22e;">:n</span> <span style="color: #a6e22e;">:t</span> vector <span style="color: #a6e22e;">:t</span> <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #a6e22e;">:n</span> succ <span style="color: #a6e22e;">:t</span> vector))

  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">(df map (:n :t1 vector (:t1 -&gt; :t2) -&gt; :n :t2 vector)</span>
  <span style="color: #FF8888;">;;     </span><span style="color: #FF8888;">(null :f -&gt; null)</span>
  <span style="color: #FF8888;">;;     </span><span style="color: #FF8888;">(:l :e cons :f -&gt; :e :f apply :l :f map cons))</span>

  (df append (<span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:t</span> vector <span style="color: #a6e22e;">:n</span> <span style="color: #a6e22e;">:t</span> vector <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> add <span style="color: #a6e22e;">:t</span> vector)
      (<span style="color: #a6e22e;">:l</span> null <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #a6e22e;">:l</span>)
      (<span style="color: #a6e22e;">:l</span> <span style="color: #a6e22e;">:r</span> <span style="color: #a6e22e;">:e</span> cons <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #a6e22e;">:l</span> <span style="color: #a6e22e;">:r</span> append <span style="color: #a6e22e;">:e</span> cons))

  (ap (<span style="color: #66d9ef; font-weight: bold;">-&gt;</span>
       null
       zero cons
       zero cons
       zero cons
       null
       zero cons
       zero cons
       zero cons
       append)))
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
喪以不執 所執者喪 執喪相比 方死方生
</div>
</body>
</html>
