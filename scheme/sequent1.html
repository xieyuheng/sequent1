<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2016-04-27 Wed 04:38 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>sequent1</title>
<meta name="generator" content="Org-mode" />
<meta name="author" content="XIE Yuheng" />
<link rel="stylesheet" href="../asset/css/page.css" type="text/css" media="screen" />
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="preamble" class="status">
喪以不執 所執者喪 執喪相比 方死方生
</div>
<div id="content">
<h1 class="title">sequent1</h1>
<div id="table-of-contents">
<h2>overview</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgdc94c87"><span class="done todo">todo</span> </a></li>
<li><a href="#orgb451adc">helper</a>
<ul>
<li><a href="#orgce24b3b">pattern match</a></li>
<li><a href="#org739587c">cat &amp; orz</a></li>
<li><a href="#orged69d34"><span class="done test">test</span> ing</a></li>
<li><a href="#org4c7064c">list</a></li>
<li><a href="#org75edf28">string</a></li>
</ul>
</li>
<li><a href="#org5be0c0b"><span class="todo note">note</span> </a>
<ul>
<li><a href="#org3c1b0c5">as prototype</a></li>
<li><a href="#orgcaa34ab">sequent</a></li>
<li><a href="#orgd23d8d7">form</a>
<ul>
<li><a href="#org55805c1">form1</a></li>
<li><a href="#org56e9d26">form2</a></li>
<li><a href="#org8277413">form3</a></li>
</ul>
</li>
<li><a href="#org69b67f6">data</a></li>
<li><a href="#org2cba79c">arity</a></li>
<li><a href="#orgef230c1">env</a></li>
<li><a href="#orge7706f0">meaning</a></li>
<li><a href="#orgc987ba6">top</a>
<ul>
<li><a href="#org5bcf761">top1</a></li>
<li><a href="#org5bb3838">top2</a></li>
</ul>
</li>
<li><a href="#org355d5e2">report</a></li>
</ul>
</li>
<li><a href="#orgda67b8">pass</a>
<ul>
<li><a href="#org396089e">pass1</a>
<ul>
<li><a href="#orgd527df1">pass1/arrow</a></li>
<li><a href="#org7586877">pass1/cedent</a></li>
<li><a href="#org86563b2">predicates</a></li>
<li><a href="#org8f5f95e">pass1</a></li>
<li><a href="#org4330ec0">pass1/var</a></li>
<li><a href="#org5f77a96"><span class="done test">test</span> </a></li>
</ul>
</li>
<li><a href="#org3e03a5b">pass2</a>
<ul>
<li><a href="#org97af7a6">pass2/arrow</a></li>
<li><a href="#org8f03adc">pass2/cedent</a></li>
<li><a href="#orgc240744">pass2/lambda</a></li>
<li><a href="#org99df108">pass2</a></li>
<li><a href="#org1a32a57">pass2/var</a></li>
<li><a href="#orgf12f53e">pass2/bind</a></li>
<li><a href="#org3ece197"><span class="done test">test</span> </a></li>
</ul>
</li>
<li><a href="#org41a7981">pass3</a>
<ul>
<li><a href="#org825c205">pass3/get-arrow</a></li>
<li><a href="#org8b14f24">pass3/arrow</a></li>
<li><a href="#orga37d2b">pass3/cedent</a></li>
<li><a href="#org6ec97f5">pass3/lambda</a></li>
<li><a href="#orgd4ab0ab">pass3</a></li>
<li><a href="#org968117f">pass3/var</a></li>
<li><a href="#orge201eca">id-&gt;ls</a></li>
<li><a href="#org1a88111"><span class="todo _gt__lt__gt__lt__gt__lt_">&gt;&lt;&gt;&lt;&gt;&lt;</span> bs/[find|walk|deep]</a></li>
<li><a href="#orgc07a49c">pass3/name</a></li>
<li><a href="#org3c7c34e">pass3/name/cons</a></li>
<li><a href="#org824f7d6">pass3/name/trunk</a></li>
<li><a href="#org15ec04c">pass3/name/proj</a></li>
<li><a href="#orgebf779c">pass3/bind</a></li>
<li><a href="#org7eedb3c">id/commit!</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org4a9b41"><span class="todo _gt__lt_">&gt;&lt;</span> copy-arrow</a>
<ul>
<li><a href="#org2a8d96a"><span class="todo note">note</span> copy</a></li>
<li><a href="#org7064dab">copy-arrow</a></li>
<li><a href="#org83d9df3">copy/var</a></li>
<li><a href="#org697da31">copy/cons</a></li>
<li><a href="#org92ac72">copy/arrow</a></li>
<li><a href="#org6cbaf79">copy/lambda</a></li>
<li><a href="#org1d1a3e8">copy/trunk</a></li>
<li><a href="#org778fd85">copy/proj</a></li>
</ul>
</li>
<li><a href="#orgb772565"><span class="todo _gt__lt_">&gt;&lt;</span> apply</a>
<ul>
<li><a href="#org75ef345">apply/arrow</a></li>
<li><a href="#org515270d">apply/cedent</a></li>
<li><a href="#org1a39e1f">apply/dispatch</a></li>
<li><a href="#org1ae7df5">apply/literal-arrow</a></li>
<li><a href="#orgbc8db69">apply/var</a></li>
<li><a href="#org5691a3d">apply/name</a></li>
<li><a href="#org3beb85e"><span class="todo _gt__lt_">&gt;&lt;</span> bs/commit!</a></li>
<li><a href="#org2fb5ac4"><span class="todo _gt__lt_">&gt;&lt;</span> bs/extend</a></li>
</ul>
</li>
<li><a href="#orgf2413fe"><span class="todo _gt__lt_">&gt;&lt;</span> unify</a>
<ul>
<li><a href="#org83eb04c"><span class="todo _gt__lt_">&gt;&lt;</span> unify</a></li>
</ul>
</li>
<li><a href="#orgd3fc0b7"><span class="todo _gt__lt_">&gt;&lt;</span> eva</a></li>
<li><a href="#org9b0c1a8"><span class="todo _gt__lt_">&gt;&lt;</span> check</a></li>
<li><a href="#org333dbdb"><span class="todo _gt__lt_">&gt;&lt;</span> type-apply</a></li>
<li><a href="#org2cd2fec"><span class="todo _gt__lt_">&gt;&lt;</span> sequent</a></li>
<li><a href="#orgdd1c309"><span class="done test">test</span> </a>
<ul>
<li><a href="#org56caaa6">natural</a></li>
<li><a href="#orgd5c4020">list</a></li>
<li><a href="#orgcd5062e">vector</a></li>
</ul>
</li>
</ul>
</div>
</div>
<ul class="org-ul">
<li><p>a prototype interpreter for a functional language</p><p>which uses sequent calculus as dependent type system</p></li>

<li><p>XIE Yuheng created</p></li></ul>

<div id="outline-container-orgdc94c87" class="outline-2">
<h2 id="orgdc94c87"><span class="done todo">todo</span> </h2>
<div class="outline-text-2" id="text-orgdc94c87">
<ul class="org-ul">
<li><p>data/print</p><p>different var should be print differently</p></li>

<li><p>check-type</p><p>infer-arity</p><p>check-cover</p><p>check-end</p></li></ul>
</div>
</div>

<div id="outline-container-orgb451adc" class="outline-2">
<h2 id="orgb451adc">helper</h2>
<div class="outline-text-2" id="text-orgb451adc">
</div><div id="outline-container-orgce24b3b" class="outline-3">
<h3 id="orgce24b3b">pattern match</h3>
<div class="outline-text-3" id="text-orgce24b3b">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #FF8888;">;; </span><span style="color: #FF8888;">module system of guile</span>
<span style="color: #FF8888;">;; </span><span style="color: #FF8888;">using http://synthcode.com/scheme/match.scm</span>
(use-modules (ice-9 match))
</pre>
</div>
</div>
</div>

<div id="outline-container-org739587c" class="outline-3">
<h3 id="org739587c">cat &amp; orz</h3>
<div class="outline-text-3" id="text-org739587c">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #FF8888;">;; </span><span style="color: #FF8888;">guile</span>
(<span style="color: #f92672; font-weight: bold;">define-syntax</span> <span style="color: #fd971f;">cat</span>
  (<span style="color: #f92672; font-weight: bold;">syntax-rules</span> ()
    [(cat (str . args))
     (format #t str . args)]
    [(cat (str . args) (str2 . args2) ...)
     (string-append
      (cat (str . args))
      (cat (str2 . args2) ...))]))

<span style="color: #FF8888;">;; </span><span style="color: #FF8888;">(define-syntax cat</span>
<span style="color: #FF8888;">;;   </span><span style="color: #FF8888;">(syntax-rules ()</span>
<span style="color: #FF8888;">;;     </span><span style="color: #FF8888;">[(cat (str . args))</span>
<span style="color: #FF8888;">;;      </span><span style="color: #FF8888;">(format str . args)]</span>
<span style="color: #FF8888;">;;     </span><span style="color: #FF8888;">[(cat (str . args) (str2 . args2) ...)</span>
<span style="color: #FF8888;">;;      </span><span style="color: #FF8888;">(string-append</span>
<span style="color: #FF8888;">;;       </span><span style="color: #FF8888;">(cat (str . args))</span>
<span style="color: #FF8888;">;;       </span><span style="color: #FF8888;">(cat (str2 . args2) ...))]))</span>

(<span style="color: #f92672; font-weight: bold;">define-syntax</span> <span style="color: #fd971f;">orz</span>
  (<span style="color: #f92672; font-weight: bold;">syntax-rules</span> ()
    [(<span style="color: #f92672; font-weight: bold;">orz</span> . body)
     (<span style="color: #f92672; font-weight: bold;">error</span> (cat . body))]))

(<span style="color: #f92672; font-weight: bold;">define-syntax</span> <span style="color: #fd971f;">note</span>
  (<span style="color: #f92672; font-weight: bold;">syntax-rules</span> ()
    [(<span style="color: #f92672; font-weight: bold;">note</span> . body)
     '()]))
</pre>
</div>
</div>
</div>

<div id="outline-container-orged69d34" class="outline-3">
<h3 id="orged69d34"><span class="done test">test</span> ing</h3>
<div class="outline-text-3" id="text-orged69d34">
<div class="org-src-container">

<pre class="src src-scheme">(use-modules (ice-9 pretty-print))

(<span style="color: #f92672; font-weight: bold;">define-syntax</span> <span style="color: #fd971f;">test</span>
  (<span style="color: #f92672; font-weight: bold;">syntax-rules</span> ()
    [(test b1 b2)
     (<span style="color: #f92672; font-weight: bold;">if</span> (equal? b1 b2)
       #t
       (<span style="color: #f92672; font-weight: bold;">let</span> ()
         (cat (<span style="color: #e6db74;">"\n"</span>))
         (cat (<span style="color: #e6db74;">"&lt;test-fail-report-begin&gt;\n"</span>))
         (cat (<span style="color: #e6db74;">"&lt;actual-form&gt; :\n"</span>))
         (pretty-print (<span style="color: #f92672; font-weight: bold;">quote</span> b1))
         (cat (<span style="color: #e6db74;">"&lt;actual-value&gt; :\n"</span>))
         (pretty-print b1)
         (cat (<span style="color: #e6db74;">"&lt;expect-form&gt; :\n"</span>))
         (pretty-print (<span style="color: #f92672; font-weight: bold;">quote</span> b2))
         (cat (<span style="color: #e6db74;">"&lt;expect-value&gt; :\n"</span>))
         (pretty-print b2)
         (<span style="color: #f92672; font-weight: bold;">orz</span> (<span style="color: #e6db74;">"&lt;test-fail-report-end&gt;\n"</span>))))]))
</pre>
</div>
</div>
</div>

<div id="outline-container-org4c7064c" class="outline-3">
<h3 id="org4c7064c">list</h3>
<div class="outline-text-3" id="text-org4c7064c">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">left-of</span> s l)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">sexp, list -&gt; list</span>
  (<span style="color: #f92672; font-weight: bold;">cond</span> [(equal? s (car l)) '()]
        [else (cons (car l) (left-of s (cdr l)))]))

(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">right-of</span> s l)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">sexp, list -&gt; list</span>
  (<span style="color: #f92672; font-weight: bold;">cond</span> [(equal? s (car l)) (cdr l)]
        [else (right-of s (cdr l))]))

(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">sublist</span> l start end)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">list, index, index -&gt; list</span>
  (<span style="color: #f92672; font-weight: bold;">cond</span> [(<span style="color: #f92672; font-weight: bold;">and</span> (eq? 0 start) (&lt;= end 0)) '()]
        [(<span style="color: #f92672; font-weight: bold;">and</span> (not (eq? 0 start)))
         (sublist (cdr l) (- start 1) (- end 1))]
        [(<span style="color: #f92672; font-weight: bold;">and</span> (eq? 0 start) (not (eq? 0 end)))
         (cons (car l) (sublist (cdr l) 0 (- end 1)))]))

(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">genlist</span> len)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">length -&gt; list</span>
  (<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">recur</span> len counter)
    (<span style="color: #f92672; font-weight: bold;">cond</span> [(eq? len counter) '()]
          [else (cons counter
                      (recur len (+ 1 counter)))]))
  (recur len 0))
</pre>
</div>
</div>
</div>

<div id="outline-container-org75edf28" class="outline-3">
<h3 id="org75edf28">string</h3>
<div class="outline-text-3" id="text-org75edf28">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">find-char</span> c s)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">char, string -&gt; curser or #f</span>
  (find-char/curser c s 0))

(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">find-char/curser</span> c s curser)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">char, string, curser -&gt; curser or #f</span>
  (<span style="color: #f92672; font-weight: bold;">if</span> (&gt;= curser (string-length s))
    #f
    (<span style="color: #f92672; font-weight: bold;">let</span> ([c0 (substring s curser (+ 1 curser))])
      (<span style="color: #f92672; font-weight: bold;">if</span> (equal? c c0)
        curser
        (find-char/curser c s (+ 1 curser))))))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org5be0c0b" class="outline-2">
<h2 id="org5be0c0b"><span class="todo note">note</span> </h2>
<div class="outline-text-2" id="text-org5be0c0b">
</div><div id="outline-container-org3c1b0c5" class="outline-3">
<h3 id="org3c1b0c5">as prototype</h3>
<div class="outline-text-3" id="text-org3c1b0c5">
<ul class="org-ul">
<li><p>lazy-eval</p><p>call-by-name</p></li></ul>
</div>
</div>

<div id="outline-container-orgcaa34ab" class="outline-3">
<h3 id="orgcaa34ab">sequent</h3>
<div class="outline-text-3" id="text-orgcaa34ab">
<ul class="org-ul">
<li><p>sequent is arrow</p><p>which is the core data type of the language</p></li></ul>
</div>
</div>

<div id="outline-container-orgd23d8d7" class="outline-3">
<h3 id="orgd23d8d7">form</h3>
<div class="outline-text-3" id="text-orgd23d8d7">
</div><div id="outline-container-org55805c1" class="outline-4">
<h4 id="org55805c1">form1</h4>
<div class="outline-text-4" id="text-org55805c1">
<ul class="org-ul">
<li><p>form1 =</p><p><ul class="org-ul"></p><p><li><p>form1/var =</p><p>:var</p><p>:var<sup>n</sup></p></li></p><p><li><p>form1/name =</p><p>name</p></li></p><p><li><p>form1/arrow =</p><p>(form1 &#x2026; -&gt; form1 &#x2026;)</p></li></p><p><li><p>form1/lambda =</p><p>(lambda form1/arrow</p><p>  form1/arrow</p><p>  &#x2026;)</p></li></p><p><li><p>form1/im-bind =</p><p>(form1/var &#x2026; : form1 &#x2026;)</p></li></p><p><li><p>form1/ex-bind =</p><p>(form1/var &#x2026; @ form1 &#x2026;)</p></li></ul></p></li></ul>
</div>
</div>

<div id="outline-container-org56e9d26" class="outline-4">
<h4 id="org56e9d26">form2</h4>
<div class="outline-text-4" id="text-org56e9d26">
<ul class="org-ul">
<li><p>form1 -pass1-&gt; form2</p><p>level of var is handled here</p></li>

<li><p>form2 =</p><p>('form2/var    (symbol level))</p><p>('form2/name   symbol)</p><p>('form2/arrow  ((form2 &#x2026;) (form2 &#x2026;)))</p><p>('form2/lambda (form2/arrow (form2/arrow &#x2026;)))</p><p>('form2/bind   ((form2/var &#x2026;) (form2 &#x2026;) leave?))</p></li>
<li><p>level = natural-number</p></li>
<li><p>leave? = 'leave | 'not-leave</p></li></ul>
</div>
</div>

<div id="outline-container-org8277413" class="outline-4">
<h4 id="org8277413">form3</h4>
<div class="outline-text-4" id="text-org8277413">
<ul class="org-ul">
<li><p>form2 -pass2-&gt; form3</p><p>id of var is handled here</p></li>

<li><p>form3 =</p><p>('form3/var    (id level))</p><p>('form3/name   symbol)</p><p>('form3/arrow  ((form3 &#x2026;) (form3 &#x2026;)))</p><p>('form3/lambda (form3/arrow (form3/arrow &#x2026;)))</p><p>('form3/bind   ((form3/var &#x2026;) (form3 &#x2026;) leave?))</p></li>
<li><p>id = #(symbol ls)</p></li></ul>
</div>
</div>
</div>

<div id="outline-container-org69b67f6" class="outline-3">
<h3 id="org69b67f6">data</h3>
<div class="outline-text-3" id="text-org69b67f6">
<ul class="org-ul">
<li><p>form3 -pass3-&gt; data</p><p>cons trunk proj are created here</p><p>arity is calculated here</p></li>
<li><p>pass3 will use env passing</p><p>note that</p><p>when env passing is used</p><p>those functions would not be separately testable</p></li>
<li><p>no unification here</p><p>bs is not used here</p><p>bind just effect on the id of var</p></li>
<li><p>ns is searched</p><p>but no effect on ns</p></li>
<li><p>how should I express such in type ?</p></li>

<li><p>data =</p><p>('var    (id level))</p><p>('cons   (name (data &#x2026;)))</p><p>('arrow  ((data &#x2026;) (data &#x2026;)))</p><p>('lambda (arrow (arrow &#x2026;)))</p><p>('trunk  (arrow (arrow &#x2026;) (data &#x2026;)))</p><p>('proj   (arrow (arrow &#x2026;) (data &#x2026;) index))</p></li></ul>
</div>
</div>

<div id="outline-container-org2cba79c" class="outline-3">
<h3 id="org2cba79c">arity</h3>
<div class="outline-text-3" id="text-org2cba79c">
<ul class="org-ul">
<li><p>there can be</p><p>arity = (number number)</p><p>in lambda &amp; trunk</p><p>but do not use separate arity for simplicity</p><p>arity is calculated from arrow repeatly</p></li></ul>
</div>
</div>

<div id="outline-container-orgef230c1" class="outline-3">
<h3 id="orgef230c1">env</h3>
<div class="outline-text-3" id="text-orgef230c1">
<ul class="org-ul">
<li><p>env = (ds bs ns)</p></li>
<li><p>ds = (data &#x2026;)</p></li>
<li><p>bs = ((id . ls) &#x2026;)</p><p><ul class="org-ul"></p><p><li><p>ls = ((level . data) &#x2026;)</p></li></ul></p></li>
<li><p>ns = ((name . meaning) &#x2026;)</p></li></ul>
</div>
</div>

<div id="outline-container-orge7706f0" class="outline-3">
<h3 id="orge7706f0">meaning</h3>
<div class="outline-text-3" id="text-orge7706f0">
<ul class="org-ul">
<li><p>meaning =</p><p>('cons/type (arrow name (name &#x2026;)))</p><p>('cons/data (arrow name name))</p><p>('lambda    (arrow (arrow &#x2026;)))</p></li></ul>
</div>
</div>

<div id="outline-container-orgc987ba6" class="outline-3">
<h3 id="orgc987ba6">top</h3>
<div class="outline-text-3" id="text-orgc987ba6">
</div><div id="outline-container-org5bcf761" class="outline-4">
<h4 id="org5bcf761">top1</h4>
<div class="outline-text-4" id="text-org5bcf761">
<ul class="org-ul">
<li><p>top1 =</p><p>('dt ((form1/name form1/arrow) ((form1/name form1/arrow) &#x2026;)))</p><p>('df ((form1/name form1/arrow) (form1/arrow &#x2026;)))</p><p>('ap form1/arrow)</p></li></ul>
</div>
</div>

<div id="outline-container-org5bb3838" class="outline-4">
<h4 id="org5bb3838">top2</h4>
<div class="outline-text-4" id="text-org5bb3838">
<ul class="org-ul">
<li><p>top2 =</p><p>('top2/dt ((form2/name form2/arrow) ((form2/name form2/arrow) &#x2026;)))</p><p>('top2/df ((form2/name form2/arrow) (form2/arrow &#x2026;)))</p><p>('top2/ap form2/arrow)</p></li></ul>
</div>
</div>
</div>

<div id="outline-container-org355d5e2" class="outline-3">
<h3 id="org355d5e2">report</h3>
<div class="outline-text-3" id="text-org355d5e2">
<ul class="org-ul">
<li><p>report =</p><p>('fail (info &#x2026;))</p><p>('success (info &#x2026;) env)</p></li>
<li><p>info = &lt;free&gt;</p></li></ul>
</div>
</div>
</div>

<div id="outline-container-orgda67b8" class="outline-2">
<h2 id="orgda67b8">pass</h2>
<div class="outline-text-2" id="text-orgda67b8">
</div><div id="outline-container-org396089e" class="outline-3">
<h3 id="org396089e">pass1</h3>
<div class="outline-text-3" id="text-org396089e">
</div><div id="outline-container-orgd527df1" class="outline-4">
<h4 id="orgd527df1">pass1/arrow</h4>
<div class="outline-text-4" id="text-orgd527df1">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">pass1/arrow</span> default-level s)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">default-level, form1/arrow -&gt; form2/arrow</span>
  (list (pass1/cedent default-level (left-of '<span style="color: #66d9ef; font-weight: bold;">-&gt;</span> s))
        (pass1/cedent default-level (right-of '<span style="color: #66d9ef; font-weight: bold;">-&gt;</span> s))))
</pre>
</div>
</div>
</div>

<div id="outline-container-org7586877" class="outline-4">
<h4 id="org7586877">pass1/cedent</h4>
<div class="outline-text-4" id="text-org7586877">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">pass1/cedent</span> default-level s)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">default-level, (form1 ...) -&gt; (form2 ...)</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> s
    ['() '()]
    [(h . r) (cons (pass1 default-level h)
                   (pass1/cedent default-level r))]))
</pre>
</div>
</div>
</div>

<div id="outline-container-org86563b2" class="outline-4">
<h4 id="org86563b2">predicates</h4>
<div class="outline-text-4" id="text-org86563b2">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">form1/var?</span> v)
  (<span style="color: #f92672; font-weight: bold;">and</span> (symbol? v)
       (equal? <span style="color: #e6db74;">":"</span> (substring (symbol-&gt;string v) 0 1))))

(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">form1/name?</span> v)
  (<span style="color: #f92672; font-weight: bold;">and</span> (symbol? v)
       (not (eq? <span style="color: #e6db74;">":"</span> (substring (symbol-&gt;string v) 0 1)))))

(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">form1/arrow?</span> v)
  (<span style="color: #f92672; font-weight: bold;">and</span> (list? v)
       (member '<span style="color: #66d9ef; font-weight: bold;">-&gt;</span> v)))

(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">form1/lambda?</span> v)
  (<span style="color: #f92672; font-weight: bold;">and</span> (list? v)
       (eq? (car v) 'lambda)))

(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">form1/im-bind?</span> v)
  (<span style="color: #f92672; font-weight: bold;">and</span> (list? v)
       (member ': v)))

(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">form1/ex-bind?</span> v)
  (<span style="color: #f92672; font-weight: bold;">and</span> (list? v)
       (member '@ v)))
</pre>
</div>
</div>
</div>

<div id="outline-container-org8f5f95e" class="outline-4">
<h4 id="org8f5f95e">pass1</h4>
<div class="outline-text-4" id="text-org8f5f95e">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">pass1</span> default-level v)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">default-level, form1 -&gt; form2</span>
  (<span style="color: #f92672; font-weight: bold;">cond</span> [(form1/var? v)
         (list 'form2/var
               (pass1/var default-level v))]
        [(form1/name? v)
         (list 'form2/name
               v)]
        [(form1/arrow? v)
         (list 'form2/arrow
               (pass1/arrow default-level v))]
        [(form1/lambda? v)
         (list 'form2/lambda
               (list (pass1/arrow default-level (cadr v))
                     (<span style="color: #f92672; font-weight: bold;">map</span> (<span style="color: #f92672; font-weight: bold;">lambda</span> (x) (pass1/arrow default-level x))
                       (cddr v))))]
        [(form1/im-bind? v)
         (list 'form2/bind
               (list (pass1/cedent 1 (left-of ': v))
                     (pass1/cedent 0 (right-of ': v))
                     'leave))]
        [(form1/ex-bind? v)
         (list 'form2/bind
               (list (pass1/cedent 1 (left-of '@ v))
                     (pass1/cedent 0 (right-of '@ v))
                     'not-leave))]
        [else
         (<span style="color: #f92672; font-weight: bold;">orz</span> (<span style="color: #e6db74;">"pass1 can not handle sexp-form:~a"</span> v))]))
</pre>
</div>
</div>
</div>

<div id="outline-container-org4330ec0" class="outline-4">
<h4 id="org4330ec0">pass1/var</h4>
<div class="outline-text-4" id="text-org4330ec0">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">pass1/var</span> default-level v)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">default-level, symbol -&gt; form2/var</span>
  (<span style="color: #f92672; font-weight: bold;">let*</span> ([str (symbol-&gt;string v)]
         [cursor (find-char <span style="color: #e6db74;">"^"</span> str)])
    (<span style="color: #f92672; font-weight: bold;">if</span> cursor
      (list (string-&gt;symbol (substring str 0 cursor))
            (string-&gt;number (substring str (+ 1 cursor))))
      (list v default-level))))
</pre>
</div>
</div>
</div>

<div id="outline-container-org5f77a96" class="outline-4">
<h4 id="org5f77a96"><span class="done test">test</span> </h4>
<div class="outline-text-4" id="text-org5f77a96">
<div class="org-src-container">

<pre class="src src-scheme">(test
 (<span style="color: #f92672; font-weight: bold;">map</span> (<span style="color: #f92672; font-weight: bold;">lambda</span> (x) (pass1/arrow 0 x))
   '((natural natural <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> natural)
     (natural natural <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> (natural natural <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> natural) natural)
     (<span style="color: #a6e22e;">:m</span> zero <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #a6e22e;">:m</span>)
     (<span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> succ <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> recur succ)
     (<span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> succ <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> (<span style="color: #f92672; font-weight: bold;">lambda</span> (natural natural <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> natural)
                            (<span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> succ <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> recur succ)
                            (<span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> succ <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> recur succ)))
     ((<span style="color: #a6e22e;">:t</span> : type) <span style="color: #a6e22e;">:t</span> <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> type)
     ((<span style="color: #a6e22e;">:t</span> @ type) <span style="color: #a6e22e;">:t</span> <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> type)
     ((<span style="color: #a6e22e;">:t^2</span> : type) <span style="color: #a6e22e;">:t</span> <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> type)
     ((<span style="color: #a6e22e;">:t1</span> <span style="color: #a6e22e;">:t2^2</span> <span style="color: #a6e22e;">:t3^0</span> : j k) <span style="color: #a6e22e;">:t</span> <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> type)
     ((<span style="color: #a6e22e;">:t^2</span> @ type) <span style="color: #a6e22e;">:t</span> <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> type)))
 '((((form2/name natural) (form2/name natural))
    ((form2/name natural)))
   (((form2/name natural) (form2/name natural))
    ((form2/arrow (((form2/name natural) (form2/name natural)) ((form2/name natural)))) (form2/name natural)))
   (((form2/var (<span style="color: #a6e22e;">:m</span> 0)) (form2/name zero))
    ((form2/var (<span style="color: #a6e22e;">:m</span> 0))))
   (((form2/var (<span style="color: #a6e22e;">:m</span> 0)) (form2/var (<span style="color: #a6e22e;">:n</span> 0)) (form2/name succ))
    ((form2/var (<span style="color: #a6e22e;">:m</span> 0)) (form2/var (<span style="color: #a6e22e;">:n</span> 0)) (form2/name recur) (form2/name succ)))
   (((form2/var (<span style="color: #a6e22e;">:m</span> 0)) (form2/var (<span style="color: #a6e22e;">:n</span> 0)) (form2/name succ))
    ((form2/var (<span style="color: #a6e22e;">:m</span> 0)) (form2/var (<span style="color: #a6e22e;">:n</span> 0)) (form2/lambda ((((form2/name natural) (form2/name natural)) ((form2/name natural))) ((((form2/var (<span style="color: #a6e22e;">:m</span> 0)) (form2/var (<span style="color: #a6e22e;">:n</span> 0)) (form2/name succ)) ((form2/var (<span style="color: #a6e22e;">:m</span> 0)) (form2/var (<span style="color: #a6e22e;">:n</span> 0)) (form2/name recur) (form2/name succ))) (((form2/var (<span style="color: #a6e22e;">:m</span> 0)) (form2/var (<span style="color: #a6e22e;">:n</span> 0)) (form2/name succ)) ((form2/var (<span style="color: #a6e22e;">:m</span> 0)) (form2/var (<span style="color: #a6e22e;">:n</span> 0)) (form2/name recur) (form2/name succ))))))))
   (((form2/bind (((form2/var (<span style="color: #a6e22e;">:t</span> 1))) ((form2/name type)) leave)) (form2/var (<span style="color: #a6e22e;">:t</span> 0)))
    ((form2/name type)))
   (((form2/bind (((form2/var (<span style="color: #a6e22e;">:t</span> 1))) ((form2/name type)) not-leave)) (form2/var (<span style="color: #a6e22e;">:t</span> 0)))
    ((form2/name type)))
   (((form2/bind (((form2/var (<span style="color: #a6e22e;">:t</span> 2))) ((form2/name type)) leave)) (form2/var (<span style="color: #a6e22e;">:t</span> 0)))
    ((form2/name type)))
   (((form2/bind (((form2/var (<span style="color: #a6e22e;">:t1</span> 1)) (form2/var (<span style="color: #a6e22e;">:t2</span> 2)) (form2/var (<span style="color: #a6e22e;">:t3</span> 0))) ((form2/name j) (form2/name k)) leave)) (form2/var (<span style="color: #a6e22e;">:t</span> 0)))
    ((form2/name type)))
   (((form2/bind (((form2/var (<span style="color: #a6e22e;">:t</span> 2))) ((form2/name type)) not-leave)) (form2/var (<span style="color: #a6e22e;">:t</span> 0)))
    ((form2/name type)))))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org3e03a5b" class="outline-3">
<h3 id="org3e03a5b">pass2</h3>
<div class="outline-text-3" id="text-org3e03a5b">
</div><div id="outline-container-org97af7a6" class="outline-4">
<h4 id="org97af7a6">pass2/arrow</h4>
<div class="outline-text-4" id="text-org97af7a6">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">pass2/arrow</span> a s)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">form2/arrow, scope -&gt; (form3/arrow scope)</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> a
    [(ac sc)
     (<span style="color: #f92672; font-weight: bold;">match</span> (pass2/cedent ac s)
       [(3ac s1)
        (<span style="color: #f92672; font-weight: bold;">match</span> (pass2/cedent sc s1)
          [(3sc s2)
           (list (list 3ac 3sc) s2)])])]))
</pre>
</div>
</div>
</div>

<div id="outline-container-org8f03adc" class="outline-4">
<h4 id="org8f03adc">pass2/cedent</h4>
<div class="outline-text-4" id="text-org8f03adc">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">pass2/cedent</span> c s)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">(form2 ...), scope -&gt; ((form3 ...) scope)</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> c
    ['() (list '() s)]
    [(h . r)
     (<span style="color: #f92672; font-weight: bold;">match</span> (pass2 h s)
       [(3f s1)
        (<span style="color: #f92672; font-weight: bold;">match</span> (pass2/cedent r s1)
          [(3c s2)
           (list (cons 3f 3c) s2)])])]))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc240744" class="outline-4">
<h4 id="orgc240744">pass2/lambda</h4>
<div class="outline-text-4" id="text-orgc240744">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">pass2/lambda</span> l s)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">form2/lambda, scope -&gt; (form3/lambda scope)</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> l
    [(a al)
     (list (list (pass2/arrow a s)
                 (<span style="color: #f92672; font-weight: bold;">map</span> (<span style="color: #f92672; font-weight: bold;">lambda</span> (x) (pass2/arrow x s))
                   al))
           s)]))
</pre>
</div>
</div>
</div>

<div id="outline-container-org99df108" class="outline-4">
<h4 id="org99df108">pass2</h4>
<div class="outline-text-4" id="text-org99df108">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">pass2</span> f s)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">form2, scope -&gt; (form2 scope)</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> f
    [('form2/var v)
     (<span style="color: #f92672; font-weight: bold;">match</span> (pass2/var v s)
       [(v1 s1)
        (list (list 'form3/var v1) s1)])]
    [('form2/name n)
     (list (list 'form3/name n) s)]
    [('form2/arrow a)
     (<span style="color: #f92672; font-weight: bold;">match</span> (pass2/arrow a s)
       [(a1 s1)
        (list (list 'form3/arrow a1) s1)])]
    [('form2/lambda l)
     (<span style="color: #f92672; font-weight: bold;">match</span> (pass2/lambda l s)
       [(l1 s1)
        (list (list 'form3/lambda l1) s1)])]
    [('form2/bind b)
     (<span style="color: #f92672; font-weight: bold;">match</span> (pass2/bind b s)
       [(b1 s1)
        (list (list 'form3/bind b1) s1)])]))
</pre>
</div>
</div>
</div>

<div id="outline-container-org1a32a57" class="outline-4">
<h4 id="org1a32a57">pass2/var</h4>
<div class="outline-text-4" id="text-org1a32a57">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">pass2/var</span> v s)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">form2/var, scope -&gt; (form3/var scope)</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> v
    [(symbol level)
     (<span style="color: #f92672; font-weight: bold;">let</span> ([found (assq symbol s)])
       (<span style="color: #f92672; font-weight: bold;">if</span> found
         (<span style="color: #f92672; font-weight: bold;">let</span> ([old (cdr found)])
           (list (list old level)
                 s))
         (<span style="color: #f92672; font-weight: bold;">let</span> ([new (vector symbol '())])
           (list (list new level)
                 (cons (cons symbol new) s)))))]))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf12f53e" class="outline-4">
<h4 id="orgf12f53e">pass2/bind</h4>
<div class="outline-text-4" id="text-orgf12f53e">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">pass2/bind</span> b s)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">form2/bind, scope -&gt; (form3/bind scope)</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> b
    [(vs c leave?)
     (<span style="color: #f92672; font-weight: bold;">match</span> (pass2/cedent vs s)
       [(3vs s1)
        (<span style="color: #f92672; font-weight: bold;">match</span> (pass2/cedent c s1)
          <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">this means vars in vs can occur in c</span>
          [(3c s2)
           (list (list 3vs 3c leave?) s2)])])]))
</pre>
</div>
</div>
</div>

<div id="outline-container-org3ece197" class="outline-4">
<h4 id="org3ece197"><span class="done test">test</span> </h4>
<div class="outline-text-4" id="text-org3ece197">
<div class="org-src-container">

<pre class="src src-scheme">(test
 (<span style="color: #f92672; font-weight: bold;">map</span> (<span style="color: #f92672; font-weight: bold;">lambda</span> (x) (pass2/arrow x '()))
   (<span style="color: #f92672; font-weight: bold;">map</span> (<span style="color: #f92672; font-weight: bold;">lambda</span> (x) (pass1/arrow 0 x))
     '((natural natural <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> natural)
       (natural natural <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> (natural natural <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> natural) natural)
       (<span style="color: #a6e22e;">:m</span> zero <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #a6e22e;">:m</span>)
       (<span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> succ <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> recur succ)
       (<span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> succ <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> (<span style="color: #f92672; font-weight: bold;">lambda</span> (natural natural <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> natural)
                              (<span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> succ <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> recur succ)
                              (<span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> succ <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> recur succ)))
       ((<span style="color: #a6e22e;">:t</span> : type) <span style="color: #a6e22e;">:t</span> <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> type)
       ((<span style="color: #a6e22e;">:t</span> @ type) <span style="color: #a6e22e;">:t</span> <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> type)
       ((<span style="color: #a6e22e;">:t^2</span> : type) <span style="color: #a6e22e;">:t</span> <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> type)
       ((<span style="color: #a6e22e;">:t1</span> <span style="color: #a6e22e;">:t2^2</span> <span style="color: #a6e22e;">:t3^0</span> : j k) <span style="color: #a6e22e;">:t</span> <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> type)
       ((<span style="color: #a6e22e;">:t^2</span> @ type) <span style="color: #a6e22e;">:t</span> <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> type))))
 '(((((form3/name natural) (form3/name natural)) ((form3/name natural))) ())
   ((((form3/name natural) (form3/name natural)) ((form3/arrow (((form3/name natural) (form3/name natural)) ((form3/name natural)))) (form3/name natural))) ())
   ((((form3/var (#(<span style="color: #a6e22e;">:m</span> ()) 0)) (form3/name zero)) ((form3/var (#(<span style="color: #a6e22e;">:m</span> ()) 0)))) ((<span style="color: #a6e22e;">:m</span> . #(<span style="color: #a6e22e;">:m</span> ()))))
   ((((form3/var (#(<span style="color: #a6e22e;">:m</span> ()) 0)) (form3/var (#(<span style="color: #a6e22e;">:n</span> ()) 0)) (form3/name succ)) ((form3/var (#(<span style="color: #a6e22e;">:m</span> ()) 0)) (form3/var (#(<span style="color: #a6e22e;">:n</span> ()) 0)) (form3/name recur) (form3/name succ))) ((<span style="color: #a6e22e;">:n</span> . #(<span style="color: #a6e22e;">:n</span> ())) (<span style="color: #a6e22e;">:m</span> . #(<span style="color: #a6e22e;">:m</span> ()))))
   ((((form3/var (#(<span style="color: #a6e22e;">:m</span> ()) 0)) (form3/var (#(<span style="color: #a6e22e;">:n</span> ()) 0)) (form3/name succ)) ((form3/var (#(<span style="color: #a6e22e;">:m</span> ()) 0)) (form3/var (#(<span style="color: #a6e22e;">:n</span> ()) 0)) (form3/lambda (((((form3/name natural) (form3/name natural)) ((form3/name natural))) ((<span style="color: #a6e22e;">:n</span> . #(<span style="color: #a6e22e;">:n</span> ())) (<span style="color: #a6e22e;">:m</span> . #(<span style="color: #a6e22e;">:m</span> ())))) (((((form3/var (#(<span style="color: #a6e22e;">:m</span> ()) 0)) (form3/var (#(<span style="color: #a6e22e;">:n</span> ()) 0)) (form3/name succ)) ((form3/var (#(<span style="color: #a6e22e;">:m</span> ()) 0)) (form3/var (#(<span style="color: #a6e22e;">:n</span> ()) 0)) (form3/name recur) (form3/name succ))) ((<span style="color: #a6e22e;">:n</span> . #(<span style="color: #a6e22e;">:n</span> ())) (<span style="color: #a6e22e;">:m</span> . #(<span style="color: #a6e22e;">:m</span> ())))) ((((form3/var (#(<span style="color: #a6e22e;">:m</span> ()) 0)) (form3/var (#(<span style="color: #a6e22e;">:n</span> ()) 0)) (form3/name succ)) ((form3/var (#(<span style="color: #a6e22e;">:m</span> ()) 0)) (form3/var (#(<span style="color: #a6e22e;">:n</span> ()) 0)) (form3/name recur) (form3/name succ))) ((<span style="color: #a6e22e;">:n</span> . #(<span style="color: #a6e22e;">:n</span> ())) (<span style="color: #a6e22e;">:m</span> . #(<span style="color: #a6e22e;">:m</span> ()))))))))) ((<span style="color: #a6e22e;">:n</span> . #(<span style="color: #a6e22e;">:n</span> ())) (<span style="color: #a6e22e;">:m</span> . #(<span style="color: #a6e22e;">:m</span> ()))))
   ((((form3/bind (((form3/var (#(<span style="color: #a6e22e;">:t</span> ()) 1))) ((form3/name type)) leave)) (form3/var (#(<span style="color: #a6e22e;">:t</span> ()) 0))) ((form3/name type))) ((<span style="color: #a6e22e;">:t</span> . #(<span style="color: #a6e22e;">:t</span> ()))))
   ((((form3/bind (((form3/var (#(<span style="color: #a6e22e;">:t</span> ()) 1))) ((form3/name type)) not-leave)) (form3/var (#(<span style="color: #a6e22e;">:t</span> ()) 0))) ((form3/name type))) ((<span style="color: #a6e22e;">:t</span> . #(<span style="color: #a6e22e;">:t</span> ()))))
   ((((form3/bind (((form3/var (#(<span style="color: #a6e22e;">:t</span> ()) 2))) ((form3/name type)) leave)) (form3/var (#(<span style="color: #a6e22e;">:t</span> ()) 0))) ((form3/name type))) ((<span style="color: #a6e22e;">:t</span> . #(<span style="color: #a6e22e;">:t</span> ()))))
   ((((form3/bind (((form3/var (#(<span style="color: #a6e22e;">:t1</span> ()) 1)) (form3/var (#(<span style="color: #a6e22e;">:t2</span> ()) 2)) (form3/var (#(<span style="color: #a6e22e;">:t3</span> ()) 0))) ((form3/name j) (form3/name k)) leave)) (form3/var (#(<span style="color: #a6e22e;">:t</span> ()) 0))) ((form3/name type))) ((<span style="color: #a6e22e;">:t</span> . #(<span style="color: #a6e22e;">:t</span> ())) (<span style="color: #a6e22e;">:t3</span> . #(<span style="color: #a6e22e;">:t3</span> ())) (<span style="color: #a6e22e;">:t2</span> . #(<span style="color: #a6e22e;">:t2</span> ())) (<span style="color: #a6e22e;">:t1</span> . #(<span style="color: #a6e22e;">:t1</span> ()))))
   ((((form3/bind (((form3/var (#(<span style="color: #a6e22e;">:t</span> ()) 2))) ((form3/name type)) not-leave)) (form3/var (#(<span style="color: #a6e22e;">:t</span> ()) 0))) ((form3/name type))) ((<span style="color: #a6e22e;">:t</span> . #(<span style="color: #a6e22e;">:t</span> ()))))))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org41a7981" class="outline-3">
<h3 id="org41a7981">pass3</h3>
<div class="outline-text-3" id="text-org41a7981">
</div><div id="outline-container-org825c205" class="outline-4">
<h4 id="org825c205">pass3/get-arrow</h4>
<div class="outline-text-4" id="text-org825c205">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">pass3/get-arrow</span> a e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">form3/arrow, env -&gt; arrow</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> (pass3/arrow a e)
    [((('arrow arrow) . _) _ _)
     arrow]))
</pre>
</div>
</div>
</div>

<div id="outline-container-org8b14f24" class="outline-4">
<h4 id="org8b14f24">pass3/arrow</h4>
<div class="outline-text-4" id="text-org8b14f24">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">pass3/arrow</span> a e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">form3/arrow, env -&gt; env</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> e
    [(ds bs ns)
     (<span style="color: #f92672; font-weight: bold;">match</span> a
       [(ac sc)
        (<span style="color: #f92672; font-weight: bold;">match</span> (pass3/cedent ac e)
          [((d1 . _) _ _)
           (<span style="color: #f92672; font-weight: bold;">match</span> (pass3/cedent sc e)
             [((d2 . _) _ _)
              (list (cons (list 'arrow (list d1 d2))
                          ds)
                    bs
                    ns)])])])]))
</pre>
</div>
</div>
</div>

<div id="outline-container-orga37d2b" class="outline-4">
<h4 id="orga37d2b">pass3/cedent</h4>
<div class="outline-text-4" id="text-orga37d2b">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">pass3/cedent</span> c e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">(form3 ...), env -&gt; env</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> e
    [(ds bs ns)
     (<span style="color: #f92672; font-weight: bold;">match</span> c
       [() e]
       [(h . r) (pass3/cedent r (pass3 h e))])]))
</pre>
</div>
</div>
</div>

<div id="outline-container-org6ec97f5" class="outline-4">
<h4 id="org6ec97f5">pass3/lambda</h4>
<div class="outline-text-4" id="text-org6ec97f5">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">pass3/lambda</span> l e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">form3/lambda, env -&gt; env</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> e
    [(ds bs ns)
     (<span style="color: #f92672; font-weight: bold;">match</span> l
       [(a al)
        (list (cons (list 'lambda
                          (pass3/get-arrow a e)
                          (<span style="color: #f92672; font-weight: bold;">map</span> (<span style="color: #f92672; font-weight: bold;">lambda</span> (x)
                                 (pass3/get-arrow x e))
                            al))
                    ds)
              bs
              ns)])]))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd4ab0ab" class="outline-4">
<h4 id="orgd4ab0ab">pass3</h4>
<div class="outline-text-4" id="text-orgd4ab0ab">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">pass3</span> f e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">form3, env -&gt; env</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> f
    [('form3/var x) (pass3/var x e)]
    [('form3/name x) (pass3/name x e)]
    [('form3/arrow x) (pass3/arrow x e)]
    [('form3/lambda x) (pass3/lambda x e)]
    [('form3/bind x) (pass3/bind x e)]))
</pre>
</div>
</div>
</div>

<div id="outline-container-org968117f" class="outline-4">
<h4 id="org968117f">pass3/var</h4>
<div class="outline-text-4" id="text-org968117f">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">pass3/var</span> v e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">form3/var, env -&gt; env</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> e
    [(ds bs ns)
     <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">actually there is no need to search bs</span>
     <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">but anyway</span>
     (list (cons (bs/deep bs (list 'var v)) ds)
           bs
           ns)]))
</pre>
</div>
</div>
</div>

<div id="outline-container-orge201eca" class="outline-4">
<h4 id="orge201eca">id-&gt;ls</h4>
<div class="outline-text-4" id="text-orge201eca">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">id-&gt;ls</span> id)
  (vector-ref id 1))
</pre>
</div>
</div>
</div>

<div id="outline-container-org1a88111" class="outline-4">
<h4 id="org1a88111"><span class="todo _gt__lt__gt__lt__gt__lt_">&gt;&lt;&gt;&lt;&gt;&lt;</span> bs/[find|walk|deep]</h4>
<div class="outline-text-4" id="text-org1a88111">
<ul class="org-ul">
<li><p>infer level n can get level n+1</p></li>

<li><p>note how the types of these functions are different</p></li></ul>

<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">bs/find</span> bs v)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">bs, var -&gt; data or #f</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> v
    [(id level)
     (<span style="color: #f92672; font-weight: bold;">let*</span> ([level (<span style="color: #f92672; font-weight: bold;">if</span> (eq? level #f)
                     0
                     level)]
            [found/commit (assq level (id-&gt;ls id))])
       (<span style="color: #f92672; font-weight: bold;">if</span> found/commit
         (cdr found/commit)
         (<span style="color: #f92672; font-weight: bold;">let*</span> ([found/ls (assq id bs)]
                [found/bind
                 (<span style="color: #f92672; font-weight: bold;">if</span> found/ls
                   (assq level (cdr found/ls))
                   #f)])
           (<span style="color: #f92672; font-weight: bold;">if</span> found/bind
             (cdr found/bind)
             #f))))]))

(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">bs/walk</span> bs d)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">bs, data -&gt; data</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> d
    [('var v)
     (<span style="color: #f92672; font-weight: bold;">let</span> ([found (bs/find bs v)])
       (<span style="color: #f92672; font-weight: bold;">if</span> found
         (bs/walk bs found)
         d))]
    [(_ e) d]))

(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">bs/deep</span> bs d)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">bs, data -&gt; data</span>
  (<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">bs/deep-list</span> bs dl)
    (<span style="color: #f92672; font-weight: bold;">map</span> (<span style="color: #f92672; font-weight: bold;">lambda</span> (x) (bs/deep bs x)) dl))
  (<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">bs/deep-arrow</span> bs a)
    (<span style="color: #f92672; font-weight: bold;">match</span> a
      [(dl1 dl2)
       (list (bs/deep-list bs dl1)
             (bs/deep-list bs dl2))]))
  (<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">bs/deep-arrow-list</span> bs al)
    (<span style="color: #f92672; font-weight: bold;">map</span> (<span style="color: #f92672; font-weight: bold;">lambda</span> (a) (bs/deep-arrow bs a)) al))
  (<span style="color: #f92672; font-weight: bold;">match</span> (bs/walk bs d)
    [('var v) ('var v)]
    [('cons (name dl))
     (list 'cons
           (list name (bs/deep-list bs dl)))]
    [('arrow a) (list 'arrow (bs/deep-arrow bs a))]
    [('lambda (a al))
     (list 'lambda
           (list (bs/deep-arrow bs a)
                 (bs/deep-arrow-list bs al)))]
    [('trunk (a al dl))
     (list 'trunk
           (list (bs/deep-arrow bs a)
                 (bs/deep-arrow-list bs al)
                 (bs/deep-list bs dl)))]
    [('proj (a al dl i))
     (list 'proj
           (list (bs/deep-arrow bs a)
                 (bs/deep-arrow-list bs al)
                 (bs/deep-list bs dl)
                 i))]))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc07a49c" class="outline-4">
<h4 id="orgc07a49c">pass3/name</h4>
<div class="outline-text-4" id="text-orgc07a49c">
<ul class="org-ul">
<li><p>apply can be used to optimize</p><p>i.e. to do more computations before storing things into ns</p><p>but I leave it for now</p></li></ul>

<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">pass3/name</span> n e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">form3/name, env -&gt; env</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> e
    [(ds bs ns)
     (<span style="color: #f92672; font-weight: bold;">let</span> ([found (assq n ns)])
       (<span style="color: #f92672; font-weight: bold;">if</span> (not found)
         (<span style="color: #f92672; font-weight: bold;">orz</span> (<span style="color: #e6db74;">"pass3/name unknow name : ~a~%"</span> n))
         (<span style="color: #f92672; font-weight: bold;">let</span> ([meaning (cdr found)])
           (<span style="color: #f92672; font-weight: bold;">match</span> meaning
             [('cons/type ((ac sc) name _))
              (pass3/name/cons (length ac) name e)]
             [('cons/data ((ac sc) name _))
              (pass3/name/cons (length ac) name e)]
             [('lambda ((ac sc) al))
              (<span style="color: #f92672; font-weight: bold;">if</span> (eq? 1 (length sc))
                (pass3/name/trunk (length ac) l e)
                (pass3/name/proj (length ac) (length sc) l e))]))))]))
</pre>
</div>
</div>
</div>

<div id="outline-container-org3c7c34e" class="outline-4">
<h4 id="org3c7c34e">pass3/name/cons</h4>
<div class="outline-text-4" id="text-org3c7c34e">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">pass3/name/cons</span> len name e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">length, name, env -&gt; env</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> e
    [(ds bs ns)
     (list (cons (list 'cons
                       (list name (sublist ds 0 len)))
                 (sublist ds len -1))
           bs
           ns)]))
</pre>
</div>
</div>
</div>

<div id="outline-container-org824f7d6" class="outline-4">
<h4 id="org824f7d6">pass3/name/trunk</h4>
<div class="outline-text-4" id="text-org824f7d6">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">pass3/name/trunk</span> len l e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">length, lambda, env -&gt; env</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> e
    [(ds bs ns)
     (<span style="color: #f92672; font-weight: bold;">match</span> l
       [(a al)
        (<span style="color: #f92672; font-weight: bold;">let</span> ([a (copy-arrow a)]
              [al (<span style="color: #f92672; font-weight: bold;">map</span> copy-arrow al)]
              [dl (sublist ds 0 len)])
          (list (cons (list 'trunk (list a al dl))
                      (sublist ds len -1))
                bs
                ns))])]))
</pre>
</div>
</div>
</div>

<div id="outline-container-org15ec04c" class="outline-4">
<h4 id="org15ec04c">pass3/name/proj</h4>
<div class="outline-text-4" id="text-org15ec04c">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">pass3/name/proj</span> len slen l e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">length, length, lambda, env -&gt; env</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> e
    [(ds bs ns)
     (<span style="color: #f92672; font-weight: bold;">match</span> l
       [(a al)
        (<span style="color: #f92672; font-weight: bold;">let*</span> ([a (copy-arrow a)]
               [al (<span style="color: #f92672; font-weight: bold;">map</span> copy-arrow al)]
               [dl (sublist ds 0 len)]
               [make-proj (<span style="color: #f92672; font-weight: bold;">lambda</span> (i) (list 'proj (list a al dl i)))])
          (list (append (<span style="color: #f92672; font-weight: bold;">map</span> make-proj (genlist slen))
                        (sublist ds len -1))
                bs
                ns))])]))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgebf779c" class="outline-4">
<h4 id="orgebf779c">pass3/bind</h4>
<div class="outline-text-4" id="text-orgebf779c">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">pass3/bind</span> b e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">form3/bind, env -&gt; env</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> b
    [(vl c leave?)
     (<span style="color: #f92672; font-weight: bold;">match</span> (pass3/cedent c e)
       [((d1 . _) _ _) <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">here I assume the c of bind is simple</span>
        (<span style="color: #f92672; font-weight: bold;">letrec</span> ([recur
                  (<span style="color: #f92672; font-weight: bold;">lambda</span> (vl e)
                    (<span style="color: #f92672; font-weight: bold;">match</span> (list vl e)
                      [(() _) e]
                      [(((id level) . r) (ds bs ns))
                       <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">&gt;&lt;&gt;&lt;&gt;&lt;</span>
                       <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">need to check if the bind already exist</span>
                       (id/commit! id (list (cons level d1)))
                       (recur r (list (<span style="color: #f92672; font-weight: bold;">if</span> leave?
                                        (cons d1 ds)
                                        ds)
                                      bs
                                      ns))]))])
          (recur vl e))])]))
</pre>
</div>
</div>
</div>

<div id="outline-container-org7eedb3c" class="outline-4">
<h4 id="org7eedb3c">id/commit!</h4>
<div class="outline-text-4" id="text-org7eedb3c">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">id/commit!</span> id ls)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">id, ls -&gt; id</span>
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">effect on id</span>
  (<span style="color: #f92672; font-weight: bold;">let</span> ()
    (<span style="color: #f92672; font-weight: bold;">vector-set!</span> id (append ls (vector-ref id 1)))
    id))
</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-org4a9b41" class="outline-2">
<h2 id="org4a9b41"><span class="todo _gt__lt_">&gt;&lt;</span> copy-arrow</h2>
<div class="outline-text-2" id="text-org4a9b41">
</div><div id="outline-container-org2a8d96a" class="outline-3">
<h3 id="org2a8d96a"><span class="todo note">note</span> copy</h3>
<div class="outline-text-3" id="text-org2a8d96a">
<ul class="org-ul">
<li><p>when forming trunk from lambda which is fetched from ns</p><p>we have to copy the lambda</p></li>

<li><p>copy is arrow by arrow</p><p>every var in new arrow is different from old arrow</p><p>thus</p><p><ol class="org-ol"></p><p><li>scope is also arrow by arrow</li></p><p><li>a non-determinate var can not be substituted into lambda as it is</p><p>but is copied</li></ol></p></li>

<li><p>this copy is one of the main place where this prototype can be optimized</p><p>a vm can be designed to replace this copy function</p><p>and change the interpreter to a compiler</p></li></ul>
</div>
</div>

<div id="outline-container-org7064dab" class="outline-3">
<h3 id="org7064dab">copy-arrow</h3>
<div class="outline-text-3" id="text-org7064dab">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">copy-arrow</span> a)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">arrow -&gt; arrow</span>
  ())
</pre>
</div>
</div>
</div>

<div id="outline-container-org83d9df3" class="outline-3">
<h3 id="org83d9df3">copy/var</h3>
</div>

<div id="outline-container-org697da31" class="outline-3">
<h3 id="org697da31">copy/cons</h3>
</div>

<div id="outline-container-org92ac72" class="outline-3">
<h3 id="org92ac72">copy/arrow</h3>
</div>

<div id="outline-container-org6cbaf79" class="outline-3">
<h3 id="org6cbaf79">copy/lambda</h3>
</div>

<div id="outline-container-org1d1a3e8" class="outline-3">
<h3 id="org1d1a3e8">copy/trunk</h3>
</div>

<div id="outline-container-org778fd85" class="outline-3">
<h3 id="org778fd85">copy/proj</h3>
</div>
</div>

<div id="outline-container-orgb772565" class="outline-2">
<h2 id="orgb772565"><span class="todo _gt__lt_">&gt;&lt;</span> apply</h2>
<div class="outline-text-2" id="text-orgb772565">
</div><div id="outline-container-org75ef345" class="outline-3">
<h3 id="org75ef345">apply/arrow</h3>
<div class="outline-text-3" id="text-org75ef345">
<ul class="org-ul">
<li><p>it returns report instead of env or #f</p><p>because when calling it</p><p>it is more easy to forget to handle the #f returned</p></li></ul>

<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">apply/arrow</span> a e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">arrow, env -&gt; report</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> e
    [(ds bs ns)
     (<span style="color: #f92672; font-weight: bold;">match</span> a
       [(ac sc)
        (<span style="color: #f92672; font-weight: bold;">match</span> (unify (<span style="color: #f92672; font-weight: bold;">lambda</span> (e) (apply/cedent ac e))
                      (list ds
                            (cons '(commit-point) bs)
                            ns))
          [('fail info-list) ('fail info-list)]
          [('success info-list e1)
           (<span style="color: #f92672; font-weight: bold;">match</span> (apply/cedent sc e1)
             [(ds2 bs2 ns2)
              (list 'success info-list
                    (list ds2 (bs/commit! bs2) ns2))])])])]))
</pre>
</div>
</div>
</div>

<div id="outline-container-org515270d" class="outline-3">
<h3 id="org515270d">apply/cedent</h3>
<div class="outline-text-3" id="text-org515270d">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">apply/cedent</span> c e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">cedent, env -&gt; env</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> c
    ['() e]
    [(h . r) (apply/cedent r (apply/dispatch h e))]))
</pre>
</div>
</div>
</div>

<div id="outline-container-org1a39e1f" class="outline-3">
<h3 id="org1a39e1f">apply/dispatch</h3>
<div class="outline-text-3" id="text-org1a39e1f">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">apply/dispatch</span> f e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">form, env -&gt; env</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> f
    [('var v) (apply/var v e)]
    [('name n) (apply/name n e)]
    [('arrow a) (apply/literal-arrow a e)]
    [('bind b) (apply/bind b e)]))
</pre>
</div>
</div>
</div>

<div id="outline-container-org1ae7df5" class="outline-3">
<h3 id="org1ae7df5">apply/literal-arrow</h3>
</div>

<div id="outline-container-orgbc8db69" class="outline-3">
<h3 id="orgbc8db69">apply/var</h3>
</div>

<div id="outline-container-org5691a3d" class="outline-3">
<h3 id="org5691a3d">apply/name</h3>
</div>

<div id="outline-container-org3beb85e" class="outline-3">
<h3 id="org3beb85e"><span class="todo _gt__lt_">&gt;&lt;</span> bs/commit!</h3>
<div class="outline-text-3" id="text-org3beb85e">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">bs/commit!</span> bs)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">bs -&gt; bs</span>
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">effect on part of bs</span>
  (<span style="color: #f92672; font-weight: bold;">cond</span> [(equal? '(commit-point) (car bs))
         (cdr bs)]
        [else
         (<span style="color: #f92672; font-weight: bold;">let*</span> ([pair (car bs)]
                [id (car pair)]
                [ls (cdr pair)])
           (id/commit! id ls)
           (bs/commit! (cdr bs)))]))
</pre>
</div>
</div>
</div>

<div id="outline-container-org2fb5ac4" class="outline-3">
<h3 id="org2fb5ac4"><span class="todo _gt__lt_">&gt;&lt;</span> bs/extend</h3>
<div class="outline-text-3" id="text-org2fb5ac4">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">defun</span> bs/extend (default-level bs v d)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">bs var data -&gt; bs</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> v
    (id level) =&gt;
    (<span style="color: #f92672; font-weight: bold;">let*</span> ((level (<span style="color: #f92672; font-weight: bold;">if</span> (eq nil level)
                      default-level
                      level))
           (found/ls (assoc id bs <span style="color: #a6e22e;">:test</span> #'eq)))
      (<span style="color: #f92672; font-weight: bold;">if</span> found/ls
          (substitute (cons id (cons (cons level d)
                                     (cdr found/ls)))
                      (<span style="color: #f92672; font-weight: bold;">lambda</span> (pair) (eq (car pair) id))
                      bs)
          (cons (cons id (list (cons level d)))
                bs)))))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgf2413fe" class="outline-2">
<h2 id="orgf2413fe"><span class="todo _gt__lt_">&gt;&lt;</span> unify</h2>
<div class="outline-text-2" id="text-orgf2413fe">
</div><div id="outline-container-org83eb04c" class="outline-3">
<h3 id="org83eb04c"><span class="todo _gt__lt_">&gt;&lt;</span> unify</h3>
<div class="outline-text-3" id="text-org83eb04c">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">unify</span> e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">(env -&gt; env), env -&gt; unify-report</span>
  )
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgd3fc0b7" class="outline-2">
<h2 id="orgd3fc0b7"><span class="todo _gt__lt_">&gt;&lt;</span> eva</h2>
</div>

<div id="outline-container-org9b0c1a8" class="outline-2">
<h2 id="org9b0c1a8"><span class="todo _gt__lt_">&gt;&lt;</span> check</h2>
</div>

<div id="outline-container-org333dbdb" class="outline-2">
<h2 id="org333dbdb"><span class="todo _gt__lt_">&gt;&lt;</span> type-apply</h2>
</div>

<div id="outline-container-org2cd2fec" class="outline-2">
<h2 id="org2cd2fec"><span class="todo _gt__lt_">&gt;&lt;</span> sequent</h2>
</div>

<div id="outline-container-orgdd1c309" class="outline-2">
<h2 id="orgdd1c309"><span class="done test">test</span> </h2>
<div class="outline-text-2" id="text-orgdd1c309">
</div><div id="outline-container-org56caaa6" class="outline-3">
<h3 id="org56caaa6">natural</h3>
<div class="outline-text-3" id="text-org56caaa6">
<div class="org-src-container">

<pre class="src src-scheme">(sequent

  (dt type (<span style="color: #66d9ef; font-weight: bold;">-&gt;</span> type))

  (dt natural (<span style="color: #66d9ef; font-weight: bold;">-&gt;</span> type)
      zero (<span style="color: #66d9ef; font-weight: bold;">-&gt;</span> natural)
      succ (natural <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> natural))

  (df add (natural natural <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> natural)
      (<span style="color: #a6e22e;">:m</span> zero <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #a6e22e;">:m</span>)
      (<span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> succ <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> add succ))

  (df mul (natural natural <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> natural)
      (<span style="color: #a6e22e;">:m</span> zero <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> zero)
      (<span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> succ <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> mul <span style="color: #a6e22e;">:m</span> add))

  (ap (<span style="color: #66d9ef; font-weight: bold;">-&gt;</span>
       zero succ
       zero succ succ
       add))

  (ap (<span style="color: #66d9ef; font-weight: bold;">-&gt;</span>
       zero succ succ
       zero succ succ
       mul))

  (ap (<span style="color: #66d9ef; font-weight: bold;">-&gt;</span> mul)))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd5c4020" class="outline-3">
<h3 id="orgd5c4020">list</h3>
<div class="outline-text-3" id="text-orgd5c4020">
<div class="org-src-container">

<pre class="src src-scheme">(sequent

  (dt type (<span style="color: #66d9ef; font-weight: bold;">-&gt;</span> type))

  (dt natural (<span style="color: #66d9ef; font-weight: bold;">-&gt;</span> type)
      zero (<span style="color: #66d9ef; font-weight: bold;">-&gt;</span> natural)
      succ (natural <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> natural))

  (df add (natural natural <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> natural)
      (<span style="color: #a6e22e;">:m</span> zero <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #a6e22e;">:m</span>)
      (<span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> succ <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> add succ))

  (df mul (natural natural <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> natural)
      (<span style="color: #a6e22e;">:m</span> zero <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> zero)
      (<span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> succ <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> mul <span style="color: #a6e22e;">:m</span> add))

  (dt list ((<span style="color: #a6e22e;">:t</span> : type) <span style="color: #a6e22e;">:t</span> <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> type)
      null (<span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #a6e22e;">:t</span> list)
      cons (<span style="color: #a6e22e;">:t</span> list <span style="color: #a6e22e;">:t</span> <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #a6e22e;">:t</span> list))

  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">(df map (:t1 list (:t1 -&gt; :t2) -&gt; :t2 list)</span>
  <span style="color: #FF8888;">;;     </span><span style="color: #FF8888;">(null :f -&gt; null)</span>
  <span style="color: #FF8888;">;;     </span><span style="color: #FF8888;">(:l :e cons :f -&gt; :e :f apply :l :f map cons))</span>

  (df append (<span style="color: #a6e22e;">:t</span> list <span style="color: #a6e22e;">:t</span> list <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #a6e22e;">:t1</span> list)
      (<span style="color: #a6e22e;">:l</span> null <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #a6e22e;">:l</span>)
      (<span style="color: #a6e22e;">:l</span> <span style="color: #a6e22e;">:r</span> <span style="color: #a6e22e;">:e</span> cons <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #a6e22e;">:l</span> <span style="color: #a6e22e;">:r</span> append <span style="color: #a6e22e;">:e</span> cons))

  (ap (<span style="color: #66d9ef; font-weight: bold;">-&gt;</span>
       null
       zero cons
       zero cons
       zero cons
       null
       zero cons
       zero cons
       zero cons
       append)))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgcd5062e" class="outline-3">
<h3 id="orgcd5062e">vector</h3>
<div class="outline-text-3" id="text-orgcd5062e">
<div class="org-src-container">

<pre class="src src-scheme">(sequent

  (dt type (<span style="color: #66d9ef; font-weight: bold;">-&gt;</span> type))

  (dt natural (<span style="color: #66d9ef; font-weight: bold;">-&gt;</span> type)
      zero (<span style="color: #66d9ef; font-weight: bold;">-&gt;</span> natural)
      succ (natural <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> natural))

  (df add (natural natural <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> natural)
      (<span style="color: #a6e22e;">:m</span> zero <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #a6e22e;">:m</span>)
      (<span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> succ <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> add succ))

  (df mul (natural natural <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> natural)
      (<span style="color: #a6e22e;">:m</span> zero <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> zero)
      (<span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> succ <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> mul <span style="color: #a6e22e;">:m</span> add))

  (dt vector ((<span style="color: #a6e22e;">:t</span> : type) natural <span style="color: #a6e22e;">:t</span> <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> type)
      null (<span style="color: #66d9ef; font-weight: bold;">-&gt;</span> zero <span style="color: #a6e22e;">:t</span> vector)
      cons (<span style="color: #a6e22e;">:n</span> <span style="color: #a6e22e;">:t</span> vector <span style="color: #a6e22e;">:t</span> <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #a6e22e;">:n</span> succ <span style="color: #a6e22e;">:t</span> vector))

  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">(df map (:n :t1 vector (:t1 -&gt; :t2) -&gt; :n :t2 vector)</span>
  <span style="color: #FF8888;">;;     </span><span style="color: #FF8888;">(null :f -&gt; null)</span>
  <span style="color: #FF8888;">;;     </span><span style="color: #FF8888;">(:l :e cons :f -&gt; :e :f apply :l :f map cons))</span>

  (df append (<span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:t</span> vector <span style="color: #a6e22e;">:n</span> <span style="color: #a6e22e;">:t</span> vector <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #a6e22e;">:m</span> <span style="color: #a6e22e;">:n</span> add <span style="color: #a6e22e;">:t</span> vector)
      (<span style="color: #a6e22e;">:l</span> null <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #a6e22e;">:l</span>)
      (<span style="color: #a6e22e;">:l</span> <span style="color: #a6e22e;">:r</span> <span style="color: #a6e22e;">:e</span> cons <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #a6e22e;">:l</span> <span style="color: #a6e22e;">:r</span> append <span style="color: #a6e22e;">:e</span> cons))

  (ap (<span style="color: #66d9ef; font-weight: bold;">-&gt;</span>
       null
       zero cons
       zero cons
       zero cons
       null
       zero cons
       zero cons
       zero cons
       append)))
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
喪以不執 所執者喪 執喪相比 方死方生
</div>
</body>
</html>
