<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2016-04-28 Thu 21:47 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>sequent1</title>
<meta name="generator" content="Org-mode" />
<meta name="author" content="XIE Yuheng" />
<link rel="stylesheet" href="asset/css/page.css" type="text/css" media="screen" />
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="preamble" class="status">
喪以不執 所執者喪 執喪相比 方死方生
</div>
<div id="content">
<h1 class="title">sequent1</h1>
<div id="table-of-contents">
<h2>overview</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orga81a85e"><span class="done todo">todo</span> </a></li>
<li><a href="#orgd0f18c5">helper</a>
<ul>
<li><a href="#orgb29b658">pattern match</a></li>
<li><a href="#org21d6929">cat &amp; orz</a></li>
<li><a href="#orgbacd4a4">little-test</a></li>
<li><a href="#org8704d86">list</a></li>
<li><a href="#org69e9ae0">string</a></li>
</ul>
</li>
<li><a href="#org12e9b1a"><span class="todo note">note</span> data type</a>
<ul>
<li><a href="#org7e60d08">form1</a></li>
<li><a href="#orge12acf8">form2</a></li>
<li><a href="#orgd64dbd3">form3</a></li>
<li><a href="#org234b0e5">data</a></li>
<li><a href="#org7e73c3f">arity</a></li>
<li><a href="#org2c572d8">env</a></li>
<li><a href="#org2fc4032">meaning</a></li>
<li><a href="#orgc705823"><span class="todo _gt__lt_">&gt;&lt;</span> top</a>
<ul>
<li><a href="#org6b635b9">top1</a></li>
<li><a href="#org58fefa">top2</a></li>
</ul>
</li>
<li><a href="#org3ed7226">report</a></li>
</ul>
</li>
<li><a href="#org7974b3d">pass1</a>
<ul>
<li><a href="#org493e20d">pass1/arrow</a></li>
<li><a href="#org7fa5115">pass1/cedent</a></li>
<li><a href="#org1d0f1ae">predicates</a></li>
<li><a href="#org9236da0">pass1</a></li>
<li><a href="#orgc86b45e">pass1/var</a></li>
</ul>
</li>
<li><a href="#org154def4">pass2</a>
<ul>
<li><a href="#org44471b3">pass2/arrow</a></li>
<li><a href="#orgcbe332c">pass2/cedent</a></li>
<li><a href="#orgae99190">pass2/lambda</a></li>
<li><a href="#org10ac423">pass2</a></li>
<li><a href="#org5d48e95">pass2/var</a></li>
<li><a href="#orgbe33360">pass2/bind</a></li>
</ul>
</li>
<li><a href="#org779a759">pass3</a>
<ul>
<li><a href="#orgba65182">pass3/get-arrow</a></li>
<li><a href="#orgd1b7af9">pass3/arrow</a></li>
<li><a href="#orga788d35">pass3/cedent</a></li>
<li><a href="#org5c4cdec">pass3/lambda</a></li>
<li><a href="#org195b3c0">pass3</a></li>
<li><a href="#org66b5098">pass3/var</a></li>
<li><a href="#orgd4cff08">id-&gt;[symbol|ls]</a></li>
<li><a href="#org3af8b78"><span class="todo _gt__lt__gt__lt__gt__lt_">&gt;&lt;&gt;&lt;&gt;&lt;</span> bs/[find|walk|deep]</a></li>
<li><a href="#org45fffc">pass3/name</a></li>
<li><a href="#org7609bc">pass3/name/cons</a></li>
<li><a href="#orga9d3a33">pass3/name/trunk</a></li>
<li><a href="#orgaca0575"><span class="todo _gt__lt__gt__lt__gt__lt_">&gt;&lt;&gt;&lt;&gt;&lt;</span> pass3/bind</a></li>
<li><a href="#org260e89a">id/commit!</a></li>
</ul>
</li>
<li><a href="#org10ae3e7">copy-arrow</a>
<ul>
<li><a href="#orgc772662"><span class="todo note">note</span> copy</a></li>
<li><a href="#orgdb135b7">copy-arrow</a></li>
<li><a href="#orgee3089c">copy/arrow</a></li>
<li><a href="#orgab67fd4">copy/cedent</a></li>
<li><a href="#org3720dcf">copy/lambda</a></li>
<li><a href="#orgd23c252">copy/arrow-list</a></li>
<li><a href="#orgba82d9e">copy</a></li>
<li><a href="#orgd7a53ae">copy/var</a></li>
<li><a href="#orgf265733">copy/ls</a></li>
<li><a href="#orgf933d8e">copy/cons</a></li>
<li><a href="#org7310e9">copy/trunk</a></li>
</ul>
</li>
<li><a href="#org56ba480">compute-arrow</a>
<ul>
<li><a href="#org9979246">compute-arrow</a></li>
<li><a href="#org2e548ab">bs/commit!</a></li>
<li><a href="#org16e7f8a">compute/cedent</a></li>
<li><a href="#orgc31f01f">compute</a></li>
</ul>
</li>
<li><a href="#org6739f20">unify</a>
<ul>
<li><a href="#org7d9d2cd">unify</a></li>
<li><a href="#org2b8e12a">unify/data-list</a></li>
<li><a href="#org6d45385">var/eq?</a></li>
<li><a href="#org74e5b56"><span class="todo _gt__lt__gt__lt__gt__lt_">&gt;&lt;&gt;&lt;&gt;&lt;</span> unify/data</a></li>
<li><a href="#org1334f1e">bs/extend</a></li>
<li><a href="#orga1d84d2">unify/var/data</a></li>
<li><a href="#org27af760">unify/cons</a></li>
<li><a href="#org8587b3f">unify/arrow</a></li>
<li><a href="#org234a01">unify/lambda</a></li>
<li><a href="#orgd362278">unify/arrow-list</a></li>
<li><a href="#org78ee75d">unify/trunk</a></li>
<li><a href="#orgcf0b21d">unify/trunk/data</a></li>
<li><a href="#orga286efc">proj</a></li>
</ul>
</li>
<li><a href="#org7406b69">filter-arrow-list</a></li>
<li><a href="#orgf3c49f6"><span class="todo _gt__lt_">&gt;&lt;</span> eva</a></li>
<li><a href="#orge67ddba"><span class="todo _gt__lt_">&gt;&lt;</span> check</a></li>
<li><a href="#orgd01b133"><span class="todo _gt__lt_">&gt;&lt;</span> type-compute</a></li>
<li><a href="#orgd3d0d28"><span class="todo _gt__lt_">&gt;&lt;</span> sequent</a></li>
</ul>
</div>
</div>
<ul class="org-ul">
<li><p>a prototype interpreter for a lovely functional language</p><p>which uses sequent calculus as dependent type system</p></li>

<li><p>it is lazy-eval and call-by-name</p></li>

<li><p>sequent is called arrow here</p><p>which is the core data type of the language</p></li>

<li><p>XIE Yuheng created</p></li></ul>

<div id="outline-container-orga81a85e" class="outline-2">
<h2 id="orga81a85e"><span class="done todo">todo</span> </h2>
<div class="outline-text-2" id="text-orga81a85e">
<ul class="org-ul">
<li><p>data/print</p><p>different var should be print differently</p></li>

<li><p>check-type</p><p>infer-arity</p><p>check-cover</p><p>check-end</p></li></ul>
</div>
</div>

<div id="outline-container-orgd0f18c5" class="outline-2">
<h2 id="orgd0f18c5">helper</h2>
<div class="outline-text-2" id="text-orgd0f18c5">
</div><div id="outline-container-orgb29b658" class="outline-3">
<h3 id="orgb29b658">pattern match</h3>
<div class="outline-text-3" id="text-orgb29b658">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #FF8888;">;; </span><span style="color: #FF8888;">module system of guile</span>
<span style="color: #FF8888;">;; </span><span style="color: #FF8888;">using http://synthcode.com/scheme/match.scm</span>
(use-modules (ice-9 match))
</pre>
</div>
</div>
</div>

<div id="outline-container-org21d6929" class="outline-3">
<h3 id="org21d6929">cat &amp; orz</h3>
<div class="outline-text-3" id="text-org21d6929">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define-syntax</span> <span style="color: #fd971f;">cat</span>
  (<span style="color: #f92672; font-weight: bold;">syntax-rules</span> ()
    [(cat (str . args))
     <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">(format str . args)</span>
     <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">guile</span>
     (format #t str . args)]
    [(cat (str . args) (str2 . args2) ...)
     (string-append
      (cat (str . args))
      (cat (str2 . args2) ...))]))

(<span style="color: #f92672; font-weight: bold;">define-syntax</span> <span style="color: #fd971f;">orz</span>
  (<span style="color: #f92672; font-weight: bold;">syntax-rules</span> ()
    [(<span style="color: #f92672; font-weight: bold;">orz</span> . body)
     (<span style="color: #f92672; font-weight: bold;">error</span> (cat . body))]))

(<span style="color: #f92672; font-weight: bold;">define-syntax</span> <span style="color: #fd971f;">note</span>
  (<span style="color: #f92672; font-weight: bold;">syntax-rules</span> ()
    [(<span style="color: #f92672; font-weight: bold;">note</span> . body)
     '()]))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbacd4a4" class="outline-3">
<h3 id="orgbacd4a4">little-test</h3>
<div class="outline-text-3" id="text-orgbacd4a4">
<div class="org-src-container">

<pre class="src src-scheme">(use-modules (ice-9 pretty-print))

(<span style="color: #f92672; font-weight: bold;">define-syntax</span> <span style="color: #fd971f;">test</span>
  (<span style="color: #f92672; font-weight: bold;">syntax-rules</span> ()
    [(test b1 b2)
     (<span style="color: #f92672; font-weight: bold;">if</span> (equal? b1 b2)
       #t
       (<span style="color: #f92672; font-weight: bold;">let</span> ()
         (cat (<span style="color: #e6db74;">"\n"</span>))
         (cat (<span style="color: #e6db74;">"&lt;test-fail-report-begin&gt;\n"</span>))
         (cat (<span style="color: #e6db74;">"&lt;actual-form&gt; :\n"</span>))
         (pretty-print (<span style="color: #f92672; font-weight: bold;">quote</span> b1))
         (cat (<span style="color: #e6db74;">"&lt;actual-value&gt; :\n"</span>))
         (pretty-print b1)
         (cat (<span style="color: #e6db74;">"&lt;expect-form&gt; :\n"</span>))
         (pretty-print (<span style="color: #f92672; font-weight: bold;">quote</span> b2))
         (cat (<span style="color: #e6db74;">"&lt;expect-value&gt; :\n"</span>))
         (pretty-print b2)
         (<span style="color: #f92672; font-weight: bold;">orz</span> (<span style="color: #e6db74;">"&lt;test-fail-report-end&gt;\n"</span>))))]))
</pre>
</div>
</div>
</div>

<div id="outline-container-org8704d86" class="outline-3">
<h3 id="org8704d86">list</h3>
<div class="outline-text-3" id="text-org8704d86">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">left-of</span> s l)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">sexp, list -&gt; list</span>
  (<span style="color: #f92672; font-weight: bold;">cond</span> [(equal? s (car l)) '()]
        [else (cons (car l) (left-of s (cdr l)))]))

(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">right-of</span> s l)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">sexp, list -&gt; list</span>
  (<span style="color: #f92672; font-weight: bold;">cond</span> [(equal? s (car l)) (cdr l)]
        [else (right-of s (cdr l))]))

(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">sublist</span> l start end)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">list, index, index -&gt; list</span>
  (<span style="color: #f92672; font-weight: bold;">cond</span> [(<span style="color: #f92672; font-weight: bold;">and</span> (eq? 0 start) (&lt;= end 0)) '()]
        [(<span style="color: #f92672; font-weight: bold;">and</span> (not (eq? 0 start)))
         (sublist (cdr l) (- start 1) (- end 1))]
        [(<span style="color: #f92672; font-weight: bold;">and</span> (eq? 0 start) (not (eq? 0 end)))
         (cons (car l) (sublist (cdr l) 0 (- end 1)))]))

(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">genlist</span> len)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">length -&gt; list</span>
  (<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">recur</span> len counter)
    (<span style="color: #f92672; font-weight: bold;">cond</span> [(eq? len counter) '()]
          [else (cons counter
                      (recur len (+ 1 counter)))]))
  (recur len 0))

(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">substitute</span> e p? l)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">element, (element -&gt; bool), (element ...) -&gt; (element ...)</span>
  (<span style="color: #f92672; font-weight: bold;">cond</span> [(eq? '() l) '()]
        [(p? (car l)) (cons e (cdr l))]
        [else (cons (car l) (substitute e p? (cdr l)))]))
</pre>
</div>
</div>
</div>

<div id="outline-container-org69e9ae0" class="outline-3">
<h3 id="org69e9ae0">string</h3>
<div class="outline-text-3" id="text-org69e9ae0">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">find-char</span> c s)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">char, string -&gt; curser or #f</span>
  (find-char/curser c s 0))

(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">find-char/curser</span> c s curser)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">char, string, curser -&gt; curser or #f</span>
  (<span style="color: #f92672; font-weight: bold;">if</span> (&gt;= curser (string-length s))
    #f
    (<span style="color: #f92672; font-weight: bold;">let</span> ([c0 (substring s curser (+ 1 curser))])
      (<span style="color: #f92672; font-weight: bold;">if</span> (equal? c c0)
        curser
        (find-char/curser c s (+ 1 curser))))))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org12e9b1a" class="outline-2">
<h2 id="org12e9b1a"><span class="todo note">note</span> data type</h2>
<div class="outline-text-2" id="text-org12e9b1a">
</div><div id="outline-container-org7e60d08" class="outline-3">
<h3 id="org7e60d08">form1</h3>
<div class="outline-text-3" id="text-org7e60d08">
<ul class="org-ul">
<li><p>form1 =</p><p><ul class="org-ul"></p><p><li><p>form1/var =</p><p>:var</p><p>:var<sup>n</sup></p></li></p><p><li><p>form1/name =</p><p>name</p></li></p><p><li><p>form1/arrow =</p><p>(form1 &#x2026; -&gt; form1 &#x2026;)</p></li></p><p><li><p>form1/lambda =</p><p>(lambda form1/arrow</p><p>  form1/arrow</p><p>  &#x2026;)</p></li></p><p><li><p>form1/im-bind =</p><p>(form1/var &#x2026; : form1 &#x2026;)</p></li></p><p><li><p>form1/ex-bind =</p><p>(form1/var &#x2026; @ form1 &#x2026;)</p></li></ul></p></li></ul>
</div>
</div>

<div id="outline-container-orge12acf8" class="outline-3">
<h3 id="orge12acf8">form2</h3>
<div class="outline-text-3" id="text-orge12acf8">
<ul class="org-ul">
<li><p>form1 -pass1-&gt; form2</p><p>default-level of var is handled here</p></li>

<li><p>form2 =</p><p>('form2/var    (symbol level))</p><p>('form2/name   symbol)</p><p>('form2/arrow  ((form2 &#x2026;) (form2 &#x2026;)))</p><p>('form2/lambda (form2/arrow (form2/arrow &#x2026;)))</p><p>('form2/bind   ((form2/var &#x2026;) (form2 &#x2026;) leave?))</p></li>
<li><p>level = natural-number</p></li>
<li><p>leave? = 'leave | 'not-leave</p></li></ul>
</div>
</div>

<div id="outline-container-orgd64dbd3" class="outline-3">
<h3 id="orgd64dbd3">form3</h3>
<div class="outline-text-3" id="text-orgd64dbd3">
<ul class="org-ul">
<li><p>form2 -pass2-&gt; form3</p><p>id of var is handled here</p></li>

<li><p>form3 =</p><p>('form3/var    (id level))</p><p>('form3/name   symbol)</p><p>('form3/arrow  ((form3 &#x2026;) (form3 &#x2026;)))</p><p>('form3/lambda (form3/arrow (form3/arrow &#x2026;)))</p><p>('form3/bind   ((form3/var &#x2026;) (form3 &#x2026;) leave?))</p></li>
<li><p>id = #(symbol ls)</p></li></ul>
</div>
</div>

<div id="outline-container-org234b0e5" class="outline-3">
<h3 id="org234b0e5">data</h3>
<div class="outline-text-3" id="text-org234b0e5">
<ul class="org-ul">
<li><p>form3 -pass3-&gt; data</p><p>cons &amp; trunk are created here</p></li>
<li><p>pass3 will use env passing</p><p>note that</p><p>when env passing is used</p><p>those functions would not be separately testable</p></li>
<li><p>no unification here</p><p>bs is not used here</p><p>bind just effect on the id of var</p></li>
<li><p>ns is searched</p><p>but no effect on ns</p></li>
<li><p>how should I express such in type ?</p></li>

<li><p>data =</p><p>('var    (id level))</p><p>('cons   (name (data &#x2026;)))</p><p>('arrow  ((data &#x2026;) (data &#x2026;)))</p><p>('lambda (arrow (arrow &#x2026;)))</p><p>('trunk  (arrow (arrow &#x2026;) (data &#x2026;) index))</p></li></ul>
</div>
</div>

<div id="outline-container-org7e73c3f" class="outline-3">
<h3 id="org7e73c3f">arity</h3>
<div class="outline-text-3" id="text-org7e73c3f">
<ul class="org-ul">
<li><p>there can be</p><p>arity = (number number)</p><p>in lambda &amp; trunk</p><p>but do not use separate arity for simplicity</p><p>arity is calculated from arrow repeatly</p></li></ul>
</div>
</div>

<div id="outline-container-org2c572d8" class="outline-3">
<h3 id="org2c572d8">env</h3>
<div class="outline-text-3" id="text-org2c572d8">
<ul class="org-ul">
<li><p>env = (ds bs ns)</p></li>
<li><p>ds = (data &#x2026;)</p></li>
<li><p>bs = ((id . ls) &#x2026;)</p><p><ul class="org-ul"></p><p><li><p>ls = ((level . data) &#x2026;)</p></li></ul></p></li>
<li><p>ns = ((name . meaning) &#x2026;)</p></li></ul>
</div>
</div>

<div id="outline-container-org2fc4032" class="outline-3">
<h3 id="org2fc4032">meaning</h3>
<div class="outline-text-3" id="text-org2fc4032">
<ul class="org-ul">
<li><p>meaning =</p><p>('cons/type (arrow name (name &#x2026;)))</p><p>('cons/data (arrow name name))</p><p>('lambda    (arrow (arrow &#x2026;)))</p></li></ul>
</div>
</div>

<div id="outline-container-orgc705823" class="outline-3">
<h3 id="orgc705823"><span class="todo _gt__lt_">&gt;&lt;</span> top</h3>
<div class="outline-text-3" id="text-orgc705823">
</div><div id="outline-container-org6b635b9" class="outline-4">
<h4 id="org6b635b9">top1</h4>
<div class="outline-text-4" id="text-org6b635b9">
<ul class="org-ul">
<li><p>top1 =</p><p>('dt ((form1/name form1/arrow) ((form1/name form1/arrow) &#x2026;)))</p><p>('df ((form1/name form1/arrow) (form1/arrow &#x2026;)))</p><p>('ap form1/arrow)</p></li></ul>
</div>
</div>

<div id="outline-container-org58fefa" class="outline-4">
<h4 id="org58fefa">top2</h4>
<div class="outline-text-4" id="text-org58fefa">
<ul class="org-ul">
<li><p>top2 =</p><p>('top2/dt ((form2/name form2/arrow) ((form2/name form2/arrow) &#x2026;)))</p><p>('top2/df ((form2/name form2/arrow) (form2/arrow &#x2026;)))</p><p>('top2/ap form2/arrow)</p></li></ul>
</div>
</div>
</div>

<div id="outline-container-org3ed7226" class="outline-3">
<h3 id="org3ed7226">report</h3>
<div class="outline-text-3" id="text-org3ed7226">
<ul class="org-ul">
<li><p>report =</p><p>('fail (info &#x2026;))</p><p>('success env)</p></li>
<li><p>info = &lt;free&gt;</p></li></ul>
</div>
</div>
</div>

<div id="outline-container-org7974b3d" class="outline-2">
<h2 id="org7974b3d">pass1</h2>
<div class="outline-text-2" id="text-org7974b3d">
</div><div id="outline-container-org493e20d" class="outline-3">
<h3 id="org493e20d">pass1/arrow</h3>
<div class="outline-text-3" id="text-org493e20d">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">pass1/arrow</span> default-level s)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">default-level, form1/arrow -&gt; form2/arrow</span>
  (list (pass1/cedent default-level (left-of '<span style="color: #66d9ef; font-weight: bold;">-&gt;</span> s))
        (pass1/cedent default-level (right-of '<span style="color: #66d9ef; font-weight: bold;">-&gt;</span> s))))
</pre>
</div>
</div>
</div>

<div id="outline-container-org7fa5115" class="outline-3">
<h3 id="org7fa5115">pass1/cedent</h3>
<div class="outline-text-3" id="text-org7fa5115">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">pass1/cedent</span> default-level s)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">default-level, (form1 ...) -&gt; (form2 ...)</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> s
    [() '()]
    [(h . r) (cons (pass1 default-level h)
                   (pass1/cedent default-level r))]))
</pre>
</div>
</div>
</div>

<div id="outline-container-org1d0f1ae" class="outline-3">
<h3 id="org1d0f1ae">predicates</h3>
<div class="outline-text-3" id="text-org1d0f1ae">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">form1/var?</span> v)
  (<span style="color: #f92672; font-weight: bold;">and</span> (symbol? v)
       (equal? <span style="color: #e6db74;">":"</span> (substring (symbol-&gt;string v) 0 1))))

(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">form1/name?</span> v)
  (<span style="color: #f92672; font-weight: bold;">and</span> (symbol? v)
       (not (eq? <span style="color: #e6db74;">":"</span> (substring (symbol-&gt;string v) 0 1)))))

(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">form1/arrow?</span> v)
  (<span style="color: #f92672; font-weight: bold;">and</span> (list? v)
       (member '<span style="color: #66d9ef; font-weight: bold;">-&gt;</span> v)))

(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">form1/lambda?</span> v)
  (<span style="color: #f92672; font-weight: bold;">and</span> (list? v)
       (eq? (car v) 'lambda)))

(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">form1/im-bind?</span> v)
  (<span style="color: #f92672; font-weight: bold;">and</span> (list? v)
       (member ': v)))

(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">form1/ex-bind?</span> v)
  (<span style="color: #f92672; font-weight: bold;">and</span> (list? v)
       (member '@ v)))
</pre>
</div>
</div>
</div>

<div id="outline-container-org9236da0" class="outline-3">
<h3 id="org9236da0">pass1</h3>
<div class="outline-text-3" id="text-org9236da0">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">pass1</span> default-level v)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">default-level, form1 -&gt; form2</span>
  (<span style="color: #f92672; font-weight: bold;">cond</span> [(form1/var? v)
         (list 'form2/var
               (pass1/var default-level v))]
        [(form1/name? v)
         (list 'form2/name
               v)]
        [(form1/arrow? v)
         (list 'form2/arrow
               (pass1/arrow default-level v))]
        [(form1/lambda? v)
         (list 'form2/lambda
               (list (pass1/arrow default-level (cadr v))
                     (<span style="color: #f92672; font-weight: bold;">map</span> (<span style="color: #f92672; font-weight: bold;">lambda</span> (x) (pass1/arrow default-level x))
                       (cddr v))))]
        [(form1/im-bind? v)
         (list 'form2/bind
               (list (pass1/cedent 1 (left-of ': v))
                     (pass1/cedent 0 (right-of ': v))
                     'leave))]
        [(form1/ex-bind? v)
         (list 'form2/bind
               (list (pass1/cedent 1 (left-of '@ v))
                     (pass1/cedent 0 (right-of '@ v))
                     'not-leave))]
        [else
         (<span style="color: #f92672; font-weight: bold;">orz</span> (<span style="color: #e6db74;">"pass1 can not handle sexp-form:~a"</span> v))]))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc86b45e" class="outline-3">
<h3 id="orgc86b45e">pass1/var</h3>
<div class="outline-text-3" id="text-orgc86b45e">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">pass1/var</span> default-level v)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">default-level, symbol -&gt; form2/var</span>
  (<span style="color: #f92672; font-weight: bold;">let*</span> ([str (symbol-&gt;string v)]
         [cursor (find-char <span style="color: #e6db74;">"^"</span> str)])
    (<span style="color: #f92672; font-weight: bold;">if</span> cursor
      (list (string-&gt;symbol (substring str 0 cursor))
            (string-&gt;number (substring str (+ 1 cursor))))
      (list v default-level))))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org154def4" class="outline-2">
<h2 id="org154def4">pass2</h2>
<div class="outline-text-2" id="text-org154def4">
</div><div id="outline-container-org44471b3" class="outline-3">
<h3 id="org44471b3">pass2/arrow</h3>
<div class="outline-text-3" id="text-org44471b3">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">pass2/arrow</span> a s)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">form2/arrow, scope -&gt; (form3/arrow scope)</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> a
    [(ac sc)
     (<span style="color: #f92672; font-weight: bold;">match</span> (pass2/cedent ac s)
       [(3ac s1)
        (<span style="color: #f92672; font-weight: bold;">match</span> (pass2/cedent sc s1)
          [(3sc s2)
           (list (list 3ac 3sc) s2)])])]))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgcbe332c" class="outline-3">
<h3 id="orgcbe332c">pass2/cedent</h3>
<div class="outline-text-3" id="text-orgcbe332c">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">pass2/cedent</span> c s)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">(form2 ...), scope -&gt; ((form3 ...) scope)</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> c
    [() (list '() s)]
    [(h . r)
     (<span style="color: #f92672; font-weight: bold;">match</span> (pass2 h s)
       [(3f s1)
        (<span style="color: #f92672; font-weight: bold;">match</span> (pass2/cedent r s1)
          [(3c s2)
           (list (cons 3f 3c) s2)])])]))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgae99190" class="outline-3">
<h3 id="orgae99190">pass2/lambda</h3>
<div class="outline-text-3" id="text-orgae99190">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">pass2/lambda</span> l s)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">form2/lambda, scope -&gt; (form3/lambda scope)</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> l
    [(a al)
     (list (list (pass2/arrow a s)
                 (<span style="color: #f92672; font-weight: bold;">map</span> (<span style="color: #f92672; font-weight: bold;">lambda</span> (x) (pass2/arrow x s))
                   al))
           s)]))
</pre>
</div>
</div>
</div>

<div id="outline-container-org10ac423" class="outline-3">
<h3 id="org10ac423">pass2</h3>
<div class="outline-text-3" id="text-org10ac423">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">pass2</span> f s)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">form2, scope -&gt; (form2 scope)</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> f
    [('form2/var v)
     (<span style="color: #f92672; font-weight: bold;">match</span> (pass2/var v s)
       [(v1 s1)
        (list (list 'form3/var v1) s1)])]
    [('form2/name n)
     (list (list 'form3/name n) s)]
    [('form2/arrow a)
     (<span style="color: #f92672; font-weight: bold;">match</span> (pass2/arrow a s)
       [(a1 s1)
        (list (list 'form3/arrow a1) s1)])]
    [('form2/lambda l)
     (<span style="color: #f92672; font-weight: bold;">match</span> (pass2/lambda l s)
       [(l1 s1)
        (list (list 'form3/lambda l1) s1)])]
    [('form2/bind b)
     (<span style="color: #f92672; font-weight: bold;">match</span> (pass2/bind b s)
       [(b1 s1)
        (list (list 'form3/bind b1) s1)])]))
</pre>
</div>
</div>
</div>

<div id="outline-container-org5d48e95" class="outline-3">
<h3 id="org5d48e95">pass2/var</h3>
<div class="outline-text-3" id="text-org5d48e95">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">pass2/var</span> v s)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">form2/var, scope -&gt; (form3/var scope)</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> v
    [(symbol level)
     (<span style="color: #f92672; font-weight: bold;">let</span> ([found (assq symbol s)])
       (<span style="color: #f92672; font-weight: bold;">if</span> found
         (<span style="color: #f92672; font-weight: bold;">let</span> ([old (cdr found)])
           (list (list old level)
                 s))
         (<span style="color: #f92672; font-weight: bold;">let</span> ([new (vector symbol '())])
           (list (list new level)
                 (cons (cons symbol new) s)))))]))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbe33360" class="outline-3">
<h3 id="orgbe33360">pass2/bind</h3>
<div class="outline-text-3" id="text-orgbe33360">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">pass2/bind</span> b s)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">form2/bind, scope -&gt; (form3/bind scope)</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> b
    [(vs c leave?)
     (<span style="color: #f92672; font-weight: bold;">match</span> (pass2/cedent vs s)
       [(3vs s1)
        (<span style="color: #f92672; font-weight: bold;">match</span> (pass2/cedent c s1)
          <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">this means vars in vs can occur in c</span>
          [(3c s2)
           (list (list 3vs 3c leave?) s2)])])]))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org779a759" class="outline-2">
<h2 id="org779a759">pass3</h2>
<div class="outline-text-2" id="text-org779a759">
</div><div id="outline-container-orgba65182" class="outline-3">
<h3 id="orgba65182">pass3/get-arrow</h3>
<div class="outline-text-3" id="text-orgba65182">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">pass3/get-arrow</span> a e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">form3/arrow, env -&gt; arrow</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> (pass3/arrow a e)
    [((('arrow arrow) . _) _ _)
     arrow]))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd1b7af9" class="outline-3">
<h3 id="orgd1b7af9">pass3/arrow</h3>
<div class="outline-text-3" id="text-orgd1b7af9">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">pass3/arrow</span> a e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">form3/arrow, env -&gt; env</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> e
    [(ds bs ns)
     (<span style="color: #f92672; font-weight: bold;">match</span> a
       [(ac sc)
        (<span style="color: #f92672; font-weight: bold;">match</span> (pass3/cedent ac e)
          [((d1 . _) _ _)
           (<span style="color: #f92672; font-weight: bold;">match</span> (pass3/cedent sc e)
             [((d2 . _) _ _)
              (list (cons (list 'arrow (list d1 d2))
                          ds)
                    bs
                    ns)])])])]))
</pre>
</div>
</div>
</div>

<div id="outline-container-orga788d35" class="outline-3">
<h3 id="orga788d35">pass3/cedent</h3>
<div class="outline-text-3" id="text-orga788d35">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">pass3/cedent</span> c e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">(form3 ...), env -&gt; env</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> e
    [(ds bs ns)
     (<span style="color: #f92672; font-weight: bold;">match</span> c
       [() e]
       [(h . r) (pass3/cedent r (pass3 h e))])]))
</pre>
</div>
</div>
</div>

<div id="outline-container-org5c4cdec" class="outline-3">
<h3 id="org5c4cdec">pass3/lambda</h3>
<div class="outline-text-3" id="text-org5c4cdec">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">pass3/lambda</span> l e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">form3/lambda, env -&gt; env</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> e
    [(ds bs ns)
     (<span style="color: #f92672; font-weight: bold;">match</span> l
       [(a al)
        (list (cons (list 'lambda
                          (pass3/get-arrow a e)
                          (<span style="color: #f92672; font-weight: bold;">map</span> (<span style="color: #f92672; font-weight: bold;">lambda</span> (x)
                                 (pass3/get-arrow x e))
                            al))
                    ds)
              bs
              ns)])]))
</pre>
</div>
</div>
</div>

<div id="outline-container-org195b3c0" class="outline-3">
<h3 id="org195b3c0">pass3</h3>
<div class="outline-text-3" id="text-org195b3c0">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">pass3</span> f e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">form3, env -&gt; env</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> f
    [('form3/var x) (pass3/var x e)]
    [('form3/name x) (pass3/name x e)]
    [('form3/arrow x) (pass3/arrow x e)]
    [('form3/lambda x) (pass3/lambda x e)]
    [('form3/bind x) (pass3/bind x e)]))
</pre>
</div>
</div>
</div>

<div id="outline-container-org66b5098" class="outline-3">
<h3 id="org66b5098">pass3/var</h3>
<div class="outline-text-3" id="text-org66b5098">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">pass3/var</span> v e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">form3/var, env -&gt; env</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> e
    [(ds bs ns)
     <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">actually there is no need to search bs</span>
     <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">but anyway</span>
     (list (cons (bs/deep bs (list 'var v)) ds)
           bs
           ns)]))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd4cff08" class="outline-3">
<h3 id="orgd4cff08">id-&gt;[symbol|ls]</h3>
<div class="outline-text-3" id="text-orgd4cff08">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">id-&gt;symbol</span> id)
  (vector-ref id 0))

(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">id-&gt;ls</span> id)
  (vector-ref id 1))
</pre>
</div>
</div>
</div>

<div id="outline-container-org3af8b78" class="outline-3">
<h3 id="org3af8b78"><span class="todo _gt__lt__gt__lt__gt__lt_">&gt;&lt;&gt;&lt;&gt;&lt;</span> bs/[find|walk|deep]</h3>
<div class="outline-text-3" id="text-org3af8b78">
<ul class="org-ul">
<li><p>infer level n can get level n+1</p></li>

<li><p>note how the types of these functions are different</p></li></ul>

<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">bs/find</span> bs v)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">bs, var -&gt; data or #f</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> v
    [(id level)
     (<span style="color: #f92672; font-weight: bold;">let*</span> ([level (<span style="color: #f92672; font-weight: bold;">if</span> (eq? level #f)
                     0
                     level)]
            [found/commit (assq level (id-&gt;ls id))])
       (<span style="color: #f92672; font-weight: bold;">if</span> found/commit
         (cdr found/commit)
         (<span style="color: #f92672; font-weight: bold;">let*</span> ([found/ls (assq id bs)]
                [found/bind
                 (<span style="color: #f92672; font-weight: bold;">if</span> found/ls
                   (assq level (cdr found/ls))
                   #f)])
           (<span style="color: #f92672; font-weight: bold;">if</span> found/bind
             (cdr found/bind)
             #f))))]))

(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">bs/walk</span> bs d)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">bs, data -&gt; data</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> d
    [('var v)
     (<span style="color: #f92672; font-weight: bold;">let</span> ([found (bs/find bs v)])
       (<span style="color: #f92672; font-weight: bold;">if</span> found
         (bs/walk bs found)
         d))]
    [(_ e) d]))

(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">bs/deep</span> bs d)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">bs, data -&gt; data</span>
  (<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">bs/deep-list</span> bs dl)
    (<span style="color: #f92672; font-weight: bold;">map</span> (<span style="color: #f92672; font-weight: bold;">lambda</span> (x) (bs/deep bs x)) dl))
  (<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">bs/deep-arrow</span> bs a)
    (<span style="color: #f92672; font-weight: bold;">match</span> a
      [(dl1 dl2)
       (list (bs/deep-list bs dl1)
             (bs/deep-list bs dl2))]))
  (<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">bs/deep-arrow-list</span> bs al)
    (<span style="color: #f92672; font-weight: bold;">map</span> (<span style="color: #f92672; font-weight: bold;">lambda</span> (a) (bs/deep-arrow bs a)) al))
  (<span style="color: #f92672; font-weight: bold;">match</span> (bs/walk bs d)
    [('var v) ('var v)]
    [('cons (name dl))
     (list 'cons
           (list name (bs/deep-list bs dl)))]
    [('arrow a) (list 'arrow (bs/deep-arrow bs a))]
    [('lambda (a al))
     (list 'lambda
           (list (bs/deep-arrow bs a)
                 (bs/deep-arrow-list bs al)))]
    [('trunk (a al dl i))
     (list 'trunk
           (list (bs/deep-arrow bs a)
                 (bs/deep-arrow-list bs al)
                 (bs/deep-list bs dl)
                 i))]))
</pre>
</div>
</div>
</div>

<div id="outline-container-org45fffc" class="outline-3">
<h3 id="org45fffc">pass3/name</h3>
<div class="outline-text-3" id="text-org45fffc">
<ul class="org-ul">
<li><p>this can be optimized by</p><p>to do more computations before storing things into ns</p><p>but I leave it for now</p></li></ul>

<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">pass3/name</span> n e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">form3/name, env -&gt; env</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> e
    [(ds bs ns)
     (<span style="color: #f92672; font-weight: bold;">let</span> ([found (assq n ns)])
       (<span style="color: #f92672; font-weight: bold;">if</span> (not found)
         (<span style="color: #f92672; font-weight: bold;">orz</span> (<span style="color: #e6db74;">"pass3/name unknow name : ~a~%"</span> n))
         (<span style="color: #f92672; font-weight: bold;">let</span> ([meaning (cdr found)])
           (<span style="color: #f92672; font-weight: bold;">match</span> meaning
             [('cons/type ((ac sc) name _))
              (pass3/name/cons (length ac) name e)]
             [('cons/data ((ac sc) name _))
              (pass3/name/cons (length ac) name e)]
             [('lambda ((ac sc) al))
              (pass3/name/trunk (length ac) (length sc) (cadr meaning) e)]))))]))
</pre>
</div>
</div>
</div>

<div id="outline-container-org7609bc" class="outline-3">
<h3 id="org7609bc">pass3/name/cons</h3>
<div class="outline-text-3" id="text-org7609bc">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">pass3/name/cons</span> len name e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">length, name, env -&gt; env</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> e
    [(ds bs ns)
     (list (cons (list 'cons
                       (list name (sublist ds 0 len)))
                 (sublist ds len -1))
           bs
           ns)]))
</pre>
</div>
</div>
</div>

<div id="outline-container-orga9d3a33" class="outline-3">
<h3 id="orga9d3a33">pass3/name/trunk</h3>
<div class="outline-text-3" id="text-orga9d3a33">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">pass3/name/trunk</span> len slen l e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">length, length, lambda, env -&gt; env</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> e
    [(ds bs ns)
     (<span style="color: #f92672; font-weight: bold;">match</span> l
       [(a al)
        (<span style="color: #f92672; font-weight: bold;">let*</span> ([a (copy-arrow a)]
               [al (<span style="color: #f92672; font-weight: bold;">map</span> copy-arrow al)]
               [dl (sublist ds 0 len)]
               [make-trunk (<span style="color: #f92672; font-weight: bold;">lambda</span> (i) (list 'trunk (list a al dl i)))])
          (list (append (<span style="color: #f92672; font-weight: bold;">map</span> make-trunk (genlist slen))
                        (sublist ds len -1))
                bs
                ns))])]))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgaca0575" class="outline-3">
<h3 id="orgaca0575"><span class="todo _gt__lt__gt__lt__gt__lt_">&gt;&lt;&gt;&lt;&gt;&lt;</span> pass3/bind</h3>
<div class="outline-text-3" id="text-orgaca0575">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">pass3/bind</span> b e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">form3/bind, env -&gt; env</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> b
    [(vl c leave?)
     (<span style="color: #f92672; font-weight: bold;">match</span> (pass3/cedent c e)
       [((d1 . _) _ _) <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">here I assume the c of bind is simple</span>
        (<span style="color: #f92672; font-weight: bold;">letrec</span> ([recur
                  (<span style="color: #f92672; font-weight: bold;">lambda</span> (vl e)
                    (<span style="color: #f92672; font-weight: bold;">match</span> (list vl e)
                      [(() _) e]
                      [(((id level) . r) (ds bs ns))
                       <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">&gt;&lt;&gt;&lt;&gt;&lt;</span>
                       <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">need to check if the bind already exist</span>
                       <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">and to check type</span>
                       (id/commit! id (list (cons level d1)))
                       (recur r (list (<span style="color: #f92672; font-weight: bold;">if</span> leave?
                                        (cons d1 ds)
                                        ds)
                                      bs
                                      ns))]))])
          (recur vl e))])]))
</pre>
</div>
</div>
</div>

<div id="outline-container-org260e89a" class="outline-3">
<h3 id="org260e89a">id/commit!</h3>
<div class="outline-text-3" id="text-org260e89a">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">id/commit!</span> id ls)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">id, ls -&gt; id</span>
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">effect on id</span>
  (<span style="color: #f92672; font-weight: bold;">let</span> ()
    (<span style="color: #f92672; font-weight: bold;">vector-set!</span> id 1 (append ls (vector-ref id 1)))
    id))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org10ae3e7" class="outline-2">
<h2 id="org10ae3e7">copy-arrow</h2>
<div class="outline-text-2" id="text-org10ae3e7">
</div><div id="outline-container-orgc772662" class="outline-3">
<h3 id="orgc772662"><span class="todo note">note</span> copy</h3>
<div class="outline-text-3" id="text-orgc772662">
<ul class="org-ul">
<li><p>when forming trunk from lambda which is fetched from ns</p><p>we have to copy the lambda</p></li>

<li><p>copy is arrow by arrow</p><p>every var in new arrow is different from old arrow</p><p>thus</p><p><ol class="org-ol"></p><p><li>scope is also arrow by arrow</li></p><p><li>a non-determinate var can not be substituted into lambda as it is</p><p>but is copied</li></ol></p></li>

<li><p>this copy is one of the main place where this prototype can be optimized</p><p>a vm can be designed to replace this copy function</p><p>and change the interpreter to a compiler</p></li></ul>
</div>
</div>

<div id="outline-container-orgdb135b7" class="outline-3">
<h3 id="orgdb135b7">copy-arrow</h3>
<div class="outline-text-3" id="text-orgdb135b7">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">copy-arrow</span> a)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">arrow -&gt; arrow</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> (copy/arrow a '())
    [(a s) a]))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgee3089c" class="outline-3">
<h3 id="orgee3089c">copy/arrow</h3>
<div class="outline-text-3" id="text-orgee3089c">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">copy/arrow</span> a s)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">arrow, scope -&gt; (arrow scope)</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> a
    [(ac sc)
     (<span style="color: #f92672; font-weight: bold;">match</span> (copy/cedent ac s)
       [(ac1 s1)
        (<span style="color: #f92672; font-weight: bold;">match</span> (copy/cedent sc s1)
          [(sc1 s2)
           (list ac1 sc1 s2)])])]))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgab67fd4" class="outline-3">
<h3 id="orgab67fd4">copy/cedent</h3>
<div class="outline-text-3" id="text-orgab67fd4">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">copy/cedent</span> c s)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">(data ...), scope -&gt; ((data ...) scope)</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> c
    [() (list '() s)]
    [(h . r)
     (<span style="color: #f92672; font-weight: bold;">match</span> (copy h s)
       [(h1 s1)
        (<span style="color: #f92672; font-weight: bold;">match</span> (copy/cedent r s1)
          [(r1 s2)
           (list (cons h1 r1) s2)])])]))
</pre>
</div>
</div>
</div>

<div id="outline-container-org3720dcf" class="outline-3">
<h3 id="org3720dcf">copy/lambda</h3>
<div class="outline-text-3" id="text-org3720dcf">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">copy/lambda</span> l s)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">lambda, scope -&gt; (lambda scope)</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> l
    [(a al)
     (<span style="color: #f92672; font-weight: bold;">match</span> (copy/arrow a s)
       [(a1 s1)
        (<span style="color: #f92672; font-weight: bold;">match</span> (copy/arrow-list al s1)
          [(al1 s2)
           (list (list a1 al1) s2)])])]))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd23c252" class="outline-3">
<h3 id="orgd23c252">copy/arrow-list</h3>
<div class="outline-text-3" id="text-orgd23c252">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">copy/arrow-list</span> al s)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">(arrow ...), scope -&gt; ((arrow ...) scope)</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> al
    [() (list '() s)]
    [(h . r)
     (<span style="color: #f92672; font-weight: bold;">match</span> (copy/arrow h s)
       [(h1 s1)
        (<span style="color: #f92672; font-weight: bold;">match</span> (copy/arrow-list r s1)
          [(r1 s2)
           (list (cons h1 r1) s2)])])]))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgba82d9e" class="outline-3">
<h3 id="orgba82d9e">copy</h3>
<div class="outline-text-3" id="text-orgba82d9e">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">copy</span> d s)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">data, scope -&gt; (data scope)</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> d
    [('var x)
     (<span style="color: #f92672; font-weight: bold;">match</span> (copy/var x s)
       [(x1 s1)
        (list (list 'var x1) s1)])]
    [('cons x)
     (<span style="color: #f92672; font-weight: bold;">match</span> (copy/cons x s)
       [(x1 s1)
        (list (list 'cons x1) s1)])]
    [('arrow x)
     (<span style="color: #f92672; font-weight: bold;">match</span> (copy/arrow x s)
       [(x1 s1)
        (list (list 'arrow x1) s1)])]
    [('lambda x)
     (<span style="color: #f92672; font-weight: bold;">match</span> (copy/lambda x s)
       [(x1 s1)
        (list (list 'lambda x1) s1)])]
    [('trunk x)
     (<span style="color: #f92672; font-weight: bold;">match</span> (copy/trunk x s)
       [(x1 s1)
        (list (list 'trunk x1) s1)])]))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd7a53ae" class="outline-3">
<h3 id="orgd7a53ae">copy/var</h3>
<div class="outline-text-3" id="text-orgd7a53ae">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">copy/var</span> v s)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">var, scope -&gt; (var scope)</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> v
    [(id level)
     (<span style="color: #f92672; font-weight: bold;">let</span> ([found (assq id s)])
       (<span style="color: #f92672; font-weight: bold;">if</span> found
         (list (list (cdr found) level) s)
         (<span style="color: #f92672; font-weight: bold;">let*</span> ([ls (id-&gt;ls id)]
                [id1 (vector (id-&gt;symbol id) '())]
                [s1 (cons (cons id id1) s)])
           (<span style="color: #f92672; font-weight: bold;">match</span> (copy/ls ls s1)
             [(ls1 s2)
              (id/commit! id1 ls1)
              (list (list id1 level) s2)]))))]))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf265733" class="outline-3">
<h3 id="orgf265733">copy/ls</h3>
<div class="outline-text-3" id="text-orgf265733">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">copy/ls</span> ls s)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">ls, scope -&gt; (ls scope)</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> ls
    [() (list '() s)]
    [((level . data) . r)
     (<span style="color: #f92672; font-weight: bold;">match</span> (copy data s)
       [(data1 s1)
        (<span style="color: #f92672; font-weight: bold;">match</span> (copy/ls r s1)
          [(r1 s2)
           (list (cons (cons level data1)
                       r1)
                 s2)])])]))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf933d8e" class="outline-3">
<h3 id="orgf933d8e">copy/cons</h3>
<div class="outline-text-3" id="text-orgf933d8e">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">copy/cons</span> c s)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">cons, scope -&gt; (cons scope)</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> c
    [(n dl)
     (<span style="color: #f92672; font-weight: bold;">match</span> (copy/cedent dl s)
       [(dl1 s1)
        (list (list n dl1) s1)])]))
</pre>
</div>
</div>
</div>

<div id="outline-container-org7310e9" class="outline-3">
<h3 id="org7310e9">copy/trunk</h3>
<div class="outline-text-3" id="text-org7310e9">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">copy/trunk</span> p s)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">trunk, scope -&gt; (trunk scope)</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> p
    [(a al dl i)
     (<span style="color: #f92672; font-weight: bold;">match</span> (copy/arrow a s)
       [(a1 s1)
        (<span style="color: #f92672; font-weight: bold;">match</span> (copy/arrow-list al s1)
          [(al1 s2)
           (<span style="color: #f92672; font-weight: bold;">match</span> (copy/cedent dl s2)
             [(dl1 s3)
              (list (list a1 al1 dl1 i) s3)])])])]))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org56ba480" class="outline-2">
<h2 id="org56ba480">compute-arrow</h2>
<div class="outline-text-2" id="text-org56ba480">
</div><div id="outline-container-org9979246" class="outline-3">
<h3 id="org9979246">compute-arrow</h3>
<div class="outline-text-3" id="text-org9979246">
<ul class="org-ul">
<li><p>compute is actually done by unification</p></li></ul>

<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">compute-arrow</span> a e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">arrow, env -&gt; report</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> e
    [(ds bs ns)
     (<span style="color: #f92672; font-weight: bold;">match</span> a
       [(ac sc)
        (<span style="color: #f92672; font-weight: bold;">match</span> (unify (<span style="color: #f92672; font-weight: bold;">lambda</span> (e) (compute/cedent ac e))
                      (list ds
                            (cons '(commit-point) bs)
                            ns))
          [('fail info-list)
           (list 'fail
                 (cons `(compute-arrow fail (arrow ,a)) info-list))]
          [('success e1)
           (<span style="color: #f92672; font-weight: bold;">match</span> (compute/cedent sc e1)
             [(ds2 bs2 ns2)
              (list 'success
                    (list ds2 (bs/commit! bs2) ns2))])])])]))
</pre>
</div>
</div>
</div>

<div id="outline-container-org2e548ab" class="outline-3">
<h3 id="org2e548ab">bs/commit!</h3>
<div class="outline-text-3" id="text-org2e548ab">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">bs/commit!</span> bs)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">bs -&gt; bs</span>
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">effect on part of bs</span>
  (<span style="color: #f92672; font-weight: bold;">cond</span> [(equal? '(commit-point) (car bs))
         (cdr bs)]
        [else
         (<span style="color: #f92672; font-weight: bold;">let*</span> ([pair (car bs)]
                [id (car pair)]
                [ls (cdr pair)])
           (id/commit! id ls)
           (bs/commit! (cdr bs)))]))
</pre>
</div>
</div>
</div>

<div id="outline-container-org16e7f8a" class="outline-3">
<h3 id="org16e7f8a">compute/cedent</h3>
<div class="outline-text-3" id="text-org16e7f8a">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">compute/cedent</span> c e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">cedent, env -&gt; env</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> c
    [() e]
    [(h . r) (compute/cedent r (compute h e))]))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc31f01f" class="outline-3">
<h3 id="orgc31f01f">compute</h3>
<div class="outline-text-3" id="text-orgc31f01f">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">compute</span> f e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">data, env -&gt; env</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> e
    [(ds bs ns)
     (list (cons f ds) bs ns)]))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org6739f20" class="outline-2">
<h2 id="org6739f20">unify</h2>
<div class="outline-text-2" id="text-org6739f20">
</div><div id="outline-container-org7d9d2cd" class="outline-3">
<h3 id="org7d9d2cd">unify</h3>
<div class="outline-text-3" id="text-org7d9d2cd">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">unify</span> f e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">(env -&gt; env), env -&gt; report</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> e
    [(ds bs ns)
     (<span style="color: #f92672; font-weight: bold;">match</span> (f (list (cons 'unify-point ds) bs ns))
       [(ds1 bs1 ns1)
        (<span style="color: #f92672; font-weight: bold;">let*</span> ([pl (left-of 'unify-point ds1)]
               [tmp (right-of 'unify-point ds1)]
               [len (length pl)]
               [dl (sublist tmp 0 len)]
               [ds2 (sublist tmp len -1)])
          (unify/data-list pl dl
                      (list 'success (list ds2 bs ns))))])]))
</pre>
</div>
</div>
</div>

<div id="outline-container-org2b8e12a" class="outline-3">
<h3 id="org2b8e12a">unify/data-list</h3>
<div class="outline-text-3" id="text-org2b8e12a">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">unify/data-list</span> pl dl r)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">(pattern ...), (data ...), report -&gt; report</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> r
    [('fail info-list) ('fail info-list)]
    [('success e)
     (<span style="color: #f92672; font-weight: bold;">if</span> (eq? pl '())
       r
       (unify/data-list
        (cdr pl) (cdr dl)
        (unify/data (car pl) (car dl) e)))]))
</pre>
</div>
</div>
</div>

<div id="outline-container-org6d45385" class="outline-3">
<h3 id="org6d45385">var/eq?</h3>
<div class="outline-text-3" id="text-org6d45385">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">var/eq?</span> v1 v2)
  (<span style="color: #f92672; font-weight: bold;">match</span> (list v1 v2)
    [((id1 level1) (id2 level2))
     (<span style="color: #f92672; font-weight: bold;">and</span> (eq? id1 id2)
          (eq? level1 level2))]))
</pre>
</div>
</div>
</div>

<div id="outline-container-org74e5b56" class="outline-3">
<h3 id="org74e5b56"><span class="todo _gt__lt__gt__lt__gt__lt_">&gt;&lt;&gt;&lt;&gt;&lt;</span> unify/data</h3>
<div class="outline-text-3" id="text-org74e5b56">
<ul class="org-ul">
<li><p>need to check type for fresh var</p><p>maybe more then var</p></li></ul>

<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">unify/data</span> p d e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">pattern, data, env -&gt; report</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> e
    [(ds bs ns)
     <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">var -walk-&gt; fresh-var</span>
     (<span style="color: #f92672; font-weight: bold;">let</span> ([p (bs/walk bs p)]
           [d (bs/walk bs d)])
       (<span style="color: #f92672; font-weight: bold;">match</span> (list p d)
         [(('var v1) ('var v2))
          (<span style="color: #f92672; font-weight: bold;">if</span> (var/eq? v1 v2)
            (list 'success e)
            (list 'success
                  (list ds
                        (bs/extend bs v1 d)
                        ns)))]
         [(('var v) _) (unify/var/data v d e)]
         [(_ ('var v)) (unify/var/data v p e)]

         [(('trunk t1) ('trunk t2)) (unify/trunk t1 t2 e)]
         [(('trunk t) _) (unify/trunk/data t d e)]
         [(_ ('trunk t)) (unify/trunk/data t p e)]

         [(('cons c1) ('cons c2)) (unify/cons c1 c2 e)]
         [(('arrow a1) ('arrow a2)) (unify/arrow a1 a2 e)]
         [(('lambda l1) ('lambda l2)) (unify/lambda l1 l2 e)]
         [(_ _)
          (list 'fail
                (list '(unify/data
                        fail to unify
                        (pattern: ,p) (data: ,d))))]))]))
</pre>
</div>
</div>
</div>

<div id="outline-container-org1334f1e" class="outline-3">
<h3 id="org1334f1e">bs/extend</h3>
<div class="outline-text-3" id="text-org1334f1e">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">bs/extend</span> bs v d)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">bs, var, data -&gt; bs</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> v
    [(id level)
     (<span style="color: #f92672; font-weight: bold;">let</span> ([found/ls (assq id bs)])
       (<span style="color: #f92672; font-weight: bold;">if</span> found/ls
         (substitute (cons id (cons (cons level d)
                                    (cdr found/ls)))
                     (<span style="color: #f92672; font-weight: bold;">lambda</span> (pair) (eq? (car pair) id))
                     bs)
         (cons (cons id (list (cons level d)))
               bs)))]))
</pre>
</div>
</div>
</div>

<div id="outline-container-orga1d84d2" class="outline-3">
<h3 id="orga1d84d2">unify/var/data</h3>
<div class="outline-text-3" id="text-orga1d84d2">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">unify/var/data</span> v d e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">var, data, env -&gt; report</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> e
    [(ds bs ns)
     (list 'success
           (list ds (bs/extend bs v d) ns))]))
</pre>
</div>
</div>
</div>

<div id="outline-container-org27af760" class="outline-3">
<h3 id="org27af760">unify/cons</h3>
<div class="outline-text-3" id="text-org27af760">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">unify/cons</span> c1 c2 e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">cons, cons, env -&gt; report</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> (list c1 c2)
    [((n1 dl1) (n2 dl2))
     (<span style="color: #f92672; font-weight: bold;">if</span> (eq? n1 n2)
       (unify/data-list dl1 dl2 (list 'success e))
       (list 'fail
             (list `(unify/cons
                     fail (cons1: ,c1) (cons: ,c2)))))]))
</pre>
</div>
</div>
</div>

<div id="outline-container-org8587b3f" class="outline-3">
<h3 id="org8587b3f">unify/arrow</h3>
<div class="outline-text-3" id="text-org8587b3f">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">unify/arrow</span> a1 a2 e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">arrow, arrow, env -&gt; report</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> (list a1 a2)
    [((ac1 sc1) (ac2 sc2))
     (<span style="color: #f92672; font-weight: bold;">match</span> (unify/data-list ac1 ac2 (list 'success e))
       [('success e1)
        (unify/data-list sc1 sc2 (list 'success e1))]
       [('fail info-list)
        (list 'fail
              (cons `(unify/arrow
                      fail  (arrow1: ,a1) (arrow2: ,a2))
                    info-list))])]))
</pre>
</div>
</div>
</div>

<div id="outline-container-org234a01" class="outline-3">
<h3 id="org234a01">unify/lambda</h3>
<div class="outline-text-3" id="text-org234a01">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">unify/lambda</span> l1 l2 e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">lambda, lambda, env -&gt; report</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> (list l1 l2)
    [((a1 al1) (a2 al2))
     (unify/arrow-list al1 al2 (unify/arrow a1 a2 e))]))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd362278" class="outline-3">
<h3 id="orgd362278">unify/arrow-list</h3>
<div class="outline-text-3" id="text-orgd362278">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">unify/arrow-list</span> al1 al2 r)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">(arrow ...), (arrow ...), report -&gt; report</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> r
    [('fail info-list) ('fail info-list)]
    [('success e)
     (<span style="color: #f92672; font-weight: bold;">if</span> (eq? al1 '())
       r
       (unify/arrow-list
        (cdr al1) (cdr al2)
        (unify/arrow (car al1) (car al2) e)))]))
</pre>
</div>
</div>
</div>

<div id="outline-container-org78ee75d" class="outline-3">
<h3 id="org78ee75d">unify/trunk</h3>
<div class="outline-text-3" id="text-org78ee75d">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">unify/trunk</span> t1 t2 e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">trunk, trunk, env -&gt; report</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> (list t1 t2)
    [((a1 al1 dl1) (a2 al2 dl2))
     (unify/data-list dl1 dl2 (unify/lambda (list a1 al1) (list a2 al2) e))]))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgcf0b21d" class="outline-3">
<h3 id="orgcf0b21d">unify/trunk/data</h3>
<div class="outline-text-3" id="text-orgcf0b21d">
<ul class="org-ul">
<li><p>filter here arrow-list</p></li></ul>

<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">unify/trunk/data</span> t d e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">trunk, data, env -&gt; report</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> e
    [(ds bs ns)
     (<span style="color: #f92672; font-weight: bold;">match</span> t
       [(a al dl i)
        (<span style="color: #f92672; font-weight: bold;">let*</span> ([dl1 (<span style="color: #f92672; font-weight: bold;">map</span> (<span style="color: #f92672; font-weight: bold;">lambda</span> (x) (bs/deep bs x)) dl)]
               [al1 (filter-arrow-list al dl1 e)])
          (<span style="color: #f92672; font-weight: bold;">match</span> al1
            [()
             (list 'fail
                   (list `(unify/trunk/data
                           fail arrow-list filter to
                           ()
                           (trunk: ,t)
                           (data: ,d))))]
            [(a1)
             (<span style="color: #f92672; font-weight: bold;">match</span> (compute-arrow a1 (list dl1 bs ns))
               <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">after this compute-arrow</span>
               <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">binds are commited</span>
               <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">then the old env is used</span>
               [('success e1) (unify/data (proj i e1) d e)]
               [('fail info) ('fail info)])]
            [(a1 a2 . _)
             (list 'fail
                   (list `(unify/trunk/data
                           fail arrow-list filter to
                           (arrow-list: ,al1)
                           (trunk: ,t)
                           (data: ,d))))]))])]))
</pre>
</div>
</div>
</div>

<div id="outline-container-orga286efc" class="outline-3">
<h3 id="orga286efc">proj</h3>
<div class="outline-text-3" id="text-orga286efc">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">proj</span> i e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">index, env -&gt; data</span>
  (<span style="color: #f92672; font-weight: bold;">match</span> e
    [(ds bs ns)
     (list-ref ds (- (length ds) i))]))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org7406b69" class="outline-2">
<h2 id="org7406b69">filter-arrow-list</h2>
<div class="outline-text-2" id="text-org7406b69">
<ul class="org-ul">
<li><p>no commit should be made here</p></li></ul>

<div class="org-src-container">

<pre class="src src-scheme">(<span style="color: #f92672; font-weight: bold;">define</span> (<span style="color: #a6e22e;">filter-arrow-list</span> al dl e)
  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">(arrow ...), (data ...), env -&gt; (arrow ...)</span>
  (<span style="color: #f92672; font-weight: bold;">if</span> (eq? '() al)
    '()
    (<span style="color: #f92672; font-weight: bold;">match</span> e
      [(ds bs ns)
        (<span style="color: #f92672; font-weight: bold;">match</span> (car al)
          [(ac sc)
           (<span style="color: #f92672; font-weight: bold;">match</span> (unify (<span style="color: #f92672; font-weight: bold;">lambda</span> (x) (compute/cedent ac x))
                         (list (append dl ds)
                               bs
                               ns))
             [('fail _)
              (filter-arrow-list (cdr al) dl e)]
             [('success e1)
              (cons (car al)
                    (filter-arrow-list (cdr al) dl e))])])])))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf3c49f6" class="outline-2">
<h2 id="orgf3c49f6"><span class="todo _gt__lt_">&gt;&lt;</span> eva</h2>
</div>

<div id="outline-container-orge67ddba" class="outline-2">
<h2 id="orge67ddba"><span class="todo _gt__lt_">&gt;&lt;</span> check</h2>
</div>

<div id="outline-container-orgd01b133" class="outline-2">
<h2 id="orgd01b133"><span class="todo _gt__lt_">&gt;&lt;</span> type-compute</h2>
</div>

<div id="outline-container-orgd3d0d28" class="outline-2">
<h2 id="orgd3d0d28"><span class="todo _gt__lt_">&gt;&lt;</span> sequent</h2>
</div>
</div>
<div id="postamble" class="status">
喪以不執 所執者喪 執喪相比 方死方生
</div>
</body>
</html>
