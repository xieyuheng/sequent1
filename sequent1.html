<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2016-05-08 Sun 09:43 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>sequent1</title>
<meta name="generator" content="Org-mode" />
<meta name="author" content="XIE Yuheng" />
<link rel="stylesheet" href="asset/css/page.css" type="text/css" media="screen" />
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="preamble" class="status">
喪以不執 所執者喪 執喪相比 方死方生
</div>
<div id="content">
<h1 class="title">sequent1</h1>
<div id="table-of-contents">
<h2>overview</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org67ee87a"><span class="done todo">todo</span> </a></li>
<li><a href="#org96cc8fa">helper</a>
<ul>
<li><a href="#org810ce74">cat &amp; orz</a></li>
<li><a href="#org81dbace">type &amp; :</a></li>
<li><a href="#orgf1997db">little-test</a></li>
<li><a href="#org931984e">list</a></li>
<li><a href="#org21476e">string</a></li>
</ul>
</li>
<li><a href="#org5e7bbec"><span class="todo note">note</span> data type summary</a>
<ul>
<li><a href="#orgdf6bffc">form1</a></li>
<li><a href="#org9514b3b">form2</a></li>
<li><a href="#orga16feb5">form3</a></li>
<li><a href="#orga72a7c2">data</a></li>
<li><a href="#org2e8f246">env</a></li>
<li><a href="#org9f9ba4">report</a></li>
<li><a href="#orgf84d179">top</a></li>
</ul>
</li>
<li><a href="#org98a82f0">pass1</a>
<ul>
<li><a href="#org6d49c32"><span class="todo note">note</span> </a></li>
<li><a href="#orgfe91797">pass1/arrow</a></li>
<li><a href="#org8117d1e">pass1/cedent</a></li>
<li><a href="#orgcf1bd24">predicates</a></li>
<li><a href="#org248ac29">pass1</a></li>
<li><a href="#org3ba6f21">pass1/var</a></li>
</ul>
</li>
<li><a href="#org6316252">pass2</a>
<ul>
<li><a href="#org9408574"><span class="todo note">note</span> </a></li>
<li><a href="#orgfe3956f">pass2/arrow</a></li>
<li><a href="#orgf761d03">pass2/cedent</a></li>
<li><a href="#org99f775a">pass2/lambda</a></li>
<li><a href="#org940de0a">pass2</a></li>
<li><a href="#org67cff0a">pass2/var</a></li>
<li><a href="#orgb6d8f86">pass2/bind</a></li>
</ul>
</li>
<li><a href="#orgad228c0">pass3</a>
<ul>
<li><a href="#org892c74"><span class="todo note">note</span> </a></li>
<li><a href="#org6dcb30c">env/pop</a></li>
<li><a href="#org9ee9cae">pass3/get-arrow</a></li>
<li><a href="#org6cdc707">pass3/arrow</a></li>
<li><a href="#org29897b4">pass3/cedent</a></li>
<li><a href="#orgaaf2d34">pass3/lambda</a></li>
<li><a href="#org1b6266b">pass3</a></li>
<li><a href="#orgb17b063">pass3/var</a></li>
<li><a href="#org78cc7e8">id-&gt;name &amp; id-&gt;counter &amp; id-&gt;ls</a></li>
<li><a href="#org96a2fb8">pass3/name</a></li>
<li><a href="#org4c1d95b">pass3/name/cons</a></li>
<li><a href="#orge92e4aa">pass3/name/trunk</a></li>
<li><a href="#org639cd42"><span class="todo _gt__lt__gt__lt__gt__lt_">&gt;&lt;&gt;&lt;&gt;&lt;</span> pass3/bind</a></li>
<li><a href="#org24b846b">id/commit!</a></li>
</ul>
</li>
<li><a href="#org2d4304d">bind-stack</a>
<ul>
<li><a href="#org6c6070a"><span class="todo note">note</span> </a></li>
<li><a href="#orgd91b5d5">bs/find</a></li>
<li><a href="#org97d67ed">bs/walk</a></li>
<li><a href="#org8059025">bs/deep</a></li>
</ul>
</li>
<li><a href="#orge7ae20c">copy-arrow</a>
<ul>
<li><a href="#orgae63897"><span class="todo note">note</span> </a></li>
<li><a href="#org9fb8e7f">copy-arrow</a></li>
<li><a href="#orgdbdfce5">copy/arrow</a></li>
<li><a href="#org36318a">copy/data-list</a></li>
<li><a href="#orgb2765d5">copy/cedent</a></li>
<li><a href="#org8c72f76">copy/lambda</a></li>
<li><a href="#orgdfd6101">copy/arrow-list</a></li>
<li><a href="#orgf3d2517">copy</a></li>
<li><a href="#org6d018d1">copy/var</a></li>
<li><a href="#org60fc717">copy/ls</a></li>
<li><a href="#org1255b3a">copy/cons</a></li>
<li><a href="#orgbb54c8d">copy/trunk</a></li>
</ul>
</li>
<li><a href="#org7d8b8f">compute</a>
<ul>
<li><a href="#org7a79632">compute/arrow</a></li>
<li><a href="#org627454a">bs/commit!</a></li>
<li><a href="#org89b71c5">compute/cedent</a></li>
<li><a href="#org7faaac8">compute</a></li>
<li><a href="#org843560f">compute/var</a></li>
<li><a href="#org3bd0c53">compute/cons</a></li>
<li><a href="#orgb5764ef">trunk-&gt;trunk*</a></li>
<li><a href="#org1bf19c1">compute/trunk</a></li>
<li><a href="#orgb01e9e2">filter-arrow-list</a></li>
<li><a href="#org14d0aa7">proj</a></li>
</ul>
</li>
<li><a href="#org5da08f8">print</a>
<ul>
<li><a href="#org731be6e">print/cedent</a></li>
<li><a href="#org1b5430a">print/data-list</a></li>
<li><a href="#orgb121aac">print/data</a></li>
<li><a href="#org5d8d092">print/var</a></li>
<li><a href="#org3a7bdf7">print/cons</a></li>
<li><a href="#orgd6f6eeb">print/arrow</a></li>
<li><a href="#orgbfd24e9"><span class="todo _gt__lt_">&gt;&lt;</span> print/lambda</a></li>
<li><a href="#orga5f24d1"><span class="todo _gt__lt_">&gt;&lt;</span> print/trunk</a></li>
</ul>
</li>
<li><a href="#org3898eee">unify</a>
<ul>
<li><a href="#org18c9435"><span class="todo note">note</span> </a></li>
<li><a href="#orgae2877b">unify/data-list</a></li>
<li><a href="#org987138b">var/eq?</a></li>
<li><a href="#orgd68e113"><span class="todo _gt__lt__gt__lt__gt__lt_">&gt;&lt;&gt;&lt;&gt;&lt;</span> unify/data</a></li>
<li><a href="#orgb4c304f">bs/extend</a></li>
<li><a href="#orgeb86ab0">unify/var/data</a></li>
<li><a href="#orgba2f78e">unify/cons</a></li>
<li><a href="#orgc535ae7">unify/arrow</a></li>
<li><a href="#orgb743412">unify/lambda</a></li>
<li><a href="#orgcfd622d">unify/arrow-list</a></li>
<li><a href="#orgfc6319">unify/trunk</a></li>
<li><a href="#orgce8cf01">unify/trunk/data</a></li>
</ul>
</li>
<li><a href="#org2925b27">eva</a>
<ul>
<li><a href="#org6bf1a33"><span class="todo note">note</span> </a></li>
<li><a href="#org9072e9d">check+ &amp; check- &amp; ?check</a></li>
<li><a href="#org94e1f42">init-env</a></li>
<li><a href="#org1881e7d">eva</a></li>
<li><a href="#org1cee2fc">eva/top-list</a></li>
<li><a href="#org4740c9a">parse/top</a></li>
<li><a href="#org9b120d4">parse/top/dt-body</a></li>
<li><a href="#orgf31261a">eva/top</a></li>
<li><a href="#orgf28ee75">form1/arrow-&gt;arrow</a></li>
<li><a href="#org311e1b6">eva/dt</a></li>
<li><a href="#orgb79520d">eva/df</a></li>
<li><a href="#org69c4b08">eva/ap</a></li>
</ul>
</li>
<li><a href="#org63efe40">sequent</a>
<ul>
<li><a href="#org18c02eb">sequent</a></li>
<li><a href="#org4fdadc"><span class="todo _gt__lt_">&gt;&lt;</span> sequent/repl</a></li>
</ul>
</li>
<li><a href="#orgfdc8c5">check</a>
<ul>
<li><a href="#org4fa4fc9">check</a></li>
<li><a href="#org2ca5671">check/arrow</a></li>
</ul>
</li>
<li><a href="#orgdebe45b">type-compute</a>
<ul>
<li><a href="#org1584686">type-compute/cedent</a></li>
<li><a href="#orgef3275f">type-compute</a></li>
<li><a href="#org6452bae">type-compute/var</a></li>
<li><a href="#org4f4fd84">type-compute/cons</a></li>
<li><a href="#org5abd77d">type-compute/arrow</a></li>
<li><a href="#org5438715">type-compute/lambda</a></li>
<li><a href="#orgafc7fd6">type-compute/trunk</a></li>
</ul>
</li>
<li><a href="#org1170b1a">infer</a>
<ul>
<li><a href="#org66e3b19">infer/arrow</a></li>
<li><a href="#org338f1ac">infer/arrow-list</a></li>
<li><a href="#org4253ee1">unite/arrow-list</a></li>
<li><a href="#org62485bd">unite/two</a></li>
</ul>
</li>
</ul>
</div>
</div>
<hr  />

<ul class="org-ul">
<li><p>a prototype interpreter for a lovely functional language</p><p>which uses sequent calculus as dependent type system</p></li>

<li><p>sequent is called arrow here</p><p>which is the core data type of the language</p></li>

<li><p>as a prototype implementation its unsatisfactory features are</p><p><ol class="org-ol"></p><p><li>call-by-name</li></p><p><li>using copy to handle scope</li></ol></p></li>

<li><p>source code is here <a href="https://github.com/xieyuheng/sequent1">https://github.com/xieyuheng/sequent1</a></p></li>

<li><p>XIE Yuheng created</p></li></ul>

<hr  />

<div id="outline-container-org67ee87a" class="outline-2">
<h2 id="org67ee87a"><span class="done todo">todo</span> </h2>
<div class="outline-text-2" id="text-org67ee87a">
<ul class="org-ul">
<li><p>a mechanism to export env processing primitive functions to sequent1</p></li>

<li><p>export apply to sequent1</p></li>

<li><p>test about apply and map</p></li>

<li><p>design more test to cover all the tricks</p></li>

<li><p>check-cover</p></li>

<li><p>check-recur</p></li>

<li><p>make the sequent/repl more useful then macro in scheme</p><p><ul class="org-ul"></p><p><li><p>when the program writing in sequent1 is wrong</p><p>sequent1 should handle it instead of crashing</p></li></ul></p></li></ul>
</div>
</div>

<div id="outline-container-org96cc8fa" class="outline-2">
<h2 id="org96cc8fa">helper</h2>
<div class="outline-text-2" id="text-org96cc8fa">
</div><div id="outline-container-org810ce74" class="outline-3">
<h3 id="org810ce74">cat &amp; orz</h3>
<div class="outline-text-3" id="text-org810ce74">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define-syntax</span> <span style="color: #fd971f;">cating</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">syntax-rules</span> <span style="color: #696969;">()</span>
    <span style="color: #797979;">[</span><span style="color: #696969;">(</span>cating <span style="color: #696969;">(</span>str . args<span style="color: #696969;">))</span>
     <span style="color: #696969;">(</span>format #f str . args<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #696969;">(</span>cat <span style="color: #696969;">(</span>str . args<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>str2 . args2<span style="color: #696969;">)</span> ...<span style="color: #696969;">)</span>
     <span style="color: #696969;">(</span>string-append
      <span style="color: #696969;">(</span>cating <span style="color: #696969;">(</span>str . args<span style="color: #696969;">))</span>
      <span style="color: #696969;">(</span>cating <span style="color: #696969;">(</span>str2 . args2<span style="color: #696969;">)</span> ...<span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>

<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define-syntax</span> <span style="color: #fd971f;">cat</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">syntax-rules</span> <span style="color: #696969;">()</span>
    <span style="color: #797979;">[</span><span style="color: #696969;">(</span>cat e ...<span style="color: #696969;">)</span>
     <span style="color: #696969;">(</span>format #t <span style="color: #696969;">(</span>cating e ...<span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>

<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define-syntax</span> <span style="color: #fd971f;">orz</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">syntax-rules</span> <span style="color: #696969;">()</span>
    <span style="color: #797979;">[</span><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">orz</span> who c ...<span style="color: #696969;">)</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">error</span> who <span style="color: #696969;">(</span>cating <span style="color: #696969;">(</span><span style="color: #e6db74;">"~%"</span><span style="color: #696969;">)</span> c ...<span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org81dbace" class="outline-3">
<h3 id="org81dbace">type &amp; :</h3>
<div class="outline-text-3" id="text-org81dbace">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define-syntax</span> <span style="color: #fd971f;">type</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">syntax-rules</span> <span style="color: #696969;">()</span>
    <span style="color: #797979;">[</span><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">type</span> . body<span style="color: #696969;">)</span>
     <span style="color: #696969;">(</span>void<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>

<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define-syntax</span> <span style="color: #fd971f;">:</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">syntax-rules</span> <span style="color: #696969;">()</span>
    <span style="color: #797979;">[</span><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> . body<span style="color: #696969;">)</span>
     <span style="color: #696969;">(</span>void<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf1997db" class="outline-3">
<h3 id="orgf1997db">little-test</h3>
<div class="outline-text-3" id="text-orgf1997db">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define-syntax</span> <span style="color: #fd971f;">test</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">syntax-rules</span> <span style="color: #696969;">()</span>
    <span style="color: #797979;">[</span><span style="color: #696969;">(</span>test b1 b2<span style="color: #696969;">)</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> <span style="color: #696969;">(</span>equal? b1 b2<span style="color: #696969;">)</span>
       #t
       <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let</span> <span style="color: #696969;">()</span>
         <span style="color: #696969;">(</span>cat <span style="color: #696969;">(</span><span style="color: #e6db74;">"~%"</span><span style="color: #696969;">)</span>
              <span style="color: #696969;">(</span><span style="color: #e6db74;">"&lt;begin-test-fail-report&gt;~%"</span><span style="color: #696969;">)</span>
              <span style="color: #696969;">(</span><span style="color: #e6db74;">":actual-form:~%"</span><span style="color: #696969;">))</span>
         <span style="color: #696969;">(</span>pretty-print <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">quote</span> b1<span style="color: #696969;">))</span>
         <span style="color: #696969;">(</span>cat <span style="color: #696969;">(</span><span style="color: #e6db74;">":actual-value:~%"</span><span style="color: #696969;">))</span>
         <span style="color: #696969;">(</span>pretty-print b1<span style="color: #696969;">)</span>
         <span style="color: #696969;">(</span>cat <span style="color: #696969;">(</span><span style="color: #e6db74;">":expect-form:~%"</span><span style="color: #696969;">))</span>
         <span style="color: #696969;">(</span>pretty-print <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">quote</span> b2<span style="color: #696969;">))</span>
         <span style="color: #696969;">(</span>cat <span style="color: #696969;">(</span><span style="color: #e6db74;">":expect-value:~%"</span><span style="color: #696969;">))</span>
         <span style="color: #696969;">(</span>pretty-print b2<span style="color: #696969;">)</span>
         <span style="color: #696969;">(</span>cat <span style="color: #696969;">(</span><span style="color: #e6db74;">"&lt;test-fail-report-end&gt;~%"</span><span style="color: #696969;">))</span>
         <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">orz</span> 'test <span style="color: #696969;">(</span><span style="color: #e6db74;">"&gt;_&lt;"</span><span style="color: #696969;">))))</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org931984e" class="outline-3">
<h3 id="org931984e">list</h3>
<div class="outline-text-3" id="text-org931984e">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">take</span> lis k<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let</span> <span style="color: #a6e22e;">recur</span> <span style="color: #696969;">((</span>lis lis<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>k k<span style="color: #696969;">))</span>
    <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> <span style="color: #696969;">(</span>zero? k<span style="color: #696969;">)</span> '<span style="color: #696969;">()</span>
        <span style="color: #696969;">(</span>cons <span style="color: #696969;">(</span>car lis<span style="color: #696969;">)</span>
              <span style="color: #696969;">(</span>recur <span style="color: #696969;">(</span>cdr lis<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>- k 1<span style="color: #696969;">))))))</span>

<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">drop</span> lis k<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let</span> <span style="color: #a6e22e;">iter</span> <span style="color: #696969;">((</span>lis lis<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>k k<span style="color: #696969;">))</span>
    <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> <span style="color: #696969;">(</span>zero? k<span style="color: #696969;">)</span> lis <span style="color: #696969;">(</span>iter <span style="color: #696969;">(</span>cdr lis<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>- k 1<span style="color: #696969;">)))))</span>

<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">left-of</span> s l<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> sexp list <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> list<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">cond</span> <span style="color: #797979;">[</span><span style="color: #696969;">(</span>equal? s <span style="color: #696969;">(</span>car l<span style="color: #696969;">))</span> '<span style="color: #696969;">()</span><span style="color: #797979;">]</span>
        <span style="color: #797979;">[</span>else <span style="color: #696969;">(</span>cons <span style="color: #696969;">(</span>car l<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>left-of s <span style="color: #696969;">(</span>cdr l<span style="color: #696969;">)))</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>

<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">right-of</span> s l<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> sexp list <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> list<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">cond</span> <span style="color: #797979;">[</span><span style="color: #696969;">(</span>equal? s <span style="color: #696969;">(</span>car l<span style="color: #696969;">))</span> <span style="color: #696969;">(</span>cdr l<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
        <span style="color: #797979;">[</span>else <span style="color: #696969;">(</span>right-of s <span style="color: #696969;">(</span>cdr l<span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>

<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">sublist</span> l start end<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> list index index <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> list<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">cond</span> <span style="color: #797979;">[</span><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">and</span> <span style="color: #696969;">(</span>eq? 0 start<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>&lt;= end 0<span style="color: #696969;">))</span> '<span style="color: #696969;">()</span><span style="color: #797979;">]</span>
        <span style="color: #797979;">[</span><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">and</span> <span style="color: #696969;">(</span>not <span style="color: #696969;">(</span>eq? 0 start<span style="color: #696969;">)))</span>
         <span style="color: #696969;">(</span>sublist <span style="color: #696969;">(</span>cdr l<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>- start 1<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>- end 1<span style="color: #696969;">))</span><span style="color: #797979;">]</span>
        <span style="color: #797979;">[</span><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">and</span> <span style="color: #696969;">(</span>eq? 0 start<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>not <span style="color: #696969;">(</span>eq? 0 end<span style="color: #696969;">)))</span>
         <span style="color: #696969;">(</span>cons <span style="color: #696969;">(</span>car l<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>sublist <span style="color: #696969;">(</span>cdr l<span style="color: #696969;">)</span> 0 <span style="color: #696969;">(</span>- end 1<span style="color: #696969;">)))</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>

<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">genlist</span> len<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> length <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> list<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">letrec</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>recur
            <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">lambda</span> <span style="color: #696969;">(</span>len counter<span style="color: #696969;">)</span>
              <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">cond</span> <span style="color: #797979;">[</span><span style="color: #696969;">(</span>eq? len counter<span style="color: #696969;">)</span> '<span style="color: #696969;">()</span><span style="color: #797979;">]</span>
                    <span style="color: #797979;">[</span>else <span style="color: #696969;">(</span>cons counter
                                <span style="color: #696969;">(</span>recur len <span style="color: #696969;">(</span>+ 1 counter<span style="color: #696969;">)))</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
    <span style="color: #696969;">(</span>recur len 0<span style="color: #696969;">)))</span>

<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">substitute</span> e p? l<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> element <span style="color: #696969;">(</span>element <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> bool<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>element ...<span style="color: #696969;">)</span> <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #696969;">(</span>element ...<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">cond</span> <span style="color: #797979;">[</span><span style="color: #696969;">(</span>eq? '<span style="color: #696969;">()</span> l<span style="color: #696969;">)</span> '<span style="color: #696969;">()</span><span style="color: #797979;">]</span>
        <span style="color: #797979;">[</span><span style="color: #696969;">(</span>p? <span style="color: #696969;">(</span>car l<span style="color: #696969;">))</span> <span style="color: #696969;">(</span>cons e <span style="color: #696969;">(</span>cdr l<span style="color: #696969;">))</span><span style="color: #797979;">]</span>
        <span style="color: #797979;">[</span>else <span style="color: #696969;">(</span>cons <span style="color: #696969;">(</span>car l<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>substitute e p? <span style="color: #696969;">(</span>cdr l<span style="color: #696969;">)))</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org21476e" class="outline-3">
<h3 id="org21476e">string</h3>
<div class="outline-text-3" id="text-org21476e">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">find-char</span> c s<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> char string <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">or</span> curser #f<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span>find-char/curser c s 0<span style="color: #696969;">))</span>

<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">find-char/curser</span> c s curser<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> char string curser <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">or</span> curser #f<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> <span style="color: #696969;">(</span>&gt;= curser <span style="color: #696969;">(</span>string-length s<span style="color: #696969;">))</span>
    #f
    <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>c0 <span style="color: #696969;">(</span>substring s curser <span style="color: #696969;">(</span>+ 1 curser<span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
      <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> <span style="color: #696969;">(</span>equal? c c0<span style="color: #696969;">)</span>
        curser
        <span style="color: #696969;">(</span>find-char/curser c s <span style="color: #696969;">(</span>+ 1 curser<span style="color: #696969;">))))))</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org5e7bbec" class="outline-2">
<h2 id="org5e7bbec"><span class="todo note">note</span> data type summary</h2>
<div class="outline-text-2" id="text-org5e7bbec">
</div><div id="outline-container-orgdf6bffc" class="outline-3">
<h3 id="orgdf6bffc">form1</h3>
<div class="outline-text-3" id="text-orgdf6bffc">
<ul class="org-ul">
<li><p>reduction strategy is revealed by the postfix notation</p></li></ul>

<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">type</span> form1
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">type</span> form1/var
    <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">example</span>
      <span style="color: #a6e22e;">:var</span>
      <span style="color: #a6e22e;">:var^n</span><span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">type</span> form1/name
    symbol<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">type</span> form1/arrow
    '<span style="color: #696969;">(</span>form1 ... <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> form1 ...<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">type</span> form1/lambda
    '<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">lambda</span> form1/arrow
       form1/arrow
       ...<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">type</span> form1/im-bind
    '<span style="color: #696969;">(</span>form1/var ... : form1 ...<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">type</span> form1/ex-bind
    '<span style="color: #696969;">(</span>form1/var ... @ form1 ...<span style="color: #696969;">)))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org9514b3b" class="outline-3">
<h3 id="org9514b3b">form2</h3>
<div class="outline-text-3" id="text-org9514b3b">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">type</span> form2
  <span style="color: #B380A8;">{</span>'form2/var    <span style="color: #B380A8;">{</span>symbol level<span style="color: #B380A8;">}}</span>
  <span style="color: #B380A8;">{</span>'form2/name   symbol<span style="color: #B380A8;">}</span>
  <span style="color: #B380A8;">{</span>'form2/arrow  <span style="color: #B380A8;">{{</span>form2 ...<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>form2 ...<span style="color: #B380A8;">}}}</span>
  <span style="color: #B380A8;">{</span>'form2/lambda <span style="color: #B380A8;">{</span>form2/arrow <span style="color: #B380A8;">{</span>form2/arrow ...<span style="color: #B380A8;">}}}</span>
  <span style="color: #B380A8;">{</span>'form2/bind   <span style="color: #B380A8;">{{</span>form2/var ...<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>form2 ...<span style="color: #B380A8;">}</span> leave?<span style="color: #B380A8;">}}</span><span style="color: #696969;">)</span>
<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">type</span> level natural-number<span style="color: #696969;">)</span>
<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">type</span> leave? bool<span style="color: #696969;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orga16feb5" class="outline-3">
<h3 id="orga16feb5">form3</h3>
<div class="outline-text-3" id="text-orga16feb5">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">type</span> form3
  <span style="color: #B380A8;">{</span>'form3/var    <span style="color: #B380A8;">{</span>id level<span style="color: #B380A8;">}}</span>
  <span style="color: #B380A8;">{</span>'form3/name   symbol<span style="color: #B380A8;">}</span>
  <span style="color: #B380A8;">{</span>'form3/arrow  <span style="color: #B380A8;">{{</span>form3 ...<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>form3 ...<span style="color: #B380A8;">}}}</span>
  <span style="color: #B380A8;">{</span>'form3/lambda <span style="color: #B380A8;">{</span>form3/arrow <span style="color: #B380A8;">{</span>form3/arrow ...<span style="color: #B380A8;">}}}</span>
  <span style="color: #B380A8;">{</span>'form3/bind   <span style="color: #B380A8;">{{</span>form3/var ...<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>form3 ...<span style="color: #B380A8;">}</span> leave?<span style="color: #B380A8;">}}</span><span style="color: #696969;">)</span>
<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">type</span> id #<span style="color: #696969;">((</span>name . counter<span style="color: #696969;">)</span> ls<span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orga72a7c2" class="outline-3">
<h3 id="orga72a7c2">data</h3>
<div class="outline-text-3" id="text-orga72a7c2">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">type</span> data
  <span style="color: #B380A8;">{</span>'var    <span style="color: #B380A8;">{</span>id level<span style="color: #B380A8;">}}</span>
  <span style="color: #B380A8;">{</span>'cons   <span style="color: #B380A8;">{</span>name <span style="color: #B380A8;">{</span>data ...<span style="color: #B380A8;">}}}</span>
  <span style="color: #B380A8;">{</span>'arrow  <span style="color: #B380A8;">{</span>cedent cedent<span style="color: #B380A8;">}}</span>
  <span style="color: #B380A8;">{</span>'lambda <span style="color: #B380A8;">{</span>arrow <span style="color: #B380A8;">{</span>arrow ...<span style="color: #B380A8;">}}}</span>
  <span style="color: #B380A8;">{</span>'trunk  <span style="color: #B380A8;">{</span>arrow <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">or</span> name <span style="color: #B380A8;">{</span>arrow ...<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span> <span style="color: #B380A8;">{</span>data ...<span style="color: #B380A8;">}</span> index<span style="color: #B380A8;">}}</span><span style="color: #696969;">)</span>
<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">type</span> cedent <span style="color: #B380A8;">{</span>data ...<span style="color: #B380A8;">}</span>
      <span style="color: #797979;">[</span>reverse a cedent get data-list<span style="color: #797979;">]</span><span style="color: #696969;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org2e8f246" class="outline-3">
<h3 id="org2e8f246">env</h3>
<div class="outline-text-3" id="text-org2e8f246">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">type</span> env <span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span>
<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">type</span> ds <span style="color: #B380A8;">{</span>data ...<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span>
<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">type</span> bs <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>id . ls<span style="color: #696969;">)</span> ...<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span>
<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">type</span> ns <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>name . meaning<span style="color: #696969;">)</span> ...<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span>
<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">type</span> ls <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>level . data<span style="color: #696969;">)</span> ...<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span>
<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">type</span> meaning
  <span style="color: #B380A8;">{</span>'cons/type <span style="color: #B380A8;">{</span>arrow name <span style="color: #B380A8;">{</span>name ...<span style="color: #B380A8;">}}}</span>
  <span style="color: #B380A8;">{</span>'cons/data <span style="color: #B380A8;">{</span>arrow name name<span style="color: #B380A8;">}}</span>
  <span style="color: #B380A8;">{</span>'lambda    <span style="color: #B380A8;">{</span>arrow <span style="color: #B380A8;">{</span>arrow ...<span style="color: #B380A8;">}}}</span><span style="color: #696969;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org9f9ba4" class="outline-3">
<h3 id="org9f9ba4">report</h3>
<div class="outline-text-3" id="text-org9f9ba4">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">type</span> report
  <span style="color: #B380A8;">{</span>'fail <span style="color: #B380A8;">{</span>info ...<span style="color: #B380A8;">}}</span>
  <span style="color: #B380A8;">{</span>'success env<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span>
<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">type</span> info <span style="color: #66d9ef; font-weight: bold;">&lt;free&gt;</span><span style="color: #696969;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf84d179" class="outline-3">
<h3 id="orgf84d179">top</h3>
<div class="outline-text-3" id="text-orgf84d179">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">type</span> top
  <span style="color: #B380A8;">{</span>'dt <span style="color: #B380A8;">{{</span>form1/name form1/arrow<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{{</span>form1/name form1/arrow<span style="color: #B380A8;">}</span> ...<span style="color: #B380A8;">}}}</span>
  <span style="color: #B380A8;">{</span>'df <span style="color: #B380A8;">{{</span>form1/name form1/arrow<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>form1/arrow ...<span style="color: #B380A8;">}}}</span>
  <span style="color: #B380A8;">{</span>'ap form1/arrow<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org98a82f0" class="outline-2">
<h2 id="org98a82f0">pass1</h2>
<div class="outline-text-2" id="text-org98a82f0">
</div><div id="outline-container-org6d49c32" class="outline-3">
<h3 id="org6d49c32"><span class="todo note">note</span> </h3>
<div class="outline-text-3" id="text-org6d49c32">
<ul class="org-ul">
<li><p>form1 -pass1-&gt; form2</p><p>default-level of var is handled here</p></li></ul>
</div>
</div>

<div id="outline-container-orgfe91797" class="outline-3">
<h3 id="orgfe91797">pass1/arrow</h3>
<div class="outline-text-3" id="text-orgfe91797">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">pass1/arrow</span> default-level s<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> default-level form1/arrow <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> form2/arrow<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span>list <span style="color: #696969;">(</span>pass1/cedent default-level <span style="color: #696969;">(</span>left-of '<span style="color: #66d9ef; font-weight: bold;">-&gt;</span> s<span style="color: #696969;">))</span>
        <span style="color: #696969;">(</span>pass1/cedent default-level <span style="color: #696969;">(</span>right-of '<span style="color: #66d9ef; font-weight: bold;">-&gt;</span> s<span style="color: #696969;">))))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org8117d1e" class="outline-3">
<h3 id="org8117d1e">pass1/cedent</h3>
<div class="outline-text-3" id="text-org8117d1e">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">pass1/cedent</span> default-level s<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> default-level <span style="color: #696969;">(</span>form1 ...<span style="color: #696969;">)</span> <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #696969;">(</span>form2 ...<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> s
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{}</span> <span style="color: #B380A8;">{}</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #696969;">(</span>h . r<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>cons <span style="color: #696969;">(</span>pass1 default-level h<span style="color: #696969;">)</span>
                   <span style="color: #696969;">(</span>pass1/cedent default-level r<span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgcf1bd24" class="outline-3">
<h3 id="orgcf1bd24">predicates</h3>
<div class="outline-text-3" id="text-orgcf1bd24">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">form1/var?</span> v<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">and</span> <span style="color: #696969;">(</span>symbol? v<span style="color: #696969;">)</span>
       <span style="color: #696969;">(</span>equal? <span style="color: #e6db74;">":"</span> <span style="color: #696969;">(</span>substring <span style="color: #696969;">(</span>symbol-&gt;string v<span style="color: #696969;">)</span> 0 1<span style="color: #696969;">))))</span>

<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">form1/name?</span> v<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">and</span> <span style="color: #696969;">(</span>symbol? v<span style="color: #696969;">)</span>
       <span style="color: #696969;">(</span>not <span style="color: #696969;">(</span>eq? <span style="color: #e6db74;">":"</span> <span style="color: #696969;">(</span>substring <span style="color: #696969;">(</span>symbol-&gt;string v<span style="color: #696969;">)</span> 0 1<span style="color: #696969;">)))))</span>

<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">form1/arrow?</span> v<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">and</span> <span style="color: #696969;">(</span>list? v<span style="color: #696969;">)</span>
       <span style="color: #696969;">(</span>member '<span style="color: #66d9ef; font-weight: bold;">-&gt;</span> v<span style="color: #696969;">)))</span>

<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">form1/lambda?</span> v<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">and</span> <span style="color: #696969;">(</span>list? v<span style="color: #696969;">)</span>
       <span style="color: #696969;">(</span>eq? <span style="color: #696969;">(</span>car v<span style="color: #696969;">)</span> 'lambda<span style="color: #696969;">)))</span>

<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">form1/im-bind?</span> v<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">and</span> <span style="color: #696969;">(</span>list? v<span style="color: #696969;">)</span>
       <span style="color: #696969;">(</span>member ': v<span style="color: #696969;">)))</span>

<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">form1/ex-bind?</span> v<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">and</span> <span style="color: #696969;">(</span>list? v<span style="color: #696969;">)</span>
       <span style="color: #696969;">(</span>member '@ v<span style="color: #696969;">)))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org248ac29" class="outline-3">
<h3 id="org248ac29">pass1</h3>
<div class="outline-text-3" id="text-org248ac29">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">pass1</span> default-level v<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> default-level form1 <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> form2<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">cond</span> <span style="color: #797979;">[</span><span style="color: #696969;">(</span>form1/var? v<span style="color: #696969;">)</span>
         <span style="color: #696969;">(</span>list 'form2/var
               <span style="color: #696969;">(</span>pass1/var default-level v<span style="color: #696969;">))</span><span style="color: #797979;">]</span>
        <span style="color: #797979;">[</span><span style="color: #696969;">(</span>form1/name? v<span style="color: #696969;">)</span>
         <span style="color: #696969;">(</span>list 'form2/name
               v<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
        <span style="color: #797979;">[</span><span style="color: #696969;">(</span>form1/arrow? v<span style="color: #696969;">)</span>
         <span style="color: #696969;">(</span>list 'form2/arrow
               <span style="color: #696969;">(</span>pass1/arrow default-level v<span style="color: #696969;">))</span><span style="color: #797979;">]</span>
        <span style="color: #797979;">[</span><span style="color: #696969;">(</span>form1/lambda? v<span style="color: #696969;">)</span>
         <span style="color: #696969;">(</span>list 'form2/lambda
               <span style="color: #696969;">(</span>list <span style="color: #696969;">(</span>pass1/arrow default-level <span style="color: #696969;">(</span>cadr v<span style="color: #696969;">))</span>
                     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">map</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">lambda</span> <span style="color: #696969;">(</span>x<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>pass1/arrow default-level x<span style="color: #696969;">))</span>
                       <span style="color: #696969;">(</span>cddr v<span style="color: #696969;">))))</span><span style="color: #797979;">]</span>
        <span style="color: #797979;">[</span><span style="color: #696969;">(</span>form1/im-bind? v<span style="color: #696969;">)</span>
         <span style="color: #696969;">(</span>list 'form2/bind
               <span style="color: #696969;">(</span>list <span style="color: #696969;">(</span>pass1/cedent 1 <span style="color: #696969;">(</span>left-of ': v<span style="color: #696969;">))</span>
                     <span style="color: #696969;">(</span>pass1/cedent 0 <span style="color: #696969;">(</span>right-of ': v<span style="color: #696969;">))</span>
                     #f<span style="color: #696969;">))</span><span style="color: #797979;">]</span>
        <span style="color: #797979;">[</span><span style="color: #696969;">(</span>form1/ex-bind? v<span style="color: #696969;">)</span>
         <span style="color: #696969;">(</span>list 'form2/bind
               <span style="color: #696969;">(</span>list <span style="color: #696969;">(</span>pass1/cedent 1 <span style="color: #696969;">(</span>left-of '@ v<span style="color: #696969;">))</span>
                     <span style="color: #696969;">(</span>pass1/cedent 0 <span style="color: #696969;">(</span>right-of '@ v<span style="color: #696969;">))</span>
                     #t<span style="color: #696969;">))</span><span style="color: #797979;">]</span>
        <span style="color: #797979;">[</span>else
         <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">orz</span> 'pass1 <span style="color: #696969;">(</span><span style="color: #e6db74;">"pass1 can not handle sexp-form:~a"</span> v<span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org3ba6f21" class="outline-3">
<h3 id="org3ba6f21">pass1/var</h3>
<div class="outline-text-3" id="text-org3ba6f21">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">pass1/var</span> default-level v<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> default-level symbol <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> form2/var<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let*</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>str <span style="color: #696969;">(</span>symbol-&gt;string v<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
         <span style="color: #797979;">[</span>cursor <span style="color: #696969;">(</span>find-char <span style="color: #e6db74;">"^"</span> str<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
    <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> cursor
      <span style="color: #696969;">(</span>list <span style="color: #696969;">(</span>string-&gt;symbol <span style="color: #696969;">(</span>substring str 0 cursor<span style="color: #696969;">))</span>
            <span style="color: #696969;">(</span>string-&gt;number <span style="color: #696969;">(</span>substring str <span style="color: #696969;">(</span>+ 1 cursor<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>string-length str<span style="color: #696969;">))))</span>
      <span style="color: #696969;">(</span>list v default-level<span style="color: #696969;">))))</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org6316252" class="outline-2">
<h2 id="org6316252">pass2</h2>
<div class="outline-text-2" id="text-org6316252">
</div><div id="outline-container-org9408574" class="outline-3">
<h3 id="org9408574"><span class="todo note">note</span> </h3>
<div class="outline-text-3" id="text-org9408574">
<ul class="org-ul">
<li><p>form2 -pass2-&gt; form3</p><p>id of var is handled here</p></li></ul>
</div>
</div>

<div id="outline-container-orgfe3956f" class="outline-3">
<h3 id="orgfe3956f">pass2/arrow</h3>
<div class="outline-text-3" id="text-orgfe3956f">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">pass2/arrow</span> a s<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> form2/arrow scope <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #696969;">(</span>form3/arrow scope<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> a
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ac sc<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>pass2/cedent ac s<span style="color: #696969;">)</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ac1 s1<span style="color: #B380A8;">}</span>
        <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>pass2/cedent sc s1<span style="color: #696969;">)</span>
          <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>sc1 s2<span style="color: #B380A8;">}</span>
           <span style="color: #B380A8;">{{</span>ac1 sc1<span style="color: #B380A8;">}</span> s2<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf761d03" class="outline-3">
<h3 id="orgf761d03">pass2/cedent</h3>
<div class="outline-text-3" id="text-orgf761d03">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">pass2/cedent</span> c s<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> <span style="color: #696969;">(</span>form2 ...<span style="color: #696969;">)</span> scope <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #696969;">((</span>form3 ...<span style="color: #696969;">)</span> scope<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> c
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{}</span> <span style="color: #B380A8;">{{}</span> s<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #696969;">(</span>f . r<span style="color: #696969;">)</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>pass2 f s<span style="color: #696969;">)</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>f1 s1<span style="color: #B380A8;">}</span>
        <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>pass2/cedent r s1<span style="color: #696969;">)</span>
          <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>c1 s2<span style="color: #B380A8;">}</span>
           <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>cons f1 c1<span style="color: #696969;">)</span> s2<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org99f775a" class="outline-3">
<h3 id="org99f775a">pass2/lambda</h3>
<div class="outline-text-3" id="text-org99f775a">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">pass2/lambda</span> l s<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> form2/lambda scope <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #696969;">(</span>form3/lambda scope<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> l
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>a al<span style="color: #B380A8;">}</span>
     <span style="color: #B380A8;">{{</span><span style="color: #696969;">(</span>pass2/arrow a s<span style="color: #696969;">)</span>
       <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">map</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">lambda</span> <span style="color: #696969;">(</span>x<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>pass2/arrow x s<span style="color: #696969;">))</span>
         al<span style="color: #696969;">)</span><span style="color: #B380A8;">}</span>
      s<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org940de0a" class="outline-3">
<h3 id="org940de0a">pass2</h3>
<div class="outline-text-3" id="text-org940de0a">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">pass2</span> f s<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> form2 scope <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #696969;">(</span>form2 scope<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> f
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'form2/var v<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>pass2/var v s<span style="color: #696969;">)</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>v1 s1<span style="color: #B380A8;">}</span>
        <span style="color: #B380A8;">{{</span>'form3/var v1<span style="color: #B380A8;">}</span> s1<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'form2/name n<span style="color: #B380A8;">}</span>
     <span style="color: #B380A8;">{{</span>'form3/name n<span style="color: #B380A8;">}</span> s<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'form2/arrow a<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>pass2/arrow a s<span style="color: #696969;">)</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>a1 s1<span style="color: #B380A8;">}</span>
        <span style="color: #B380A8;">{{</span>'form3/arrow a1<span style="color: #B380A8;">}</span> s1<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'form2/lambda l<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>pass2/lambda l s<span style="color: #696969;">)</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>l1 s1<span style="color: #B380A8;">}</span>
        <span style="color: #B380A8;">{{</span>'form3/lambda l1<span style="color: #B380A8;">}</span> s1<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'form2/bind b<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>pass2/bind b s<span style="color: #696969;">)</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>b1 s1<span style="color: #B380A8;">}</span>
        <span style="color: #B380A8;">{{</span>'form3/bind b1<span style="color: #B380A8;">}</span> s1<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org67cff0a" class="outline-3">
<h3 id="org67cff0a">pass2/var</h3>
<div class="outline-text-3" id="text-org67cff0a">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #a6e22e;">id/counter</span> 0<span style="color: #696969;">)</span>

<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">pass2/var</span> v s<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> form2/var scope <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #696969;">(</span>form3/var scope<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> v
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>symbol level<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>found <span style="color: #696969;">(</span>assq symbol s<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
       <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> found
         <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>old <span style="color: #696969;">(</span>cdr found<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
           <span style="color: #B380A8;">{{</span>old level<span style="color: #B380A8;">}</span> s<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span>
         <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>new <span style="color: #696969;">(</span>vector <span style="color: #696969;">(</span>cons symbol id/counter<span style="color: #696969;">)</span> '<span style="color: #696969;">())</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
           <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">set!</span> id/counter <span style="color: #696969;">(</span>+ 1 id/counter<span style="color: #696969;">))</span>
           <span style="color: #B380A8;">{{</span>new level<span style="color: #B380A8;">}</span>
            <span style="color: #696969;">(</span>cons <span style="color: #696969;">(</span>cons symbol new<span style="color: #696969;">)</span> s<span style="color: #696969;">)</span><span style="color: #B380A8;">}</span><span style="color: #696969;">)))</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb6d8f86" class="outline-3">
<h3 id="orgb6d8f86">pass2/bind</h3>
<div class="outline-text-3" id="text-orgb6d8f86">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">pass2/bind</span> b s<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> form2/bind scope <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #696969;">(</span>form3/bind scope<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> b
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>vs c leave?<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>pass2/cedent vs s<span style="color: #696969;">)</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>vs1 s1<span style="color: #B380A8;">}</span>
        <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>pass2/cedent c s1<span style="color: #696969;">)</span>
          <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">this means vars in vs can occur in c</span>
          <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>c1 s2<span style="color: #B380A8;">}</span>
           <span style="color: #B380A8;">{{</span>vs1 c1 leave?<span style="color: #B380A8;">}</span> s2<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgad228c0" class="outline-2">
<h2 id="orgad228c0">pass3</h2>
<div class="outline-text-2" id="text-orgad228c0">
</div><div id="outline-container-org892c74" class="outline-3">
<h3 id="org892c74"><span class="todo note">note</span> </h3>
<div class="outline-text-3" id="text-org892c74">
<ul class="org-ul">
<li><p>form3 -pass3-&gt; data</p><p>cons &amp; trunk are created here</p></li>

<li><p>note that</p><p>we are building new function body</p><p>with the help of the data-stack</p><p>thus</p><p>whenever a list of data in data-stack are used to form a function body</p><p>the list should be reversed</p></li>

<li><p>pass3 will use env passing</p><p>note that</p><p>when env passing is used</p><p>those functions would not be separately testable</p></li>

<li><p>no unification here</p><p>bs is not used here</p><p>bind just effect on the id of var</p></li>

<li><p>ns is searched</p><p>but no effect on ns</p></li>

<li><p>how should I express such in type ?</p></li></ul>
</div>
</div>

<div id="outline-container-org6dcb30c" class="outline-3">
<h3 id="org6dcb30c">env/pop</h3>
<div class="outline-text-3" id="text-org6dcb30c">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">env/pop</span> e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #696969;">(</span>data env<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>d . r<span style="color: #696969;">)</span> bs ns<span style="color: #B380A8;">}</span>
     <span style="color: #B380A8;">{</span>d <span style="color: #B380A8;">{</span>r bs ns<span style="color: #B380A8;">}}</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org9ee9cae" class="outline-3">
<h3 id="org9ee9cae">pass3/get-arrow</h3>
<div class="outline-text-3" id="text-org9ee9cae">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">pass3/get-arrow</span> a e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> form3/arrow env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> arrow<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>env/pop <span style="color: #696969;">(</span>pass3/arrow a e<span style="color: #696969;">))</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{{</span>'arrow arrow<span style="color: #B380A8;">}</span> __<span style="color: #B380A8;">}</span>
     arrow<span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org6cdc707" class="outline-3">
<h3 id="org6cdc707">pass3/arrow</h3>
<div class="outline-text-3" id="text-org6cdc707">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">pass3/arrow</span> a e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> form3/arrow env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> env<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> a
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ac sc<span style="color: #B380A8;">}</span>
        <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>pass3/cedent ac e<span style="color: #696969;">)</span>
          <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds1 __ __<span style="color: #B380A8;">}</span>
           <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>pass3/cedent sc e<span style="color: #696969;">)</span>
             <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds2 __ __<span style="color: #B380A8;">}</span>
              <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>cons <span style="color: #B380A8;">{</span>'arrow <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>reverse ds1<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reverse ds2<span style="color: #696969;">)</span><span style="color: #B380A8;">}}</span>
                     ds<span style="color: #696969;">)</span>
               bs
               ns<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org29897b4" class="outline-3">
<h3 id="org29897b4">pass3/cedent</h3>
<div class="outline-text-3" id="text-org29897b4">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">pass3/cedent</span> c e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> <span style="color: #696969;">(</span>form3 ...<span style="color: #696969;">)</span> env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> env<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> c
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{}</span> e<span style="color: #797979;">]</span>
       <span style="color: #797979;">[</span><span style="color: #696969;">(</span>h . r<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>pass3/cedent r <span style="color: #696969;">(</span>pass3 h e<span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgaaf2d34" class="outline-3">
<h3 id="orgaaf2d34">pass3/lambda</h3>
<div class="outline-text-3" id="text-orgaaf2d34">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">pass3/lambda</span> l e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> form3/lambda env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> env<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> l
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>a al<span style="color: #B380A8;">}</span>
        <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>cons <span style="color: #B380A8;">{</span>'lambda <span style="color: #696969;">(</span>pass3/get-arrow a e<span style="color: #696969;">)</span>
                 <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">map</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">lambda</span> <span style="color: #696969;">(</span>x<span style="color: #696969;">)</span>
                        <span style="color: #696969;">(</span>pass3/get-arrow x e<span style="color: #696969;">))</span>
                   al<span style="color: #696969;">)</span><span style="color: #B380A8;">}</span>
               ds<span style="color: #696969;">)</span>
         bs
         ns<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org1b6266b" class="outline-3">
<h3 id="org1b6266b">pass3</h3>
<div class="outline-text-3" id="text-org1b6266b">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">pass3</span> f e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> form3 env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> env<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> f
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'form3/var x<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>pass3/var x e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'form3/name x<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>pass3/name x e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'form3/arrow x<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>pass3/arrow x e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'form3/lambda x<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>pass3/lambda x e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'form3/bind x<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>pass3/bind x e<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb17b063" class="outline-3">
<h3 id="orgb17b063">pass3/var</h3>
<div class="outline-text-3" id="text-orgb17b063">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">pass3/var</span> v e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> form3/var env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> env<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span>
     <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">actually there is no need to search bs</span>
     <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">but anyway</span>
     <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>cons <span style="color: #696969;">(</span>bs/deep bs <span style="color: #B380A8;">{</span>'var v<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span> ds<span style="color: #696969;">)</span>
      bs
      ns<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org78cc7e8" class="outline-3">
<h3 id="org78cc7e8">id-&gt;name &amp; id-&gt;counter &amp; id-&gt;ls</h3>
<div class="outline-text-3" id="text-org78cc7e8">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">id-&gt;name</span> id<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span>car <span style="color: #696969;">(</span>vector-ref id 0<span style="color: #696969;">)))</span>

<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">id-&gt;counter</span> id<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span>cdr <span style="color: #696969;">(</span>vector-ref id 0<span style="color: #696969;">)))</span>

<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">id-&gt;ls</span> id<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span>vector-ref id 1<span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org96a2fb8" class="outline-3">
<h3 id="org96a2fb8">pass3/name</h3>
<div class="outline-text-3" id="text-org96a2fb8">
<ul class="org-ul">
<li><p>this can be optimized by</p><p>to do more computations before storing things into ns</p><p>but I leave it for now</p></li></ul>

<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">pass3/name</span> n e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> form3/name env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> env<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>found <span style="color: #696969;">(</span>assq n ns<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
       <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> <span style="color: #696969;">(</span>not found<span style="color: #696969;">)</span>
         <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">orz</span> 'pass3/name <span style="color: #696969;">(</span><span style="color: #e6db74;">"unknow name : ~a~%"</span> n<span style="color: #696969;">))</span>
         <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>meaning <span style="color: #696969;">(</span>cdr found<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
           <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> meaning
             <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'cons/type <span style="color: #B380A8;">{{</span>ac sc<span style="color: #B380A8;">}</span> n1 __<span style="color: #B380A8;">}}</span>
              <span style="color: #696969;">(</span>pass3/name/cons <span style="color: #696969;">(</span>length ac<span style="color: #696969;">)</span> n1 e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
             <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'cons/data <span style="color: #B380A8;">{{</span>ac sc<span style="color: #B380A8;">}</span> n1 __<span style="color: #B380A8;">}}</span>
              <span style="color: #696969;">(</span>pass3/name/cons <span style="color: #696969;">(</span>length ac<span style="color: #696969;">)</span> n1 e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
             <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'lambda <span style="color: #B380A8;">{{</span>ac sc<span style="color: #B380A8;">}</span> __<span style="color: #B380A8;">}}</span>
              <span style="color: #696969;">(</span>pass3/name/trunk <span style="color: #696969;">(</span>length ac<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>length sc<span style="color: #696969;">)</span> <span style="color: #B380A8;">{</span>ac sc<span style="color: #B380A8;">}</span> n e<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))))</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org4c1d95b" class="outline-3">
<h3 id="org4c1d95b">pass3/name/cons</h3>
<div class="outline-text-3" id="text-org4c1d95b">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">pass3/name/cons</span> len name e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> length name env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> env<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span>
     <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>cons <span style="color: #B380A8;">{</span>'cons
             <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">dl in cons is as the order of dl in start</span>
             <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">thus no reverse is needed</span>
             <span style="color: #B380A8;">{</span>name <span style="color: #696969;">(</span>sublist ds 0 len<span style="color: #696969;">)</span><span style="color: #B380A8;">}}</span>
            <span style="color: #696969;">(</span>sublist ds len <span style="color: #696969;">(</span>length ds<span style="color: #696969;">)))</span>
      bs
      ns<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orge92e4aa" class="outline-3">
<h3 id="orge92e4aa">pass3/name/trunk</h3>
<div class="outline-text-3" id="text-orge92e4aa">
<ul class="org-ul">
<li><p>when intro a trunk</p><p>only name should be recorded not the body</p><p>this is to handle recursive definitions</p></li>

<li><p>type arrow needs to be copied</p></li></ul>

<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">pass3/name/trunk</span> len slen a n e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> length length arrow name env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> env<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let*</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>a <span style="color: #696969;">(</span>copy-arrow a<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
            <span style="color: #797979;">[</span>dl <span style="color: #696969;">(</span>sublist ds 0 len<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
            <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">dl in trunk is as the order of dl in start</span>
            <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">thus no reverse is needed</span>
            <span style="color: #797979;">[</span>make-trunk <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">lambda</span> <span style="color: #696969;">(</span>i<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>list 'trunk <span style="color: #696969;">(</span>list a n dl i<span style="color: #696969;">)))</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
       <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>append <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">map</span> make-trunk <span style="color: #696969;">(</span>genlist slen<span style="color: #696969;">))</span>
                <span style="color: #696969;">(</span>sublist ds len <span style="color: #696969;">(</span>length ds<span style="color: #696969;">)))</span>
        bs
        ns<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org639cd42" class="outline-3">
<h3 id="org639cd42"><span class="todo _gt__lt__gt__lt__gt__lt_">&gt;&lt;&gt;&lt;&gt;&lt;</span> pass3/bind</h3>
<div class="outline-text-3" id="text-org639cd42">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">pass3/bind</span> b e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> form3/bind env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> env<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> b
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>vl c leave?<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>pass3/cedent c e<span style="color: #696969;">)</span>
       <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">&gt;&lt;&gt;&lt;&gt;&lt;</span>
       <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">here I assume the c returns only one data</span>
       <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">actual error handling is needed</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>d1 . __<span style="color: #696969;">)</span> __ __<span style="color: #B380A8;">}</span>
        <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">letrec</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>recur
                  <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">(: (form3/var ...) env -&gt; env)</span>
                  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">lambda</span> <span style="color: #696969;">(</span>vl e<span style="color: #696969;">)</span>
                    <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
                      <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span>
                       <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> vl
                         <span style="color: #797979;">[</span><span style="color: #B380A8;">{}</span> e<span style="color: #797979;">]</span>
                         <span style="color: #797979;">[</span><span style="color: #696969;">(</span><span style="color: #B380A8;">{</span>'form3/var <span style="color: #B380A8;">{</span>id level<span style="color: #B380A8;">}}</span> . r<span style="color: #696969;">)</span>
                          <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">&gt;&lt;&gt;&lt;&gt;&lt;</span>
                          <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">no error handling here</span>
                          <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">&gt;&lt;&gt;&lt;&gt;&lt;</span>
                          <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">need to check if the bind already exist</span>
                          <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">and to check type</span>
                          <span style="color: #696969;">(</span>id/commit! id <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>cons level d1<span style="color: #696969;">)</span><span style="color: #B380A8;">}</span><span style="color: #696969;">)</span>
                          <span style="color: #696969;">(</span>recur r <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> leave?
                                      <span style="color: #696969;">(</span>cons d1 ds<span style="color: #696969;">)</span>
                                      ds<span style="color: #696969;">)</span>
                                    bs
                                    ns<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
          <span style="color: #696969;">(</span>recur vl e<span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org24b846b" class="outline-3">
<h3 id="org24b846b">id/commit!</h3>
<div class="outline-text-3" id="text-org24b846b">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">id/commit!</span> id ls<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> id ls <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> id
     <span style="color: #797979;">[</span>with effect on id<span style="color: #797979;">]</span><span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let</span> <span style="color: #696969;">()</span>
    <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">vector-set!</span> id 1 <span style="color: #696969;">(</span>append ls <span style="color: #696969;">(</span>vector-ref id 1<span style="color: #696969;">)))</span>
    id<span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org2d4304d" class="outline-2">
<h2 id="org2d4304d">bind-stack</h2>
<div class="outline-text-2" id="text-org2d4304d">
</div><div id="outline-container-org6c6070a" class="outline-3">
<h3 id="org6c6070a"><span class="todo note">note</span> </h3>
<div class="outline-text-3" id="text-org6c6070a">
<ul class="org-ul">
<li><p>&gt;&lt;&gt;&lt;&gt;&lt;</p></li>

<li><p>infer level n can get level n+1</p></li>

<li><p>note how the types of these functions are different</p></li></ul>
</div>
</div>

<div id="outline-container-orgd91b5d5" class="outline-3">
<h3 id="orgd91b5d5">bs/find</h3>
<div class="outline-text-3" id="text-orgd91b5d5">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">bs/find</span> bs v<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> bs var <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">or</span> data #f<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> v
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>id level<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let*</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>level <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> <span style="color: #696969;">(</span>eq? level #f<span style="color: #696969;">)</span>
                     0
                     level<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
            <span style="color: #797979;">[</span>found/commit <span style="color: #696969;">(</span>assq level <span style="color: #696969;">(</span>id-&gt;ls id<span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
       <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> found/commit
         <span style="color: #696969;">(</span>cdr found/commit<span style="color: #696969;">)</span>
         <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let*</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>found/ls <span style="color: #696969;">(</span>assq id bs<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
                <span style="color: #797979;">[</span>found/bind
                 <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> found/ls
                   <span style="color: #696969;">(</span>assq level <span style="color: #696969;">(</span>cdr found/ls<span style="color: #696969;">))</span>
                   #f<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
           <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> found/bind
             <span style="color: #696969;">(</span>cdr found/bind<span style="color: #696969;">)</span>
             #f<span style="color: #696969;">))))</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org97d67ed" class="outline-3">
<h3 id="org97d67ed">bs/walk</h3>
<div class="outline-text-3" id="text-org97d67ed">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">bs/walk</span> bs d<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> bs data <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> data<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> d
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'var v<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>found <span style="color: #696969;">(</span>bs/find bs v<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
       <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> found
         <span style="color: #696969;">(</span>bs/walk bs found<span style="color: #696969;">)</span>
         d<span style="color: #696969;">))</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>__ e<span style="color: #B380A8;">}</span> d<span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org8059025" class="outline-3">
<h3 id="org8059025">bs/deep</h3>
<div class="outline-text-3" id="text-org8059025">
<ul class="org-ul">
<li><p>do not handle trunk here</p><p>because I think maybe no computations should be done in pass3</p></li></ul>

<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">bs/deep</span> bs d<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> bs data <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> data<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">letrec*</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>bs/deep-list
             <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">lambda</span> <span style="color: #696969;">(</span>bs dl<span style="color: #696969;">)</span>
               <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">map</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">lambda</span> <span style="color: #696969;">(</span>x<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>bs/deep bs x<span style="color: #696969;">))</span> dl<span style="color: #696969;">))</span><span style="color: #797979;">]</span>
            <span style="color: #797979;">[</span>bs/deep-arrow
             <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">lambda</span> <span style="color: #696969;">(</span>bs a<span style="color: #696969;">)</span>
               <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> a
                 <span style="color: #797979;">[</span><span style="color: #696969;">(</span>dl1 dl2<span style="color: #696969;">)</span>
                  <span style="color: #696969;">(</span>list <span style="color: #696969;">(</span>bs/deep-list bs dl1<span style="color: #696969;">)</span>
                        <span style="color: #696969;">(</span>bs/deep-list bs dl2<span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span><span style="color: #797979;">]</span>
            <span style="color: #797979;">[</span>bs/deep-arrow-list
             <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">lambda</span> <span style="color: #696969;">(</span>bs al<span style="color: #696969;">)</span>
               <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">map</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">lambda</span> <span style="color: #696969;">(</span>a<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>bs/deep-arrow bs a<span style="color: #696969;">))</span> al<span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
    <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>bs/walk bs d<span style="color: #696969;">)</span>
      <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'var v<span style="color: #B380A8;">}</span>
       <span style="color: #B380A8;">{</span>'var v<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
      <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'cons <span style="color: #696969;">(</span>name dl<span style="color: #696969;">)</span><span style="color: #B380A8;">}</span>
       <span style="color: #B380A8;">{</span>'cons <span style="color: #B380A8;">{</span>name <span style="color: #696969;">(</span>bs/deep-list bs dl<span style="color: #696969;">)</span><span style="color: #B380A8;">}}</span><span style="color: #797979;">]</span>
      <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'arrow a<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'arrow <span style="color: #696969;">(</span>bs/deep-arrow bs a<span style="color: #696969;">)</span><span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
      <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'lambda <span style="color: #696969;">(</span>a al<span style="color: #696969;">)</span><span style="color: #B380A8;">}</span>
       <span style="color: #B380A8;">{</span>'lambda <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>bs/deep-arrow bs a<span style="color: #696969;">)</span>
                 <span style="color: #696969;">(</span>bs/deep-arrow-list bs al<span style="color: #696969;">)</span><span style="color: #B380A8;">}}</span><span style="color: #797979;">]</span>
      <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'trunk <span style="color: #696969;">(</span>a al dl i<span style="color: #696969;">)</span><span style="color: #B380A8;">}</span>
       <span style="color: #B380A8;">{</span>'trunk
         <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>bs/deep-arrow bs a<span style="color: #696969;">)</span>
          <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> <span style="color: #696969;">(</span>symbol? al<span style="color: #696969;">)</span>
            al
            <span style="color: #696969;">(</span>bs/deep-arrow-list bs al<span style="color: #696969;">))</span>
          <span style="color: #696969;">(</span>bs/deep-list bs dl<span style="color: #696969;">)</span>
          i<span style="color: #B380A8;">}}</span><span style="color: #797979;">]</span><span style="color: #696969;">)))</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orge7ae20c" class="outline-2">
<h2 id="orge7ae20c">copy-arrow</h2>
<div class="outline-text-2" id="text-orge7ae20c">
</div><div id="outline-container-orgae63897" class="outline-3">
<h3 id="orgae63897"><span class="todo note">note</span> </h3>
<div class="outline-text-3" id="text-orgae63897">
<ul class="org-ul">
<li><p>the name in trunk will be changed to (arrow &#x2026;)</p><p>(arrow &#x2026;) is fetched from ns and copied</p></li>

<li><p><p></p><p>copy-arrow is called when</p><p></p></p><p><table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides"></p><p></p><p></p><p><colgroup></p><p><col  class="org-left" /></p><p></p><p><col  class="org-left" /></p><p></colgroup></p><p><tbody></p><p><tr></p><p><td class="org-left">trunk intro in pass3</td></p><p><td class="org-left">copy type arrow</td></p><p></tr></p><p></p><p><tr></p><p><td class="org-left">trunk-&gt;trunk*</td></p><p><td class="org-left">copy body arrow-list</td></p><p></tr></p><p></p><p><tr></p><p><td class="org-left">compute/arrow in type-compute</td></p><p><td class="org-left">copy arrow to maintain undo-ablity</td></p><p></tr></p><p></tbody></p><p></table></p></li>

<li><p>copy is arrow by arrow</p><p>every var in new arrow is different from old arrow</p><p>thus</p><p><ol class="org-ol"></p><p><li>scope is also arrow by arrow</li></p><p><li>a non-determinate var can not be substituted into lambda as it is</p><p>but is copied</li></ol></p></li>

<li><p>this copy is one of the main place where this prototype can be optimized</p><p>a vm can be designed to replace this copy function</p><p>and change the interpreter to a compiler</p></li></ul>
</div>
</div>

<div id="outline-container-org9fb8e7f" class="outline-3">
<h3 id="org9fb8e7f">copy-arrow</h3>
<div class="outline-text-3" id="text-org9fb8e7f">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">copy-arrow</span> a<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> arrow <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> arrow<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>copy/arrow a '<span style="color: #696969;">())</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>a s<span style="color: #B380A8;">}</span> a<span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgdbdfce5" class="outline-3">
<h3 id="orgdbdfce5">copy/arrow</h3>
<div class="outline-text-3" id="text-orgdbdfce5">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">copy/arrow</span> a s<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> arrow scope <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #696969;">(</span>arrow scope<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> a
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ac sc<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>copy/cedent ac s<span style="color: #696969;">)</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ac1 s1<span style="color: #B380A8;">}</span>
        <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>copy/cedent sc s1<span style="color: #696969;">)</span>
          <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>sc1 s2<span style="color: #B380A8;">}</span>
           <span style="color: #B380A8;">{{</span>ac1 sc1<span style="color: #B380A8;">}</span> s2<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org36318a" class="outline-3">
<h3 id="org36318a">copy/data-list</h3>
<div class="outline-text-3" id="text-org36318a">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">copy/data-list</span> dl s<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> <span style="color: #696969;">(</span>data ...<span style="color: #696969;">)</span> scope <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #696969;">((</span>data ...<span style="color: #696969;">)</span> scope<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span>copy/cedent dl s<span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb2765d5" class="outline-3">
<h3 id="orgb2765d5">copy/cedent</h3>
<div class="outline-text-3" id="text-orgb2765d5">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">copy/cedent</span> c s<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> cedent scope <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #696969;">(</span>cedent scope<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> c
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{}</span> <span style="color: #B380A8;">{{}</span> s<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #696969;">(</span>h . r<span style="color: #696969;">)</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>copy h s<span style="color: #696969;">)</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>h1 s1<span style="color: #B380A8;">}</span>
        <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>copy/cedent r s1<span style="color: #696969;">)</span>
          <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>r1 s2<span style="color: #B380A8;">}</span>
           <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>cons h1 r1<span style="color: #696969;">)</span> s2<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org8c72f76" class="outline-3">
<h3 id="org8c72f76">copy/lambda</h3>
<div class="outline-text-3" id="text-org8c72f76">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">copy/lambda</span> l s<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> lambda scope <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">lambda</span> scope<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> l
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>a al<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>copy/arrow a s<span style="color: #696969;">)</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>a1 s1<span style="color: #B380A8;">}</span>
        <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>copy/arrow-list al s1<span style="color: #696969;">)</span>
          <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>al1 s2<span style="color: #B380A8;">}</span>
           <span style="color: #B380A8;">{{</span>a1 al1<span style="color: #B380A8;">}</span> s2<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgdfd6101" class="outline-3">
<h3 id="orgdfd6101">copy/arrow-list</h3>
<div class="outline-text-3" id="text-orgdfd6101">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">copy/arrow-list</span> al s<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> <span style="color: #696969;">(</span>arrow ...<span style="color: #696969;">)</span> scope <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #696969;">((</span>arrow ...<span style="color: #696969;">)</span> scope<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> al
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{}</span> <span style="color: #B380A8;">{{}</span> s<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #696969;">(</span>h . r<span style="color: #696969;">)</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>copy/arrow h s<span style="color: #696969;">)</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>h1 s1<span style="color: #B380A8;">}</span>
        <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>copy/arrow-list r s1<span style="color: #696969;">)</span>
          <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>r1 s2<span style="color: #B380A8;">}</span>
           <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>cons h1 r1<span style="color: #696969;">)</span> s2<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf3d2517" class="outline-3">
<h3 id="orgf3d2517">copy</h3>
<div class="outline-text-3" id="text-orgf3d2517">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">copy</span> d s<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> data scope <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #696969;">(</span>data scope<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> d
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'var x<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>copy/var x s<span style="color: #696969;">)</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>x1 s1<span style="color: #B380A8;">}</span>
        <span style="color: #B380A8;">{{</span>'var x1<span style="color: #B380A8;">}</span> s1<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'cons x<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>copy/cons x s<span style="color: #696969;">)</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>x1 s1<span style="color: #B380A8;">}</span>
        <span style="color: #B380A8;">{{</span>'cons x1<span style="color: #B380A8;">}</span> s1<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'arrow x<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>copy/arrow x s<span style="color: #696969;">)</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>x1 s1<span style="color: #B380A8;">}</span>
        <span style="color: #B380A8;">{{</span>'arrow x1<span style="color: #B380A8;">}</span> s1<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'lambda x<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>copy/lambda x s<span style="color: #696969;">)</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>x1 s1<span style="color: #B380A8;">}</span>
        <span style="color: #B380A8;">{{</span>'lambda x1<span style="color: #B380A8;">}</span> s1<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'trunk x<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>copy/trunk x s<span style="color: #696969;">)</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>x1 s1<span style="color: #B380A8;">}</span>
        <span style="color: #B380A8;">{{</span>'trunk x1<span style="color: #B380A8;">}</span> s1<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org6d018d1" class="outline-3">
<h3 id="org6d018d1">copy/var</h3>
<div class="outline-text-3" id="text-org6d018d1">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">copy/var</span> v s<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> var scope <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #696969;">(</span>var scope<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> v
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>id level<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>found <span style="color: #696969;">(</span>assq id s<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
       <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> found
         <span style="color: #B380A8;">{{</span><span style="color: #696969;">(</span>cdr found<span style="color: #696969;">)</span> level<span style="color: #B380A8;">}</span> s<span style="color: #B380A8;">}</span>
         <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let*</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>ls <span style="color: #696969;">(</span>id-&gt;ls id<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
                <span style="color: #797979;">[</span>id1 <span style="color: #696969;">(</span>vector <span style="color: #696969;">(</span>cons <span style="color: #696969;">(</span>id-&gt;name id<span style="color: #696969;">)</span> id/counter<span style="color: #696969;">)</span> '<span style="color: #696969;">())</span><span style="color: #797979;">]</span>
                <span style="color: #797979;">[</span>s1 <span style="color: #696969;">(</span>cons <span style="color: #696969;">(</span>cons id id1<span style="color: #696969;">)</span> s<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
           <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">set!</span> id/counter <span style="color: #696969;">(</span>+ 1 id/counter<span style="color: #696969;">))</span>
           <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>copy/ls ls s1<span style="color: #696969;">)</span>
             <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ls1 s2<span style="color: #B380A8;">}</span>
              <span style="color: #696969;">(</span>id/commit! id1 ls1<span style="color: #696969;">)</span>
              <span style="color: #B380A8;">{{</span>id1 level<span style="color: #B380A8;">}</span> s2<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">))))</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org60fc717" class="outline-3">
<h3 id="org60fc717">copy/ls</h3>
<div class="outline-text-3" id="text-org60fc717">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">copy/ls</span> ls s<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> ls scope <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #696969;">(</span>ls scope<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> ls
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{}</span> <span style="color: #B380A8;">{{}</span> s<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #696969;">((</span>level . data<span style="color: #696969;">)</span> . r<span style="color: #696969;">)</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>copy data s<span style="color: #696969;">)</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>data1 s1<span style="color: #B380A8;">}</span>
        <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>copy/ls r s1<span style="color: #696969;">)</span>
          <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>r1 s2<span style="color: #B380A8;">}</span>
           <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>cons <span style="color: #696969;">(</span>cons level data1<span style="color: #696969;">)</span>
                  r1<span style="color: #696969;">)</span>
            s2<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org1255b3a" class="outline-3">
<h3 id="org1255b3a">copy/cons</h3>
<div class="outline-text-3" id="text-org1255b3a">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">copy/cons</span> c s<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> cons scope <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #696969;">(</span>cons scope<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> c
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>n dl<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>copy/data-list dl s<span style="color: #696969;">)</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>dl1 s1<span style="color: #B380A8;">}</span>
        <span style="color: #B380A8;">{{</span>n dl1<span style="color: #B380A8;">}</span> s1<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbb54c8d" class="outline-3">
<h3 id="orgbb54c8d">copy/trunk</h3>
<div class="outline-text-3" id="text-orgbb54c8d">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">copy/trunk</span> p s<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> trunk scope <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">trunk</span> scope<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> p
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>a al dl i<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> <span style="color: #696969;">(</span>symbol? al<span style="color: #696969;">)</span>
       <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>copy/arrow a s<span style="color: #696969;">)</span>
         <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>a1 s1<span style="color: #B380A8;">}</span>
          <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>copy/data-list dl s1<span style="color: #696969;">)</span>
            <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>dl1 s2<span style="color: #B380A8;">}</span>
             <span style="color: #B380A8;">{{</span>a1 al dl1 i<span style="color: #B380A8;">}</span> s2<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
       <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>copy/arrow a s<span style="color: #696969;">)</span>
         <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>a1 s1<span style="color: #B380A8;">}</span>
          <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>copy/arrow-list al s1<span style="color: #696969;">)</span>
            <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>al1 s2<span style="color: #B380A8;">}</span>
             <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>copy/data-list dl s2<span style="color: #696969;">)</span>
               <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>dl1 s3<span style="color: #B380A8;">}</span>
                <span style="color: #B380A8;">{{</span>a1 al1 dl1 i<span style="color: #B380A8;">}</span> s3<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org7d8b8f" class="outline-2">
<h2 id="org7d8b8f">compute</h2>
<div class="outline-text-2" id="text-org7d8b8f">
</div><div id="outline-container-org7a79632" class="outline-3">
<h3 id="org7a79632">compute/arrow</h3>
<div class="outline-text-3" id="text-org7a79632">
<ul class="org-ul">
<li><p>commit should be preformed arrow by arrow</p><p>one arrow can only commit on its own var</p><p>this is achieve by the natural of the structure of bs</p></li>

<li><p>note that</p><p>commit is only meant to handle non-determinate var</p><p>of which the level n is bound</p><p>where n &gt; 0</p></li></ul>

<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">compute/arrow</span> a e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> arrow env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> report<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> a
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ac sc<span style="color: #B380A8;">}</span>
        <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>alen <span style="color: #696969;">(</span>length ac<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
              <span style="color: #797979;">[</span>slen <span style="color: #696969;">(</span>length sc<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
          <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>compute/cedent ac <span style="color: #B380A8;">{</span>ds <span style="color: #696969;">(</span>cons '<span style="color: #696969;">(</span>commit-point<span style="color: #696969;">)</span> bs<span style="color: #696969;">)</span> ns<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span>
            <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
            <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{</span>ds1 bs1 ns1<span style="color: #B380A8;">}}</span>
             <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>unify/data-list
                     <span style="color: #696969;">(</span>take ds1 alen<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>take <span style="color: #696969;">(</span>drop ds1 alen<span style="color: #696969;">)</span> alen<span style="color: #696969;">)</span>
                     <span style="color: #B380A8;">{</span>'success
                      <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>drop <span style="color: #696969;">(</span>drop ds1 alen<span style="color: #696969;">)</span> alen<span style="color: #696969;">)</span>
                       bs1
                       ns1<span style="color: #B380A8;">}}</span><span style="color: #696969;">)</span>
               <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
               <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success e2<span style="color: #B380A8;">}</span>
                <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>compute/cedent sc e2<span style="color: #696969;">)</span>
                  <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
                  <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{</span>ds3 bs3 ns3<span style="color: #B380A8;">}}</span>
                   <span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{</span>ds3 <span style="color: #696969;">(</span>bs/commit! bs3<span style="color: #696969;">)</span> ns3<span style="color: #B380A8;">}}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org627454a" class="outline-3">
<h3 id="org627454a">bs/commit!</h3>
<div class="outline-text-3" id="text-org627454a">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">bs/commit!</span> bs<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> bs <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> bs
     <span style="color: #797979;">[</span>with effect on part of elements of bs<span style="color: #797979;">]</span><span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">cond</span> <span style="color: #797979;">[</span><span style="color: #696969;">(</span>equal? '<span style="color: #696969;">(</span>commit-point<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>car bs<span style="color: #696969;">))</span>
         <span style="color: #696969;">(</span>cdr bs<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
        <span style="color: #797979;">[</span>else
         <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let*</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>pair <span style="color: #696969;">(</span>car bs<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
                <span style="color: #797979;">[</span>id <span style="color: #696969;">(</span>car pair<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
                <span style="color: #797979;">[</span>ls <span style="color: #696969;">(</span>cdr pair<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
           <span style="color: #696969;">(</span>id/commit! id ls<span style="color: #696969;">)</span>
           <span style="color: #696969;">(</span>bs/commit! <span style="color: #696969;">(</span>cdr bs<span style="color: #696969;">)))</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org89b71c5" class="outline-3">
<h3 id="org89b71c5">compute/cedent</h3>
<div class="outline-text-3" id="text-org89b71c5">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">compute/cedent</span> c e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> cedent env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> report<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> c
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{}</span> <span style="color: #B380A8;">{</span>'success e<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #696969;">(</span>h . r<span style="color: #696969;">)</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>compute h e<span style="color: #696969;">)</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success e1<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>compute/cedent r e1<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org7faaac8" class="outline-3">
<h3 id="org7faaac8">compute</h3>
<div class="outline-text-3" id="text-org7faaac8">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">compute</span> d e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> data env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> report<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #696969;">(</span>ds bs ns<span style="color: #696969;">)</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> d
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'var x<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>compute/var x e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'cons x<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>compute/cons x e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'trunk x<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>compute/trunk x e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
       <span style="color: #797979;">[</span>__ <span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>cons d ds<span style="color: #696969;">)</span> bs ns<span style="color: #B380A8;">}}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org843560f" class="outline-3">
<h3 id="org843560f">compute/var</h3>
<div class="outline-text-3" id="text-org843560f">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">compute/var</span> v e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> var env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> report<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #696969;">(</span>ds bs ns<span style="color: #696969;">)</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>d <span style="color: #696969;">(</span>bs/deep bs <span style="color: #B380A8;">{</span>'var v<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
       <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> d
         <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">result found from this var needs to be compute again</span>
         <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">except for fresh var</span>
         <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'var __<span style="color: #B380A8;">}</span>
          <span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>cons d ds<span style="color: #696969;">)</span> bs ns<span style="color: #B380A8;">}}</span><span style="color: #797979;">]</span>
         <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>__ __<span style="color: #B380A8;">}</span>
          <span style="color: #696969;">(</span>compute d e<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org3bd0c53" class="outline-3">
<h3 id="org3bd0c53">compute/cons</h3>
<div class="outline-text-3" id="text-org3bd0c53">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">compute/cons</span> c e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> cons env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> report<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #696969;">(</span>ds bs ns<span style="color: #696969;">)</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> c
       <span style="color: #797979;">[</span><span style="color: #696969;">(</span>n dl<span style="color: #696969;">)</span>
        <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">the following reverse</span>
        <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">dl in stack -&gt; dl in function body</span>
        <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>compute/cedent <span style="color: #696969;">(</span>reverse dl<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>list '<span style="color: #696969;">()</span> bs ns<span style="color: #696969;">))</span>
          <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span>
           <span style="color: #B380A8;">{</span>'fail <span style="color: #696969;">(</span>cons `<span style="color: #696969;">(</span>compute/cons
                          fail
                          <span style="color: #696969;">(</span>cons: ,c<span style="color: #696969;">))</span>
                        il<span style="color: #696969;">)</span><span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
          <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{</span>ds1 bs1 ns1<span style="color: #B380A8;">}}</span>
           <span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>cons <span style="color: #B380A8;">{</span>'cons <span style="color: #B380A8;">{</span>n ds1<span style="color: #B380A8;">}}</span>
                            ds<span style="color: #696969;">)</span>
                      bs
                      ns<span style="color: #B380A8;">}}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb5764ef" class="outline-3">
<h3 id="orgb5764ef">trunk-&gt;trunk*</h3>
<div class="outline-text-3" id="text-orgb5764ef">
<ul class="org-ul">
<li><p>replace the name in trunk by arrow-list</p></li>

<li><p>the ns of env is needed</p><p>to find the arrow-list under the name</p></li></ul>

<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">trunk-&gt;trunk*</span> t e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> trunk env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> trunk<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> t
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>a al dl i<span style="color: #B380A8;">}</span>
        <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> <span style="color: #696969;">(</span>not <span style="color: #696969;">(</span>symbol? al<span style="color: #696969;">))</span>
          <span style="color: #B380A8;">{</span>a al dl i<span style="color: #B380A8;">}</span>
          <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">this is the only place (arrow ...) is copied</span>
          <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">&gt;&lt;&gt;&lt;&gt;&lt; many place are copying now</span>
          <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let*</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>n al<span style="color: #797979;">]</span>
                 <span style="color: #797979;">[</span>found <span style="color: #696969;">(</span>assq n ns<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
            <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> <span style="color: #696969;">(</span>not found<span style="color: #696969;">)</span>
              <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">orz</span> 'trunk-&gt;trunk*
                <span style="color: #696969;">(</span><span style="color: #e6db74;">"fail~%"</span><span style="color: #696969;">)</span>
                <span style="color: #696969;">(</span><span style="color: #e6db74;">"unknow name : ~a~%"</span> n<span style="color: #696969;">))</span>
              <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>meaning <span style="color: #696969;">(</span>cdr found<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
                <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> meaning
                  <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'lambda <span style="color: #B380A8;">{{</span>ac sc<span style="color: #B380A8;">}</span> al1<span style="color: #B380A8;">}}</span>
                   <span style="color: #B380A8;">{</span>a <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">map</span> copy-arrow al1<span style="color: #696969;">)</span> dl i<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
                  <span style="color: #797979;">[</span>__
                   <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">orz</span> 'trunk-&gt;trunk*
                     <span style="color: #696969;">(</span><span style="color: #e6db74;">"trunk-&gt;trunk* fail~%"</span> <span style="color: #696969;">)</span>
                     <span style="color: #696969;">(</span><span style="color: #e6db74;">"name is not lambda : ~a~%"</span> n<span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">)))))</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org1bf19c1" class="outline-3">
<h3 id="org1bf19c1">compute/trunk</h3>
<div class="outline-text-3" id="text-org1bf19c1">
<ul class="org-ul">
<li><p>there is no reducible trunk after compute/trunk</p><p>thus no reducible trunk after compute/arrow</p></li></ul>

<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">compute/trunk</span> t e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> trunk env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> report<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>trunk-&gt;trunk* t e<span style="color: #696969;">)</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>a al dl i<span style="color: #B380A8;">}</span>
        <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">the following reverse</span>
        <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">dl in stack -&gt; dl in function body</span>
        <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>compute/cedent <span style="color: #696969;">(</span>reverse dl<span style="color: #696969;">)</span> <span style="color: #B380A8;">{{}</span> bs ns<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span>
          <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span>
           <span style="color: #B380A8;">{</span>'fail <span style="color: #696969;">(</span>cons `<span style="color: #696969;">(</span>compute/trunk
                          fail when computing data-list
                          <span style="color: #696969;">(</span>data-list: ,dl<span style="color: #696969;">)</span>
                          <span style="color: #696969;">(</span>cons: ,c<span style="color: #696969;">))</span>
                        il<span style="color: #696969;">)</span><span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
          <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success e1<span style="color: #B380A8;">}</span>
           <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e1
             <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds1 bs1 ns1<span style="color: #B380A8;">}</span>
              <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let*</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>dl1 ds1<span style="color: #797979;">]</span>
                     <span style="color: #797979;">[</span>al1 <span style="color: #696969;">(</span>filter-arrow-list al dl1 e1<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
                <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> al1
                  <span style="color: #797979;">[</span><span style="color: #B380A8;">{}</span>
                   <span style="color: #B380A8;">{</span>'fail <span style="color: #B380A8;">{</span>`<span style="color: #696969;">(</span>compute/trunk
                             no antecedent match
                             <span style="color: #696969;">(</span>data-list: ,ds1<span style="color: #696969;">)</span>
                             <span style="color: #696969;">(</span>arrow-list: ,al<span style="color: #696969;">)</span>
                             <span style="color: #696969;">(</span>trunk: ,t<span style="color: #696969;">))</span><span style="color: #B380A8;">}}</span><span style="color: #797979;">]</span>
                  <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>a1<span style="color: #B380A8;">}</span>
                   <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>compute/arrow a1 e1<span style="color: #696969;">)</span>
                     <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">after this compute/arrow</span>
                     <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">binds are commited</span>
                     <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success e2<span style="color: #B380A8;">}</span>
                      <span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>cons <span style="color: #696969;">(</span>proj i e2<span style="color: #696969;">)</span> ds<span style="color: #696969;">)</span>
                                 bs1
                                 ns1<span style="color: #B380A8;">}}</span><span style="color: #797979;">]</span>
                     <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span>
                  <span style="color: #797979;">[</span><span style="color: #696969;">(</span>a1 a2 . __<span style="color: #696969;">)</span>
                   <span style="color: #B380A8;">{</span>'success
                    <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>cons <span style="color: #B380A8;">{</span>'trunk <span style="color: #B380A8;">{</span>a al1 dl1 i<span style="color: #B380A8;">}}</span>
                           ds<span style="color: #696969;">)</span>
                     bs1
                     ns1<span style="color: #B380A8;">}}</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb01e9e2" class="outline-3">
<h3 id="orgb01e9e2">filter-arrow-list</h3>
<div class="outline-text-3" id="text-orgb01e9e2">
<ul class="org-ul">
<li><p>no commit should be made here</p></li></ul>

<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">filter-arrow-list</span> al dl e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> <span style="color: #696969;">(</span>arrow ...<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>data ...<span style="color: #696969;">)</span> env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #696969;">(</span>arrow ...<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> <span style="color: #696969;">(</span>eq? '<span style="color: #696969;">()</span> al<span style="color: #696969;">)</span>
    '<span style="color: #696969;">()</span>
    <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
      <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span>
       <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>car al<span style="color: #696969;">)</span>
         <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ac __<span style="color: #B380A8;">}</span>
          <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>alen <span style="color: #696969;">(</span>length ac<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
            <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>compute/cedent ac e<span style="color: #696969;">)</span>
              <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail __<span style="color: #B380A8;">}</span>
               <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">orz</span> 'filter-arrow-list <span style="color: #696969;">(</span><span style="color: #e6db74;">"fail to compute/cedent~%"</span><span style="color: #696969;">))</span><span style="color: #797979;">]</span>
              <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{</span>ds1 bs1 ns1<span style="color: #B380A8;">}}</span>
               <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>unify/data-list
                       dl <span style="color: #696969;">(</span>take ds1 alen<span style="color: #696969;">)</span>
                       <span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>drop ds1 alen<span style="color: #696969;">)</span>
                                  bs1
                                  ns1<span style="color: #B380A8;">}}</span><span style="color: #696969;">)</span>
                 <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail __<span style="color: #B380A8;">}</span>
                  <span style="color: #696969;">(</span>filter-arrow-list <span style="color: #696969;">(</span>cdr al<span style="color: #696969;">)</span> dl e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
                 <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success __<span style="color: #B380A8;">}</span>
                  <span style="color: #696969;">(</span>cons <span style="color: #696969;">(</span>car al<span style="color: #696969;">)</span>
                        <span style="color: #696969;">(</span>filter-arrow-list <span style="color: #696969;">(</span>cdr al<span style="color: #696969;">)</span> dl e<span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org14d0aa7" class="outline-3">
<h3 id="org14d0aa7">proj</h3>
<div class="outline-text-3" id="text-org14d0aa7">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">proj</span> i e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> index env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> data<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #696969;">(</span>ds bs ns<span style="color: #696969;">)</span>
     <span style="color: #696969;">(</span>list-ref ds <span style="color: #696969;">(</span>- <span style="color: #696969;">(</span>length ds<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>+ 1 i<span style="color: #696969;">)))</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org5da08f8" class="outline-2">
<h2 id="org5da08f8">print</h2>
<div class="outline-text-2" id="text-org5da08f8">
</div><div id="outline-container-org731be6e" class="outline-3">
<h3 id="org731be6e">print/cedent</h3>
<div class="outline-text-3" id="text-org731be6e">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">print/cedent</span> c e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> cedent env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #797979;">[</span>effect on terminal<span style="color: #797979;">]</span><span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> c
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{}</span> <span style="color: #696969;">(</span>void<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>d<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>print/data d e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #696969;">(</span>d . r<span style="color: #696969;">)</span>
     <span style="color: #696969;">(</span>print/data d e<span style="color: #696969;">)</span>
     <span style="color: #696969;">(</span>format #t <span style="color: #e6db74;">" "</span><span style="color: #696969;">)</span>
     <span style="color: #696969;">(</span>print/cedent r e<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org1b5430a" class="outline-3">
<h3 id="org1b5430a">print/data-list</h3>
<div class="outline-text-3" id="text-org1b5430a">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">print/data-list</span> dl e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> <span style="color: #696969;">(</span>data ...<span style="color: #696969;">)</span> env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #797979;">[</span>effect on terminal<span style="color: #797979;">]</span><span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span>print/cedent <span style="color: #696969;">(</span>reverse dl<span style="color: #696969;">)</span> e<span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb121aac" class="outline-3">
<h3 id="orgb121aac">print/data</h3>
<div class="outline-text-3" id="text-orgb121aac">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">print/data</span> d e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> data env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #797979;">[</span>effect on terminal<span style="color: #797979;">]</span><span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> d
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'var x<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>print/var x e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'cons x<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>print/cons x e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'arrow x<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>print/arrow x e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'lambda x<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>print/lambda x e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'trunk x<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>print/trunk x e<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org5d8d092" class="outline-3">
<h3 id="org5d8d092">print/var</h3>
<div class="outline-text-3" id="text-org5d8d092">
<ul class="org-ul">
<li><p>different var should be print differently</p></li>

<li><p>note that</p><p>the env is not used by even print/var</p></li></ul>

<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">print/var</span> v e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> var env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #797979;">[</span>effect on terminal<span style="color: #797979;">]</span><span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> v
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>id level<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>name <span style="color: #696969;">(</span>id-&gt;name id<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
           <span style="color: #797979;">[</span>counter <span style="color: #696969;">(</span>id-&gt;counter id<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
       <span style="color: #696969;">(</span>format #t <span style="color: #e6db74;">":~a:~a^~a"</span> counter name level<span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org3a7bdf7" class="outline-3">
<h3 id="org3a7bdf7">print/cons</h3>
<div class="outline-text-3" id="text-org3a7bdf7">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">print/cons</span> c e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> cons env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #797979;">[</span>effect on terminal<span style="color: #797979;">]</span><span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> c
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>n dl<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span>format #t <span style="color: #e6db74;">"["</span><span style="color: #696969;">)</span>
     <span style="color: #696969;">(</span>print/data-list dl e<span style="color: #696969;">)</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> <span style="color: #696969;">(</span>null? dl<span style="color: #696969;">)</span>
       <span style="color: #696969;">(</span>format #t <span style="color: #e6db74;">"~a]"</span> n<span style="color: #696969;">)</span>
       <span style="color: #696969;">(</span>format #t <span style="color: #e6db74;">" ~a]"</span> n<span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd6f6eeb" class="outline-3">
<h3 id="orgd6f6eeb">print/arrow</h3>
<div class="outline-text-3" id="text-orgd6f6eeb">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">print/arrow</span> a e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> arrow env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #797979;">[</span>effect on terminal<span style="color: #797979;">]</span><span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> a
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ac sc<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span>format #t <span style="color: #e6db74;">"("</span><span style="color: #696969;">)</span>
     <span style="color: #696969;">(</span>print/cedent ac e<span style="color: #696969;">)</span>
     <span style="color: #696969;">(</span>format #t <span style="color: #e6db74;">" -&gt; "</span><span style="color: #696969;">)</span>
     <span style="color: #696969;">(</span>print/cedent sc e<span style="color: #696969;">)</span>
     <span style="color: #696969;">(</span>format #t <span style="color: #e6db74;">")"</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbfd24e9" class="outline-3">
<h3 id="orgbfd24e9"><span class="todo _gt__lt_">&gt;&lt;</span> print/lambda</h3>
<div class="outline-text-3" id="text-orgbfd24e9">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">print/lambda</span> l e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> lambda env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #797979;">[</span>effect on terminal<span style="color: #797979;">]</span><span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> l
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>a al<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span>format #t <span style="color: #e6db74;">"&lt;lambda&gt;"</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orga5f24d1" class="outline-3">
<h3 id="orga5f24d1"><span class="todo _gt__lt_">&gt;&lt;</span> print/trunk</h3>
<div class="outline-text-3" id="text-orga5f24d1">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">print/trunk</span> t e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> trunk env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #797979;">[</span>effect on terminal<span style="color: #797979;">]</span><span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> t
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>a al dl i<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span>format #t <span style="color: #e6db74;">"&lt;trunk&gt;"</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org3898eee" class="outline-2">
<h2 id="org3898eee">unify</h2>
<div class="outline-text-2" id="text-org3898eee">
</div><div id="outline-container-org18c9435" class="outline-3">
<h3 id="org18c9435"><span class="todo note">note</span> </h3>
<div class="outline-text-3" id="text-org18c9435">
<ul class="org-ul">
<li><p>firstly we have first order syntactic unification</p><p>except for unify/trunk/data where semantic unification is used</p><p>and for unify/trunk where first syntactic unification is tried</p><p>if it fail</p><p>semantic unification is used</p></li></ul>
</div>
</div>

<div id="outline-container-orgae2877b" class="outline-3">
<h3 id="orgae2877b">unify/data-list</h3>
<div class="outline-text-3" id="text-orgae2877b">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">unify/data-list</span> pl dl r<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> <span style="color: #696969;">(</span>pattern ...<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>data ...<span style="color: #696969;">)</span> report <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> report<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> r
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success e<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">cond</span> <span style="color: #797979;">[</span><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">and</span> <span style="color: #696969;">(</span>eq? pl '<span style="color: #696969;">())</span> <span style="color: #696969;">(</span>eq? dl '<span style="color: #696969;">()))</span>
            r<span style="color: #797979;">]</span>
           <span style="color: #797979;">[</span><span style="color: #696969;">(</span>eq? pl <span style="color: #B380A8;">{}</span><span style="color: #696969;">)</span>
            <span style="color: #B380A8;">{</span>'fail <span style="color: #B380A8;">{</span>`<span style="color: #696969;">(</span>unify/data-list
                      fail pl and dl is not of the same length
                      <span style="color: #696969;">(</span>additional-dl: ,dl<span style="color: #696969;">))</span><span style="color: #B380A8;">}}</span><span style="color: #797979;">]</span>
           <span style="color: #797979;">[</span><span style="color: #696969;">(</span>eq? dl <span style="color: #B380A8;">{}</span><span style="color: #696969;">)</span>
            <span style="color: #B380A8;">{</span>'fail <span style="color: #B380A8;">{</span>`<span style="color: #696969;">(</span>unify/data-list
                      fail pl and dl is not of the same length
                      <span style="color: #696969;">(</span>additional-pl: ,pl<span style="color: #696969;">))</span><span style="color: #B380A8;">}}</span><span style="color: #797979;">]</span>
           <span style="color: #797979;">[</span>else
            <span style="color: #696969;">(</span>unify/data-list
             <span style="color: #696969;">(</span>cdr pl<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>cdr dl<span style="color: #696969;">)</span>
             <span style="color: #696969;">(</span>unify/data <span style="color: #696969;">(</span>car pl<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>car dl<span style="color: #696969;">)</span> e<span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org987138b" class="outline-3">
<h3 id="org987138b">var/eq?</h3>
<div class="outline-text-3" id="text-org987138b">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">var/eq?</span> v1 v2<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>list v1 v2<span style="color: #696969;">)</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{{</span>id1 level1<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>id2 level2<span style="color: #B380A8;">}}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">and</span> <span style="color: #696969;">(</span>eq? id1 id2<span style="color: #696969;">)</span>
          <span style="color: #696969;">(</span>eq? level1 level2<span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd68e113" class="outline-3">
<h3 id="orgd68e113"><span class="todo _gt__lt__gt__lt__gt__lt_">&gt;&lt;&gt;&lt;&gt;&lt;</span> unify/data</h3>
<div class="outline-text-3" id="text-orgd68e113">
<ul class="org-ul">
<li><p>need to check type for fresh var</p><p>maybe more then var</p></li></ul>

<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">unify/data</span> p d e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> pattern data env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> report<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span>
     <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">var -walk-&gt; fresh-var</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>p <span style="color: #696969;">(</span>bs/walk bs p<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
           <span style="color: #797979;">[</span>d <span style="color: #696969;">(</span>bs/walk bs d<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
       <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #B380A8;">{</span>p d<span style="color: #B380A8;">}</span>
         <span style="color: #797979;">[</span><span style="color: #B380A8;">{{</span>'var v1<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'var v2<span style="color: #B380A8;">}}</span>
          <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> <span style="color: #696969;">(</span>var/eq? v1 v2<span style="color: #696969;">)</span>
            <span style="color: #B380A8;">{</span>'success e<span style="color: #B380A8;">}</span>
            <span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{</span>ds
                       <span style="color: #696969;">(</span>bs/extend bs v1 d<span style="color: #696969;">)</span>
                       ns<span style="color: #B380A8;">}}</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span>
         <span style="color: #797979;">[</span><span style="color: #B380A8;">{{</span>'var v<span style="color: #B380A8;">}</span> __<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>unify/var/data v d e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
         <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>__ <span style="color: #B380A8;">{</span>'var v<span style="color: #B380A8;">}}</span> <span style="color: #696969;">(</span>unify/var/data v p e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>

         <span style="color: #797979;">[</span><span style="color: #B380A8;">{{</span>'trunk t1<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'trunk t2<span style="color: #B380A8;">}}</span> <span style="color: #696969;">(</span>unify/trunk t1 t2 e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
         <span style="color: #797979;">[</span><span style="color: #B380A8;">{{</span>'trunk t<span style="color: #B380A8;">}</span> __<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>unify/trunk/data t d e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
         <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>__ <span style="color: #B380A8;">{</span>'trunk t<span style="color: #B380A8;">}}</span> <span style="color: #696969;">(</span>unify/trunk/data t p e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>

         <span style="color: #797979;">[</span><span style="color: #B380A8;">{{</span>'cons c1<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'cons c2<span style="color: #B380A8;">}}</span> <span style="color: #696969;">(</span>unify/cons c1 c2 e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
         <span style="color: #797979;">[</span><span style="color: #B380A8;">{{</span>'arrow a1<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'arrow a2<span style="color: #B380A8;">}}</span> <span style="color: #696969;">(</span>unify/arrow a1 a2 e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
         <span style="color: #797979;">[</span><span style="color: #B380A8;">{{</span>'lambda l1<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'lambda l2<span style="color: #B380A8;">}}</span> <span style="color: #696969;">(</span>unify/lambda l1 l2 e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
         <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>__ __<span style="color: #B380A8;">}</span>
          <span style="color: #B380A8;">{</span>'fail <span style="color: #B380A8;">{</span>`<span style="color: #696969;">(</span>unify/data
                    fail to unify
                    <span style="color: #696969;">(</span>pattern: ,p<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>data: ,d<span style="color: #696969;">))</span><span style="color: #B380A8;">}}</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb4c304f" class="outline-3">
<h3 id="orgb4c304f">bs/extend</h3>
<div class="outline-text-3" id="text-orgb4c304f">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">bs/extend</span> bs v d<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> bs var data <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> bs<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> v
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>id level<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>found/ls <span style="color: #696969;">(</span>assq id bs<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
       <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> found/ls
         <span style="color: #696969;">(</span>substitute <span style="color: #696969;">(</span>cons id <span style="color: #696969;">(</span>cons <span style="color: #696969;">(</span>cons level d<span style="color: #696969;">)</span>
                                    <span style="color: #696969;">(</span>cdr found/ls<span style="color: #696969;">)))</span>
                     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">lambda</span> <span style="color: #696969;">(</span>pair<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>eq? <span style="color: #696969;">(</span>car pair<span style="color: #696969;">)</span> id<span style="color: #696969;">))</span>
                     bs<span style="color: #696969;">)</span>
         <span style="color: #696969;">(</span>cons <span style="color: #696969;">(</span>cons id <span style="color: #696969;">(</span>list <span style="color: #696969;">(</span>cons level d<span style="color: #696969;">)))</span>
               bs<span style="color: #696969;">)))</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgeb86ab0" class="outline-3">
<h3 id="orgeb86ab0">unify/var/data</h3>
<div class="outline-text-3" id="text-orgeb86ab0">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">unify/var/data</span> v d e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> var data env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> report<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span>
     <span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{</span>ds <span style="color: #696969;">(</span>bs/extend bs v d<span style="color: #696969;">)</span> ns<span style="color: #B380A8;">}}</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgba2f78e" class="outline-3">
<h3 id="orgba2f78e">unify/cons</h3>
<div class="outline-text-3" id="text-orgba2f78e">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">unify/cons</span> c1 c2 e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> cons cons env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> report<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #B380A8;">{</span>c1 c2<span style="color: #B380A8;">}</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{{</span>n1 dl1<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>n2 dl2<span style="color: #B380A8;">}}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> <span style="color: #696969;">(</span>eq? n1 n2<span style="color: #696969;">)</span>
       <span style="color: #696969;">(</span>unify/data-list dl1 dl2 <span style="color: #B380A8;">{</span>'success e<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span>
       <span style="color: #B380A8;">{</span>'fail <span style="color: #B380A8;">{</span>`<span style="color: #696969;">(</span>unify/cons
                 fail
                 <span style="color: #696969;">(</span>cons1: ,c1<span style="color: #696969;">)</span>
                 <span style="color: #696969;">(</span>cons2: ,c2<span style="color: #696969;">))</span><span style="color: #B380A8;">}}</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc535ae7" class="outline-3">
<h3 id="orgc535ae7">unify/arrow</h3>
<div class="outline-text-3" id="text-orgc535ae7">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">unify/arrow</span> a1 a2 e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> arrow arrow env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> report<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #B380A8;">{</span>a1 a2<span style="color: #B380A8;">}</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{{</span>ac1 sc1<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>ac2 sc2<span style="color: #B380A8;">}}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>unify/data-list ac1 ac2 <span style="color: #B380A8;">{</span>'success e<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success e1<span style="color: #B380A8;">}</span>
        <span style="color: #696969;">(</span>unify/data-list sc1 sc2 <span style="color: #B380A8;">{</span>'success e1<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span>
        <span style="color: #B380A8;">{</span>'fail <span style="color: #696969;">(</span>cons `<span style="color: #696969;">(</span>unify/arrow
                       fail  <span style="color: #696969;">(</span>arrow1: ,a1<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>arrow2: ,a2<span style="color: #696969;">))</span>
                     il<span style="color: #696969;">)</span><span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb743412" class="outline-3">
<h3 id="orgb743412">unify/lambda</h3>
<div class="outline-text-3" id="text-orgb743412">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">unify/lambda</span> l1 l2 e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> lambda lambda env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> report<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #B380A8;">{</span>l1 l2<span style="color: #B380A8;">}</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{{</span>a1 al1<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>a2 al2<span style="color: #B380A8;">}}</span>
     <span style="color: #696969;">(</span>unify/arrow-list al1 al2 <span style="color: #696969;">(</span>unify/arrow a1 a2 e<span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgcfd622d" class="outline-3">
<h3 id="orgcfd622d">unify/arrow-list</h3>
<div class="outline-text-3" id="text-orgcfd622d">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">unify/arrow-list</span> al1 al2 r<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> <span style="color: #696969;">(</span>arrow ...<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>arrow ...<span style="color: #696969;">)</span> report <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> report<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> r
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success e<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> <span style="color: #696969;">(</span>eq? al1 <span style="color: #B380A8;">{}</span><span style="color: #696969;">)</span>
       r
       <span style="color: #696969;">(</span>unify/arrow-list
        <span style="color: #696969;">(</span>cdr al1<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>cdr al2<span style="color: #696969;">)</span>
        <span style="color: #696969;">(</span>unify/arrow <span style="color: #696969;">(</span>car al1<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>car al2<span style="color: #696969;">)</span> e<span style="color: #696969;">)))</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgfc6319" class="outline-3">
<h3 id="orgfc6319">unify/trunk</h3>
<div class="outline-text-3" id="text-orgfc6319">
<ul class="org-ul">
<li><p>it will not diverge on recursive call here</p><p>because the trunk of recursive call</p><p>only have name in it</p><p>but not have the arrow-list</p></li>

<li><p>thus</p><p>we can unify on function</p><p>but only use syntactic unification</p><p>not second order semantic unification</p></li></ul>

<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">unify/trunk</span> t1 t2 e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> trunk trunk env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> report<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #B380A8;">{</span>t1 t2<span style="color: #B380A8;">}</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{{</span>a1 al1 dl1 i1<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>a2 al2 dl2 i2<span style="color: #B380A8;">}}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> <span style="color: #696969;">(</span>not <span style="color: #696969;">(</span>eq? i1 i2<span style="color: #696969;">))</span>
       <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">syntactic unification fail</span>
       <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">recur to unify/data</span>
       <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">only when at least one of the trunk is reducible</span>
       <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">and if the arguments of this recur are both trunk</span>
       <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">they must be non-reducible</span>
       <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">thus will not get in to this branch again</span>
       <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>filter-arrow-list al1 dl1 e<span style="color: #696969;">)</span>
               <span style="color: #696969;">(</span>filter-arrow-list al2 dl2 e<span style="color: #696969;">)</span><span style="color: #B380A8;">}</span>
         <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>l1 l2<span style="color: #B380A8;">}</span>
          <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> <span style="color: #696969;">(</span>not <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">or</span> <span style="color: #696969;">(</span>eq? 1 <span style="color: #696969;">(</span>length l1<span style="color: #696969;">))</span> <span style="color: #696969;">(</span>eq? 1 <span style="color: #696969;">(</span>length l2<span style="color: #696969;">))))</span>
            <span style="color: #B380A8;">{</span>'fail <span style="color: #B380A8;">{</span>`<span style="color: #696969;">(</span>unify/trunk
                      fail indexes are different
                      <span style="color: #696969;">(</span>trunk1: ,t1<span style="color: #696969;">)</span>
                      <span style="color: #696969;">(</span>trunk2: ,t2<span style="color: #696969;">)</span>
                      and both trunks are non-reducible<span style="color: #696969;">)</span><span style="color: #B380A8;">}}</span>
            <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>compute/trunk t1 e<span style="color: #696969;">)</span>
                    <span style="color: #696969;">(</span>compute/trunk t2 e<span style="color: #696969;">)</span><span style="color: #B380A8;">}</span>
              <span style="color: #797979;">[</span><span style="color: #B380A8;">{{</span>'success <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>d1 . __<span style="color: #696969;">)</span> __ __<span style="color: #B380A8;">}}</span>
                <span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>d2 . __<span style="color: #696969;">)</span> __ __<span style="color: #B380A8;">}}}</span>
               <span style="color: #696969;">(</span>unify/data d1 d2 e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
              <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>__ __<span style="color: #B380A8;">}</span>
               <span style="color: #B380A8;">{</span>'fail <span style="color: #B380A8;">{</span>`<span style="color: #696969;">(</span>unify/trunk
                         fail indexes are different
                         <span style="color: #696969;">(</span>trunk1: ,t1<span style="color: #696969;">)</span>
                         <span style="color: #696969;">(</span>trunk2: ,t2<span style="color: #696969;">)</span>
                         and fail to compute/trunk one of them<span style="color: #696969;">)</span><span style="color: #B380A8;">}}</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
       <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">cond</span> <span style="color: #797979;">[</span><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">and</span> <span style="color: #696969;">(</span>symbol? al1<span style="color: #696969;">)</span>
                   <span style="color: #696969;">(</span>symbol? al2<span style="color: #696969;">)</span>
                   <span style="color: #696969;">(</span>eq? al1 al2<span style="color: #696969;">))</span>
              <span style="color: #696969;">(</span>unify/data-list
               dl1 dl2
               <span style="color: #696969;">(</span>unify/arrow a1 a2 e<span style="color: #696969;">))</span><span style="color: #797979;">]</span>
             <span style="color: #797979;">[</span><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">and</span> <span style="color: #696969;">(</span>symbol? al1<span style="color: #696969;">)</span>
                   <span style="color: #696969;">(</span>not <span style="color: #696969;">(</span>symbol? al2<span style="color: #696969;">)))</span>
              <span style="color: #696969;">(</span>unify/trunk <span style="color: #696969;">(</span>trunk-&gt;trunk* t1 e<span style="color: #696969;">)</span> t2 e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
             <span style="color: #797979;">[</span><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">and</span> <span style="color: #696969;">(</span>not <span style="color: #696969;">(</span>symbol? al1<span style="color: #696969;">))</span>
                   <span style="color: #696969;">(</span>symbol? al2<span style="color: #696969;">))</span>
              <span style="color: #696969;">(</span>unify/trunk  t1 <span style="color: #696969;">(</span>trunk-&gt;trunk* t2 e<span style="color: #696969;">)</span> e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
             <span style="color: #797979;">[</span>else <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">al1 al2 are both not symbol</span>
              <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>unify/data-list
                      dl1 dl2
                      <span style="color: #696969;">(</span>unify/lambda <span style="color: #B380A8;">{</span>a1 al1<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>a2 al2<span style="color: #B380A8;">}</span> e<span style="color: #696969;">))</span>
                <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success e1<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'success e1<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
                <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span>
                 <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">recur to unify/data</span>
                 <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">only when at least one of the trunk is reducible</span>
                 <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">and if the arguments of this recur are both trunk</span>
                 <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">they must be non-reducible</span>
                 <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">thus will not get in to this branch again</span>
                 <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>filter-arrow-list al1 dl1 e<span style="color: #696969;">)</span>
                         <span style="color: #696969;">(</span>filter-arrow-list al2 dl2 e<span style="color: #696969;">)</span><span style="color: #B380A8;">}</span>
                   <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>l1 l2<span style="color: #B380A8;">}</span>
                    <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> <span style="color: #696969;">(</span>not <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">or</span> <span style="color: #696969;">(</span>eq? 1 <span style="color: #696969;">(</span>length l1<span style="color: #696969;">))</span> <span style="color: #696969;">(</span>eq? 1 <span style="color: #696969;">(</span>length l2<span style="color: #696969;">))))</span>
                      <span style="color: #B380A8;">{</span>'fail <span style="color: #B380A8;">{</span>`<span style="color: #696969;">(</span>unify/trunk
                                syntacticly different trunks
                                <span style="color: #696969;">(</span>trunk1: ,t1<span style="color: #696969;">)</span>
                                <span style="color: #696969;">(</span>trunk2: ,t2<span style="color: #696969;">)</span>
                                and both trunks are non-reducible<span style="color: #696969;">)</span><span style="color: #B380A8;">}}</span>
                      <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>compute/trunk t1 e<span style="color: #696969;">)</span>
                              <span style="color: #696969;">(</span>compute/trunk t2 e<span style="color: #696969;">)</span><span style="color: #B380A8;">}</span>
                        <span style="color: #797979;">[</span><span style="color: #B380A8;">{{</span>'success <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>d1 . __<span style="color: #696969;">)</span> __ __<span style="color: #B380A8;">}}</span>
                          <span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>d2 . __<span style="color: #696969;">)</span> __ __<span style="color: #B380A8;">}}}</span>
                         <span style="color: #696969;">(</span>unify/data d1 d2 e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
                        <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>__ __<span style="color: #B380A8;">}</span>
                         <span style="color: #B380A8;">{</span>'fail <span style="color: #B380A8;">{</span>`<span style="color: #696969;">(</span>unify/trunk
                                   fail indexes are different
                                   <span style="color: #696969;">(</span>trunk1: ,t1<span style="color: #696969;">)</span>
                                   <span style="color: #696969;">(</span>trunk2: ,t2<span style="color: #696969;">)</span>
                                   and fail to compute/trunk one of them<span style="color: #696969;">)</span><span style="color: #B380A8;">}}</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgce8cf01" class="outline-3">
<h3 id="orgce8cf01">unify/trunk/data</h3>
<div class="outline-text-3" id="text-orgce8cf01">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">unify/trunk/data</span> t d e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> trunk data env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> report<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>compute/trunk t e<span style="color: #696969;">)</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span>
     <span style="color: #B380A8;">{</span>'fail <span style="color: #696969;">(</span>cons `<span style="color: #696969;">(</span>unify/trunk/data
                    <span style="color: #696969;">(</span>trunk: ,t<span style="color: #696969;">)</span>
                    <span style="color: #696969;">(</span>data: ,d<span style="color: #696969;">))</span>
                  il<span style="color: #696969;">)</span><span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success e1<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>env/pop e1<span style="color: #696969;">)</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{{</span>'trunk t1<span style="color: #B380A8;">}</span> e2<span style="color: #B380A8;">}</span>
        <span style="color: #B380A8;">{</span>'fail <span style="color: #B380A8;">{</span>`<span style="color: #696969;">(</span>unify/trunk/data
                  <span style="color: #696969;">(</span>trunk: ,t<span style="color: #696969;">)</span>
                  compute to
                  <span style="color: #696969;">(</span>trunk: ,t1<span style="color: #696969;">))</span><span style="color: #B380A8;">}}</span><span style="color: #797979;">]</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>d1 e2<span style="color: #B380A8;">}</span>
        <span style="color: #696969;">(</span>unify/data d1 d e2<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org2925b27" class="outline-2">
<h2 id="org2925b27">eva</h2>
<div class="outline-text-2" id="text-org2925b27">
</div><div id="outline-container-org6bf1a33" class="outline-3">
<h3 id="org6bf1a33"><span class="todo note">note</span> </h3>
<div class="outline-text-3" id="text-org6bf1a33">
<ul class="org-ul">
<li><p>the design must be separately testable</p><p>first without check</p><p>then add check</p></li></ul>
</div>
</div>

<div id="outline-container-org9072e9d" class="outline-3">
<h3 id="org9072e9d">check+ &amp; check- &amp; ?check</h3>
<div class="outline-text-3" id="text-org9072e9d">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #a6e22e;">check?</span> #t<span style="color: #696969;">)</span>
<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">check+</span><span style="color: #696969;">)</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">set!</span> check? #t<span style="color: #696969;">)</span> #t<span style="color: #696969;">)</span>
<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">check-</span><span style="color: #696969;">)</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">set!</span> check? #f<span style="color: #696969;">)</span> #f<span style="color: #696969;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org94e1f42" class="outline-3">
<h3 id="org94e1f42">init-env</h3>
<div class="outline-text-3" id="text-org94e1f42">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #a6e22e;">init-env</span>
  '<span style="color: #696969;">(()</span>
    <span style="color: #696969;">()</span>
    <span style="color: #696969;">((</span><span style="color: #f92672; font-weight: bold;">type</span> . <span style="color: #696969;">(</span>cons/type <span style="color: #696969;">((()</span>
                          <span style="color: #696969;">(</span>cons <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">type</span> <span style="color: #696969;">())))</span>
                         type
                         type<span style="color: #696969;">))))))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org1881e7d" class="outline-3">
<h3 id="org1881e7d">eva</h3>
<div class="outline-text-3" id="text-org1881e7d">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define-syntax</span> <span style="color: #fd971f;">eva</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">syntax-rules</span> <span style="color: #696969;">()</span>
    <span style="color: #797979;">[</span><span style="color: #696969;">(</span>eva e ...<span style="color: #696969;">)</span>
     <span style="color: #696969;">(</span>eva/top-list <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">map</span> parse/top <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">quote</span> <span style="color: #696969;">(</span>e ...<span style="color: #696969;">)))</span> init-env<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org1cee2fc" class="outline-3">
<h3 id="org1cee2fc">eva/top-list</h3>
<div class="outline-text-3" id="text-org1cee2fc">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">eva/top-list</span> tl e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> <span style="color: #696969;">(</span>top ...<span style="color: #696969;">)</span> env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> env<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> tl
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{}</span> e<span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #696969;">(</span>t . r<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>eva/top-list r <span style="color: #696969;">(</span>eva/top t e<span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org4740c9a" class="outline-3">
<h3 id="org4740c9a">parse/top</h3>
<div class="outline-text-3" id="text-org4740c9a">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">parse/top</span> s<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> sexp-top <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> top<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> s
    <span style="color: #797979;">[</span><span style="color: #696969;">(</span>'dt n a . body<span style="color: #696969;">)</span>
     <span style="color: #B380A8;">{</span>'dt <span style="color: #B380A8;">{{</span>n a<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>parse/top/dt-body body<span style="color: #696969;">)</span><span style="color: #B380A8;">}}</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #696969;">(</span>'df n a . al<span style="color: #696969;">)</span>
     <span style="color: #B380A8;">{</span>'df <span style="color: #B380A8;">{{</span>n a<span style="color: #B380A8;">}</span> al<span style="color: #B380A8;">}}</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'ap a<span style="color: #B380A8;">}</span>
     <span style="color: #B380A8;">{</span>'ap a<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org9b120d4" class="outline-3">
<h3 id="org9b120d4">parse/top/dt-body</h3>
<div class="outline-text-3" id="text-org9b120d4">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">parse/top/dt-body</span> body<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> dt-body <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #696969;">((</span>form1/name form1/arrow<span style="color: #696969;">)</span> ...<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">cond</span> <span style="color: #797979;">[</span><span style="color: #696969;">(</span>eq? '<span style="color: #696969;">()</span> body<span style="color: #696969;">)</span> '<span style="color: #696969;">()</span><span style="color: #797979;">]</span>
        <span style="color: #797979;">[</span><span style="color: #696969;">(</span>eq? '<span style="color: #696969;">()</span> <span style="color: #696969;">(</span>cdr body<span style="color: #696969;">))</span>
         <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">orz</span> 'parse/top/dt-body <span style="color: #696969;">(</span><span style="color: #e6db74;">"wrong body : ~a~%"</span> body<span style="color: #696969;">))</span><span style="color: #797979;">]</span>
        <span style="color: #797979;">[</span>else
         <span style="color: #696969;">(</span>cons <span style="color: #696969;">(</span>list <span style="color: #696969;">(</span>car body<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>cadr body<span style="color: #696969;">))</span>
               <span style="color: #696969;">(</span>parse/top/dt-body <span style="color: #696969;">(</span>cddr body<span style="color: #696969;">)))</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf31261a" class="outline-3">
<h3 id="orgf31261a">eva/top</h3>
<div class="outline-text-3" id="text-orgf31261a">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">eva/top</span> t e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> top env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> env<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> t
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'dt dt<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>eva/dt dt e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'df df<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>eva/df df e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'ap a<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>eva/ap a e<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf28ee75" class="outline-3">
<h3 id="orgf28ee75">form1/arrow-&gt;arrow</h3>
<div class="outline-text-3" id="text-orgf28ee75">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">form1/arrow-&gt;arrow</span> a e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> form1/arrow env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> arrow<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>pass2/arrow <span style="color: #696969;">(</span>pass1/arrow 0 a<span style="color: #696969;">)</span> <span style="color: #B380A8;">{}</span><span style="color: #696969;">)</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>a1 s<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>pass3/get-arrow a1 e<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org311e1b6" class="outline-3">
<h3 id="org311e1b6">eva/dt</h3>
<div class="outline-text-3" id="text-org311e1b6">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">eva/dt</span> dt e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> <span style="color: #696969;">((</span>form1/name form1/arrow<span style="color: #696969;">)</span> <span style="color: #696969;">((</span>form1/name form1/arrow<span style="color: #696969;">)</span> ...<span style="color: #696969;">))</span> env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> env<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> dt
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{{</span>n a<span style="color: #B380A8;">}</span> nal<span style="color: #B380A8;">}</span>
        <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let*</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>nl <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">map</span> car nal<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
               <span style="color: #797979;">[</span>a0 <span style="color: #696969;">(</span>form1/arrow-&gt;arrow a e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
               <span style="color: #797979;">[</span>ns1 <span style="color: #696969;">(</span>cons <span style="color: #696969;">(</span>cons n
                                <span style="color: #B380A8;">{</span>'cons/type <span style="color: #B380A8;">{</span>a0 n nl<span style="color: #B380A8;">}}</span><span style="color: #696969;">)</span>
                          ns<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
          <span style="color: #696969;">(</span>eva/dt/data-constructor-list n nal <span style="color: #B380A8;">{</span>ds bs ns1<span style="color: #B380A8;">}</span><span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>

<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">eva/dt/data-constructor</span> type-name na e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> name <span style="color: #696969;">(</span>form1/name form1/arrow<span style="color: #696969;">)</span> env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> env<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> na
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>n a<span style="color: #B380A8;">}</span>
        <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>a0 <span style="color: #696969;">(</span>form1/arrow-&gt;arrow a e<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
          <span style="color: #B380A8;">{</span>ds
           bs
           <span style="color: #696969;">(</span>cons <span style="color: #696969;">(</span>cons n <span style="color: #B380A8;">{</span>'cons/data <span style="color: #B380A8;">{</span>a0 n type-name<span style="color: #B380A8;">}}</span><span style="color: #696969;">)</span>
                 ns<span style="color: #696969;">)</span><span style="color: #B380A8;">}</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>

<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">eva/dt/data-constructor-list</span> type-name nal e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> name <span style="color: #696969;">((</span>form1/name form1/arrow<span style="color: #696969;">)</span> ...<span style="color: #696969;">)</span> env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> env<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> nal
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{}</span> e<span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #696969;">(</span>na . r<span style="color: #696969;">)</span>
     <span style="color: #696969;">(</span>eva/dt/data-constructor-list
      type-name r
      <span style="color: #696969;">(</span>eva/dt/data-constructor type-name na e<span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb79520d" class="outline-3">
<h3 id="orgb79520d">eva/df</h3>
<div class="outline-text-3" id="text-orgb79520d">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">eva/df</span> df e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> <span style="color: #696969;">((</span>form1/name form1/arrow<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>form1/arrow ...<span style="color: #696969;">))</span> env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> env<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> df
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{{</span>n a<span style="color: #B380A8;">}</span> al<span style="color: #B380A8;">}</span>
        <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let*</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>a0 <span style="color: #696969;">(</span>form1/arrow-&gt;arrow a e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
               <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">need to put the type into ns first</span>
               <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">for recursive call in arrow-list</span>
               <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">that is</span>
               <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">in ns</span>
               <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">type global-bindings and arrow-list global-bindings</span>
               <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">must be separately interfaced</span>
               <span style="color: #797979;">[</span>ns0 <span style="color: #696969;">(</span>cons <span style="color: #696969;">(</span>cons n <span style="color: #B380A8;">{</span>'lambda <span style="color: #B380A8;">{</span>a0 'placeholder<span style="color: #B380A8;">}}</span><span style="color: #696969;">)</span>
                          ns<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
               <span style="color: #797979;">[</span>al0 <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">map</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">lambda</span> <span style="color: #696969;">(</span>x<span style="color: #696969;">)</span>
                           <span style="color: #696969;">(</span>form1/arrow-&gt;arrow x <span style="color: #B380A8;">{</span>ds bs ns0<span style="color: #B380A8;">}</span><span style="color: #696969;">))</span>
                      al<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
               <span style="color: #797979;">[</span>ns1 <span style="color: #696969;">(</span>cons <span style="color: #696969;">(</span>cons n
                                <span style="color: #B380A8;">{</span>'lambda <span style="color: #B380A8;">{</span>a0 al0<span style="color: #B380A8;">}}</span><span style="color: #696969;">)</span>
                          ns<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
          <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> <span style="color: #696969;">(</span>not check?<span style="color: #696969;">)</span>
            <span style="color: #B380A8;">{</span>ds bs ns1<span style="color: #B380A8;">}</span>
            <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>check a0 al0 <span style="color: #B380A8;">{</span>ds bs ns1<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span>
              <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">note that the bs of the env</span>
              <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">returned by check is not clean</span>
              <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">thus e1 is not used as return env</span>
              <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success e1<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>ds bs ns1<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
              <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span>
               <span style="color: #696969;">(</span>cat <span style="color: #696969;">(</span><span style="color: #e6db74;">"eva/df fail to define : ~a~%"</span> df<span style="color: #696969;">))</span>
               <span style="color: #696969;">(</span>pretty-print il<span style="color: #696969;">)</span>
               <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">orz</span> 'eva/df <span style="color: #696969;">(</span><span style="color: #e6db74;">"end of report~%"</span><span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">)))</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org69c4b08" class="outline-3">
<h3 id="org69c4b08">eva/ap</h3>
<div class="outline-text-3" id="text-org69c4b08">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">eva/ap</span> a e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> form1/arrow env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> env<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>a0 <span style="color: #696969;">(</span>form1/arrow-&gt;arrow a e<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
    <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>compute/arrow a0 e<span style="color: #696969;">)</span>
      <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success e1<span style="color: #B380A8;">}</span> e1<span style="color: #797979;">]</span>
      <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span>
       <span style="color: #696969;">(</span>cat <span style="color: #696969;">(</span><span style="color: #e6db74;">"eva/ap fail~%"</span><span style="color: #696969;">))</span>
       <span style="color: #696969;">(</span>pretty-print il<span style="color: #696969;">)</span>
       <span style="color: #696969;">(</span>cat <span style="color: #696969;">(</span><span style="color: #e6db74;">"~%"</span><span style="color: #696969;">))</span>
       <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">orz</span> 'eva/ap <span style="color: #696969;">(</span><span style="color: #e6db74;">"end of report~%"</span><span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">)))</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org63efe40" class="outline-2">
<h2 id="org63efe40">sequent</h2>
<div class="outline-text-2" id="text-org63efe40">
</div><div id="outline-container-org18c02eb" class="outline-3">
<h3 id="org18c02eb">sequent</h3>
<div class="outline-text-3" id="text-org18c02eb">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">sequent</span><span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #797979;">[</span>loop<span style="color: #797979;">]</span><span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span>cat <span style="color: #696969;">(</span><span style="color: #e6db74;">"welcome to sequent ^-^/~%"</span><span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span>sequent/repl init-env<span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org4fdadc" class="outline-3">
<h3 id="org4fdadc"><span class="todo _gt__lt_">&gt;&lt;</span> sequent/repl</h3>
<div class="outline-text-3" id="text-org4fdadc">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">sequent/repl</span> e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #797979;">[</span>loop<span style="color: #797979;">]</span><span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let*</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>top <span style="color: #696969;">(</span>read<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
         <span style="color: #797979;">[</span>e1 <span style="color: #696969;">(</span>eva/top <span style="color: #696969;">(</span>parse/top top<span style="color: #696969;">)</span> e<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
    <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e1
      <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds1 bs1 ns1<span style="color: #B380A8;">}</span>
       <span style="color: #696969;">(</span>print/data-list ds1 e1<span style="color: #696969;">)</span>
       <span style="color: #696969;">(</span>newline<span style="color: #696969;">)</span>
       <span style="color: #696969;">(</span>sequent/repl e1<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)))</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgfdc8c5" class="outline-2">
<h2 id="orgfdc8c5">check</h2>
<div class="outline-text-2" id="text-orgfdc8c5">
</div><div id="outline-container-org4fa4fc9" class="outline-3">
<h3 id="org4fa4fc9">check</h3>
<div class="outline-text-3" id="text-org4fa4fc9">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">check</span> t al e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> arrow <span style="color: #696969;">(</span>arrow ...<span style="color: #696969;">)</span> env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> report<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> al
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{}</span> <span style="color: #B380A8;">{</span>'success e<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #696969;">(</span>a . r<span style="color: #696969;">)</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>check/arrow t a e<span style="color: #696969;">)</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success e1<span style="color: #B380A8;">}</span>
        <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">note that the above return env is droped</span>
        <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">this is viewed as undo</span>
        <span style="color: #696969;">(</span>check t r e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org2ca5671" class="outline-3">
<h3 id="org2ca5671">check/arrow</h3>
<div class="outline-text-3" id="text-org2ca5671">
<ul class="org-ul">
<li><p>&gt;&lt;&gt;&lt;&gt;&lt; how to refactor this</p></li></ul>

<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">check/arrow</span> t a e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> arrow arrow env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> report<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>list t a<span style="color: #696969;">)</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{{</span>tac tsc<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>ac sc<span style="color: #B380A8;">}}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>alen <span style="color: #696969;">(</span>length ac<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
           <span style="color: #797979;">[</span>talen <span style="color: #696969;">(</span>length tac<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
           <span style="color: #797979;">[</span>slen <span style="color: #696969;">(</span>length sc<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
           <span style="color: #797979;">[</span>tslen <span style="color: #696969;">(</span>length tsc<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
       <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>compute/cedent tac e<span style="color: #696969;">)</span>
         <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span>
          <span style="color: #B380A8;">{</span>'fail <span style="color: #696969;">(</span>cons `<span style="color: #696969;">(</span>check/arrow
                         fail on compute/cedent
                         <span style="color: #696969;">(</span>type-antecedent: ,tac<span style="color: #696969;">))</span>
                       il<span style="color: #696969;">)</span><span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
         <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success e1<span style="color: #B380A8;">}</span>
          <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>type-compute/cedent ac e1<span style="color: #696969;">)</span>
            <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span>
             <span style="color: #B380A8;">{</span>'fail <span style="color: #696969;">(</span>cons `<span style="color: #696969;">(</span>check/arrow
                            fail on compute/cedent
                            <span style="color: #696969;">(</span>antecedent: ,ac<span style="color: #696969;">))</span>
                          il<span style="color: #696969;">)</span><span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
            <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success e2<span style="color: #B380A8;">}</span>
             <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e2
               <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds2 bs2 ns2<span style="color: #B380A8;">}</span>
                <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>unify/data-list
                        <span style="color: #696969;">(</span>take ds2 talen<span style="color: #696969;">)</span>
                        <span style="color: #696969;">(</span>take <span style="color: #696969;">(</span>drop ds2 talen<span style="color: #696969;">)</span> alen<span style="color: #696969;">)</span>
                        <span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>drop <span style="color: #696969;">(</span>drop ds2 talen<span style="color: #696969;">)</span> alen<span style="color: #696969;">)</span>
                                   bs2
                                   ns2<span style="color: #B380A8;">}}</span><span style="color: #696969;">)</span>
                  <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span>
                   <span style="color: #B380A8;">{</span>'fail <span style="color: #696969;">(</span>cons `<span style="color: #696969;">(</span>check/arrow
                                  fail on unify/data-list
                                  <span style="color: #696969;">(</span>type-antecedent: ,tac<span style="color: #696969;">)</span>
                                  <span style="color: #696969;">(</span>antecedent: ,ac<span style="color: #696969;">))</span>
                                il<span style="color: #696969;">)</span><span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
                  <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success e3<span style="color: #B380A8;">}</span>
                   <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>compute/cedent tsc e3<span style="color: #696969;">)</span>
                     <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span>
                      <span style="color: #B380A8;">{</span>'fail <span style="color: #696969;">(</span>cons `<span style="color: #696969;">(</span>check/arrow
                                     fail on compute/cedent
                                     <span style="color: #696969;">(</span>type-succedent: ,tsc<span style="color: #696969;">))</span>
                                   il<span style="color: #696969;">)</span><span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
                     <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success e4<span style="color: #B380A8;">}</span>
                      <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>type-compute/cedent sc e4<span style="color: #696969;">)</span>
                        <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span>
                         <span style="color: #B380A8;">{</span>'fail <span style="color: #696969;">(</span>cons `<span style="color: #696969;">(</span>check/arrow
                                        fail on
                                        <span style="color: #696969;">(</span>succedent: ,sc<span style="color: #696969;">))</span>
                                      il<span style="color: #696969;">)</span><span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
                        <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success e5<span style="color: #B380A8;">}</span>
                         <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e5
                           <span style="color: #797979;">[</span><span style="color: #696969;">(</span>ds5 bs5 ns5<span style="color: #696969;">)</span>
                            <span style="color: #696969;">(</span>unify/data-list
                             <span style="color: #696969;">(</span>take ds5 tslen<span style="color: #696969;">)</span>
                             <span style="color: #696969;">(</span>take <span style="color: #696969;">(</span>drop ds5 tslen<span style="color: #696969;">)</span> slen<span style="color: #696969;">)</span>
                             <span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>drop <span style="color: #696969;">(</span>drop ds5 tslen<span style="color: #696969;">)</span> slen<span style="color: #696969;">)</span>
                                        bs5
                                        ns5<span style="color: #B380A8;">}}</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgdebe45b" class="outline-2">
<h2 id="orgdebe45b">type-compute</h2>
<div class="outline-text-2" id="text-orgdebe45b">
</div><div id="outline-container-org1584686" class="outline-3">
<h3 id="org1584686">type-compute/cedent</h3>
<div class="outline-text-3" id="text-org1584686">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">type-compute/cedent</span> c e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> cedent env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> report<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> c
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{}</span> <span style="color: #B380A8;">{</span>'success e<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #696969;">(</span>d . r<span style="color: #696969;">)</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>type-compute d e<span style="color: #696969;">)</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success e1<span style="color: #B380A8;">}</span>
        <span style="color: #696969;">(</span>type-compute/cedent r e1<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgef3275f" class="outline-3">
<h3 id="orgef3275f">type-compute</h3>
<div class="outline-text-3" id="text-orgef3275f">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">type-compute</span> d e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> data env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> report<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> d
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'var x<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>type-compute/var x e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'cons x<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>type-compute/cons x e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'arrow x<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>type-compute/arrow x e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'lambda x<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>type-compute/lambda x e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'trunk x<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>type-compute/trunk x e<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org6452bae" class="outline-3">
<h3 id="org6452bae">type-compute/var</h3>
<div class="outline-text-3" id="text-org6452bae">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">type-compute/var</span> v e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> var env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> report<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> v
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>id level<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span>compute/var <span style="color: #B380A8;">{</span>id <span style="color: #696969;">(</span>+ 1 level<span style="color: #696969;">)</span><span style="color: #B380A8;">}</span> e<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org4f4fd84" class="outline-3">
<h3 id="org4f4fd84">type-compute/cons</h3>
<div class="outline-text-3" id="text-org4f4fd84">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">type-compute/cons</span> c e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> cons env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> report<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> c
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>n dl<span style="color: #B380A8;">}</span>
        <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>found <span style="color: #696969;">(</span>assq n ns<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
          <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> <span style="color: #696969;">(</span>not found<span style="color: #696969;">)</span>
            <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">orz</span> 'type-compute/cons
              <span style="color: #696969;">(</span><span style="color: #e6db74;">"unknow name : ~a~%"</span> n<span style="color: #696969;">)</span>
              <span style="color: #696969;">(</span><span style="color: #e6db74;">"cons : ~a~%"</span> c<span style="color: #696969;">))</span>
            <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>meaning <span style="color: #696969;">(</span>cdr found<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
              <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> meaning
                <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>any-type <span style="color: #696969;">(</span>t . __<span style="color: #696969;">)</span><span style="color: #B380A8;">}</span>
                 <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>type-compute/cedent <span style="color: #696969;">(</span>reverse dl<span style="color: #696969;">)</span> e<span style="color: #696969;">)</span>
                   <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
                   <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success e1<span style="color: #B380A8;">}</span>
                    <span style="color: #696969;">(</span>compute/arrow <span style="color: #696969;">(</span>copy-arrow t<span style="color: #696969;">)</span> e1<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))))</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org5abd77d" class="outline-3">
<h3 id="org5abd77d">type-compute/arrow</h3>
<div class="outline-text-3" id="text-org5abd77d">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">type-compute/arrow</span> a e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> arrow env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> report<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>copy-arrow a<span style="color: #696969;">)</span>
       <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">need to copy the arrow first</span>
       <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">because the return arrow might be applied somewhere else</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ac sc<span style="color: #B380A8;">}</span>
        <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>type-compute/cedent ac <span style="color: #B380A8;">{{}</span> <span style="color: #696969;">(</span>cons '<span style="color: #696969;">(</span>commit-point<span style="color: #696969;">)</span> bs<span style="color: #696969;">)</span> ns<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span>
          <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
          <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{</span>ds1 bs1 ns1<span style="color: #B380A8;">}}</span>
           <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>type-compute/cedent sc <span style="color: #B380A8;">{{}</span> bs1 ns1<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span>
             <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
             <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{</span>ds2 bs2 ns2<span style="color: #B380A8;">}}</span>
              <span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>cons <span style="color: #B380A8;">{</span>'arrow <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>reverse ds1<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reverse ds2<span style="color: #696969;">)</span><span style="color: #B380A8;">}}</span>
                               ds<span style="color: #696969;">)</span>
                         <span style="color: #696969;">(</span>bs/commit! bs2<span style="color: #696969;">)</span>
                         ns2<span style="color: #B380A8;">}}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org5438715" class="outline-3">
<h3 id="org5438715">type-compute/lambda</h3>
<div class="outline-text-3" id="text-org5438715">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">type-compute/lambda</span> l e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> lambda env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> report<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> l
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>a al<span style="color: #B380A8;">}</span>
        <span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>cons <span style="color: #B380A8;">{</span>'arrow a<span style="color: #B380A8;">}</span> ds<span style="color: #696969;">)</span>
                   bs
                   ns<span style="color: #B380A8;">}}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgafc7fd6" class="outline-3">
<h3 id="orgafc7fd6">type-compute/trunk</h3>
<div class="outline-text-3" id="text-orgafc7fd6">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">type-compute/trunk</span> t e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> trunk env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> report<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> t
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>a __ dl i<span style="color: #B380A8;">}</span>
        <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>type-compute/cedent <span style="color: #696969;">(</span>reverse dl<span style="color: #696969;">)</span> <span style="color: #B380A8;">{{}</span> bs ns<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span>
          <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
          <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success e1<span style="color: #B380A8;">}</span>
           <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e1
             <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds1 bs1 ns1<span style="color: #B380A8;">}</span>
              <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>compute/arrow <span style="color: #696969;">(</span>copy-arrow a<span style="color: #696969;">)</span> e1<span style="color: #696969;">)</span>
                <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
                <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success e2<span style="color: #B380A8;">}</span>
                 <span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>cons <span style="color: #696969;">(</span>proj i e2<span style="color: #696969;">)</span> ds<span style="color: #696969;">)</span>
                            bs1
                            ns1<span style="color: #B380A8;">}}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org1170b1a" class="outline-2">
<h2 id="org1170b1a">infer</h2>
<div class="outline-text-2" id="text-org1170b1a">
</div><div id="outline-container-org66e3b19" class="outline-3">
<h3 id="org66e3b19">infer/arrow</h3>
<div class="outline-text-3" id="text-org66e3b19">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">infer/arrow</span> a e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> arrow env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> arrow<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>type-compute/arrow a e<span style="color: #696969;">)</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">orz</span> 'infer/arrow
       <span style="color: #696969;">(</span><span style="color: #e6db74;">"fail to type-compute/arrow : ~a~%"</span> a<span style="color: #696969;">)</span>
       <span style="color: #696969;">(</span><span style="color: #e6db74;">"reported info-list : ~a~%"</span> il<span style="color: #696969;">))</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>a1 . __<span style="color: #696969;">)</span> __ __<span style="color: #B380A8;">}}</span>
     a1<span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org338f1ac" class="outline-3">
<h3 id="org338f1ac">infer/arrow-list</h3>
<div class="outline-text-3" id="text-org338f1ac">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">infer/arrow-list</span> al e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> <span style="color: #696969;">(</span>arrow ...<span style="color: #696969;">)</span> env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> arrow<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span>unite/arrow-list
   <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">map</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">lambda</span> <span style="color: #696969;">(</span>x<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>infer/arrow x e<span style="color: #696969;">))</span> al<span style="color: #696969;">)</span>
   e<span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org4253ee1" class="outline-3">
<h3 id="org4253ee1">unite/arrow-list</h3>
<div class="outline-text-3" id="text-org4253ee1">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">unite/arrow-list</span> al e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> <span style="color: #696969;">(</span>arrow ...<span style="color: #696969;">)</span> env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> arrow<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">letrec</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>recur
            <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">lambda</span> <span style="color: #696969;">(</span>a l<span style="color: #696969;">)</span>
              <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> arrow <span style="color: #696969;">(</span>arrow ...<span style="color: #696969;">)</span> <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> arrow<span style="color: #696969;">)</span>
              <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> l
                <span style="color: #797979;">[</span><span style="color: #B380A8;">{}</span> a<span style="color: #797979;">]</span>
                <span style="color: #797979;">[</span><span style="color: #696969;">(</span>h . r<span style="color: #696969;">)</span>
                 <span style="color: #696969;">(</span>recur <span style="color: #696969;">(</span>unite/two a h e<span style="color: #696969;">)</span> r<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
    <span style="color: #696969;">(</span>recur <span style="color: #696969;">(</span>car al<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>cdr al<span style="color: #696969;">))))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org62485bd" class="outline-3">
<h3 id="org62485bd">unite/two</h3>
<div class="outline-text-3" id="text-org62485bd">
<ul class="org-ul">
<li><p>this is the meet operation of the subsumption lattice of arrow</p></li></ul>

<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">unite/two</span> a1 a2 e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> arrow arrow env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> arrow<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #B380A8;">{</span>a1 a2<span style="color: #B380A8;">}</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{{</span>ac1 sc1<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>ac2 sc2<span style="color: #B380A8;">}}</span>
        <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>ac1 <span style="color: #696969;">(</span>copy-arrow ac1<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
              <span style="color: #797979;">[</span>sc1 <span style="color: #696969;">(</span>copy-arrow sc1<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
              <span style="color: #797979;">[</span>ac2 <span style="color: #696969;">(</span>copy-arrow ac2<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
              <span style="color: #797979;">[</span>sc2 <span style="color: #696969;">(</span>copy-arrow sc2<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
          <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>unify/data-list
                  ac1 ac2
                  <span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{{}</span> <span style="color: #696969;">(</span>cons '<span style="color: #696969;">(</span>commit-point<span style="color: #696969;">)</span> bs<span style="color: #696969;">)</span> ns<span style="color: #B380A8;">}}</span><span style="color: #696969;">)</span>
            <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">orz</span> 'unite/two
                          <span style="color: #696969;">(</span><span style="color: #e6db74;">"fail to unify antecedent~%"</span><span style="color: #696969;">)</span>
                          <span style="color: #696969;">(</span><span style="color: #e6db74;">"ac1 : ~a~%"</span> ac1<span style="color: #696969;">)</span>
                          <span style="color: #696969;">(</span><span style="color: #e6db74;">"ac2 : ~a~%"</span> ac2<span style="color: #696969;">))</span><span style="color: #797979;">]</span>
            <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{</span>__ bs1 ns1<span style="color: #B380A8;">}}</span>
             <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>unify/data-list
                     sc1 sc2
                     <span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{{}</span> bs1 ns1<span style="color: #B380A8;">}}</span><span style="color: #696969;">)</span>
               <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">orz</span> 'unite/two
                             <span style="color: #696969;">(</span><span style="color: #e6db74;">"fail to unify succedent~%"</span><span style="color: #696969;">)</span>
                             <span style="color: #696969;">(</span><span style="color: #e6db74;">"sc1 : ~a~%"</span> sc1<span style="color: #696969;">)</span>
                             <span style="color: #696969;">(</span><span style="color: #e6db74;">"sc2 : ~a~%"</span> sc2<span style="color: #696969;">))</span><span style="color: #797979;">]</span>
               <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{</span>ds2 bs2 ns2<span style="color: #B380A8;">}}</span>
                <span style="color: #696969;">(</span>bs/commit! bs2<span style="color: #696969;">)</span>
                <span style="color: #B380A8;">{</span>ac1 sc1<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
喪以不執 所執者喪 執喪相比 方死方生
</div>
</body>
</html>
