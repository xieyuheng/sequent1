<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2016-05-15 Sun 18:49 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>sequent1</title>
<meta name="generator" content="Org-mode" />
<meta name="author" content="XIE Yuheng" />
<link rel="stylesheet" href="http://xieyuheng.github.io/asset/css/page.css" type="text/css" media="screen" />
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="preamble" class="status">
喪以不執 所執者喪 執喪相比 方死方生
</div>
<div id="content">
<h1 class="title">sequent1</h1>
<div id="table-of-contents">
<h2>overview</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org25f48d8"><span class="done todo">todo</span> </a></li>
<li><a href="#org223514"><span class="todo note">note</span> </a>
<ul>
<li><a href="#orgc6e2bf5">unsatisfactory features</a></li>
<li><a href="#orgcf866b0">sequent</a></li>
<li><a href="#org5762f78">form1</a></li>
<li><a href="#orgeddb42b">form2</a></li>
<li><a href="#orgb499910">form3</a></li>
<li><a href="#orgafbb4f9">data</a></li>
<li><a href="#orge437756">env</a></li>
<li><a href="#orgd624679">report</a></li>
<li><a href="#org4bcb317">top</a></li>
<li><a href="#org4330e20">no dependent type in scheme</a></li>
</ul>
</li>
<li><a href="#orgc0feb8c">pass1</a>
<ul>
<li><a href="#org4028784"><span class="todo note">note</span> </a></li>
<li><a href="#org999fd96">pass1/arrow</a></li>
<li><a href="#orge85f3c7">pass1/cedent</a></li>
<li><a href="#orgda5ae5">predicates</a></li>
<li><a href="#org887b0ea">pass1</a></li>
<li><a href="#org5c408c3">pass1/var</a></li>
</ul>
</li>
<li><a href="#org297ff5e">pass2</a>
<ul>
<li><a href="#org4e743a2"><span class="todo note">note</span> </a></li>
<li><a href="#org7912280">pass2/get-arrow</a></li>
<li><a href="#org324189a">pass2/arrow</a></li>
<li><a href="#orgb1ba4c7">pass2/cedent</a></li>
<li><a href="#org5b40725">pass2/lambda</a></li>
<li><a href="#org8f08085">pass2</a></li>
<li><a href="#org65729ca">id/new</a></li>
<li><a href="#org9a319e0">pass2/var</a></li>
<li><a href="#orgce2ab69">pass2/bind</a></li>
</ul>
</li>
<li><a href="#orga9be135">pass3</a>
<ul>
<li><a href="#orgd94b48f"><span class="todo note">note</span> </a></li>
<li><a href="#orge92d0e5">env/pop</a></li>
<li><a href="#org2708177">pass3/get-arrow</a></li>
<li><a href="#orgb4e282f">pass3/arrow</a></li>
<li><a href="#orgd603320">pass3/get-arrow-check</a></li>
<li><a href="#org43ab821">pass3/arrow-check</a></li>
<li><a href="#orgda8331a">pass3/cedent</a></li>
<li><a href="#org4fc0ad5">pass3/lambda</a></li>
<li><a href="#org6529b6">pass3</a></li>
<li><a href="#org771fd05">pass3/var</a></li>
<li><a href="#orgfd09ee1">pass3/apply</a></li>
<li><a href="#org2e9be1c">pass3/apply/data</a></li>
<li><a href="#org6075a24">pass3/apply/arrow</a></li>
<li><a href="#org8e9b862">pass3/apply/lambda</a></li>
<li><a href="#orgef95b48">pass3/apply/var</a></li>
<li><a href="#org9dab3e1">id-&gt;name &amp; id-&gt;counter &amp; id-&gt;ls</a></li>
<li><a href="#org94389b8">pass3/name</a></li>
<li><a href="#org80dacae">pass3/name/cons</a></li>
<li><a href="#org5288032">pass3/name/trunk</a></li>
<li><a href="#org36683c5">pass3/bind</a></li>
<li><a href="#orgfff4340">id/commit!</a></li>
</ul>
</li>
<li><a href="#org57e57b2">bind-stack</a>
<ul>
<li><a href="#org67da8af"><span class="todo note">note</span> </a></li>
<li><a href="#org94fbd55">bs/find</a></li>
<li><a href="#orga046707">bs/walk</a></li>
<li><a href="#orgda8b134">bs/deep</a></li>
<li><a href="#orgfe5b1b7">var/fresh?</a></li>
</ul>
</li>
<li><a href="#orgad067ee">copy-arrow</a>
<ul>
<li><a href="#orgf813a55"><span class="todo note">note</span> </a></li>
<li><a href="#org84e3e5f">copy-arrow</a></li>
<li><a href="#org50c5641">copy-cedent</a></li>
<li><a href="#orgd6699ab">copy/arrow</a></li>
<li><a href="#org87accab">copy/data-list</a></li>
<li><a href="#orgaffdf86">copy/cedent</a></li>
<li><a href="#orga9d883a">copy/lambda</a></li>
<li><a href="#orga8d4203">copy/arrow-list</a></li>
<li><a href="#org2a97b08">copy</a></li>
<li><a href="#org54e4702">copy/var</a></li>
<li><a href="#org402da70">copy/ls</a></li>
<li><a href="#org6bfd16e">copy/cons</a></li>
<li><a href="#org83ceec8">copy/trunk</a></li>
</ul>
</li>
<li><a href="#orgf16b8e0">compute</a>
<ul>
<li><a href="#orge6f2d32">compute/arrow</a></li>
<li><a href="#org55ac307">bs/commit!</a></li>
<li><a href="#orge9c4287">compute/cedent</a></li>
<li><a href="#org17c77b">compute</a></li>
<li><a href="#orga307604">compute/var</a></li>
<li><a href="#org1a942ac">compute/cons</a></li>
<li><a href="#orgf6e14e3">compute/trunk</a>
<ul>
<li><a href="#orga39300f">compute/trunk</a></li>
<li><a href="#orgb230089">compute/trunk/tody/var</a></li>
<li><a href="#org24e1638">compute/trunk/tody/name</a></li>
<li><a href="#org692192">compute/trunk/tody/arrow-list</a></li>
<li><a href="#orgdafed1d">trunk-&gt;trunk*</a></li>
</ul>
</li>
<li><a href="#org16971be">list-unify/antecedent</a></li>
<li><a href="#orgf9b996f">filter-arrow-list</a></li>
<li><a href="#orgca565d9">proj</a></li>
</ul>
</li>
<li><a href="#org873e190">print</a>
<ul>
<li><a href="#orge85761e">print/cedent</a></li>
<li><a href="#orgc506fd8">print/data-list</a></li>
<li><a href="#org959040e">print/data</a></li>
<li><a href="#orgd98e55d">print/var</a></li>
<li><a href="#org8c17f7f">print/cons</a></li>
<li><a href="#org50624a3">print/arrow</a></li>
<li><a href="#org6b5a0ef"><span class="todo _gt__lt_">&gt;&lt;</span> print/lambda</a></li>
<li><a href="#org7620712"><span class="todo _gt__lt_">&gt;&lt;</span> print/trunk</a></li>
</ul>
</li>
<li><a href="#orgc91ce8b">unify</a>
<ul>
<li><a href="#orgec25a81"><span class="todo note">note</span> </a></li>
<li><a href="#org29a8353">unify/data-list</a></li>
<li><a href="#org1195e5a">var/eq?</a></li>
<li><a href="#org31f15e1">unify/data</a></li>
<li><a href="#org80f4ee0">bs/extend</a></li>
<li><a href="#org4e4458b">unify/var/data</a></li>
<li><a href="#orgcc58fe">consistent-check</a>
<ul>
<li><a href="#orgad07300">consistent-check</a></li>
<li><a href="#org367d029">consistent-check/level-diff</a></li>
<li><a href="#org772f066">type-compute/repeat</a></li>
<li><a href="#org2bd13ca">var/highest? &amp; var/lowest?</a></li>
<li><a href="#org64f567f">var/above &amp; var/below</a></li>
</ul>
</li>
<li><a href="#orgf7bdd3b">unify/cons</a></li>
<li><a href="#org5e29aa2">unify/arrow</a></li>
<li><a href="#orgfef9edf">unify/lambda</a></li>
<li><a href="#orgaab8e8c">unify/arrow-list</a></li>
<li><a href="#org4fc1b5c">unify/trunk</a>
<ul>
<li><a href="#org5251c4a"><span class="todo note">note</span> </a></li>
<li><a href="#org20316d1">unify/trunk</a></li>
<li><a href="#org94d877c">unify/trunk/syntactic</a></li>
<li><a href="#org7dc3982">unify/trunk/semantic</a></li>
</ul>
</li>
<li><a href="#org23c7776">unify/trunk/data</a></li>
</ul>
</li>
<li><a href="#org4dc6f2c">eva</a>
<ul>
<li><a href="#orgd1c0abd">init-env</a></li>
<li><a href="#org44cce8a">eva</a></li>
<li><a href="#orgd0e9d9b">eva/top-list</a></li>
<li><a href="#org9150dd7">parse/top</a></li>
<li><a href="#org3c8fa2b">parse/top/deftype-body</a></li>
<li><a href="#org40ead6e">eva/top</a></li>
<li><a href="#org84cb112">form1/arrow-&gt;arrow</a></li>
<li><a href="#org7b8dcc">form1/arrow-&gt;arrow-check</a></li>
<li><a href="#org60e4a0c">eva/app</a></li>
<li><a href="#orgf6f18e9">eva/deftype</a></li>
<li><a href="#orgbe84b60">cover-check? &amp; cover-check- &amp; cover-check+</a></li>
<li><a href="#org97af248">recur-check? &amp; recur-check- &amp; recur-check+</a></li>
<li><a href="#org59a4f3">eva/defn</a></li>
</ul>
</li>
<li><a href="#org87014c4">sequent</a>
<ul>
<li><a href="#orgb619f60">sequent</a></li>
<li><a href="#org3441a3a"><span class="todo _gt__lt_">&gt;&lt;</span> sequent/repl</a></li>
</ul>
</li>
<li><a href="#orge4a41c1">type-compute</a>
<ul>
<li><a href="#org3d7f5d3">type-compute/cedent</a></li>
<li><a href="#org29030d7">type-compute</a></li>
<li><a href="#org50f72a0">type-compute/var</a></li>
<li><a href="#orga7f4e47">type-compute/cons</a></li>
<li><a href="#orga06f22e">type-compute/arrow</a></li>
<li><a href="#org7b87d93">type-compute/lambda</a></li>
<li><a href="#orge2a3b6">type-compute/trunk</a></li>
</ul>
</li>
<li><a href="#org96e7b42">infer</a>
<ul>
<li><a href="#org6d98158">infer/arrow</a></li>
<li><a href="#orgf717ef3">infer/arrow-list</a></li>
<li><a href="#orge5e9487">unite/arrow-list</a></li>
<li><a href="#orgd1e42c">unite/two</a></li>
</ul>
</li>
<li><a href="#orge42de58">cover-check</a>
<ul>
<li><a href="#org1766446">cover-check</a></li>
<li><a href="#org338c7aa"><span class="todo _gt__lt_">&gt;&lt;</span> cover-check/cedent</a></li>
<li><a href="#org1271f98"><span class="todo _gt__lt_">&gt;&lt;</span> </a></li>
<li><a href="#org73d83be"><span class="todo note">note</span> alterdata</a></li>
<li><a href="#org4e362bb">data-gen</a></li>
<li><a href="#org29881d3"><span class="todo _gt__lt_">&gt;&lt;</span> alter-expand</a></li>
<li><a href="#orgb0d7e4d">data-gen/cedent</a></li>
<li><a href="#org87bfc24">data-gen/data</a></li>
<li><a href="#orga4aaf63"><span class="todo _gt__lt_">&gt;&lt;</span> data-gen/cons</a></li>
<li><a href="#org3d9cfea"><span class="todo _gt__lt_">&gt;&lt;</span> data-gen/var</a></li>
<li><a href="#orgf9da6a"><span class="todo _gt__lt_">&gt;&lt;</span> data-gen/arrow</a></li>
<li><a href="#orgb65a78d"><span class="todo _gt__lt_">&gt;&lt;</span> data-gen/trunk</a></li>
<li><a href="#org39ff141">data-gen/lambda</a></li>
</ul>
</li>
<li><a href="#orgce6e26">recur-check</a>
<ul>
<li><a href="#org659aca9"><span class="todo note">note</span> </a></li>
<li><a href="#org5adac58"><span class="todo _gt__lt_">&gt;&lt;</span> recur-check</a></li>
</ul>
</li>
</ul>
</div>
</div>
<hr  />

<ul class="org-ul">
<li><p>the implementation of the interpreter (<a href="https://github.com/xieyuheng/sequent1">source</a>)</p></li></ul>

<hr  />

<div id="outline-container-org25f48d8" class="outline-2">
<h2 id="org25f48d8"><span class="done todo">todo</span> </h2>
<div class="outline-text-2" id="text-org25f48d8">
<ul class="org-ul">
<li><p>examples I need more examples</p></li>

<li><p>cover-check</p></li>

<li><p>recur-check</p></li>

<li><p>repl handles error</p></li>

<li><p>report info should be strictly structured</p></li></ul>
</div>
</div>

<div id="outline-container-org223514" class="outline-2">
<h2 id="org223514"><span class="todo note">note</span> </h2>
<div class="outline-text-2" id="text-org223514">
</div><div id="outline-container-orgc6e2bf5" class="outline-3">
<h3 id="orgc6e2bf5">unsatisfactory features</h3>
<div class="outline-text-3" id="text-orgc6e2bf5">
<ul class="org-ul">
<li><p>as a prototype implementation its unsatisfactory features are</p><p><ol class="org-ol"></p><p><li>call-by-name</li></p><p><li>using copy to handle scope</li></ol></p></li></ul>
</div>
</div>

<div id="outline-container-orgcf866b0" class="outline-3">
<h3 id="orgcf866b0">sequent</h3>
<div class="outline-text-3" id="text-orgcf866b0">
<ul class="org-ul">
<li><p>sequent is called arrow here</p><p>which is the core data type of the language</p></li></ul>
</div>
</div>

<div id="outline-container-org5762f78" class="outline-3">
<h3 id="org5762f78">form1</h3>
<div class="outline-text-3" id="text-org5762f78">
<ul class="org-ul">
<li><p>reduction strategy is revealed by the postfix notation</p></li></ul>

<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">type</span> form1
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">type</span> form1/var
    <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">example</span>
      <span style="color: #a6e22e;">:var</span>
      <span style="color: #a6e22e;">:var^n</span><span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">type</span> form1/name
    symbol<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">type</span> form1/arrow
    '<span style="color: #696969;">(</span>form1 ... <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> form1 ...<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">type</span> form1/lambda
    '<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">lambda</span> form1/arrow
       form1/arrow
       ...<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">type</span> form1/im-bind
    '<span style="color: #696969;">(</span>form1/var ... : form1 ...<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">type</span> form1/ex-bind
    '<span style="color: #696969;">(</span>form1/var ... @ form1 ...<span style="color: #696969;">)))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgeddb42b" class="outline-3">
<h3 id="orgeddb42b">form2</h3>
<div class="outline-text-3" id="text-orgeddb42b">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">type</span> form2
  <span style="color: #B380A8;">{</span>'form2/var    <span style="color: #B380A8;">{</span>symbol level<span style="color: #B380A8;">}}</span>
  <span style="color: #B380A8;">{</span>'form2/name   symbol<span style="color: #B380A8;">}</span>
  <span style="color: #B380A8;">{</span>'form2/arrow  <span style="color: #B380A8;">{{</span>form2 ...<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>form2 ...<span style="color: #B380A8;">}}}</span>
  <span style="color: #B380A8;">{</span>'form2/lambda <span style="color: #B380A8;">{</span>form2/arrow <span style="color: #B380A8;">{</span>form2/arrow ...<span style="color: #B380A8;">}}}</span>
  <span style="color: #B380A8;">{</span>'form2/bind   <span style="color: #B380A8;">{{</span>form2/var ...<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>form2 ...<span style="color: #B380A8;">}</span> leave?<span style="color: #B380A8;">}}</span><span style="color: #696969;">)</span>
<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">type</span> level natural-number<span style="color: #696969;">)</span>
<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">type</span> leave? bool<span style="color: #696969;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb499910" class="outline-3">
<h3 id="orgb499910">form3</h3>
<div class="outline-text-3" id="text-orgb499910">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">type</span> form3
  <span style="color: #B380A8;">{</span>'form3/var    <span style="color: #B380A8;">{</span>id level<span style="color: #B380A8;">}}</span>
  <span style="color: #B380A8;">{</span>'form3/name   symbol<span style="color: #B380A8;">}</span>
  <span style="color: #B380A8;">{</span>'form3/arrow  <span style="color: #B380A8;">{{</span>form3 ...<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>form3 ...<span style="color: #B380A8;">}}}</span>
  <span style="color: #B380A8;">{</span>'form3/lambda <span style="color: #B380A8;">{</span>form3/arrow <span style="color: #B380A8;">{</span>form3/arrow ...<span style="color: #B380A8;">}}}</span>
  <span style="color: #B380A8;">{</span>'form3/bind   <span style="color: #B380A8;">{{</span>form3/var ...<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>form3 ...<span style="color: #B380A8;">}</span> leave?<span style="color: #B380A8;">}}</span><span style="color: #696969;">)</span>
<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">type</span> id #<span style="color: #696969;">((</span>name . counter<span style="color: #696969;">)</span> ls<span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgafbb4f9" class="outline-3">
<h3 id="orgafbb4f9">data</h3>
<div class="outline-text-3" id="text-orgafbb4f9">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">type</span> data
  <span style="color: #B380A8;">{</span>'var    <span style="color: #B380A8;">{</span>id level<span style="color: #B380A8;">}}</span>
  <span style="color: #B380A8;">{</span>'cons   <span style="color: #B380A8;">{</span>name <span style="color: #B380A8;">{</span>data ...<span style="color: #B380A8;">}}}</span>
  <span style="color: #B380A8;">{</span>'arrow  <span style="color: #B380A8;">{</span>cedent cedent<span style="color: #B380A8;">}}</span>
  <span style="color: #B380A8;">{</span>'lambda <span style="color: #B380A8;">{</span>arrow <span style="color: #B380A8;">{</span>arrow ...<span style="color: #B380A8;">}}}</span>
  <span style="color: #B380A8;">{</span>'trunk  <span style="color: #B380A8;">{</span>arrow tody <span style="color: #B380A8;">{</span>data ...<span style="color: #B380A8;">}</span> index<span style="color: #B380A8;">}}</span><span style="color: #696969;">)</span>
<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">type</span> cedent <span style="color: #B380A8;">{</span>data ...<span style="color: #B380A8;">}</span>
      <span style="color: #797979;">[</span>reverse a cedent get data-list<span style="color: #797979;">]</span><span style="color: #696969;">)</span>
<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">type</span> tody <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">trunk-body</span>
  <span style="color: #B380A8;">{</span>'tody/name name<span style="color: #B380A8;">}</span>
  <span style="color: #B380A8;">{</span>'tody/arrow-list <span style="color: #B380A8;">{</span>arrow ...<span style="color: #B380A8;">}}</span>
  <span style="color: #B380A8;">{</span>'tody/var var<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orge437756" class="outline-3">
<h3 id="orge437756">env</h3>
<div class="outline-text-3" id="text-orge437756">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">type</span> env <span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span>
<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">type</span> ds <span style="color: #B380A8;">{</span>data ...<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span>
<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">type</span> bs <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>id . ls<span style="color: #696969;">)</span> ...<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span>
<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">type</span> ns <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>name . meaning<span style="color: #696969;">)</span> ...<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span>
<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">type</span> ls <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>level . data<span style="color: #696969;">)</span> ...<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span>
<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">type</span> meaning
  <span style="color: #B380A8;">{</span>'cons/type <span style="color: #B380A8;">{</span>arrow name <span style="color: #B380A8;">{</span>name ...<span style="color: #B380A8;">}}}</span>
  <span style="color: #B380A8;">{</span>'cons/data <span style="color: #B380A8;">{</span>arrow name name<span style="color: #B380A8;">}}</span>
  <span style="color: #B380A8;">{</span>'lambda    <span style="color: #B380A8;">{</span>arrow <span style="color: #B380A8;">{</span>arrow ...<span style="color: #B380A8;">}}}</span><span style="color: #696969;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd624679" class="outline-3">
<h3 id="orgd624679">report</h3>
<div class="outline-text-3" id="text-orgd624679">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">type</span> report
  <span style="color: #B380A8;">{</span>'fail <span style="color: #B380A8;">{</span>info ...<span style="color: #B380A8;">}}</span>
  <span style="color: #B380A8;">{</span>'success env<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span>
<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">type</span> info <span style="color: #66d9ef; font-weight: bold;">&lt;free&gt;</span><span style="color: #696969;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org4bcb317" class="outline-3">
<h3 id="org4bcb317">top</h3>
<div class="outline-text-3" id="text-org4bcb317">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">type</span> top
  <span style="color: #B380A8;">{</span>'deftype <span style="color: #B380A8;">{{</span>form1/name form1/arrow<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{{</span>form1/name form1/arrow<span style="color: #B380A8;">}</span> ...<span style="color: #B380A8;">}}}</span>
  <span style="color: #B380A8;">{</span>'defn <span style="color: #B380A8;">{{</span>form1/name form1/arrow<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>form1/arrow ...<span style="color: #B380A8;">}}}</span>
  <span style="color: #B380A8;">{</span>'app form1/arrow<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org4330e20" class="outline-3">
<h3 id="org4330e20">no dependent type in scheme</h3>
<div class="outline-text-3" id="text-org4330e20">
<ul class="org-ul">
<li><p>because I am not documenting these scheme functions by dependent type</p><p>the type document already fail to express</p><p>most of the natural of env passing functions</p></li>

<li><p>not to mention the invariants of functions which is described by english</p><p>neither they can be expressed by the week type notation</p></li>

<li><p>it is such a cognitive burden</p><p>it is what makes programming a hard work where mistake is too easy</p></li></ul>
</div>
</div>
</div>

<div id="outline-container-orgc0feb8c" class="outline-2">
<h2 id="orgc0feb8c">pass1</h2>
<div class="outline-text-2" id="text-orgc0feb8c">
</div><div id="outline-container-org4028784" class="outline-3">
<h3 id="org4028784"><span class="todo note">note</span> </h3>
<div class="outline-text-3" id="text-org4028784">
<ul class="org-ul">
<li><p>form1 -pass1-&gt; form2</p><p>default-level of var is handled here</p></li></ul>
</div>
</div>

<div id="outline-container-org999fd96" class="outline-3">
<h3 id="org999fd96">pass1/arrow</h3>
<div class="outline-text-3" id="text-org999fd96">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">pass1/arrow</span> default-level s<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> default-level form1/arrow <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> form2/arrow<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span>list <span style="color: #696969;">(</span>pass1/cedent default-level <span style="color: #696969;">(</span>left-of '<span style="color: #66d9ef; font-weight: bold;">-&gt;</span> s<span style="color: #696969;">))</span>
        <span style="color: #696969;">(</span>pass1/cedent default-level <span style="color: #696969;">(</span>right-of '<span style="color: #66d9ef; font-weight: bold;">-&gt;</span> s<span style="color: #696969;">))))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orge85f3c7" class="outline-3">
<h3 id="orge85f3c7">pass1/cedent</h3>
<div class="outline-text-3" id="text-orge85f3c7">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">pass1/cedent</span> default-level s<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> default-level <span style="color: #696969;">(</span>form1 ...<span style="color: #696969;">)</span> <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #696969;">(</span>form2 ...<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> s
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{}</span> <span style="color: #B380A8;">{}</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #696969;">(</span>h . r<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>cons <span style="color: #696969;">(</span>pass1 default-level h<span style="color: #696969;">)</span>
                   <span style="color: #696969;">(</span>pass1/cedent default-level r<span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgda5ae5" class="outline-3">
<h3 id="orgda5ae5">predicates</h3>
<div class="outline-text-3" id="text-orgda5ae5">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">form1/var?</span> v<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">and</span> <span style="color: #696969;">(</span>symbol? v<span style="color: #696969;">)</span>
       <span style="color: #696969;">(</span>equal? <span style="color: #e6db74;">":"</span> <span style="color: #696969;">(</span>substring <span style="color: #696969;">(</span>symbol-&gt;string v<span style="color: #696969;">)</span> 0 1<span style="color: #696969;">))))</span>

<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">form1/name?</span> v<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">and</span> <span style="color: #696969;">(</span>symbol? v<span style="color: #696969;">)</span>
       <span style="color: #696969;">(</span>not <span style="color: #696969;">(</span>eq? <span style="color: #e6db74;">":"</span> <span style="color: #696969;">(</span>substring <span style="color: #696969;">(</span>symbol-&gt;string v<span style="color: #696969;">)</span> 0 1<span style="color: #696969;">)))))</span>

<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">form1/arrow?</span> v<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">and</span> <span style="color: #696969;">(</span>list? v<span style="color: #696969;">)</span>
       <span style="color: #696969;">(</span>member '<span style="color: #66d9ef; font-weight: bold;">-&gt;</span> v<span style="color: #696969;">)))</span>

<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">form1/lambda?</span> v<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">and</span> <span style="color: #696969;">(</span>list? v<span style="color: #696969;">)</span>
       <span style="color: #696969;">(</span>eq? <span style="color: #696969;">(</span>car v<span style="color: #696969;">)</span> 'lambda<span style="color: #696969;">)))</span>

<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">form1/im-bind?</span> v<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">and</span> <span style="color: #696969;">(</span>list? v<span style="color: #696969;">)</span>
       <span style="color: #696969;">(</span>member ': v<span style="color: #696969;">)))</span>

<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">form1/ex-bind?</span> v<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">and</span> <span style="color: #696969;">(</span>list? v<span style="color: #696969;">)</span>
       <span style="color: #696969;">(</span>member '@ v<span style="color: #696969;">)))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org887b0ea" class="outline-3">
<h3 id="org887b0ea">pass1</h3>
<div class="outline-text-3" id="text-org887b0ea">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">pass1</span> default-level v<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> default-level form1 <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> form2<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">cond</span> <span style="color: #797979;">[</span><span style="color: #696969;">(</span>form1/var? v<span style="color: #696969;">)</span>
         <span style="color: #696969;">(</span>list 'form2/var
               <span style="color: #696969;">(</span>pass1/var default-level v<span style="color: #696969;">))</span><span style="color: #797979;">]</span>
        <span style="color: #797979;">[</span><span style="color: #696969;">(</span>form1/name? v<span style="color: #696969;">)</span>
         <span style="color: #696969;">(</span>list 'form2/name
               v<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
        <span style="color: #797979;">[</span><span style="color: #696969;">(</span>form1/arrow? v<span style="color: #696969;">)</span>
         <span style="color: #696969;">(</span>list 'form2/arrow
               <span style="color: #696969;">(</span>pass1/arrow default-level v<span style="color: #696969;">))</span><span style="color: #797979;">]</span>
        <span style="color: #797979;">[</span><span style="color: #696969;">(</span>form1/lambda? v<span style="color: #696969;">)</span>
         <span style="color: #696969;">(</span>list 'form2/lambda
               <span style="color: #696969;">(</span>list <span style="color: #696969;">(</span>pass1/arrow default-level <span style="color: #696969;">(</span>cadr v<span style="color: #696969;">))</span>
                     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">map</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">lambda</span> <span style="color: #696969;">(</span>x<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>pass1/arrow default-level x<span style="color: #696969;">))</span>
                       <span style="color: #696969;">(</span>cddr v<span style="color: #696969;">))))</span><span style="color: #797979;">]</span>
        <span style="color: #797979;">[</span><span style="color: #696969;">(</span>form1/im-bind? v<span style="color: #696969;">)</span>
         <span style="color: #696969;">(</span>list 'form2/bind
               <span style="color: #696969;">(</span>list <span style="color: #696969;">(</span>pass1/cedent 1 <span style="color: #696969;">(</span>left-of ': v<span style="color: #696969;">))</span>
                     <span style="color: #696969;">(</span>pass1/cedent 0 <span style="color: #696969;">(</span>right-of ': v<span style="color: #696969;">))</span>
                     #f<span style="color: #696969;">))</span><span style="color: #797979;">]</span>
        <span style="color: #797979;">[</span><span style="color: #696969;">(</span>form1/ex-bind? v<span style="color: #696969;">)</span>
         <span style="color: #696969;">(</span>list 'form2/bind
               <span style="color: #696969;">(</span>list <span style="color: #696969;">(</span>pass1/cedent 1 <span style="color: #696969;">(</span>left-of '@ v<span style="color: #696969;">))</span>
                     <span style="color: #696969;">(</span>pass1/cedent 0 <span style="color: #696969;">(</span>right-of '@ v<span style="color: #696969;">))</span>
                     #t<span style="color: #696969;">))</span><span style="color: #797979;">]</span>
        <span style="color: #797979;">[</span>else
         <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">orz</span> 'pass1 <span style="color: #696969;">(</span><span style="color: #e6db74;">"pass1 can not handle sexp-form:~a"</span> v<span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org5c408c3" class="outline-3">
<h3 id="org5c408c3">pass1/var</h3>
<div class="outline-text-3" id="text-org5c408c3">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">pass1/var</span> default-level v<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> default-level symbol <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> form2/var<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let*</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>str <span style="color: #696969;">(</span>symbol-&gt;string v<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
         <span style="color: #797979;">[</span>cursor <span style="color: #696969;">(</span>find-char <span style="color: #e6db74;">"^"</span> str<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
    <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> cursor
      <span style="color: #696969;">(</span>list <span style="color: #696969;">(</span>string-&gt;symbol <span style="color: #696969;">(</span>substring str 0 cursor<span style="color: #696969;">))</span>
            <span style="color: #696969;">(</span>string-&gt;number <span style="color: #696969;">(</span>substring str <span style="color: #696969;">(</span>+ 1 cursor<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>string-length str<span style="color: #696969;">))))</span>
      <span style="color: #696969;">(</span>list v default-level<span style="color: #696969;">))))</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org297ff5e" class="outline-2">
<h2 id="org297ff5e">pass2</h2>
<div class="outline-text-2" id="text-org297ff5e">
</div><div id="outline-container-org4e743a2" class="outline-3">
<h3 id="org4e743a2"><span class="todo note">note</span> </h3>
<div class="outline-text-3" id="text-org4e743a2">
<ul class="org-ul">
<li><p>form2 -pass2-&gt; form3</p><p>id of var is handled here</p></li></ul>
</div>
</div>

<div id="outline-container-org7912280" class="outline-3">
<h3 id="org7912280">pass2/get-arrow</h3>
<div class="outline-text-3" id="text-org7912280">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">pass2/get-arrow</span> a s<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> form2/arrow scope <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> form3/arrow<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>pass2/arrow a s<span style="color: #696969;">)</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>a1 s<span style="color: #B380A8;">}</span> a1<span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org324189a" class="outline-3">
<h3 id="org324189a">pass2/arrow</h3>
<div class="outline-text-3" id="text-org324189a">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">pass2/arrow</span> a s<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> form2/arrow scope <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #696969;">(</span>form3/arrow scope<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> a
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ac sc<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>pass2/cedent ac s<span style="color: #696969;">)</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ac1 s1<span style="color: #B380A8;">}</span>
        <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>pass2/cedent sc s1<span style="color: #696969;">)</span>
          <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>sc1 s2<span style="color: #B380A8;">}</span>
           <span style="color: #B380A8;">{{</span>ac1 sc1<span style="color: #B380A8;">}</span> s2<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb1ba4c7" class="outline-3">
<h3 id="orgb1ba4c7">pass2/cedent</h3>
<div class="outline-text-3" id="text-orgb1ba4c7">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">pass2/cedent</span> c s<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> <span style="color: #696969;">(</span>form2 ...<span style="color: #696969;">)</span> scope <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #696969;">((</span>form3 ...<span style="color: #696969;">)</span> scope<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> c
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{}</span> <span style="color: #B380A8;">{{}</span> s<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #696969;">(</span>f . r<span style="color: #696969;">)</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>pass2 f s<span style="color: #696969;">)</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>f1 s1<span style="color: #B380A8;">}</span>
        <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>pass2/cedent r s1<span style="color: #696969;">)</span>
          <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>c1 s2<span style="color: #B380A8;">}</span>
           <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>cons f1 c1<span style="color: #696969;">)</span> s2<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org5b40725" class="outline-3">
<h3 id="org5b40725">pass2/lambda</h3>
<div class="outline-text-3" id="text-org5b40725">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">pass2/lambda</span> l s<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> form2/lambda scope <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #696969;">(</span>form3/lambda scope<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> l
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>a al<span style="color: #B380A8;">}</span>
     <span style="color: #B380A8;">{{</span><span style="color: #696969;">(</span>pass2/get-arrow a s<span style="color: #696969;">)</span>
       <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">map</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">lambda</span> <span style="color: #696969;">(</span>x<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>pass2/get-arrow x s<span style="color: #696969;">))</span>
         al<span style="color: #696969;">)</span><span style="color: #B380A8;">}</span>
      s<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org8f08085" class="outline-3">
<h3 id="org8f08085">pass2</h3>
<div class="outline-text-3" id="text-org8f08085">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">pass2</span> f s<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> form2 scope <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #696969;">(</span>form2 scope<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> f
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'form2/var v<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>pass2/var v s<span style="color: #696969;">)</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>v1 s1<span style="color: #B380A8;">}</span>
        <span style="color: #B380A8;">{{</span>'form3/var v1<span style="color: #B380A8;">}</span> s1<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'form2/name n<span style="color: #B380A8;">}</span>
     <span style="color: #B380A8;">{{</span>'form3/name n<span style="color: #B380A8;">}</span> s<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'form2/arrow a<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>pass2/arrow a s<span style="color: #696969;">)</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>a1 s1<span style="color: #B380A8;">}</span>
        <span style="color: #B380A8;">{{</span>'form3/arrow a1<span style="color: #B380A8;">}</span> s1<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'form2/lambda l<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>pass2/lambda l s<span style="color: #696969;">)</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>l1 s1<span style="color: #B380A8;">}</span>
        <span style="color: #B380A8;">{{</span>'form3/lambda l1<span style="color: #B380A8;">}</span> s1<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'form2/bind b<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>pass2/bind b s<span style="color: #696969;">)</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>b1 s1<span style="color: #B380A8;">}</span>
        <span style="color: #B380A8;">{{</span>'form3/bind b1<span style="color: #B380A8;">}</span> s1<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org65729ca" class="outline-3">
<h3 id="org65729ca">id/new</h3>
<div class="outline-text-3" id="text-org65729ca">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #a6e22e;">id/counter</span> 0<span style="color: #696969;">)</span>

<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">id/new</span> n ls<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> name ls <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> id<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">set!</span> id/counter <span style="color: #696969;">(</span>+ 1 id/counter<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span>vector <span style="color: #696969;">(</span>cons n id/counter<span style="color: #696969;">)</span> ls<span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org9a319e0" class="outline-3">
<h3 id="org9a319e0">pass2/var</h3>
<div class="outline-text-3" id="text-org9a319e0">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">pass2/var</span> v s<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> form2/var scope <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #696969;">(</span>form3/var scope<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> v
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>symbol level<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>found <span style="color: #696969;">(</span>assq symbol s<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
       <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> found
         <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>old <span style="color: #696969;">(</span>cdr found<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
           <span style="color: #B380A8;">{{</span>old level<span style="color: #B380A8;">}</span> s<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span>
         <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>new <span style="color: #696969;">(</span>id/new symbol '<span style="color: #696969;">())</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
           <span style="color: #B380A8;">{{</span>new level<span style="color: #B380A8;">}</span>
            <span style="color: #696969;">(</span>cons <span style="color: #696969;">(</span>cons symbol new<span style="color: #696969;">)</span> s<span style="color: #696969;">)</span><span style="color: #B380A8;">}</span><span style="color: #696969;">)))</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgce2ab69" class="outline-3">
<h3 id="orgce2ab69">pass2/bind</h3>
<div class="outline-text-3" id="text-orgce2ab69">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">pass2/bind</span> b s<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> form2/bind scope <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #696969;">(</span>form3/bind scope<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> b
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>vs c leave?<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>pass2/cedent vs s<span style="color: #696969;">)</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>vs1 s1<span style="color: #B380A8;">}</span>
        <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>pass2/cedent c s1<span style="color: #696969;">)</span>
          <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">this means vars in vs can occur in c</span>
          <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>c1 s2<span style="color: #B380A8;">}</span>
           <span style="color: #B380A8;">{{</span>vs1 c1 leave?<span style="color: #B380A8;">}</span> s2<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orga9be135" class="outline-2">
<h2 id="orga9be135">pass3</h2>
<div class="outline-text-2" id="text-orga9be135">
</div><div id="outline-container-orgd94b48f" class="outline-3">
<h3 id="orgd94b48f"><span class="todo note">note</span> </h3>
<div class="outline-text-3" id="text-orgd94b48f">
<ul class="org-ul">
<li><p>form3 -pass3-&gt; data</p><p>cons &amp; trunk are created here</p><p><ul class="org-ul"></p><p><li><p>ns is searched</p><p>but no effect on ns</p></li></ul></p></li>

<li><p>note that</p><p>we are building new function body</p><p>with the help of the data-stack</p><p>thus</p><p>whenever a list of data in data-stack are used to form a function body</p><p>the list should be reversed</p></li>

<li><p>bind is handled here</p><p>no unification here</p><p>bs is not used here</p><p>bind just effect on the id of var</p></li>

<li><p>apply is handled here</p><p>when meet 'apply' form a trunk from arrow or lambda</p><p>if it is arrow</p><p>use infer/arrow to get the type of it</p><p>if it is lambda</p><p>use infer/arrow-list to get the type of it</p></li>

<li><p>pass3 will use env passing</p><p>note that</p><p>when env passing is used</p><p>those functions would not be separately testable</p></li>

<li><p>note that</p><p>nested arrow or lambda will not block scope</p><p>different var must have different name</p><p>this is due to the natural of non-determinate data</p></li></ul>
</div>
</div>

<div id="outline-container-orge92d0e5" class="outline-3">
<h3 id="orge92d0e5">env/pop</h3>
<div class="outline-text-3" id="text-orge92d0e5">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">env/pop</span> e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #696969;">(</span>data env<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>d . r<span style="color: #696969;">)</span> bs ns<span style="color: #B380A8;">}</span>
     <span style="color: #B380A8;">{</span>d <span style="color: #B380A8;">{</span>r bs ns<span style="color: #B380A8;">}}</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org2708177" class="outline-3">
<h3 id="org2708177">pass3/get-arrow</h3>
<div class="outline-text-3" id="text-org2708177">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">pass3/get-arrow</span> a e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> form3/arrow env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> arrow<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>env/pop <span style="color: #696969;">(</span>pass3/arrow a e<span style="color: #696969;">))</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{{</span>'arrow arrow<span style="color: #B380A8;">}</span> __<span style="color: #B380A8;">}</span>
     arrow<span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb4e282f" class="outline-3">
<h3 id="orgb4e282f">pass3/arrow</h3>
<div class="outline-text-3" id="text-orgb4e282f">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">pass3/arrow</span> a e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> form3/arrow env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> env<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> a
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ac sc<span style="color: #B380A8;">}</span>
        <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>pass3/cedent ac <span style="color: #B380A8;">{{}</span> bs ns<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span>
          <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>dl-ac __ __<span style="color: #B380A8;">}</span>
           <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>pass3/cedent sc <span style="color: #B380A8;">{{}</span> bs ns<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span>
             <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>dl-sc __ __<span style="color: #B380A8;">}</span>
              <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>cons <span style="color: #B380A8;">{</span>'arrow <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>reverse dl-ac<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reverse dl-sc<span style="color: #696969;">)</span><span style="color: #B380A8;">}}</span>
                     ds<span style="color: #696969;">)</span>
               bs
               ns<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd603320" class="outline-3">
<h3 id="orgd603320">pass3/get-arrow-check</h3>
<div class="outline-text-3" id="text-orgd603320">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">pass3/get-arrow-check</span> ta a e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> arrow form3/arrow env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> arrow<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>env/pop <span style="color: #696969;">(</span>pass3/arrow-check ta a e<span style="color: #696969;">))</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{{</span>'arrow arrow<span style="color: #B380A8;">}</span> __<span style="color: #B380A8;">}</span>
     arrow<span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org43ab821" class="outline-3">
<h3 id="org43ab821">pass3/arrow-check</h3>
<div class="outline-text-3" id="text-org43ab821">
<ul class="org-ul">
<li><p>check should be merged into pass3</p><p>because to form trunk from var by apply</p><p>I need the type of var to arrow</p><p>to assign such type</p><p>I need to check antecedent first</p></li>

<li><p>note that the efforts of unifications here are commited</p><p>before this commite I copy the type arrow</p></li>

<li><p>I need to do commit here</p><p>because when apply a var</p><p>I need to get the type of it</p><p>to form a trunk</p></li></ul>

<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">pass3/arrow-check</span> ta a e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> arrow form3/arrow env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> env<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>ta <span style="color: #696969;">(</span>copy-arrow ta<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
    <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
      <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span>
       <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #B380A8;">{</span>ta a<span style="color: #B380A8;">}</span>
         <span style="color: #797979;">[</span><span style="color: #B380A8;">{{</span>tac tsc<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>ac sc<span style="color: #B380A8;">}}</span>
          <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>pass3/cedent ac <span style="color: #B380A8;">{{}</span> <span style="color: #696969;">(</span>cons '<span style="color: #696969;">(</span>commit-point<span style="color: #696969;">)</span> bs<span style="color: #696969;">)</span> ns<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span>
            <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>dl-ac bs-ac __<span style="color: #B380A8;">}</span>
             <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>type-compute/cedent <span style="color: #696969;">(</span>reverse dl-ac<span style="color: #696969;">)</span> <span style="color: #B380A8;">{{}</span> bs-ac ns<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span>
               <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span>
                <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">orz</span> 'pass3/arrow-check
                  <span style="color: #696969;">(</span><span style="color: #e6db74;">"fail to type-compute/cedent~%"</span><span style="color: #696969;">)</span>
                  <span style="color: #696969;">(</span><span style="color: #e6db74;">"ac : ~a~%"</span> <span style="color: #696969;">(</span>reverse dl-ac<span style="color: #696969;">))</span>
                  <span style="color: #696969;">(</span><span style="color: #e6db74;">"info-list : ~a~%"</span> il<span style="color: #696969;">))</span><span style="color: #797979;">]</span>
               <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{</span>type-dl-ac type-bs-ac __<span style="color: #B380A8;">}}</span>
                <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>compute/cedent tac <span style="color: #B380A8;">{{}</span> type-bs-ac ns<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span>
                  <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span>
                   <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">orz</span> 'pass3/arrow-check
                     <span style="color: #696969;">(</span><span style="color: #e6db74;">"fail to compute/cedent~%"</span><span style="color: #696969;">)</span>
                     <span style="color: #696969;">(</span><span style="color: #e6db74;">"tac : ~a~%"</span> tac<span style="color: #696969;">)</span>
                     <span style="color: #696969;">(</span><span style="color: #e6db74;">"info-list : ~a~%"</span> il<span style="color: #696969;">))</span><span style="color: #797979;">]</span>
                  <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{</span>dl-tac bs-tac __<span style="color: #B380A8;">}}</span>
                   <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>unify/data-list
                           dl-tac type-dl-ac
                           <span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{{}</span> bs-tac ns<span style="color: #B380A8;">}}</span><span style="color: #696969;">)</span>
                     <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span>
                      <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">orz</span> 'pass3/arrow-check
                        <span style="color: #696969;">(</span><span style="color: #e6db74;">"fail to unify/data-list~%"</span><span style="color: #696969;">)</span>
                        <span style="color: #696969;">(</span><span style="color: #e6db74;">"dl-tac : ~a~%"</span> dl-tac<span style="color: #696969;">)</span>
                        <span style="color: #696969;">(</span><span style="color: #e6db74;">"type-dl-ac : ~a~%"</span> type-dl-ac<span style="color: #696969;">)</span>
                        <span style="color: #696969;">(</span><span style="color: #e6db74;">"info-list : ~a~%"</span> il<span style="color: #696969;">))</span><span style="color: #797979;">]</span>
                     <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{</span>__ bs-antecedent __<span style="color: #B380A8;">}}</span>
                      <span style="color: #696969;">(</span>bs/commit! bs-antecedent<span style="color: #696969;">)</span>
                      <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>pass3/cedent sc <span style="color: #B380A8;">{{}</span> <span style="color: #696969;">(</span>cons '<span style="color: #696969;">(</span>commit-point<span style="color: #696969;">)</span> bs<span style="color: #696969;">)</span> ns<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span>
                        <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>dl-sc bs-sc __<span style="color: #B380A8;">}</span>
                         <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>type-compute/cedent <span style="color: #696969;">(</span>reverse dl-sc<span style="color: #696969;">)</span> <span style="color: #B380A8;">{{}</span> bs-sc ns<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span>
                           <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span>
                            <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">orz</span> 'pass3/arrow-check
                              <span style="color: #696969;">(</span><span style="color: #e6db74;">"fail to type-compute/cedent~%"</span><span style="color: #696969;">)</span>
                              <span style="color: #696969;">(</span><span style="color: #e6db74;">"sc : ~a~%"</span> <span style="color: #696969;">(</span>reverse dl-sc<span style="color: #696969;">))</span>
                              <span style="color: #696969;">(</span><span style="color: #e6db74;">"info-list : ~a~%"</span> il<span style="color: #696969;">))</span><span style="color: #797979;">]</span>
                           <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{</span>type-dl-sc type-bs-sc __<span style="color: #B380A8;">}}</span>
                            <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>compute/cedent tsc <span style="color: #B380A8;">{{}</span> type-bs-sc ns<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span>
                              <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span>
                               <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">orz</span> 'pass3/arrow-check
                                 <span style="color: #696969;">(</span><span style="color: #e6db74;">"fail to compute/cedent~%"</span><span style="color: #696969;">)</span>
                                 <span style="color: #696969;">(</span><span style="color: #e6db74;">"tsc : ~a~%"</span> tsc<span style="color: #696969;">)</span>
                                 <span style="color: #696969;">(</span><span style="color: #e6db74;">"info-list : ~a~%"</span> il<span style="color: #696969;">))</span><span style="color: #797979;">]</span>
                              <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{</span>dl-tsc bs-tsc __<span style="color: #B380A8;">}}</span>
                               <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>unify/data-list
                                       dl-tsc type-dl-sc
                                       <span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{{}</span> bs-tsc ns<span style="color: #B380A8;">}}</span><span style="color: #696969;">)</span>
                                 <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span>
                                  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">orz</span> 'pass3/arrow-check
                                    <span style="color: #696969;">(</span><span style="color: #e6db74;">"fail to unify/data-list:~%"</span><span style="color: #696969;">)</span>
                                    <span style="color: #696969;">(</span><span style="color: #e6db74;">"dl-tsc : ~a~%"</span> dl-tsc<span style="color: #696969;">)</span>
                                    <span style="color: #696969;">(</span><span style="color: #e6db74;">"type-dl-sc : ~a~%"</span> type-dl-sc<span style="color: #696969;">)</span>
                                    <span style="color: #696969;">(</span><span style="color: #e6db74;">"info-list : ~a~%"</span> il<span style="color: #696969;">))</span><span style="color: #797979;">]</span>
                                 <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{</span>__ bs-succedent __<span style="color: #B380A8;">}}</span>
                                  <span style="color: #696969;">(</span>bs/commit! bs-succedent<span style="color: #696969;">)</span>
                                  <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>cons <span style="color: #B380A8;">{</span>'arrow <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>reverse dl-ac<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reverse dl-sc<span style="color: #696969;">)</span><span style="color: #B380A8;">}}</span>
                                         ds<span style="color: #696969;">)</span>
                                   bs
                                   ns<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgda8331a" class="outline-3">
<h3 id="orgda8331a">pass3/cedent</h3>
<div class="outline-text-3" id="text-orgda8331a">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">pass3/cedent</span> c e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> <span style="color: #696969;">(</span>form3 ...<span style="color: #696969;">)</span> env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> env<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> c
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{}</span> e<span style="color: #797979;">]</span>
       <span style="color: #797979;">[</span><span style="color: #696969;">(</span>h . r<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>pass3/cedent r <span style="color: #696969;">(</span>pass3 h e<span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org4fc0ad5" class="outline-3">
<h3 id="org4fc0ad5">pass3/lambda</h3>
<div class="outline-text-3" id="text-org4fc0ad5">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">pass3/lambda</span> l e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> form3/lambda env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> env<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> l
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>a al<span style="color: #B380A8;">}</span>
        <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>ta <span style="color: #696969;">(</span>pass3/get-arrow a e<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
          <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>cons <span style="color: #B380A8;">{</span>'lambda
                     <span style="color: #B380A8;">{</span>ta
                      <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">map</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">lambda</span> <span style="color: #696969;">(</span>x<span style="color: #696969;">)</span>
                             <span style="color: #696969;">(</span>pass3/get-arrow-check ta x e<span style="color: #696969;">))</span>
                        al<span style="color: #696969;">)</span><span style="color: #B380A8;">}}</span>
                 ds<span style="color: #696969;">)</span>
           bs
           ns<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org6529b6" class="outline-3">
<h3 id="org6529b6">pass3</h3>
<div class="outline-text-3" id="text-org6529b6">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">pass3</span> f e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> form3 env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> env<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> f
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'form3/var x<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>pass3/var x e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'form3/name 'apply<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>pass3/apply e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'form3/name x<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>pass3/name x e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'form3/arrow x<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>pass3/arrow x e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'form3/lambda x<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>pass3/lambda x e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'form3/bind x<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>pass3/bind x e<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org771fd05" class="outline-3">
<h3 id="org771fd05">pass3/var</h3>
<div class="outline-text-3" id="text-org771fd05">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">pass3/var</span> v e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> form3/var env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> env<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span>
     <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">actually there is no need to search bs</span>
     <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">but anyway</span>
     <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>cons <span style="color: #696969;">(</span>bs/deep bs <span style="color: #B380A8;">{</span>'var v<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span> ds<span style="color: #696969;">)</span>
      bs
      ns<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgfd09ee1" class="outline-3">
<h3 id="orgfd09ee1">pass3/apply</h3>
<div class="outline-text-3" id="text-orgfd09ee1">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">pass3/apply</span> e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> env<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>d . r<span style="color: #696969;">)</span> bs ns<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span>pass3/apply/data d <span style="color: #B380A8;">{</span>r bs ns<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org2e9be1c" class="outline-3">
<h3 id="org2e9be1c">pass3/apply/data</h3>
<div class="outline-text-3" id="text-org2e9be1c">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">pass3/apply/data</span> d e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> data env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> env<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> d
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'arrow x<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span>pass3/apply/arrow x e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'lambda x<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span>pass3/apply/lambda x e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'var x<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span>pass3/apply/var x e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span>__
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">orz</span> 'pass3/apply/data
       <span style="color: #696969;">(</span><span style="color: #e6db74;">"can only apply arrow or lambda or var~%"</span><span style="color: #696969;">)</span>
       <span style="color: #696969;">(</span><span style="color: #e6db74;">"but the data at the top of data-stack is : ~a~%"</span> d<span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org6075a24" class="outline-3">
<h3 id="org6075a24">pass3/apply/arrow</h3>
<div class="outline-text-3" id="text-org6075a24">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">pass3/apply/arrow</span> a e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> arrow env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> env<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let*</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>t <span style="color: #696969;">(</span>infer/arrow a e<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
       <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> t
         <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ac sc<span style="color: #B380A8;">}</span>
          <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let*</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>alen <span style="color: #696969;">(</span>length ac<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
                 <span style="color: #797979;">[</span>slen <span style="color: #696969;">(</span>length sc<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
                 <span style="color: #797979;">[</span>dl <span style="color: #696969;">(</span>sublist ds 0 alen<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
                 <span style="color: #797979;">[</span>make-trunk
                  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">lambda</span> <span style="color: #696969;">(</span>i<span style="color: #696969;">)</span>
                    <span style="color: #B380A8;">{</span>'trunk
                      <span style="color: #B380A8;">{</span>t <span style="color: #B380A8;">{</span>'tody/arrow-list <span style="color: #B380A8;">{</span>a<span style="color: #B380A8;">}}</span> dl i<span style="color: #B380A8;">}}</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
            <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>append <span style="color: #696969;">(</span>reverse <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">map</span> make-trunk <span style="color: #696969;">(</span>genlist slen<span style="color: #696969;">)))</span>
                     <span style="color: #696969;">(</span>sublist ds alen <span style="color: #696969;">(</span>length ds<span style="color: #696969;">)))</span>
             bs
             ns<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org8e9b862" class="outline-3">
<h3 id="org8e9b862">pass3/apply/lambda</h3>
<div class="outline-text-3" id="text-org8e9b862">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">pass3/apply/lambda</span> l e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> lambda env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> env<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> l
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{{</span>ac sc<span style="color: #B380A8;">}</span> al<span style="color: #B380A8;">}</span>
        <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let*</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>alen <span style="color: #696969;">(</span>length ac<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
               <span style="color: #797979;">[</span>slen <span style="color: #696969;">(</span>length sc<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
               <span style="color: #797979;">[</span>dl <span style="color: #696969;">(</span>sublist ds 0 alen<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
               <span style="color: #797979;">[</span>make-trunk
                <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">lambda</span> <span style="color: #696969;">(</span>i<span style="color: #696969;">)</span>
                  <span style="color: #B380A8;">{</span>'trunk
                    <span style="color: #B380A8;">{{</span>ac sc<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'tody/arrow-list al<span style="color: #B380A8;">}</span> dl i<span style="color: #B380A8;">}}</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
          <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>append <span style="color: #696969;">(</span>reverse <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">map</span> make-trunk <span style="color: #696969;">(</span>genlist slen<span style="color: #696969;">)))</span>
                   <span style="color: #696969;">(</span>sublist ds alen <span style="color: #696969;">(</span>length ds<span style="color: #696969;">)))</span>
           bs
           ns<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgef95b48" class="outline-3">
<h3 id="orgef95b48">pass3/apply/var</h3>
<div class="outline-text-3" id="text-orgef95b48">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">pass3/apply/var</span> v e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> var env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> env<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> <span style="color: #696969;">(</span>not <span style="color: #696969;">(</span>var/fresh? v e<span style="color: #696969;">))</span>
       <span style="color: #696969;">(</span>pass3/apply/data <span style="color: #696969;">(</span>bs/deep bs <span style="color: #B380A8;">{</span>'var v<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span> e<span style="color: #696969;">)</span>
       <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>type-compute/var v e<span style="color: #696969;">)</span>
         <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span>
          <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">orz</span> 'pass3/apply/var
            <span style="color: #696969;">(</span><span style="color: #e6db74;">"fail to compute the type of var : ~a~%"</span> v<span style="color: #696969;">)</span>
            <span style="color: #696969;">(</span><span style="color: #e6db74;">"report info :~%~a~%"</span> il<span style="color: #696969;">))</span><span style="color: #797979;">]</span>
         <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>d . __<span style="color: #696969;">)</span> __ __<span style="color: #B380A8;">}}</span>
          <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> d
            <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'arrow <span style="color: #B380A8;">{</span>ac sc<span style="color: #B380A8;">}}</span>
             <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let*</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>alen <span style="color: #696969;">(</span>length ac<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
                    <span style="color: #797979;">[</span>slen <span style="color: #696969;">(</span>length sc<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
                    <span style="color: #797979;">[</span>dl <span style="color: #696969;">(</span>sublist ds 0 alen<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
                    <span style="color: #797979;">[</span>make-trunk
                     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">lambda</span> <span style="color: #696969;">(</span>i<span style="color: #696969;">)</span>
                       <span style="color: #B380A8;">{</span>'trunk
                         <span style="color: #B380A8;">{{</span>ac sc<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'tody/var v<span style="color: #B380A8;">}</span> dl i<span style="color: #B380A8;">}}</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
               <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>append <span style="color: #696969;">(</span>reverse <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">map</span> make-trunk <span style="color: #696969;">(</span>genlist slen<span style="color: #696969;">)))</span>
                        <span style="color: #696969;">(</span>sublist ds alen <span style="color: #696969;">(</span>length ds<span style="color: #696969;">)))</span>
                bs
                ns<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span>
            <span style="color: #797979;">[</span>__
             <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">orz</span> 'pass3/apply/var
               <span style="color: #696969;">(</span><span style="color: #e6db74;">"to form trunk from var~%"</span><span style="color: #696969;">)</span>
               <span style="color: #696969;">(</span><span style="color: #e6db74;">"the type of var must be a arrow~%"</span><span style="color: #696969;">)</span>
               <span style="color: #696969;">(</span><span style="color: #e6db74;">"var : ~a~%"</span> v<span style="color: #696969;">)</span>
               <span style="color: #696969;">(</span><span style="color: #e6db74;">"type of var : ~a~%"</span> d<span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org9dab3e1" class="outline-3">
<h3 id="org9dab3e1">id-&gt;name &amp; id-&gt;counter &amp; id-&gt;ls</h3>
<div class="outline-text-3" id="text-org9dab3e1">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">id-&gt;name</span> id<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span>car <span style="color: #696969;">(</span>vector-ref id 0<span style="color: #696969;">)))</span>

<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">id-&gt;counter</span> id<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span>cdr <span style="color: #696969;">(</span>vector-ref id 0<span style="color: #696969;">)))</span>

<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">id-&gt;ls</span> id<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span>vector-ref id 1<span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org94389b8" class="outline-3">
<h3 id="org94389b8">pass3/name</h3>
<div class="outline-text-3" id="text-org94389b8">
<ul class="org-ul">
<li><p>this can be optimized by</p><p>to do more computations before storing things into ns</p><p>but I leave it for now</p></li></ul>

<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">pass3/name</span> n e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> form3/name env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> env<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>found <span style="color: #696969;">(</span>assq n ns<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
       <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> <span style="color: #696969;">(</span>not found<span style="color: #696969;">)</span>
         <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">orz</span> 'pass3/name <span style="color: #696969;">(</span><span style="color: #e6db74;">"unknow name : ~a~%"</span> n<span style="color: #696969;">))</span>
         <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>meaning <span style="color: #696969;">(</span>cdr found<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
           <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> meaning
             <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'cons/type <span style="color: #B380A8;">{{</span>ac sc<span style="color: #B380A8;">}</span> n1 __<span style="color: #B380A8;">}}</span>
              <span style="color: #696969;">(</span>pass3/name/cons <span style="color: #696969;">(</span>length ac<span style="color: #696969;">)</span> n1 e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
             <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'cons/data <span style="color: #B380A8;">{{</span>ac sc<span style="color: #B380A8;">}</span> n1 __<span style="color: #B380A8;">}}</span>
              <span style="color: #696969;">(</span>pass3/name/cons <span style="color: #696969;">(</span>length ac<span style="color: #696969;">)</span> n1 e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
             <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'lambda <span style="color: #B380A8;">{{</span>ac sc<span style="color: #B380A8;">}</span> __<span style="color: #B380A8;">}}</span>
              <span style="color: #696969;">(</span>pass3/name/trunk <span style="color: #696969;">(</span>length ac<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>length sc<span style="color: #696969;">)</span> <span style="color: #B380A8;">{</span>ac sc<span style="color: #B380A8;">}</span> n e<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))))</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org80dacae" class="outline-3">
<h3 id="org80dacae">pass3/name/cons</h3>
<div class="outline-text-3" id="text-org80dacae">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">pass3/name/cons</span> len name e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> length name env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> env<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span>
     <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>cons <span style="color: #B380A8;">{</span>'cons
             <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">dl in cons is as the order of dl in start</span>
             <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">thus no reverse is needed</span>
             <span style="color: #B380A8;">{</span>name <span style="color: #696969;">(</span>sublist ds 0 len<span style="color: #696969;">)</span><span style="color: #B380A8;">}}</span>
            <span style="color: #696969;">(</span>sublist ds len <span style="color: #696969;">(</span>length ds<span style="color: #696969;">)))</span>
      bs
      ns<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org5288032" class="outline-3">
<h3 id="org5288032">pass3/name/trunk</h3>
<div class="outline-text-3" id="text-org5288032">
<ul class="org-ul">
<li><p>when intro a trunk from name</p><p>only name should be recorded not the body</p><p>this is to handle recursive definitions</p></li>

<li><p>type arrow needs to be copied</p></li></ul>

<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">pass3/name/trunk</span> alen slen a n e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> length length arrow name env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> env<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let*</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>a <span style="color: #696969;">(</span>copy-arrow a<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
            <span style="color: #797979;">[</span>dl <span style="color: #696969;">(</span>sublist ds 0 alen<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
            <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">dl in trunk is as the order of dl in stack</span>
            <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">thus no reverse is needed</span>
            <span style="color: #797979;">[</span>make-trunk <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">lambda</span> <span style="color: #696969;">(</span>i<span style="color: #696969;">)</span> <span style="color: #B380A8;">{</span>'trunk <span style="color: #B380A8;">{</span>a <span style="color: #B380A8;">{</span>'tody/name n<span style="color: #B380A8;">}</span> dl i<span style="color: #B380A8;">}}</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
       <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>append <span style="color: #696969;">(</span>reverse <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">map</span> make-trunk <span style="color: #696969;">(</span>genlist slen<span style="color: #696969;">)))</span>
                <span style="color: #696969;">(</span>sublist ds alen <span style="color: #696969;">(</span>length ds<span style="color: #696969;">)))</span>
        bs
        ns<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org36683c5" class="outline-3">
<h3 id="org36683c5">pass3/bind</h3>
<div class="outline-text-3" id="text-org36683c5">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">pass3/bind</span> b e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> form3/bind env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> env<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> b
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>vl c leave?<span style="color: #B380A8;">}</span>
        <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>pass3/cedent c <span style="color: #B380A8;">{{}</span> bs ns<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span>
          <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds1 __ __<span style="color: #B380A8;">}</span>
           <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> <span style="color: #696969;">(</span>not <span style="color: #696969;">(</span>eq? 1 <span style="color: #696969;">(</span>length ds1<span style="color: #696969;">)))</span>
             <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">orz</span> 'pass3/bind
               <span style="color: #696969;">(</span><span style="color: #e6db74;">"the cedent in bind should only return one data~%"</span><span style="color: #696969;">)</span>
               <span style="color: #696969;">(</span><span style="color: #e6db74;">"bind : ~a~%"</span> b<span style="color: #696969;">))</span>
             <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>d1 <span style="color: #696969;">(</span>car ds1<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
               <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">letrec</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>recur
                         <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">lambda</span> <span style="color: #696969;">(</span>vl e<span style="color: #696969;">)</span>
                           <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> <span style="color: #696969;">(</span>form3/var ...<span style="color: #696969;">)</span> env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> env<span style="color: #696969;">)</span>
                           <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
                             <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span>
                              <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> vl
                                <span style="color: #797979;">[</span><span style="color: #B380A8;">{}</span> e<span style="color: #797979;">]</span>
                                <span style="color: #797979;">[</span><span style="color: #696969;">(</span><span style="color: #B380A8;">{</span>'form3/var <span style="color: #B380A8;">{</span>id level<span style="color: #B380A8;">}}</span> . r<span style="color: #696969;">)</span>
                                 <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> <span style="color: #696969;">(</span>not <span style="color: #696969;">(</span>var/fresh? <span style="color: #B380A8;">{</span>id level<span style="color: #B380A8;">}</span> e<span style="color: #696969;">))</span>
                                   <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">orz</span> 'pass3/bind
                                     <span style="color: #696969;">(</span><span style="color: #e6db74;">"var is not fresh : ~a~%"</span> <span style="color: #B380A8;">{</span>id level<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span>
                                     <span style="color: #696969;">(</span><span style="color: #e6db74;">"env : ~a~%"</span> e<span style="color: #696969;">))</span>
                                   <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> <span style="color: #696969;">(</span>not
                                        <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>consistent-check
                                                <span style="color: #B380A8;">{</span>id level<span style="color: #B380A8;">}</span> d1 e<span style="color: #696969;">)</span>
                                          <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail __<span style="color: #B380A8;">}</span> #f<span style="color: #797979;">]</span>
                                          <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success __<span style="color: #B380A8;">}</span> #t<span style="color: #797979;">]</span><span style="color: #696969;">))</span>
                                     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">orz</span> 'pass3/bind
                                       <span style="color: #696969;">(</span><span style="color: #e6db74;">"var data is not consistent~%"</span><span style="color: #696969;">)</span>
                                       <span style="color: #696969;">(</span><span style="color: #e6db74;">"var : ~a~%"</span> <span style="color: #B380A8;">{</span>id level<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span>
                                       <span style="color: #696969;">(</span><span style="color: #e6db74;">"data : ~a~%"</span> d1<span style="color: #696969;">))</span>
                                     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let</span> <span style="color: #696969;">()</span>
                                       <span style="color: #696969;">(</span>id/commit! id <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>cons level d1<span style="color: #696969;">)</span><span style="color: #B380A8;">}</span><span style="color: #696969;">)</span>
                                       <span style="color: #696969;">(</span>recur r <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> leave?
                                                   <span style="color: #696969;">(</span>cons d1 ds<span style="color: #696969;">)</span>
                                                   ds<span style="color: #696969;">)</span>
                                                 bs
                                                 ns<span style="color: #B380A8;">}</span><span style="color: #696969;">))))</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
                 <span style="color: #696969;">(</span>recur vl e<span style="color: #696969;">))))</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgfff4340" class="outline-3">
<h3 id="orgfff4340">id/commit!</h3>
<div class="outline-text-3" id="text-orgfff4340">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">id/commit!</span> id ls<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> id ls <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> id
     <span style="color: #797979;">[</span>with effect on id<span style="color: #797979;">]</span><span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let</span> <span style="color: #696969;">()</span>
    <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">vector-set!</span> id 1 <span style="color: #696969;">(</span>append ls <span style="color: #696969;">(</span>vector-ref id 1<span style="color: #696969;">)))</span>
    id<span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org57e57b2" class="outline-2">
<h2 id="org57e57b2">bind-stack</h2>
<div class="outline-text-2" id="text-org57e57b2">
</div><div id="outline-container-org67da8af" class="outline-3">
<h3 id="org67da8af"><span class="todo note">note</span> </h3>
<div class="outline-text-3" id="text-org67da8af">
<ul class="org-ul">
<li><p>&gt;&lt;&gt;&lt;&gt;&lt;</p></li>

<li><p>infer level n can get level n+1</p></li>

<li><p>note how the types of these functions are different</p></li></ul>
</div>
</div>

<div id="outline-container-org94fbd55" class="outline-3">
<h3 id="org94fbd55">bs/find</h3>
<div class="outline-text-3" id="text-org94fbd55">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">bs/find</span> bs v<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> bs var <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">or</span> data #f<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> v
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>id level<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let*</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>level <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> <span style="color: #696969;">(</span>eq? level #f<span style="color: #696969;">)</span>
                     0
                     level<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
            <span style="color: #797979;">[</span>found/commit <span style="color: #696969;">(</span>assq level <span style="color: #696969;">(</span>id-&gt;ls id<span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
       <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> found/commit
         <span style="color: #696969;">(</span>cdr found/commit<span style="color: #696969;">)</span>
         <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let*</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>found/ls <span style="color: #696969;">(</span>assq id bs<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
                <span style="color: #797979;">[</span>found/bind
                 <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> found/ls
                   <span style="color: #696969;">(</span>assq level <span style="color: #696969;">(</span>cdr found/ls<span style="color: #696969;">))</span>
                   #f<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
           <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> found/bind
             <span style="color: #696969;">(</span>cdr found/bind<span style="color: #696969;">)</span>
             #f<span style="color: #696969;">))))</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orga046707" class="outline-3">
<h3 id="orga046707">bs/walk</h3>
<div class="outline-text-3" id="text-orga046707">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">bs/walk</span> bs d<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> bs data <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> data<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> d
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'var v<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>found <span style="color: #696969;">(</span>bs/find bs v<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
       <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> found
         <span style="color: #696969;">(</span>bs/walk bs found<span style="color: #696969;">)</span>
         d<span style="color: #696969;">))</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>__ e<span style="color: #B380A8;">}</span> d<span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgda8b134" class="outline-3">
<h3 id="orgda8b134">bs/deep</h3>
<div class="outline-text-3" id="text-orgda8b134">
<ul class="org-ul">
<li><p>do not handle trunk here</p><p>because I think maybe no computations should be done in pass3</p></li></ul>

<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">bs/deep</span> bs d<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> bs data <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> data<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">letrec*</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>bs/deep-list
             <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">lambda</span> <span style="color: #696969;">(</span>bs dl<span style="color: #696969;">)</span>
               <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">map</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">lambda</span> <span style="color: #696969;">(</span>x<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>bs/deep bs x<span style="color: #696969;">))</span> dl<span style="color: #696969;">))</span><span style="color: #797979;">]</span>
            <span style="color: #797979;">[</span>bs/deep-arrow
             <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">lambda</span> <span style="color: #696969;">(</span>bs a<span style="color: #696969;">)</span>
               <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> a
                 <span style="color: #797979;">[</span><span style="color: #696969;">(</span>dl1 dl2<span style="color: #696969;">)</span>
                  <span style="color: #696969;">(</span>list <span style="color: #696969;">(</span>bs/deep-list bs dl1<span style="color: #696969;">)</span>
                        <span style="color: #696969;">(</span>bs/deep-list bs dl2<span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span><span style="color: #797979;">]</span>
            <span style="color: #797979;">[</span>bs/deep-arrow-list
             <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">lambda</span> <span style="color: #696969;">(</span>bs al<span style="color: #696969;">)</span>
               <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">map</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">lambda</span> <span style="color: #696969;">(</span>a<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>bs/deep-arrow bs a<span style="color: #696969;">))</span> al<span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
    <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>bs/walk bs d<span style="color: #696969;">)</span>
      <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">a var is fresh after bs/walk</span>
      <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'var v<span style="color: #B380A8;">}</span>
       <span style="color: #B380A8;">{</span>'var v<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
      <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'cons <span style="color: #B380A8;">{</span>name dl<span style="color: #B380A8;">}}</span>
       <span style="color: #B380A8;">{</span>'cons <span style="color: #B380A8;">{</span>name <span style="color: #696969;">(</span>bs/deep-list bs dl<span style="color: #696969;">)</span><span style="color: #B380A8;">}}</span><span style="color: #797979;">]</span>
      <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'arrow a<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'arrow <span style="color: #696969;">(</span>bs/deep-arrow bs a<span style="color: #696969;">)</span><span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
      <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'lambda <span style="color: #B380A8;">{</span>a al<span style="color: #B380A8;">}}</span>
       <span style="color: #B380A8;">{</span>'lambda <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>bs/deep-arrow bs a<span style="color: #696969;">)</span>
                 <span style="color: #696969;">(</span>bs/deep-arrow-list bs al<span style="color: #696969;">)</span><span style="color: #B380A8;">}}</span><span style="color: #797979;">]</span>
      <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'trunk <span style="color: #B380A8;">{</span>a tody dl i<span style="color: #B380A8;">}}</span>
       <span style="color: #B380A8;">{</span>'trunk
         <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>bs/deep-arrow bs a<span style="color: #696969;">)</span>
          <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> tody
            <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'tody/var v<span style="color: #B380A8;">}</span>
             <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>bs/deep bs <span style="color: #B380A8;">{</span>'var v<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span>
               <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'var v1<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'tody/var v1<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
               <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'arrow a1<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'tody/arrow-list <span style="color: #B380A8;">{</span>a1<span style="color: #B380A8;">}}</span><span style="color: #797979;">]</span>
               <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'lambda <span style="color: #B380A8;">{</span>a al<span style="color: #B380A8;">}}</span> <span style="color: #B380A8;">{</span>'tody/arrow-list al<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
               <span style="color: #797979;">[</span>d
                <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">orz</span> 'bs/deep
                  <span style="color: #696969;">(</span><span style="color: #e6db74;">"find something wrong from the var in the tody of trunk~%"</span><span style="color: #696969;">)</span>
                  <span style="color: #696969;">(</span><span style="color: #e6db74;">"data : ~a~%"</span> d<span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span>
            <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'tody/name n<span style="color: #B380A8;">}</span>
             <span style="color: #B380A8;">{</span>'tody/name n<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
            <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'tody/arrow-list al<span style="color: #B380A8;">}</span>
             <span style="color: #B380A8;">{</span>'tody/arrow-list <span style="color: #696969;">(</span>bs/deep-arrow-list bs al<span style="color: #696969;">)</span><span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
          <span style="color: #696969;">(</span>bs/deep-list bs dl<span style="color: #696969;">)</span>
          i<span style="color: #B380A8;">}}</span><span style="color: #797979;">]</span><span style="color: #696969;">)))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgfe5b1b7" class="outline-3">
<h3 id="orgfe5b1b7">var/fresh?</h3>
<div class="outline-text-3" id="text-orgfe5b1b7">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">var/fresh?</span> v e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> var env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> bool<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span>equal? <span style="color: #696969;">(</span>bs/walk bs <span style="color: #B380A8;">{</span>'var v<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span>
             <span style="color: #B380A8;">{</span>'var v<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgad067ee" class="outline-2">
<h2 id="orgad067ee">copy-arrow</h2>
<div class="outline-text-2" id="text-orgad067ee">
</div><div id="outline-container-orgf813a55" class="outline-3">
<h3 id="orgf813a55"><span class="todo note">note</span> </h3>
<div class="outline-text-3" id="text-orgf813a55">
<ul class="org-ul">
<li><p>the name in trunk will be changed to (arrow &#x2026;)</p><p>(arrow &#x2026;) is fetched from ns and copied</p></li>

<li><p><p></p><p>copy-arrow is called when</p><p></p></p><p><table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides"></p><p></p><p></p><p><colgroup></p><p><col  class="org-left" /></p><p></p><p><col  class="org-left" /></p><p></colgroup></p><p><tbody></p><p><tr></p><p><td class="org-left">trunk intro in pass3</td></p><p><td class="org-left">copy type arrow</td></p><p></tr></p><p></p><p><tr></p><p><td class="org-left">trunk-&gt;trunk*</td></p><p><td class="org-left">copy body arrow-list</td></p><p></tr></p><p></p><p><tr></p><p><td class="org-left">compute/arrow in type-compute</td></p><p><td class="org-left">copy arrow to maintain undo-ablity</td></p><p></tr></p><p></tbody></p><p></table></p></li>

<li><p>copy is arrow by arrow</p><p>every var in new arrow is different from old arrow</p><p>thus</p><p><ol class="org-ol"></p><p><li>scope is also arrow by arrow</li></p><p><li>a non-determinate var can not be substituted into lambda as it is</p><p>but is copied</li></ol></p></li>

<li><p>this copy is one of the main place where this prototype can be optimized</p><p>a vm can be designed to replace this copy function</p><p>and change the interpreter to a compiler</p></li></ul>
</div>
</div>

<div id="outline-container-org84e3e5f" class="outline-3">
<h3 id="org84e3e5f">copy-arrow</h3>
<div class="outline-text-3" id="text-org84e3e5f">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">copy-arrow</span> a<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> arrow <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> arrow<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>copy/arrow a '<span style="color: #696969;">())</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>a1 __<span style="color: #B380A8;">}</span> a1<span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org50c5641" class="outline-3">
<h3 id="org50c5641">copy-cedent</h3>
<div class="outline-text-3" id="text-org50c5641">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">copy-cedent</span> c<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> cedent <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> cedent<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>copy/cedent c '<span style="color: #696969;">())</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>c1 __<span style="color: #B380A8;">}</span> c1<span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd6699ab" class="outline-3">
<h3 id="orgd6699ab">copy/arrow</h3>
<div class="outline-text-3" id="text-orgd6699ab">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">copy/arrow</span> a s<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> arrow scope <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #696969;">(</span>arrow scope<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> a
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ac sc<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>copy/cedent ac s<span style="color: #696969;">)</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ac1 s1<span style="color: #B380A8;">}</span>
        <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>copy/cedent sc s1<span style="color: #696969;">)</span>
          <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>sc1 s2<span style="color: #B380A8;">}</span>
           <span style="color: #B380A8;">{{</span>ac1 sc1<span style="color: #B380A8;">}</span> s2<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org87accab" class="outline-3">
<h3 id="org87accab">copy/data-list</h3>
<div class="outline-text-3" id="text-org87accab">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">copy/data-list</span> dl s<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> <span style="color: #696969;">(</span>data ...<span style="color: #696969;">)</span> scope <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #696969;">((</span>data ...<span style="color: #696969;">)</span> scope<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span>copy/cedent dl s<span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgaffdf86" class="outline-3">
<h3 id="orgaffdf86">copy/cedent</h3>
<div class="outline-text-3" id="text-orgaffdf86">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">copy/cedent</span> c s<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> cedent scope <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #696969;">(</span>cedent scope<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> c
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{}</span> <span style="color: #B380A8;">{{}</span> s<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #696969;">(</span>h . r<span style="color: #696969;">)</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>copy h s<span style="color: #696969;">)</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>h1 s1<span style="color: #B380A8;">}</span>
        <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>copy/cedent r s1<span style="color: #696969;">)</span>
          <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>r1 s2<span style="color: #B380A8;">}</span>
           <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>cons h1 r1<span style="color: #696969;">)</span> s2<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orga9d883a" class="outline-3">
<h3 id="orga9d883a">copy/lambda</h3>
<div class="outline-text-3" id="text-orga9d883a">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">copy/lambda</span> l s<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> lambda scope <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">lambda</span> scope<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> l
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>a al<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>copy/arrow a s<span style="color: #696969;">)</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>a1 s1<span style="color: #B380A8;">}</span>
        <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>copy/arrow-list al s1<span style="color: #696969;">)</span>
          <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>al1 s2<span style="color: #B380A8;">}</span>
           <span style="color: #B380A8;">{{</span>a1 al1<span style="color: #B380A8;">}</span> s2<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orga8d4203" class="outline-3">
<h3 id="orga8d4203">copy/arrow-list</h3>
<div class="outline-text-3" id="text-orga8d4203">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">copy/arrow-list</span> al s<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> <span style="color: #696969;">(</span>arrow ...<span style="color: #696969;">)</span> scope <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #696969;">((</span>arrow ...<span style="color: #696969;">)</span> scope<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> al
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{}</span> <span style="color: #B380A8;">{{}</span> s<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #696969;">(</span>h . r<span style="color: #696969;">)</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>copy/arrow h s<span style="color: #696969;">)</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>h1 s1<span style="color: #B380A8;">}</span>
        <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>copy/arrow-list r s1<span style="color: #696969;">)</span>
          <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>r1 s2<span style="color: #B380A8;">}</span>
           <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>cons h1 r1<span style="color: #696969;">)</span> s2<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org2a97b08" class="outline-3">
<h3 id="org2a97b08">copy</h3>
<div class="outline-text-3" id="text-org2a97b08">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">copy</span> d s<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> data scope <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #696969;">(</span>data scope<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> d
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'var x<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>copy/var x s<span style="color: #696969;">)</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>x1 s1<span style="color: #B380A8;">}</span>
        <span style="color: #B380A8;">{{</span>'var x1<span style="color: #B380A8;">}</span> s1<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'cons x<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>copy/cons x s<span style="color: #696969;">)</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>x1 s1<span style="color: #B380A8;">}</span>
        <span style="color: #B380A8;">{{</span>'cons x1<span style="color: #B380A8;">}</span> s1<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'arrow x<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>copy/arrow x s<span style="color: #696969;">)</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>x1 s1<span style="color: #B380A8;">}</span>
        <span style="color: #B380A8;">{{</span>'arrow x1<span style="color: #B380A8;">}</span> s1<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'lambda x<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>copy/lambda x s<span style="color: #696969;">)</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>x1 s1<span style="color: #B380A8;">}</span>
        <span style="color: #B380A8;">{{</span>'lambda x1<span style="color: #B380A8;">}</span> s1<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'trunk x<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>copy/trunk x s<span style="color: #696969;">)</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>x1 s1<span style="color: #B380A8;">}</span>
        <span style="color: #B380A8;">{{</span>'trunk x1<span style="color: #B380A8;">}</span> s1<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org54e4702" class="outline-3">
<h3 id="org54e4702">copy/var</h3>
<div class="outline-text-3" id="text-org54e4702">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">copy/var</span> v s<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> var scope <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #696969;">(</span>var scope<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> v
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>id level<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>found <span style="color: #696969;">(</span>assq id s<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
       <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> found
         <span style="color: #B380A8;">{{</span><span style="color: #696969;">(</span>cdr found<span style="color: #696969;">)</span> level<span style="color: #B380A8;">}</span> s<span style="color: #B380A8;">}</span>
         <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let*</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>ls <span style="color: #696969;">(</span>id-&gt;ls id<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
                <span style="color: #797979;">[</span>id1 <span style="color: #696969;">(</span>id/new <span style="color: #696969;">(</span>id-&gt;name id<span style="color: #696969;">)</span> '<span style="color: #696969;">())</span><span style="color: #797979;">]</span>
                <span style="color: #797979;">[</span>s1 <span style="color: #696969;">(</span>cons <span style="color: #696969;">(</span>cons id id1<span style="color: #696969;">)</span> s<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
           <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>copy/ls ls s1<span style="color: #696969;">)</span>
             <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ls1 s2<span style="color: #B380A8;">}</span>
              <span style="color: #696969;">(</span>id/commit! id1 ls1<span style="color: #696969;">)</span>
              <span style="color: #B380A8;">{{</span>id1 level<span style="color: #B380A8;">}</span> s2<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">))))</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org402da70" class="outline-3">
<h3 id="org402da70">copy/ls</h3>
<div class="outline-text-3" id="text-org402da70">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">copy/ls</span> ls s<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> ls scope <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #696969;">(</span>ls scope<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> ls
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{}</span> <span style="color: #B380A8;">{{}</span> s<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #696969;">((</span>level . data<span style="color: #696969;">)</span> . r<span style="color: #696969;">)</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>copy data s<span style="color: #696969;">)</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>data1 s1<span style="color: #B380A8;">}</span>
        <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>copy/ls r s1<span style="color: #696969;">)</span>
          <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>r1 s2<span style="color: #B380A8;">}</span>
           <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>cons <span style="color: #696969;">(</span>cons level data1<span style="color: #696969;">)</span>
                  r1<span style="color: #696969;">)</span>
            s2<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org6bfd16e" class="outline-3">
<h3 id="org6bfd16e">copy/cons</h3>
<div class="outline-text-3" id="text-org6bfd16e">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">copy/cons</span> c s<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> cons scope <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #696969;">(</span>cons scope<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> c
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>n dl<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>copy/data-list dl s<span style="color: #696969;">)</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>dl1 s1<span style="color: #B380A8;">}</span>
        <span style="color: #B380A8;">{{</span>n dl1<span style="color: #B380A8;">}</span> s1<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org83ceec8" class="outline-3">
<h3 id="org83ceec8">copy/trunk</h3>
<div class="outline-text-3" id="text-org83ceec8">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">copy/trunk</span> p s<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> trunk scope <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">trunk</span> scope<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> p
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>a tody dl i<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> tody
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'tody/var v<span style="color: #B380A8;">}</span>
        <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>copy/arrow a s<span style="color: #696969;">)</span>
          <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>a1 s1<span style="color: #B380A8;">}</span>
           <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>copy/data-list dl s1<span style="color: #696969;">)</span>
             <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>dl1 s2<span style="color: #B380A8;">}</span>
              <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>copy/var v s2<span style="color: #696969;">)</span>
                <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>v1 s3<span style="color: #B380A8;">}</span>
                 <span style="color: #B380A8;">{{</span>a1 <span style="color: #B380A8;">{</span>'tody/var v1<span style="color: #B380A8;">}</span> dl1 i<span style="color: #B380A8;">}</span> s3<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'tody/name n<span style="color: #B380A8;">}</span>
        <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>copy/arrow a s<span style="color: #696969;">)</span>
          <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>a1 s1<span style="color: #B380A8;">}</span>
           <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>copy/data-list dl s1<span style="color: #696969;">)</span>
             <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>dl1 s2<span style="color: #B380A8;">}</span>
              <span style="color: #B380A8;">{{</span>a1 <span style="color: #B380A8;">{</span>'tody/name n<span style="color: #B380A8;">}</span> dl1 i<span style="color: #B380A8;">}</span> s2<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'tody/arrow-list al<span style="color: #B380A8;">}</span>
        <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>copy/arrow a s<span style="color: #696969;">)</span>
          <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>a1 s1<span style="color: #B380A8;">}</span>
           <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>copy/arrow-list al s1<span style="color: #696969;">)</span>
             <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>al1 s2<span style="color: #B380A8;">}</span>
              <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>copy/data-list dl s2<span style="color: #696969;">)</span>
                <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>dl1 s3<span style="color: #B380A8;">}</span>
                 <span style="color: #B380A8;">{{</span>a1 <span style="color: #B380A8;">{</span>'tody/arrow-list al1<span style="color: #B380A8;">}</span> dl1 i<span style="color: #B380A8;">}</span> s3<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgf16b8e0" class="outline-2">
<h2 id="orgf16b8e0">compute</h2>
<div class="outline-text-2" id="text-orgf16b8e0">
</div><div id="outline-container-orge6f2d32" class="outline-3">
<h3 id="orge6f2d32">compute/arrow</h3>
<div class="outline-text-3" id="text-orge6f2d32">
<ul class="org-ul">
<li><p>commit should be preformed arrow by arrow</p><p>one arrow can only commit on its own var</p><p>this is achieve by the natural of the structure of bs</p></li>

<li><p>note that</p><p>commit is only meant to handle non-determinate var</p><p>of which the level n is bound</p><p>where n &gt; 0</p></li></ul>

<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">compute/arrow</span> a e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> arrow env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> report<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> a
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ac sc<span style="color: #B380A8;">}</span>
        <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>alen <span style="color: #696969;">(</span>length ac<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
              <span style="color: #797979;">[</span>slen <span style="color: #696969;">(</span>length sc<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
          <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>compute/cedent ac <span style="color: #B380A8;">{</span>ds <span style="color: #696969;">(</span>cons '<span style="color: #696969;">(</span>commit-point<span style="color: #696969;">)</span> bs<span style="color: #696969;">)</span> ns<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span>
            <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
            <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{</span>ds1 bs1 ns1<span style="color: #B380A8;">}}</span>
             <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>unify/data-list
                     <span style="color: #696969;">(</span>take ds1 alen<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>take <span style="color: #696969;">(</span>drop ds1 alen<span style="color: #696969;">)</span> alen<span style="color: #696969;">)</span>
                     <span style="color: #B380A8;">{</span>'success
                      <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>drop <span style="color: #696969;">(</span>drop ds1 alen<span style="color: #696969;">)</span> alen<span style="color: #696969;">)</span>
                       bs1
                       ns1<span style="color: #B380A8;">}}</span><span style="color: #696969;">)</span>
               <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
               <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success e2<span style="color: #B380A8;">}</span>
                <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>compute/cedent sc e2<span style="color: #696969;">)</span>
                  <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
                  <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{</span>ds3 bs3 ns3<span style="color: #B380A8;">}}</span>
                   <span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{</span>ds3 <span style="color: #696969;">(</span>bs/commit! bs3<span style="color: #696969;">)</span> ns3<span style="color: #B380A8;">}}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org55ac307" class="outline-3">
<h3 id="org55ac307">bs/commit!</h3>
<div class="outline-text-3" id="text-org55ac307">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">bs/commit!</span> bs<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> bs <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> bs
     <span style="color: #797979;">[</span>with effect on part of elements of bs<span style="color: #797979;">]</span><span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">cond</span> <span style="color: #797979;">[</span><span style="color: #696969;">(</span>equal? '<span style="color: #696969;">(</span>commit-point<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>car bs<span style="color: #696969;">))</span>
         <span style="color: #696969;">(</span>cdr bs<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
        <span style="color: #797979;">[</span>else
         <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let*</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>pair <span style="color: #696969;">(</span>car bs<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
                <span style="color: #797979;">[</span>id <span style="color: #696969;">(</span>car pair<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
                <span style="color: #797979;">[</span>ls <span style="color: #696969;">(</span>cdr pair<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
           <span style="color: #696969;">(</span>id/commit! id ls<span style="color: #696969;">)</span>
           <span style="color: #696969;">(</span>bs/commit! <span style="color: #696969;">(</span>cdr bs<span style="color: #696969;">)))</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orge9c4287" class="outline-3">
<h3 id="orge9c4287">compute/cedent</h3>
<div class="outline-text-3" id="text-orge9c4287">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">compute/cedent</span> c e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> cedent env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> report<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> c
    <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">proper tail call</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>h<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>compute h e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{}</span> <span style="color: #B380A8;">{</span>'success e<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #696969;">(</span>h . r<span style="color: #696969;">)</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>compute h e<span style="color: #696969;">)</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success e1<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>compute/cedent r e1<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org17c77b" class="outline-3">
<h3 id="org17c77b">compute</h3>
<div class="outline-text-3" id="text-org17c77b">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">compute</span> d e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> data env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> report<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #696969;">(</span>ds bs ns<span style="color: #696969;">)</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> d
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'var x<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>compute/var x e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'cons x<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>compute/cons x e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'trunk x<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>compute/trunk x e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
       <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">note that arrow in arrow is computed as literal</span>
       <span style="color: #797979;">[</span>__ <span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>cons d ds<span style="color: #696969;">)</span> bs ns<span style="color: #B380A8;">}}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orga307604" class="outline-3">
<h3 id="orga307604">compute/var</h3>
<div class="outline-text-3" id="text-orga307604">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">compute/var</span> v e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> var env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> report<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #696969;">(</span>ds bs ns<span style="color: #696969;">)</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>d <span style="color: #696969;">(</span>bs/deep bs <span style="color: #B380A8;">{</span>'var v<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
       <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> d
         <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">result found from this var needs to be compute again</span>
         <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">except for fresh var</span>
         <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'var __<span style="color: #B380A8;">}</span>
          <span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>cons d ds<span style="color: #696969;">)</span> bs ns<span style="color: #B380A8;">}}</span><span style="color: #797979;">]</span>
         <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>__ __<span style="color: #B380A8;">}</span>
          <span style="color: #696969;">(</span>compute d e<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org1a942ac" class="outline-3">
<h3 id="org1a942ac">compute/cons</h3>
<div class="outline-text-3" id="text-org1a942ac">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">compute/cons</span> c e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> cons env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> report<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #696969;">(</span>ds bs ns<span style="color: #696969;">)</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> c
       <span style="color: #797979;">[</span><span style="color: #696969;">(</span>n dl<span style="color: #696969;">)</span>
        <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">the following reverse</span>
        <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">dl in stack -&gt; dl in function body</span>
        <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>compute/cedent <span style="color: #696969;">(</span>reverse dl<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>list '<span style="color: #696969;">()</span> bs ns<span style="color: #696969;">))</span>
          <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span>
           <span style="color: #B380A8;">{</span>'fail <span style="color: #696969;">(</span>cons `<span style="color: #696969;">(</span>compute/cons
                          fail
                          <span style="color: #696969;">(</span>cons: ,c<span style="color: #696969;">))</span>
                        il<span style="color: #696969;">)</span><span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
          <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{</span>ds1 bs1 ns1<span style="color: #B380A8;">}}</span>
           <span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>cons <span style="color: #B380A8;">{</span>'cons <span style="color: #B380A8;">{</span>n ds1<span style="color: #B380A8;">}}</span>
                            ds<span style="color: #696969;">)</span>
                      bs
                      ns<span style="color: #B380A8;">}}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf6e14e3" class="outline-3">
<h3 id="orgf6e14e3">compute/trunk</h3>
<div class="outline-text-3" id="text-orgf6e14e3">
</div><div id="outline-container-orga39300f" class="outline-4">
<h4 id="orga39300f">compute/trunk</h4>
<div class="outline-text-4" id="text-orga39300f">
<ul class="org-ul">
<li><p>I thought</p><p>there is no reducible trunk after compute/trunk</p><p>thus no reducible trunk after compute/arrow</p><p>but it is actually not true</p><p>because computations after a non-reducible trunk</p><p>might make the trunk reducible</p><p>but no look-back is implemented to handle such case</p></li>

<li><p>&gt;&lt;&gt;&lt;&gt;&lt;</p><p>since I do not really have this invariant</p><p>I should be careful to make sure that</p><p>no functions rely on this invariant</p></li></ul>

<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">compute/trunk</span> t e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> trunk env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> report<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> t
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>a tody dl i<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> tody
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'tody/var __<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>compute/trunk/tody/var t e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'tody/name __<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>compute/trunk/tody/name t e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'tody/arrow-list __<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>compute/trunk/tody/arrow-list t e<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb230089" class="outline-4">
<h4 id="orgb230089">compute/trunk/tody/var</h4>
<div class="outline-text-4" id="text-orgb230089">
<ul class="org-ul">
<li><p>non-determinate may still here</p></li></ul>

<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">compute/trunk/tody/var</span> t e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> trunk env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> report<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> t
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>a <span style="color: #B380A8;">{</span>'tody/var v<span style="color: #B380A8;">}</span> dl i<span style="color: #B380A8;">}</span>
        <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>bs/deep bs <span style="color: #B380A8;">{</span>'var v<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span>
          <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'var v1<span style="color: #B380A8;">}</span>
           <span style="color: #B380A8;">{</span>'success
            <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>cons <span style="color: #B380A8;">{</span>'trunk <span style="color: #B380A8;">{</span>a <span style="color: #B380A8;">{</span>'tody/var v1<span style="color: #B380A8;">}</span> dl i<span style="color: #B380A8;">}}</span> ds<span style="color: #696969;">)</span>
             bs
             ns<span style="color: #B380A8;">}}</span><span style="color: #797979;">]</span>
          <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'arrow a1<span style="color: #B380A8;">}</span>
           <span style="color: #696969;">(</span>compute/trunk/tody/arrow-list
            <span style="color: #B380A8;">{</span>a <span style="color: #B380A8;">{</span>'tody/arrow-list <span style="color: #B380A8;">{</span>a1<span style="color: #B380A8;">}}</span> dl i<span style="color: #B380A8;">}</span> e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
          <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'lambda <span style="color: #B380A8;">{</span>a1 al<span style="color: #B380A8;">}}</span>
           <span style="color: #696969;">(</span>compute/trunk/tody/arrow-list
            <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">I can use a1 or a</span>
            <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">I use a here</span>
            <span style="color: #B380A8;">{</span>a <span style="color: #B380A8;">{</span>'tody/arrow-list al<span style="color: #B380A8;">}</span> dl i<span style="color: #B380A8;">}</span> e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
          <span style="color: #797979;">[</span>d
           <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">orz</span> 'compute/trunk/tody/var
             <span style="color: #696969;">(</span><span style="color: #e6db74;">"find something wrong from the var in the tody of trunk~%"</span><span style="color: #696969;">)</span>
             <span style="color: #696969;">(</span><span style="color: #e6db74;">"data : ~a~%"</span> d<span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org24e1638" class="outline-4">
<h4 id="org24e1638">compute/trunk/tody/name</h4>
<div class="outline-text-4" id="text-org24e1638">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">compute/trunk/tody/name</span> t e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> trunk env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> report<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> t
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>a <span style="color: #B380A8;">{</span>'tody/name n<span style="color: #B380A8;">}</span> dl i<span style="color: #B380A8;">}</span>
        <span style="color: #696969;">(</span>compute/trunk/tody/arrow-list <span style="color: #696969;">(</span>trunk-&gt;trunk* t e<span style="color: #696969;">)</span> e<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org692192" class="outline-4">
<h4 id="org692192">compute/trunk/tody/arrow-list</h4>
<div class="outline-text-4" id="text-org692192">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">compute/trunk/tody/arrow-list</span> t e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> trunk env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> report<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> t
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>a <span style="color: #B380A8;">{</span>'tody/arrow-list al<span style="color: #B380A8;">}</span> dl i<span style="color: #B380A8;">}</span>
        <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">the following reverse</span>
        <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">dl in stack -&gt; dl in function body</span>
        <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>compute/cedent <span style="color: #696969;">(</span>reverse dl<span style="color: #696969;">)</span> <span style="color: #B380A8;">{{}</span> bs ns<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span>
          <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span>
           <span style="color: #B380A8;">{</span>'fail <span style="color: #696969;">(</span>cons `<span style="color: #696969;">(</span>compute/trunk/tody/arrow-list
                          fail when computing data-list
                          <span style="color: #696969;">(</span>data-list: ,dl<span style="color: #696969;">)</span>
                          <span style="color: #696969;">(</span>cons: ,c<span style="color: #696969;">))</span>
                        il<span style="color: #696969;">)</span><span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
          <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success e1<span style="color: #B380A8;">}</span>
           <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e1
             <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds1 bs1 ns1<span style="color: #B380A8;">}</span>
              <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let*</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>dl1 ds1<span style="color: #797979;">]</span>
                     <span style="color: #797979;">[</span>al1 <span style="color: #696969;">(</span>filter-arrow-list al dl1 e1<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
                <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> al1
                  <span style="color: #797979;">[</span><span style="color: #B380A8;">{}</span>
                   <span style="color: #B380A8;">{</span>'fail <span style="color: #B380A8;">{</span>`<span style="color: #696969;">(</span>compute/trunk/tody/arrow-list
                             no antecedent match
                             <span style="color: #696969;">(</span>data-list: ,ds1<span style="color: #696969;">)</span>
                             <span style="color: #696969;">(</span>arrow-list: ,al<span style="color: #696969;">)</span>
                             <span style="color: #696969;">(</span>trunk: ,t<span style="color: #696969;">))</span>
                           `<span style="color: #696969;">(</span>list-unify/antecedent
                             report
                             ,<span style="color: #696969;">(</span>list-unify/antecedent al dl1 e1<span style="color: #696969;">))</span><span style="color: #B380A8;">}}</span><span style="color: #797979;">]</span>
                  <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>a1<span style="color: #B380A8;">}</span>
                   <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>compute/arrow a1 e1<span style="color: #696969;">)</span>
                     <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">after this compute/arrow</span>
                     <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">binds are commited</span>
                     <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success e2<span style="color: #B380A8;">}</span>
                      <span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>cons <span style="color: #696969;">(</span>proj i e2<span style="color: #696969;">)</span> ds<span style="color: #696969;">)</span>
                                 bs1
                                 ns1<span style="color: #B380A8;">}}</span><span style="color: #797979;">]</span>
                     <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span>
                  <span style="color: #797979;">[</span><span style="color: #696969;">(</span>a1 a2 . __<span style="color: #696969;">)</span>
                   <span style="color: #B380A8;">{</span>'success
                    <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>cons <span style="color: #B380A8;">{</span>'trunk <span style="color: #B380A8;">{</span>a <span style="color: #B380A8;">{</span>'tody/arrow-list al1<span style="color: #B380A8;">}</span> dl1 i<span style="color: #B380A8;">}}</span>
                           ds<span style="color: #696969;">)</span>
                     bs1
                     ns1<span style="color: #B380A8;">}}</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgdafed1d" class="outline-4">
<h4 id="orgdafed1d">trunk-&gt;trunk*</h4>
<div class="outline-text-4" id="text-orgdafed1d">
<ul class="org-ul">
<li><p>replace the name in trunk by arrow-list</p></li>

<li><p>the ns of env is needed</p><p>to find the arrow-list under the name</p></li></ul>

<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">trunk-&gt;trunk*</span> t e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> trunk env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> trunk<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> t
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>a <span style="color: #B380A8;">{</span>'tody/name n<span style="color: #B380A8;">}</span> dl i<span style="color: #B380A8;">}</span>
        <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>found <span style="color: #696969;">(</span>assq n ns<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
          <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> <span style="color: #696969;">(</span>not found<span style="color: #696969;">)</span>
            <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">orz</span> 'trunk-&gt;trunk*
              <span style="color: #696969;">(</span><span style="color: #e6db74;">"fail~%"</span><span style="color: #696969;">)</span>
              <span style="color: #696969;">(</span><span style="color: #e6db74;">"unknow name : ~a~%"</span> n<span style="color: #696969;">))</span>
            <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>meaning <span style="color: #696969;">(</span>cdr found<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
              <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> meaning
                <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'lambda <span style="color: #B380A8;">{{</span>ac sc<span style="color: #B380A8;">}</span> al1<span style="color: #B380A8;">}}</span>
                 <span style="color: #B380A8;">{</span>a <span style="color: #B380A8;">{</span>'tody/arrow-list <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">map</span> copy-arrow al1<span style="color: #696969;">)</span><span style="color: #B380A8;">}</span> dl i<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
                <span style="color: #797979;">[</span>__
                 <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">orz</span> 'trunk-&gt;trunk*
                   <span style="color: #696969;">(</span><span style="color: #e6db74;">"trunk-&gt;trunk* fail~%"</span> <span style="color: #696969;">)</span>
                   <span style="color: #696969;">(</span><span style="color: #e6db74;">"name is not lambda : ~a~%"</span> n<span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">))))</span><span style="color: #797979;">]</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>a tody dl i<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>a tody dl i<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org16971be" class="outline-3">
<h3 id="org16971be">list-unify/antecedent</h3>
<div class="outline-text-3" id="text-org16971be">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">list-unify/antecedent</span> al dl e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> <span style="color: #696969;">(</span>arrow ...<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>data ...<span style="color: #696969;">)</span> env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #696969;">((</span>report arrow<span style="color: #696969;">)</span> ...<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">map</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">lambda</span> <span style="color: #696969;">(</span>a<span style="color: #696969;">)</span>
         <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
           <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span>
            <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> a
              <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ac __<span style="color: #B380A8;">}</span>
               <span style="color: #B380A8;">{</span>a <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>compute/cedent ac <span style="color: #B380A8;">{{}</span> bs ns<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span>
                    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'fail <span style="color: #696969;">(</span>cons `<span style="color: #696969;">(</span>list-unify/antecedent
                                               fail to compute/cedent
                                               <span style="color: #696969;">(</span>ac: ,ac<span style="color: #696969;">))</span>
                                             il<span style="color: #696969;">)</span><span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
                    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{</span>ds1 bs1 ns1<span style="color: #B380A8;">}}</span>
                     <span style="color: #696969;">(</span>unify/data-list
                      dl ds1
                      <span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{</span>ds bs1 ns1<span style="color: #B380A8;">}}</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
    al<span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf9b996f" class="outline-3">
<h3 id="orgf9b996f">filter-arrow-list</h3>
<div class="outline-text-3" id="text-orgf9b996f">
<ul class="org-ul">
<li><p>no commit should be made here</p></li></ul>

<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">filter-arrow-list</span> al dl e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> <span style="color: #696969;">(</span>arrow ...<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>data ...<span style="color: #696969;">)</span> env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #696969;">(</span>arrow ...<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> <span style="color: #696969;">(</span>eq? '<span style="color: #696969;">()</span> al<span style="color: #696969;">)</span>
    '<span style="color: #696969;">()</span>
    <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
      <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span>
       <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>car al<span style="color: #696969;">)</span>
         <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ac __<span style="color: #B380A8;">}</span>
          <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>alen <span style="color: #696969;">(</span>length ac<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
            <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>compute/cedent ac e<span style="color: #696969;">)</span>
              <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail __<span style="color: #B380A8;">}</span>
               <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">orz</span> 'filter-arrow-list <span style="color: #696969;">(</span><span style="color: #e6db74;">"fail to compute/cedent~%"</span><span style="color: #696969;">))</span><span style="color: #797979;">]</span>
              <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{</span>ds1 bs1 ns1<span style="color: #B380A8;">}}</span>
               <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>unify/data-list
                       dl <span style="color: #696969;">(</span>take ds1 alen<span style="color: #696969;">)</span>
                       <span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>drop ds1 alen<span style="color: #696969;">)</span>
                                  bs1
                                  ns1<span style="color: #B380A8;">}}</span><span style="color: #696969;">)</span>
                 <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail __<span style="color: #B380A8;">}</span>
                  <span style="color: #696969;">(</span>filter-arrow-list <span style="color: #696969;">(</span>cdr al<span style="color: #696969;">)</span> dl e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
                 <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success __<span style="color: #B380A8;">}</span>
                  <span style="color: #696969;">(</span>cons <span style="color: #696969;">(</span>car al<span style="color: #696969;">)</span>
                        <span style="color: #696969;">(</span>filter-arrow-list <span style="color: #696969;">(</span>cdr al<span style="color: #696969;">)</span> dl e<span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgca565d9" class="outline-3">
<h3 id="orgca565d9">proj</h3>
<div class="outline-text-3" id="text-orgca565d9">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">proj</span> i e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> index env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> data<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #696969;">(</span>ds bs ns<span style="color: #696969;">)</span>
     <span style="color: #696969;">(</span>list-ref ds <span style="color: #696969;">(</span>- <span style="color: #696969;">(</span>length ds<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>+ 1 i<span style="color: #696969;">)))</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org873e190" class="outline-2">
<h2 id="org873e190">print</h2>
<div class="outline-text-2" id="text-org873e190">
</div><div id="outline-container-orge85761e" class="outline-3">
<h3 id="orge85761e">print/cedent</h3>
<div class="outline-text-3" id="text-orge85761e">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">print/cedent</span> c e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> cedent env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #797979;">[</span>effect on terminal<span style="color: #797979;">]</span><span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> c
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{}</span> <span style="color: #696969;">(</span>void<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>d<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>print/data d e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #696969;">(</span>d . r<span style="color: #696969;">)</span>
     <span style="color: #696969;">(</span>print/data d e<span style="color: #696969;">)</span>
     <span style="color: #696969;">(</span>format #t <span style="color: #e6db74;">" "</span><span style="color: #696969;">)</span>
     <span style="color: #696969;">(</span>print/cedent r e<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc506fd8" class="outline-3">
<h3 id="orgc506fd8">print/data-list</h3>
<div class="outline-text-3" id="text-orgc506fd8">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">print/data-list</span> dl e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> <span style="color: #696969;">(</span>data ...<span style="color: #696969;">)</span> env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #797979;">[</span>effect on terminal<span style="color: #797979;">]</span><span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span>print/cedent <span style="color: #696969;">(</span>reverse dl<span style="color: #696969;">)</span> e<span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org959040e" class="outline-3">
<h3 id="org959040e">print/data</h3>
<div class="outline-text-3" id="text-org959040e">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">print/data</span> d e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> data env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #797979;">[</span>effect on terminal<span style="color: #797979;">]</span><span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> d
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'var x<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>print/var x e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'cons x<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>print/cons x e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'arrow x<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>print/arrow x e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'lambda x<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>print/lambda x e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'trunk x<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>print/trunk x e<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd98e55d" class="outline-3">
<h3 id="orgd98e55d">print/var</h3>
<div class="outline-text-3" id="text-orgd98e55d">
<ul class="org-ul">
<li><p>different var should be print differently</p></li>

<li><p>note that</p><p>the env is not used by even print/var</p></li></ul>

<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">print/var</span> v e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> var env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #797979;">[</span>effect on terminal<span style="color: #797979;">]</span><span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> v
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>id level<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>name <span style="color: #696969;">(</span>id-&gt;name id<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
           <span style="color: #797979;">[</span>counter <span style="color: #696969;">(</span>id-&gt;counter id<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
       <span style="color: #696969;">(</span>format #t <span style="color: #e6db74;">":~a:~a^~a"</span> counter name level<span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org8c17f7f" class="outline-3">
<h3 id="org8c17f7f">print/cons</h3>
<div class="outline-text-3" id="text-org8c17f7f">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">print/cons</span> c e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> cons env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #797979;">[</span>effect on terminal<span style="color: #797979;">]</span><span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> c
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>n dl<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span>format #t <span style="color: #e6db74;">"["</span><span style="color: #696969;">)</span>
     <span style="color: #696969;">(</span>print/data-list dl e<span style="color: #696969;">)</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> <span style="color: #696969;">(</span>null? dl<span style="color: #696969;">)</span>
       <span style="color: #696969;">(</span>format #t <span style="color: #e6db74;">"~a]"</span> n<span style="color: #696969;">)</span>
       <span style="color: #696969;">(</span>format #t <span style="color: #e6db74;">" ~a]"</span> n<span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org50624a3" class="outline-3">
<h3 id="org50624a3">print/arrow</h3>
<div class="outline-text-3" id="text-org50624a3">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">print/arrow</span> a e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> arrow env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #797979;">[</span>effect on terminal<span style="color: #797979;">]</span><span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> a
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ac sc<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span>format #t <span style="color: #e6db74;">"("</span><span style="color: #696969;">)</span>
     <span style="color: #696969;">(</span>print/cedent ac e<span style="color: #696969;">)</span>
     <span style="color: #696969;">(</span>format #t <span style="color: #e6db74;">" -&gt; "</span><span style="color: #696969;">)</span>
     <span style="color: #696969;">(</span>print/cedent sc e<span style="color: #696969;">)</span>
     <span style="color: #696969;">(</span>format #t <span style="color: #e6db74;">")"</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org6b5a0ef" class="outline-3">
<h3 id="org6b5a0ef"><span class="todo _gt__lt_">&gt;&lt;</span> print/lambda</h3>
<div class="outline-text-3" id="text-org6b5a0ef">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">print/lambda</span> l e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> lambda env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #797979;">[</span>effect on terminal<span style="color: #797979;">]</span><span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> l
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>a al<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span>format #t <span style="color: #e6db74;">"&lt;lambda&gt;"</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org7620712" class="outline-3">
<h3 id="org7620712"><span class="todo _gt__lt_">&gt;&lt;</span> print/trunk</h3>
<div class="outline-text-3" id="text-org7620712">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">print/trunk</span> t e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> trunk env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #797979;">[</span>effect on terminal<span style="color: #797979;">]</span><span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> t
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>a tody dl i<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span>format #t <span style="color: #e6db74;">"&lt;trunk&gt;"</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgc91ce8b" class="outline-2">
<h2 id="orgc91ce8b">unify</h2>
<div class="outline-text-2" id="text-orgc91ce8b">
</div><div id="outline-container-orgec25a81" class="outline-3">
<h3 id="orgec25a81"><span class="todo note">note</span> </h3>
<div class="outline-text-3" id="text-orgec25a81">
<ul class="org-ul">
<li><p>firstly we have first order syntactic unification</p></li>

<li><p>except for unify/trunk/data</p><p>where semantic unification is used</p></li>

<li><p>and for unify/trunk</p><p>where first syntactic unification is tried</p><p>if it fail</p><p>semantic unification is used</p></li>

<li><p>semantic unification is unification modulo theory</p><p>the theory here is function composition</p></li></ul>
</div>
</div>

<div id="outline-container-org29a8353" class="outline-3">
<h3 id="org29a8353">unify/data-list</h3>
<div class="outline-text-3" id="text-org29a8353">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">unify/data-list</span> pl dl r<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> <span style="color: #696969;">(</span>pattern ...<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>data ...<span style="color: #696969;">)</span> report <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> report<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> r
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success e<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">cond</span> <span style="color: #797979;">[</span><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">and</span> <span style="color: #696969;">(</span>eq? pl '<span style="color: #696969;">())</span> <span style="color: #696969;">(</span>eq? dl '<span style="color: #696969;">()))</span>
            r<span style="color: #797979;">]</span>
           <span style="color: #797979;">[</span><span style="color: #696969;">(</span>eq? pl <span style="color: #B380A8;">{}</span><span style="color: #696969;">)</span>
            <span style="color: #B380A8;">{</span>'fail <span style="color: #B380A8;">{</span>`<span style="color: #696969;">(</span>unify/data-list
                      fail pl and dl is not of the same length
                      <span style="color: #696969;">(</span>additional-dl: ,dl<span style="color: #696969;">))</span><span style="color: #B380A8;">}}</span><span style="color: #797979;">]</span>
           <span style="color: #797979;">[</span><span style="color: #696969;">(</span>eq? dl <span style="color: #B380A8;">{}</span><span style="color: #696969;">)</span>
            <span style="color: #B380A8;">{</span>'fail <span style="color: #B380A8;">{</span>`<span style="color: #696969;">(</span>unify/data-list
                      fail pl and dl is not of the same length
                      <span style="color: #696969;">(</span>additional-pl: ,pl<span style="color: #696969;">))</span><span style="color: #B380A8;">}}</span><span style="color: #797979;">]</span>
           <span style="color: #797979;">[</span>else
            <span style="color: #696969;">(</span>unify/data-list
             <span style="color: #696969;">(</span>cdr pl<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>cdr dl<span style="color: #696969;">)</span>
             <span style="color: #696969;">(</span>unify/data <span style="color: #696969;">(</span>car pl<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>car dl<span style="color: #696969;">)</span> e<span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org1195e5a" class="outline-3">
<h3 id="org1195e5a">var/eq?</h3>
<div class="outline-text-3" id="text-org1195e5a">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">var/eq?</span> v1 v2<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>list v1 v2<span style="color: #696969;">)</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{{</span>id1 level1<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>id2 level2<span style="color: #B380A8;">}}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">and</span> <span style="color: #696969;">(</span>eq? id1 id2<span style="color: #696969;">)</span>
          <span style="color: #696969;">(</span>eq? level1 level2<span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org31f15e1" class="outline-3">
<h3 id="org31f15e1">unify/data</h3>
<div class="outline-text-3" id="text-org31f15e1">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">unify/data</span> p d e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> pattern data env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> report<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span>
     <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">var -walk-&gt; fresh-var</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>p <span style="color: #696969;">(</span>bs/walk bs p<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
           <span style="color: #797979;">[</span>d <span style="color: #696969;">(</span>bs/walk bs d<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
       <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #B380A8;">{</span>p d<span style="color: #B380A8;">}</span>
         <span style="color: #797979;">[</span><span style="color: #B380A8;">{{</span>'var v1<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'var v2<span style="color: #B380A8;">}}</span>
          <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> <span style="color: #696969;">(</span>var/eq? v1 v2<span style="color: #696969;">)</span>
            <span style="color: #B380A8;">{</span>'success e<span style="color: #B380A8;">}</span>
            <span style="color: #696969;">(</span>unify/var/data v1 d e<span style="color: #696969;">))</span><span style="color: #797979;">]</span>
         <span style="color: #797979;">[</span><span style="color: #B380A8;">{{</span>'var v<span style="color: #B380A8;">}</span> __<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>unify/var/data v d e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
         <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>__ <span style="color: #B380A8;">{</span>'var v<span style="color: #B380A8;">}}</span> <span style="color: #696969;">(</span>unify/var/data v p e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>

         <span style="color: #797979;">[</span><span style="color: #B380A8;">{{</span>'trunk t1<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'trunk t2<span style="color: #B380A8;">}}</span> <span style="color: #696969;">(</span>unify/trunk t1 t2 e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
         <span style="color: #797979;">[</span><span style="color: #B380A8;">{{</span>'trunk t<span style="color: #B380A8;">}</span> __<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>unify/trunk/data t d e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
         <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>__ <span style="color: #B380A8;">{</span>'trunk t<span style="color: #B380A8;">}}</span> <span style="color: #696969;">(</span>unify/trunk/data t p e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>

         <span style="color: #797979;">[</span><span style="color: #B380A8;">{{</span>'cons c1<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'cons c2<span style="color: #B380A8;">}}</span> <span style="color: #696969;">(</span>unify/cons c1 c2 e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
         <span style="color: #797979;">[</span><span style="color: #B380A8;">{{</span>'arrow a1<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'arrow a2<span style="color: #B380A8;">}}</span> <span style="color: #696969;">(</span>unify/arrow a1 a2 e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
         <span style="color: #797979;">[</span><span style="color: #B380A8;">{{</span>'lambda l1<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'lambda l2<span style="color: #B380A8;">}}</span> <span style="color: #696969;">(</span>unify/lambda l1 l2 e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
         <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>__ __<span style="color: #B380A8;">}</span>
          <span style="color: #B380A8;">{</span>'fail <span style="color: #B380A8;">{</span>`<span style="color: #696969;">(</span>unify/data
                    fail to unify
                    <span style="color: #696969;">(</span>pattern: ,p<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>data: ,d<span style="color: #696969;">))</span><span style="color: #B380A8;">}}</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org80f4ee0" class="outline-3">
<h3 id="org80f4ee0">bs/extend</h3>
<div class="outline-text-3" id="text-org80f4ee0">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">bs/extend</span> bs v d<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> bs var data <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> bs<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> v
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>id level<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>found/ls <span style="color: #696969;">(</span>assq id bs<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
       <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> found/ls
         <span style="color: #696969;">(</span>substitute <span style="color: #696969;">(</span>cons id <span style="color: #696969;">(</span>cons <span style="color: #696969;">(</span>cons level d<span style="color: #696969;">)</span>
                                    <span style="color: #696969;">(</span>cdr found/ls<span style="color: #696969;">)))</span>
                     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">lambda</span> <span style="color: #696969;">(</span>pair<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>eq? <span style="color: #696969;">(</span>car pair<span style="color: #696969;">)</span> id<span style="color: #696969;">))</span>
                     bs<span style="color: #696969;">)</span>
         <span style="color: #696969;">(</span>cons <span style="color: #696969;">(</span>cons id <span style="color: #696969;">(</span>list <span style="color: #696969;">(</span>cons level d<span style="color: #696969;">)))</span>
               bs<span style="color: #696969;">)))</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org4e4458b" class="outline-3">
<h3 id="org4e4458b">unify/var/data</h3>
<div class="outline-text-3" id="text-org4e4458b">
<ul class="org-ul">
<li><p>before bs/extend need to ensure that</p><p>the bind to be added is consistent with binds already in bs</p><p>this is where the levels of var come into the game</p></li></ul>

<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">unify/var/data</span> v d e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> fresh-var data env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> report<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>consistent-check v d e<span style="color: #696969;">)</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span>
        <span style="color: #B380A8;">{</span>'fail <span style="color: #696969;">(</span>cons `<span style="color: #696969;">(</span>unify/var/data
                       consistent-check fail
                       <span style="color: #696969;">(</span>v: ,v<span style="color: #696969;">)</span>
                       <span style="color: #696969;">(</span>d: ,d<span style="color: #696969;">))</span>
                     il<span style="color: #696969;">)</span><span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success __<span style="color: #B380A8;">}</span>
        <span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{</span>ds <span style="color: #696969;">(</span>bs/extend bs v d<span style="color: #696969;">)</span> ns<span style="color: #B380A8;">}}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgcc58fe" class="outline-3">
<h3 id="orgcc58fe">consistent-check</h3>
<div class="outline-text-3" id="text-orgcc58fe">
</div><div id="outline-container-orgad07300" class="outline-4">
<h4 id="orgad07300">consistent-check</h4>
<div class="outline-text-4" id="text-orgad07300">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">consistent-check</span> v d e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> fresh-var data env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> report<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #B380A8;">{</span>v e<span style="color: #B380A8;">}</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{{</span>id level<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>var/highest? v e<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>var/lowest? v e<span style="color: #696969;">)</span><span style="color: #B380A8;">}</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>#t #t<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'success e<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>#t #f<span style="color: #B380A8;">}</span>
        <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>var/below v e<span style="color: #696969;">)</span>
          <span style="color: #797979;">[</span><span style="color: #B380A8;">{{</span>__ low-level<span style="color: #B380A8;">}</span> low-d<span style="color: #B380A8;">}</span>
           <span style="color: #696969;">(</span>consistent-check/level-diff <span style="color: #696969;">(</span>- level low-level<span style="color: #696969;">)</span> low-d d e<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>#f #t<span style="color: #B380A8;">}</span>
        <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>var/above v e<span style="color: #696969;">)</span>
          <span style="color: #797979;">[</span><span style="color: #B380A8;">{{</span>__ high-level<span style="color: #B380A8;">}</span> high-d<span style="color: #B380A8;">}</span>
           <span style="color: #696969;">(</span>consistent-check/level-diff <span style="color: #696969;">(</span>- high-level level<span style="color: #696969;">)</span> d high-d e<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>#f #f<span style="color: #B380A8;">}</span>
        <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>var/below v e<span style="color: #696969;">)</span>
          <span style="color: #797979;">[</span><span style="color: #B380A8;">{{</span>__ low-level<span style="color: #B380A8;">}</span> low-d<span style="color: #B380A8;">}</span>
           <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>consistent-check/level-diff <span style="color: #696969;">(</span>- level low-level<span style="color: #696969;">)</span> low-d d e<span style="color: #696969;">)</span>
             <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
             <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success __<span style="color: #B380A8;">}</span>
              <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>var/above v e<span style="color: #696969;">)</span>
                <span style="color: #797979;">[</span><span style="color: #B380A8;">{{</span>__ high-level<span style="color: #B380A8;">}</span> high-d<span style="color: #B380A8;">}</span>
                 <span style="color: #696969;">(</span>consistent-check/level-diff <span style="color: #696969;">(</span>- high-level level<span style="color: #696969;">)</span> d high-d e<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org367d029" class="outline-4">
<h4 id="org367d029">consistent-check/level-diff</h4>
<div class="outline-text-4" id="text-org367d029">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">consistent-check/level-diff</span> level-diff d1 d2 e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> level-diff data data env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> report<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>type-compute/repeat level-diff d1 e<span style="color: #696969;">)</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>d0 . __<span style="color: #696969;">)</span> bs1 ns1<span style="color: #B380A8;">}}</span>
        <span style="color: #696969;">(</span>unify/data d0 d2 <span style="color: #B380A8;">{</span>ds bs1 ns1<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org772f066" class="outline-4">
<h4 id="org772f066">type-compute/repeat</h4>
<div class="outline-text-4" id="text-org772f066">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">type-compute/repeat</span> c d e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> counter data env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> report<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>eq? 0 c<span style="color: #696969;">)</span>
       <span style="color: #797979;">[</span>#t <span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>cons d ds<span style="color: #696969;">)</span> bs ns<span style="color: #B380A8;">}}</span><span style="color: #797979;">]</span>
       <span style="color: #797979;">[</span>#f <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>type-compute d e<span style="color: #696969;">)</span>
             <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
             <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>d1 . r<span style="color: #696969;">)</span> bs1 ns1<span style="color: #B380A8;">}}</span>
              <span style="color: #696969;">(</span>type-compute/repeat <span style="color: #696969;">(</span>- c 1<span style="color: #696969;">)</span> d1 <span style="color: #B380A8;">{</span>r bs1 ns1<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org2bd13ca" class="outline-4">
<h4 id="org2bd13ca">var/highest? &amp; var/lowest?</h4>
<div class="outline-text-4" id="text-org2bd13ca">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">var/highest?</span> v e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> fresh-var env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> bool<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> v
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>id level<span style="color: #B380A8;">}</span>
        <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let*</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>found <span style="color: #696969;">(</span>assq id bs<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
               <span style="color: #797979;">[</span>ls <span style="color: #696969;">(</span>append <span style="color: #696969;">(</span>id-&gt;ls id<span style="color: #696969;">)</span>
                           <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> found <span style="color: #696969;">(</span>cdr found<span style="color: #696969;">)</span> '<span style="color: #696969;">()))</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
          <span style="color: #696969;">(</span>list-every?
           <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">lambda</span> <span style="color: #696969;">(</span>x<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>&gt; level <span style="color: #696969;">(</span>car x<span style="color: #696969;">)))</span>
           ls<span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>

<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">var/lowest?</span> v e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> fresh-var env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> bool<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> v
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>id level<span style="color: #B380A8;">}</span>
        <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let*</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>found <span style="color: #696969;">(</span>assq id bs<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
               <span style="color: #797979;">[</span>ls <span style="color: #696969;">(</span>append <span style="color: #696969;">(</span>id-&gt;ls id<span style="color: #696969;">)</span>
                           <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> found <span style="color: #696969;">(</span>cdr found<span style="color: #696969;">)</span> '<span style="color: #696969;">()))</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
          <span style="color: #696969;">(</span>list-every?
           <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">lambda</span> <span style="color: #696969;">(</span>x<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>&lt; level <span style="color: #696969;">(</span>car x<span style="color: #696969;">)))</span>
           ls<span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org64f567f" class="outline-4">
<h4 id="org64f567f">var/above &amp; var/below</h4>
<div class="outline-text-4" id="text-org64f567f">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">var/above</span> v e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> fresh-var env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #696969;">(</span>var data<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> v
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>id level<span style="color: #B380A8;">}</span>
        <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let*</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>found <span style="color: #696969;">(</span>assq id bs<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
               <span style="color: #797979;">[</span>ls <span style="color: #696969;">(</span>append <span style="color: #696969;">(</span>id-&gt;ls id<span style="color: #696969;">)</span>
                           <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> found <span style="color: #696969;">(</span>cdr found<span style="color: #696969;">)</span> '<span style="color: #696969;">()))</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
          <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>pair
                 <span style="color: #696969;">(</span>car <span style="color: #696969;">(</span>filter <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">lambda</span> <span style="color: #696969;">(</span>x<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>&gt; <span style="color: #696969;">(</span>car x<span style="color: #696969;">)</span> level<span style="color: #696969;">))</span>
                              <span style="color: #696969;">(</span>sort <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">lambda</span> <span style="color: #696969;">(</span>x y<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>&lt; <span style="color: #696969;">(</span>car x<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>car y<span style="color: #696969;">)))</span>
                                    ls<span style="color: #696969;">)))</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
            <span style="color: #B380A8;">{{</span>id <span style="color: #696969;">(</span>car pair<span style="color: #696969;">)</span><span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>cdr pair<span style="color: #696969;">)</span><span style="color: #B380A8;">}</span><span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>

<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">var/below</span> v e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> fresh-var env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #696969;">(</span>var data<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> v
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>id level<span style="color: #B380A8;">}</span>
        <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let*</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>found <span style="color: #696969;">(</span>assq id bs<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
               <span style="color: #797979;">[</span>ls <span style="color: #696969;">(</span>append <span style="color: #696969;">(</span>id-&gt;ls id<span style="color: #696969;">)</span>
                           <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> found <span style="color: #696969;">(</span>cdr found<span style="color: #696969;">)</span> '<span style="color: #696969;">()))</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
          <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>pair
                 <span style="color: #696969;">(</span>car <span style="color: #696969;">(</span>filter <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">lambda</span> <span style="color: #696969;">(</span>x<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>&lt; <span style="color: #696969;">(</span>car x<span style="color: #696969;">)</span> level<span style="color: #696969;">))</span>
                              <span style="color: #696969;">(</span>sort <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">lambda</span> <span style="color: #696969;">(</span>x y<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>&gt; <span style="color: #696969;">(</span>car x<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>car y<span style="color: #696969;">)))</span>
                                    ls<span style="color: #696969;">)))</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
            <span style="color: #B380A8;">{{</span>id <span style="color: #696969;">(</span>car pair<span style="color: #696969;">)</span><span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>cdr pair<span style="color: #696969;">)</span><span style="color: #B380A8;">}</span><span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgf7bdd3b" class="outline-3">
<h3 id="orgf7bdd3b">unify/cons</h3>
<div class="outline-text-3" id="text-orgf7bdd3b">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">unify/cons</span> c1 c2 e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> cons cons env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> report<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #B380A8;">{</span>c1 c2<span style="color: #B380A8;">}</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{{</span>n1 dl1<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>n2 dl2<span style="color: #B380A8;">}}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> <span style="color: #696969;">(</span>eq? n1 n2<span style="color: #696969;">)</span>
       <span style="color: #696969;">(</span>unify/data-list dl1 dl2 <span style="color: #B380A8;">{</span>'success e<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span>
       <span style="color: #B380A8;">{</span>'fail <span style="color: #B380A8;">{</span>`<span style="color: #696969;">(</span>unify/cons
                 fail
                 <span style="color: #696969;">(</span>cons1: ,c1<span style="color: #696969;">)</span>
                 <span style="color: #696969;">(</span>cons2: ,c2<span style="color: #696969;">))</span><span style="color: #B380A8;">}}</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org5e29aa2" class="outline-3">
<h3 id="org5e29aa2">unify/arrow</h3>
<div class="outline-text-3" id="text-org5e29aa2">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">unify/arrow</span> a1 a2 e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> arrow arrow env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> report<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #B380A8;">{</span>a1 a2<span style="color: #B380A8;">}</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{{</span>ac1 sc1<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>ac2 sc2<span style="color: #B380A8;">}}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>unify/data-list ac1 ac2 <span style="color: #B380A8;">{</span>'success e<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success e1<span style="color: #B380A8;">}</span>
        <span style="color: #696969;">(</span>unify/data-list sc1 sc2 <span style="color: #B380A8;">{</span>'success e1<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span>
        <span style="color: #B380A8;">{</span>'fail <span style="color: #696969;">(</span>cons `<span style="color: #696969;">(</span>unify/arrow
                       fail  <span style="color: #696969;">(</span>arrow1: ,a1<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>arrow2: ,a2<span style="color: #696969;">))</span>
                     il<span style="color: #696969;">)</span><span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgfef9edf" class="outline-3">
<h3 id="orgfef9edf">unify/lambda</h3>
<div class="outline-text-3" id="text-orgfef9edf">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">unify/lambda</span> l1 l2 e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> lambda lambda env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> report<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #B380A8;">{</span>l1 l2<span style="color: #B380A8;">}</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{{</span>a1 al1<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>a2 al2<span style="color: #B380A8;">}}</span>
     <span style="color: #696969;">(</span>unify/arrow-list al1 al2 <span style="color: #696969;">(</span>unify/arrow a1 a2 e<span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgaab8e8c" class="outline-3">
<h3 id="orgaab8e8c">unify/arrow-list</h3>
<div class="outline-text-3" id="text-orgaab8e8c">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">unify/arrow-list</span> al1 al2 r<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> <span style="color: #696969;">(</span>arrow ...<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>arrow ...<span style="color: #696969;">)</span> report <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> report<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> r
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success e<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> <span style="color: #696969;">(</span>eq? al1 <span style="color: #B380A8;">{}</span><span style="color: #696969;">)</span>
       r
       <span style="color: #696969;">(</span>unify/arrow-list
        <span style="color: #696969;">(</span>cdr al1<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>cdr al2<span style="color: #696969;">)</span>
        <span style="color: #696969;">(</span>unify/arrow <span style="color: #696969;">(</span>car al1<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>car al2<span style="color: #696969;">)</span> e<span style="color: #696969;">)))</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org4fc1b5c" class="outline-3">
<h3 id="org4fc1b5c">unify/trunk</h3>
<div class="outline-text-3" id="text-org4fc1b5c">
</div><div id="outline-container-org5251c4a" class="outline-4">
<h4 id="org5251c4a"><span class="todo note">note</span> </h4>
<div class="outline-text-4" id="text-org5251c4a">
<ul class="org-ul">
<li><p>it will not diverge on recursive call here</p><p>because the trunk of recursive call</p><p>only have name in it</p><p>but not have the arrow-list</p></li>

<li><p>to be able to unify on trunk</p><p>is different from</p><p>to be able to unify on arrow or lambda</p><p>we do not really have</p><p>second order semantic unification here</p></li></ul>
</div>
</div>

<div id="outline-container-org20316d1" class="outline-4">
<h4 id="org20316d1">unify/trunk</h4>
<div class="outline-text-4" id="text-org20316d1">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">unify/trunk</span> t1 t2 e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> trunk trunk env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> report<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>unify/trunk/syntactic t1 t2 e<span style="color: #696969;">)</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success e1<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'success e1<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il1<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>unify/trunk/semantic t1 t2 e<span style="color: #696969;">)</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success e2<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'success e2<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il2<span style="color: #B380A8;">}</span>
        <span style="color: #B380A8;">{</span>'fail <span style="color: #696969;">(</span>append il2 il1<span style="color: #696969;">)</span><span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org94d877c" class="outline-4">
<h4 id="org94d877c">unify/trunk/syntactic</h4>
<div class="outline-text-4" id="text-org94d877c">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">unify/trunk/syntactic</span> t1 t2 e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> trunk trunk env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> report<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #B380A8;">{</span>t1 t2<span style="color: #B380A8;">}</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{{</span>a1 tody1 dl1 i1<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>a2 tody2 dl2 i2<span style="color: #B380A8;">}}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> <span style="color: #696969;">(</span>not <span style="color: #696969;">(</span>eq? i1 i2<span style="color: #696969;">))</span>
       <span style="color: #B380A8;">{</span>'fail <span style="color: #B380A8;">{</span>`<span style="color: #696969;">(</span>unify/trunk/syntactic
                 fail indexes are different
                 <span style="color: #696969;">(</span>trunk1: ,t1<span style="color: #696969;">)</span>
                 <span style="color: #696969;">(</span>trunk2: ,t2<span style="color: #696969;">))</span><span style="color: #B380A8;">}}</span>
       <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #B380A8;">{</span>tody1 tody2<span style="color: #B380A8;">}</span>
         <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">about name</span>
         <span style="color: #797979;">[</span><span style="color: #B380A8;">{{</span>'tody/name n1<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'tody/name n2<span style="color: #B380A8;">}}</span>
          <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> <span style="color: #696969;">(</span>eq? n1 n2<span style="color: #696969;">)</span>
            <span style="color: #696969;">(</span>unify/data-list dl1 dl2 <span style="color: #696969;">(</span>unify/arrow a1 a2 e<span style="color: #696969;">))</span>
            <span style="color: #B380A8;">{</span>'fail <span style="color: #B380A8;">{</span>`<span style="color: #696969;">(</span>unify/trunk/syntactic
                      fail names are different
                      <span style="color: #696969;">(</span>trunk1: ,t1<span style="color: #696969;">)</span>
                      <span style="color: #696969;">(</span>trunk2: ,t2<span style="color: #696969;">))</span><span style="color: #B380A8;">}}</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span>
         <span style="color: #797979;">[</span><span style="color: #B380A8;">{{</span>'tody/name n<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'tody/var v<span style="color: #B380A8;">}}</span>
          <span style="color: #696969;">(</span>unify/trunk/syntactic <span style="color: #696969;">(</span>trunk-&gt;trunk* t1 e<span style="color: #696969;">)</span> t2 e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
         <span style="color: #797979;">[</span><span style="color: #B380A8;">{{</span>'tody/var v<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'tody/name n<span style="color: #B380A8;">}}</span>
          <span style="color: #696969;">(</span>unify/trunk/syntactic  t1 <span style="color: #696969;">(</span>trunk-&gt;trunk* t2 e<span style="color: #696969;">)</span> e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
         <span style="color: #797979;">[</span><span style="color: #B380A8;">{{</span>'tody/name n<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'tody/arrow-list al<span style="color: #B380A8;">}}</span>
          <span style="color: #696969;">(</span>unify/trunk/syntactic <span style="color: #696969;">(</span>trunk-&gt;trunk* t1 e<span style="color: #696969;">)</span> t2 e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
         <span style="color: #797979;">[</span><span style="color: #B380A8;">{{</span>'tody/arrow-list al<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'tody/name n<span style="color: #B380A8;">}}</span>
          <span style="color: #696969;">(</span>unify/trunk/syntactic  t1 <span style="color: #696969;">(</span>trunk-&gt;trunk* t2 e<span style="color: #696969;">)</span> e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
         <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">about var</span>
         <span style="color: #797979;">[</span><span style="color: #B380A8;">{{</span>'tody/var v1<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'tody/var v2<span style="color: #B380A8;">}}</span>
          <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>unify/data <span style="color: #B380A8;">{</span>'var v1<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'var v2<span style="color: #B380A8;">}</span> e<span style="color: #696969;">)</span>
            <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
            <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success e1<span style="color: #B380A8;">}</span>
             <span style="color: #696969;">(</span>unify/data-list dl1 dl2 <span style="color: #696969;">(</span>unify/arrow a1 a2 e1<span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span>
         <span style="color: #797979;">[</span><span style="color: #B380A8;">{{</span>'tody/var v<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'tody/arrow-list al<span style="color: #B380A8;">}}</span>
          <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>unify/data <span style="color: #B380A8;">{</span>'var v<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'lambda <span style="color: #B380A8;">{</span>a2 al<span style="color: #B380A8;">}}</span> e<span style="color: #696969;">)</span>
            <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
            <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success e1<span style="color: #B380A8;">}</span>
             <span style="color: #696969;">(</span>unify/data-list dl1 dl2 <span style="color: #696969;">(</span>unify/arrow a1 a2 e1<span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span>
         <span style="color: #797979;">[</span><span style="color: #B380A8;">{{</span>'tody/arrow-list al<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'tody/var v<span style="color: #B380A8;">}}</span>
          <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>unify/data <span style="color: #B380A8;">{</span>'lambda <span style="color: #B380A8;">{</span>a1 al<span style="color: #B380A8;">}}</span> <span style="color: #B380A8;">{</span>'var v<span style="color: #B380A8;">}</span> e<span style="color: #696969;">)</span>
            <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
            <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success e1<span style="color: #B380A8;">}</span>
             <span style="color: #696969;">(</span>unify/data-list dl1 dl2 <span style="color: #696969;">(</span>unify/arrow a1 a2 e1<span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span>
         <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">about arrow-list</span>
         <span style="color: #797979;">[</span><span style="color: #B380A8;">{{</span>'tody/arrow-list al1<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'tody/arrow-list al2<span style="color: #B380A8;">}}</span>
          <span style="color: #696969;">(</span>unify/data-list
           dl1 dl2
           <span style="color: #696969;">(</span>unify/lambda <span style="color: #B380A8;">{</span>a1 al1<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>a2 al2<span style="color: #B380A8;">}</span> e<span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org7dc3982" class="outline-4">
<h4 id="org7dc3982">unify/trunk/semantic</h4>
<div class="outline-text-4" id="text-org7dc3982">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">unify/trunk/semantic</span> t1 t2 e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> trunk trunk env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> report<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #B380A8;">{</span>t1 t2<span style="color: #B380A8;">}</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{{</span>a1 tody1 dl1 i1<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>a2 tody2 dl2 i2<span style="color: #B380A8;">}}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #B380A8;">{</span>tody1 tody2<span style="color: #B380A8;">}</span>
       <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">about name</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{{</span>'tody/name n<span style="color: #B380A8;">}</span> __<span style="color: #B380A8;">}</span>
        <span style="color: #696969;">(</span>unify/trunk/semantic <span style="color: #696969;">(</span>trunk-&gt;trunk* t1 e<span style="color: #696969;">)</span> t2 e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>__ <span style="color: #B380A8;">{</span>'tody/name n<span style="color: #B380A8;">}}</span>
        <span style="color: #696969;">(</span>unify/trunk/semantic t1 <span style="color: #696969;">(</span>trunk-&gt;trunk* t2 e<span style="color: #696969;">)</span> e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
       <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">about var</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{{</span>'tody/var v<span style="color: #B380A8;">}</span> __<span style="color: #B380A8;">}</span>
        <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>compute/var v e<span style="color: #696969;">)</span>
          <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
          <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>d . __<span style="color: #696969;">)</span> __ __<span style="color: #B380A8;">}}</span>
           <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> d
             <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'arrow a<span style="color: #B380A8;">}</span>
              <span style="color: #696969;">(</span>unify/trunk/semantic
               <span style="color: #B380A8;">{</span>a1 <span style="color: #B380A8;">{</span>'tody/arrow-list <span style="color: #B380A8;">{</span>a<span style="color: #B380A8;">}}</span> dl1 i1<span style="color: #B380A8;">}</span> t2 e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
             <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'lambda <span style="color: #B380A8;">{</span>a al<span style="color: #B380A8;">}}</span>
              <span style="color: #696969;">(</span>unify/trunk/semantic
               <span style="color: #B380A8;">{</span>a1 <span style="color: #B380A8;">{</span>'tody/arrow-list al<span style="color: #B380A8;">}</span> dl1 i1<span style="color: #B380A8;">}</span> t2 e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
             <span style="color: #797979;">[</span>__
              <span style="color: #B380A8;">{</span>'fail <span style="color: #B380A8;">{</span>`<span style="color: #696969;">(</span>unify/trunk/semantic
                        a var computes to neither arrow nor lambda
                        <span style="color: #696969;">(</span>var: ,v<span style="color: #696969;">))</span><span style="color: #B380A8;">}}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>__ <span style="color: #B380A8;">{</span>'tody/var v<span style="color: #B380A8;">}}</span>
        <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>compute/var v e<span style="color: #696969;">)</span>
          <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
          <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>d . __<span style="color: #696969;">)</span> __ __<span style="color: #B380A8;">}}</span>
           <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> d
             <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'arrow a<span style="color: #B380A8;">}</span>
              <span style="color: #696969;">(</span>unify/trunk/semantic
               t1 <span style="color: #B380A8;">{</span>a2 <span style="color: #B380A8;">{</span>'tody/arrow-list <span style="color: #B380A8;">{</span>a<span style="color: #B380A8;">}}</span> dl2 i2<span style="color: #B380A8;">}</span> e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
             <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'lambda <span style="color: #B380A8;">{</span>a al<span style="color: #B380A8;">}}</span>
              <span style="color: #696969;">(</span>unify/trunk/semantic
               t1 <span style="color: #B380A8;">{</span>a2 <span style="color: #B380A8;">{</span>'tody/arrow-list al<span style="color: #B380A8;">}</span> dl2 i2<span style="color: #B380A8;">}</span> e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
             <span style="color: #797979;">[</span>__
              <span style="color: #B380A8;">{</span>'fail <span style="color: #B380A8;">{</span>`<span style="color: #696969;">(</span>unify/trunk/semantic
                        a var computes to neither arrow nor lambda
                        <span style="color: #696969;">(</span>var: ,v<span style="color: #696969;">))</span><span style="color: #B380A8;">}}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span>
       <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">about arrow-list</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{{</span>'tody/arrow-list al1<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'tody/arrow-list al2<span style="color: #B380A8;">}}</span>
        <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">recur to unify/data</span>
        <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">only when at least one of the trunk is reducible</span>
        <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">and if the arguments of this recur are both trunk</span>
        <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">one of them may still be reducible</span>
        <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">thus will get in to this branch again</span>
        <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>filter-arrow-list al1 dl1 e<span style="color: #696969;">)</span>
                <span style="color: #696969;">(</span>filter-arrow-list al2 dl2 e<span style="color: #696969;">)</span><span style="color: #B380A8;">}</span>
          <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>l1 l2<span style="color: #B380A8;">}</span>
           <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> <span style="color: #696969;">(</span>not <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">or</span> <span style="color: #696969;">(</span>eq? 1 <span style="color: #696969;">(</span>length l1<span style="color: #696969;">))</span> <span style="color: #696969;">(</span>eq? 1 <span style="color: #696969;">(</span>length l2<span style="color: #696969;">))))</span>
             <span style="color: #B380A8;">{</span>'fail <span style="color: #B380A8;">{</span>`<span style="color: #696969;">(</span>unify/trunk/semantic
                       fail both trunks are non-reducible
                       <span style="color: #696969;">(</span>trunk1: ,t1<span style="color: #696969;">)</span>
                       <span style="color: #696969;">(</span>trunk2: ,t2<span style="color: #696969;">))</span><span style="color: #B380A8;">}}</span>
             <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>compute/trunk t1 e<span style="color: #696969;">)</span>
                     <span style="color: #696969;">(</span>compute/trunk t2 e<span style="color: #696969;">)</span><span style="color: #B380A8;">}</span>
               <span style="color: #797979;">[</span><span style="color: #B380A8;">{{</span>'success <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>d1 . __<span style="color: #696969;">)</span> __ __<span style="color: #B380A8;">}}</span>
                 <span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>d2 . __<span style="color: #696969;">)</span> __ __<span style="color: #B380A8;">}}}</span>
                <span style="color: #696969;">(</span>unify/data d1 d2 e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
               <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>__ __<span style="color: #B380A8;">}</span>
                <span style="color: #B380A8;">{</span>'fail <span style="color: #B380A8;">{</span>`<span style="color: #696969;">(</span>unify/trunk/semantic
                          fail to compute/trunk one of the trunks
                          <span style="color: #696969;">(</span>trunk1: ,t1<span style="color: #696969;">)</span>
                          <span style="color: #696969;">(</span>trunk2: ,t2<span style="color: #696969;">))</span><span style="color: #B380A8;">}}</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org23c7776" class="outline-3">
<h3 id="org23c7776">unify/trunk/data</h3>
<div class="outline-text-3" id="text-org23c7776">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">unify/trunk/data</span> t d e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> trunk data env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> report<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>compute/trunk t e<span style="color: #696969;">)</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span>
     <span style="color: #B380A8;">{</span>'fail <span style="color: #696969;">(</span>cons `<span style="color: #696969;">(</span>unify/trunk/data
                    <span style="color: #696969;">(</span>trunk: ,t<span style="color: #696969;">)</span>
                    <span style="color: #696969;">(</span>data: ,d<span style="color: #696969;">))</span>
                  il<span style="color: #696969;">)</span><span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success e1<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>env/pop e1<span style="color: #696969;">)</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{{</span>'trunk t1<span style="color: #B380A8;">}</span> e2<span style="color: #B380A8;">}</span>
        <span style="color: #B380A8;">{</span>'fail <span style="color: #B380A8;">{</span>`<span style="color: #696969;">(</span>unify/trunk/data
                  <span style="color: #696969;">(</span>trunk: ,t<span style="color: #696969;">)</span>
                  compute to
                  <span style="color: #696969;">(</span>trunk: ,t1<span style="color: #696969;">))</span><span style="color: #B380A8;">}}</span><span style="color: #797979;">]</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>d1 e2<span style="color: #B380A8;">}</span>
        <span style="color: #696969;">(</span>unify/data d1 d e2<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org4dc6f2c" class="outline-2">
<h2 id="org4dc6f2c">eva</h2>
<div class="outline-text-2" id="text-org4dc6f2c">
</div><div id="outline-container-orgd1c0abd" class="outline-3">
<h3 id="orgd1c0abd">init-env</h3>
<div class="outline-text-3" id="text-orgd1c0abd">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #a6e22e;">init-env</span>
  '<span style="color: #696969;">(()</span>
    <span style="color: #696969;">()</span>
    <span style="color: #696969;">((</span><span style="color: #f92672; font-weight: bold;">type</span> . <span style="color: #696969;">(</span>cons/type <span style="color: #696969;">((()</span>
                          <span style="color: #696969;">(</span>cons <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">type</span> <span style="color: #696969;">())))</span>
                         type
                         type<span style="color: #696969;">))))))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org44cce8a" class="outline-3">
<h3 id="org44cce8a">eva</h3>
<div class="outline-text-3" id="text-org44cce8a">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define-syntax</span> <span style="color: #fd971f;">eva</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">syntax-rules</span> <span style="color: #696969;">()</span>
    <span style="color: #797979;">[</span><span style="color: #696969;">(</span>eva e ...<span style="color: #696969;">)</span>
     <span style="color: #696969;">(</span>eva/top-list <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">map</span> parse/top <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">quote</span> <span style="color: #696969;">(</span>e ...<span style="color: #696969;">)))</span> init-env<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd0e9d9b" class="outline-3">
<h3 id="orgd0e9d9b">eva/top-list</h3>
<div class="outline-text-3" id="text-orgd0e9d9b">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">eva/top-list</span> tl e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> <span style="color: #696969;">(</span>top ...<span style="color: #696969;">)</span> env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> env<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> tl
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{}</span> e<span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #696969;">(</span>t . r<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>eva/top-list r <span style="color: #696969;">(</span>eva/top t e<span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org9150dd7" class="outline-3">
<h3 id="org9150dd7">parse/top</h3>
<div class="outline-text-3" id="text-org9150dd7">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">parse/top</span> s<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> sexp-top <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> top<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> s
    <span style="color: #797979;">[</span><span style="color: #696969;">(</span>'deftype n a . body<span style="color: #696969;">)</span>
     <span style="color: #B380A8;">{</span>'deftype <span style="color: #B380A8;">{{</span>n a<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>parse/top/deftype-body body<span style="color: #696969;">)</span><span style="color: #B380A8;">}}</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #696969;">(</span>'defn n a . al<span style="color: #696969;">)</span>
     <span style="color: #B380A8;">{</span>'defn <span style="color: #B380A8;">{{</span>n a<span style="color: #B380A8;">}</span> al<span style="color: #B380A8;">}}</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'app a<span style="color: #B380A8;">}</span>
     <span style="color: #B380A8;">{</span>'app a<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org3c8fa2b" class="outline-3">
<h3 id="org3c8fa2b">parse/top/deftype-body</h3>
<div class="outline-text-3" id="text-org3c8fa2b">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">parse/top/deftype-body</span> body<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> deftype-body <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #696969;">((</span>form1/name form1/arrow<span style="color: #696969;">)</span> ...<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">cond</span> <span style="color: #797979;">[</span><span style="color: #696969;">(</span>eq? '<span style="color: #696969;">()</span> body<span style="color: #696969;">)</span> '<span style="color: #696969;">()</span><span style="color: #797979;">]</span>
        <span style="color: #797979;">[</span><span style="color: #696969;">(</span>eq? '<span style="color: #696969;">()</span> <span style="color: #696969;">(</span>cdr body<span style="color: #696969;">))</span>
         <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">orz</span> 'parse/top/deftype-body <span style="color: #696969;">(</span><span style="color: #e6db74;">"wrong body : ~a~%"</span> body<span style="color: #696969;">))</span><span style="color: #797979;">]</span>
        <span style="color: #797979;">[</span>else
         <span style="color: #696969;">(</span>cons <span style="color: #696969;">(</span>list <span style="color: #696969;">(</span>car body<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>cadr body<span style="color: #696969;">))</span>
               <span style="color: #696969;">(</span>parse/top/deftype-body <span style="color: #696969;">(</span>cddr body<span style="color: #696969;">)))</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org40ead6e" class="outline-3">
<h3 id="org40ead6e">eva/top</h3>
<div class="outline-text-3" id="text-org40ead6e">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">eva/top</span> t e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> top env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> env<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> t
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'deftype deftype<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>eva/deftype deftype e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'defn defn<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>eva/defn defn e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'app a<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>eva/app a e<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org84cb112" class="outline-3">
<h3 id="org84cb112">form1/arrow-&gt;arrow</h3>
<div class="outline-text-3" id="text-org84cb112">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">form1/arrow-&gt;arrow</span> a e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> form1/arrow env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> arrow<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>pass2/arrow <span style="color: #696969;">(</span>pass1/arrow 0 a<span style="color: #696969;">)</span> <span style="color: #B380A8;">{}</span><span style="color: #696969;">)</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>a1 s<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>pass3/get-arrow a1 e<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org7b8dcc" class="outline-3">
<h3 id="org7b8dcc">form1/arrow-&gt;arrow-check</h3>
<div class="outline-text-3" id="text-org7b8dcc">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">form1/arrow-&gt;arrow-check</span> ta a e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> form1/arrow env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> arrow<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>pass2/arrow <span style="color: #696969;">(</span>pass1/arrow 0 a<span style="color: #696969;">)</span> <span style="color: #B380A8;">{}</span><span style="color: #696969;">)</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>a1 s<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>pass3/get-arrow-check ta a1 e<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org60e4a0c" class="outline-3">
<h3 id="org60e4a0c">eva/app</h3>
<div class="outline-text-3" id="text-org60e4a0c">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">eva/app</span> a e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> form1/arrow env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> env<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>a0 <span style="color: #696969;">(</span>form1/arrow-&gt;arrow a e<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
    <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>compute/arrow a0 e<span style="color: #696969;">)</span>
      <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success e1<span style="color: #B380A8;">}</span> e1<span style="color: #797979;">]</span>
      <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span>
       <span style="color: #696969;">(</span>cat <span style="color: #696969;">(</span><span style="color: #e6db74;">"eva/app fail~%"</span><span style="color: #696969;">))</span>
       <span style="color: #696969;">(</span>pretty-print il<span style="color: #696969;">)</span>
       <span style="color: #696969;">(</span>cat <span style="color: #696969;">(</span><span style="color: #e6db74;">"~%"</span><span style="color: #696969;">))</span>
       <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">orz</span> 'eva/ap <span style="color: #696969;">(</span><span style="color: #e6db74;">"end of report~%"</span><span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">)))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf6f18e9" class="outline-3">
<h3 id="orgf6f18e9">eva/deftype</h3>
<div class="outline-text-3" id="text-orgf6f18e9">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">eva/deftype</span> deftype e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> <span style="color: #696969;">((</span>form1/name form1/arrow<span style="color: #696969;">)</span> <span style="color: #696969;">((</span>form1/name form1/arrow<span style="color: #696969;">)</span> ...<span style="color: #696969;">))</span> env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> env<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> deftype
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{{</span>n a<span style="color: #B380A8;">}</span> nal<span style="color: #B380A8;">}</span>
        <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let*</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>nl <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">map</span> car nal<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
               <span style="color: #797979;">[</span>a0 <span style="color: #696969;">(</span>form1/arrow-&gt;arrow a e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
               <span style="color: #797979;">[</span>ns1 <span style="color: #696969;">(</span>cons <span style="color: #696969;">(</span>cons n
                                <span style="color: #B380A8;">{</span>'cons/type <span style="color: #B380A8;">{</span>a0 n nl<span style="color: #B380A8;">}}</span><span style="color: #696969;">)</span>
                          ns<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
          <span style="color: #696969;">(</span>eva/deftype/data-constructor-list n nal <span style="color: #B380A8;">{</span>ds bs ns1<span style="color: #B380A8;">}</span><span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>

<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">eva/deftype/data-constructor</span> type-name na e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> name <span style="color: #696969;">(</span>form1/name form1/arrow<span style="color: #696969;">)</span> env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> env<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> na
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>n a<span style="color: #B380A8;">}</span>
        <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>a0 <span style="color: #696969;">(</span>form1/arrow-&gt;arrow a e<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
          <span style="color: #B380A8;">{</span>ds
           bs
           <span style="color: #696969;">(</span>cons <span style="color: #696969;">(</span>cons n <span style="color: #B380A8;">{</span>'cons/data <span style="color: #B380A8;">{</span>a0 n type-name<span style="color: #B380A8;">}}</span><span style="color: #696969;">)</span>
                 ns<span style="color: #696969;">)</span><span style="color: #B380A8;">}</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>

<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">eva/deftype/data-constructor-list</span> type-name nal e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> name <span style="color: #696969;">((</span>form1/name form1/arrow<span style="color: #696969;">)</span> ...<span style="color: #696969;">)</span> env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> env<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> nal
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{}</span> e<span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #696969;">(</span>na . r<span style="color: #696969;">)</span>
     <span style="color: #696969;">(</span>eva/deftype/data-constructor-list
      type-name r
      <span style="color: #696969;">(</span>eva/deftype/data-constructor type-name na e<span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbe84b60" class="outline-3">
<h3 id="orgbe84b60">cover-check? &amp; cover-check- &amp; cover-check+</h3>
<div class="outline-text-3" id="text-orgbe84b60">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #a6e22e;">cover-check?</span> #t<span style="color: #696969;">)</span>
<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">cover-check-</span><span style="color: #696969;">)</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">set!</span> cover-check? #f<span style="color: #696969;">)</span> #f<span style="color: #696969;">)</span>
<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">cover-check+</span><span style="color: #696969;">)</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">set!</span> cover-check? #t<span style="color: #696969;">)</span> #t<span style="color: #696969;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org97af248" class="outline-3">
<h3 id="org97af248">recur-check? &amp; recur-check- &amp; recur-check+</h3>
<div class="outline-text-3" id="text-org97af248">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #a6e22e;">recur-check?</span> #t<span style="color: #696969;">)</span>
<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">recur-check-</span><span style="color: #696969;">)</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">set!</span> recur-check? #f<span style="color: #696969;">)</span> #f<span style="color: #696969;">)</span>
<span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">recur-check+</span><span style="color: #696969;">)</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">set!</span> recur-check? #t<span style="color: #696969;">)</span> #t<span style="color: #696969;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org59a4f3" class="outline-3">
<h3 id="org59a4f3">eva/defn</h3>
<div class="outline-text-3" id="text-org59a4f3">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">eva/defn</span> defn e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> <span style="color: #696969;">((</span>form1/name form1/arrow<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>form1/arrow ...<span style="color: #696969;">))</span> env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> env<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> defn
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{{</span>n a<span style="color: #B380A8;">}</span> al<span style="color: #B380A8;">}</span>
        <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let*</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>a0 <span style="color: #696969;">(</span>form1/arrow-&gt;arrow a e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
               <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">need to put the type into ns first</span>
               <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">for recursive call in arrow-list</span>
               <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">that is</span>
               <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">in ns</span>
               <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">type global-bindings and arrow-list global-bindings</span>
               <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">must be separately interfaced</span>
               <span style="color: #797979;">[</span>ns0 <span style="color: #696969;">(</span>cons <span style="color: #696969;">(</span>cons n <span style="color: #B380A8;">{</span>'lambda <span style="color: #B380A8;">{</span>a0 'placeholder<span style="color: #B380A8;">}}</span><span style="color: #696969;">)</span> ns<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
               <span style="color: #797979;">[</span>l1 <span style="color: #B380A8;">{</span>a0 <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">map</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">lambda</span> <span style="color: #696969;">(</span>x<span style="color: #696969;">)</span>
                              <span style="color: #696969;">(</span>form1/arrow-&gt;arrow-check
                               a0 x <span style="color: #B380A8;">{</span>ds bs ns0<span style="color: #B380A8;">}</span><span style="color: #696969;">))</span>
                         al<span style="color: #696969;">)</span><span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
               <span style="color: #797979;">[</span>ns1 <span style="color: #696969;">(</span>cons <span style="color: #696969;">(</span>cons n <span style="color: #B380A8;">{</span>'lambda l1<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span> ns<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
               <span style="color: #797979;">[</span>e1 <span style="color: #B380A8;">{</span>ds bs ns1<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
          <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> cover-check?
            <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>cover-check l1 e1<span style="color: #696969;">)</span>
              <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">orz</span> 'eva/defn
                            <span style="color: #696969;">(</span><span style="color: #e6db74;">"info-list :~%~a~%"</span> il<span style="color: #696969;">))</span><span style="color: #797979;">]</span>
              <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success __<span style="color: #B380A8;">}</span> 'ok<span style="color: #797979;">]</span><span style="color: #696969;">))</span>
          <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> recur-check?
            <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>recur-check n l1 e1<span style="color: #696969;">)</span>
              <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">orz</span> 'eva/defn
                            <span style="color: #696969;">(</span><span style="color: #e6db74;">"info-list :~%~a~%"</span> il<span style="color: #696969;">))</span><span style="color: #797979;">]</span>
              <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success __<span style="color: #B380A8;">}</span> 'ok<span style="color: #797979;">]</span><span style="color: #696969;">))</span>
          e1<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org87014c4" class="outline-2">
<h2 id="org87014c4">sequent</h2>
<div class="outline-text-2" id="text-org87014c4">
</div><div id="outline-container-orgb619f60" class="outline-3">
<h3 id="orgb619f60">sequent</h3>
<div class="outline-text-3" id="text-orgb619f60">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">sequent</span><span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #797979;">[</span>loop<span style="color: #797979;">]</span><span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span>cat <span style="color: #696969;">(</span><span style="color: #e6db74;">"welcome to sequent ^-^/~%"</span><span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span>sequent/repl init-env<span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org3441a3a" class="outline-3">
<h3 id="org3441a3a"><span class="todo _gt__lt_">&gt;&lt;</span> sequent/repl</h3>
<div class="outline-text-3" id="text-org3441a3a">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">sequent/repl</span> e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #797979;">[</span>loop<span style="color: #797979;">]</span><span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let*</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>top <span style="color: #696969;">(</span>read<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
         <span style="color: #797979;">[</span>e1 <span style="color: #696969;">(</span>eva/top <span style="color: #696969;">(</span>parse/top top<span style="color: #696969;">)</span> e<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
    <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e1
      <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds1 bs1 ns1<span style="color: #B380A8;">}</span>
       <span style="color: #696969;">(</span>print/data-list ds1 e1<span style="color: #696969;">)</span>
       <span style="color: #696969;">(</span>newline<span style="color: #696969;">)</span>
       <span style="color: #696969;">(</span>sequent/repl e1<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)))</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orge4a41c1" class="outline-2">
<h2 id="orge4a41c1">type-compute</h2>
<div class="outline-text-2" id="text-orge4a41c1">
</div><div id="outline-container-org3d7f5d3" class="outline-3">
<h3 id="org3d7f5d3">type-compute/cedent</h3>
<div class="outline-text-3" id="text-org3d7f5d3">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">type-compute/cedent</span> c e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> cedent env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> report<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> c
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{}</span> <span style="color: #B380A8;">{</span>'success e<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #696969;">(</span>d . r<span style="color: #696969;">)</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>type-compute d e<span style="color: #696969;">)</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success e1<span style="color: #B380A8;">}</span>
        <span style="color: #696969;">(</span>type-compute/cedent r e1<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org29030d7" class="outline-3">
<h3 id="org29030d7">type-compute</h3>
<div class="outline-text-3" id="text-org29030d7">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">type-compute</span> d e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> data env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> report<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> d
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'var x<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>type-compute/var x e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'cons x<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>type-compute/cons x e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'arrow x<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>type-compute/arrow x e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'lambda x<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>type-compute/lambda x e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'trunk x<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>type-compute/trunk x e<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org50f72a0" class="outline-3">
<h3 id="org50f72a0">type-compute/var</h3>
<div class="outline-text-3" id="text-org50f72a0">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">type-compute/var</span> v e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> var env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> report<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> v
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>id level<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span>compute/var <span style="color: #B380A8;">{</span>id <span style="color: #696969;">(</span>+ 1 level<span style="color: #696969;">)</span><span style="color: #B380A8;">}</span> e<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orga7f4e47" class="outline-3">
<h3 id="orga7f4e47">type-compute/cons</h3>
<div class="outline-text-3" id="text-orga7f4e47">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">type-compute/cons</span> c e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> cons env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> report<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> c
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>n dl<span style="color: #B380A8;">}</span>
        <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>found <span style="color: #696969;">(</span>assq n ns<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
          <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> <span style="color: #696969;">(</span>not found<span style="color: #696969;">)</span>
            <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">orz</span> 'type-compute/cons
              <span style="color: #696969;">(</span><span style="color: #e6db74;">"unknow name : ~a~%"</span> n<span style="color: #696969;">)</span>
              <span style="color: #696969;">(</span><span style="color: #e6db74;">"cons : ~a~%"</span> c<span style="color: #696969;">))</span>
            <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>meaning <span style="color: #696969;">(</span>cdr found<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
              <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> meaning
                <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>any-type <span style="color: #696969;">(</span>t . __<span style="color: #696969;">)</span><span style="color: #B380A8;">}</span>
                 <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>type-compute/cedent <span style="color: #696969;">(</span>reverse dl<span style="color: #696969;">)</span> e<span style="color: #696969;">)</span>
                   <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
                   <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success e1<span style="color: #B380A8;">}</span>
                    <span style="color: #696969;">(</span>compute/arrow <span style="color: #696969;">(</span>copy-arrow t<span style="color: #696969;">)</span> e1<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))))</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orga06f22e" class="outline-3">
<h3 id="orga06f22e">type-compute/arrow</h3>
<div class="outline-text-3" id="text-orga06f22e">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">type-compute/arrow</span> a e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> arrow env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> report<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>copy-arrow a<span style="color: #696969;">)</span>
       <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">need to copy the arrow first</span>
       <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">because the return arrow might be applied somewhere else</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ac sc<span style="color: #B380A8;">}</span>
        <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>type-compute/cedent ac <span style="color: #B380A8;">{{}</span> <span style="color: #696969;">(</span>cons '<span style="color: #696969;">(</span>commit-point<span style="color: #696969;">)</span> bs<span style="color: #696969;">)</span> ns<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span>
          <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
          <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{</span>ds1 bs1 ns1<span style="color: #B380A8;">}}</span>
           <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>type-compute/cedent sc <span style="color: #B380A8;">{{}</span> bs1 ns1<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span>
             <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
             <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{</span>ds2 bs2 ns2<span style="color: #B380A8;">}}</span>
              <span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>cons <span style="color: #B380A8;">{</span>'arrow <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>reverse ds1<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reverse ds2<span style="color: #696969;">)</span><span style="color: #B380A8;">}}</span>
                               ds<span style="color: #696969;">)</span>
                         <span style="color: #696969;">(</span>bs/commit! bs2<span style="color: #696969;">)</span>
                         ns2<span style="color: #B380A8;">}}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org7b87d93" class="outline-3">
<h3 id="org7b87d93">type-compute/lambda</h3>
<div class="outline-text-3" id="text-org7b87d93">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">type-compute/lambda</span> l e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> lambda env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> report<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> l
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>a al<span style="color: #B380A8;">}</span>
        <span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>cons <span style="color: #B380A8;">{</span>'arrow a<span style="color: #B380A8;">}</span> ds<span style="color: #696969;">)</span>
                   bs
                   ns<span style="color: #B380A8;">}}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orge2a3b6" class="outline-3">
<h3 id="orge2a3b6">type-compute/trunk</h3>
<div class="outline-text-3" id="text-orge2a3b6">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">type-compute/trunk</span> t e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> trunk env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> report<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> t
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>a __ dl i<span style="color: #B380A8;">}</span>
        <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>type-compute/cedent <span style="color: #696969;">(</span>reverse dl<span style="color: #696969;">)</span> <span style="color: #B380A8;">{{}</span> bs ns<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span>
          <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
          <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success e1<span style="color: #B380A8;">}</span>
           <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e1
             <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds1 bs1 ns1<span style="color: #B380A8;">}</span>
              <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>compute/arrow <span style="color: #696969;">(</span>copy-arrow a<span style="color: #696969;">)</span> e1<span style="color: #696969;">)</span>
                <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span>
                <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success e2<span style="color: #B380A8;">}</span>
                 <span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>cons <span style="color: #696969;">(</span>proj i e2<span style="color: #696969;">)</span> ds<span style="color: #696969;">)</span>
                            bs1
                            ns1<span style="color: #B380A8;">}}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org96e7b42" class="outline-2">
<h2 id="org96e7b42">infer</h2>
<div class="outline-text-2" id="text-org96e7b42">
</div><div id="outline-container-org6d98158" class="outline-3">
<h3 id="org6d98158">infer/arrow</h3>
<div class="outline-text-3" id="text-org6d98158">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">infer/arrow</span> a e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> arrow env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> arrow<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>type-compute/arrow a e<span style="color: #696969;">)</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">orz</span> 'infer/arrow
       <span style="color: #696969;">(</span><span style="color: #e6db74;">"fail to type-compute/arrow : ~a~%"</span> a<span style="color: #696969;">)</span>
       <span style="color: #696969;">(</span><span style="color: #e6db74;">"reported info-list : ~a~%"</span> il<span style="color: #696969;">))</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>a1 . __<span style="color: #696969;">)</span> __ __<span style="color: #B380A8;">}}</span>
     a1<span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf717ef3" class="outline-3">
<h3 id="orgf717ef3">infer/arrow-list</h3>
<div class="outline-text-3" id="text-orgf717ef3">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">infer/arrow-list</span> al e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> <span style="color: #696969;">(</span>arrow ...<span style="color: #696969;">)</span> env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> arrow<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span>unite/arrow-list
   <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">map</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">lambda</span> <span style="color: #696969;">(</span>x<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>infer/arrow x e<span style="color: #696969;">))</span> al<span style="color: #696969;">)</span>
   e<span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orge5e9487" class="outline-3">
<h3 id="orge5e9487">unite/arrow-list</h3>
<div class="outline-text-3" id="text-orge5e9487">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">unite/arrow-list</span> al e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> <span style="color: #696969;">(</span>arrow ...<span style="color: #696969;">)</span> env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> arrow<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">letrec</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>recur
            <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">lambda</span> <span style="color: #696969;">(</span>a l<span style="color: #696969;">)</span>
              <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> arrow <span style="color: #696969;">(</span>arrow ...<span style="color: #696969;">)</span> <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> arrow<span style="color: #696969;">)</span>
              <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> l
                <span style="color: #797979;">[</span><span style="color: #B380A8;">{}</span> a<span style="color: #797979;">]</span>
                <span style="color: #797979;">[</span><span style="color: #696969;">(</span>h . r<span style="color: #696969;">)</span>
                 <span style="color: #696969;">(</span>recur <span style="color: #696969;">(</span>unite/two a h e<span style="color: #696969;">)</span> r<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
    <span style="color: #696969;">(</span>recur <span style="color: #696969;">(</span>car al<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>cdr al<span style="color: #696969;">))))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd1e42c" class="outline-3">
<h3 id="orgd1e42c">unite/two</h3>
<div class="outline-text-3" id="text-orgd1e42c">
<ul class="org-ul">
<li><p>this is the meet operation of the subsumption lattice of arrow</p></li></ul>

<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">unite/two</span> a1 a2 e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> arrow arrow env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> arrow<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #B380A8;">{</span>a1 a2<span style="color: #B380A8;">}</span>
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{{</span>ac1 sc1<span style="color: #B380A8;">}</span> <span style="color: #B380A8;">{</span>ac2 sc2<span style="color: #B380A8;">}}</span>
        <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>ac1 <span style="color: #696969;">(</span>copy-arrow ac1<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
              <span style="color: #797979;">[</span>sc1 <span style="color: #696969;">(</span>copy-arrow sc1<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
              <span style="color: #797979;">[</span>ac2 <span style="color: #696969;">(</span>copy-arrow ac2<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
              <span style="color: #797979;">[</span>sc2 <span style="color: #696969;">(</span>copy-arrow sc2<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
          <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>unify/data-list
                  ac1 ac2
                  <span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{{}</span> <span style="color: #696969;">(</span>cons '<span style="color: #696969;">(</span>commit-point<span style="color: #696969;">)</span> bs<span style="color: #696969;">)</span> ns<span style="color: #B380A8;">}}</span><span style="color: #696969;">)</span>
            <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">orz</span> 'unite/two
                          <span style="color: #696969;">(</span><span style="color: #e6db74;">"fail to unify antecedent~%"</span><span style="color: #696969;">)</span>
                          <span style="color: #696969;">(</span><span style="color: #e6db74;">"ac1 : ~a~%"</span> ac1<span style="color: #696969;">)</span>
                          <span style="color: #696969;">(</span><span style="color: #e6db74;">"ac2 : ~a~%"</span> ac2<span style="color: #696969;">))</span><span style="color: #797979;">]</span>
            <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{</span>__ bs1 ns1<span style="color: #B380A8;">}}</span>
             <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>unify/data-list
                     sc1 sc2
                     <span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{{}</span> bs1 ns1<span style="color: #B380A8;">}}</span><span style="color: #696969;">)</span>
               <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail il<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">orz</span> 'unite/two
                             <span style="color: #696969;">(</span><span style="color: #e6db74;">"fail to unify succedent~%"</span><span style="color: #696969;">)</span>
                             <span style="color: #696969;">(</span><span style="color: #e6db74;">"sc1 : ~a~%"</span> sc1<span style="color: #696969;">)</span>
                             <span style="color: #696969;">(</span><span style="color: #e6db74;">"sc2 : ~a~%"</span> sc2<span style="color: #696969;">))</span><span style="color: #797979;">]</span>
               <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success <span style="color: #B380A8;">{</span>ds2 bs2 ns2<span style="color: #B380A8;">}}</span>
                <span style="color: #696969;">(</span>bs/commit! bs2<span style="color: #696969;">)</span>
                <span style="color: #B380A8;">{</span>ac1 sc1<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orge42de58" class="outline-2">
<h2 id="orge42de58">cover-check</h2>
<div class="outline-text-2" id="text-orge42de58">
</div><div id="outline-container-org1766446" class="outline-3">
<h3 id="org1766446">cover-check</h3>
<div class="outline-text-3" id="text-org1766446">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">cover-check</span> l e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> lambda env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> report<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> l
       <span style="color: #797979;">[</span><span style="color: #B380A8;">{{</span>ac __<span style="color: #B380A8;">}</span> al<span style="color: #B380A8;">}</span>
        <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> <span style="color: #696969;">(</span>data-gen ac <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">map</span> car al<span style="color: #696969;">)</span> e<span style="color: #696969;">)</span>
          <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>c bsl<span style="color: #B380A8;">}</span>
           <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">let</span> <span style="color: #696969;">(</span><span style="color: #797979;">[</span>report-list
                  <span style="color: #696969;">(</span>filter
                   <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">lambda</span> <span style="color: #696969;">(</span>r<span style="color: #696969;">)</span>
                     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> r
                       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'fail __<span style="color: #B380A8;">}</span> #t<span style="color: #797979;">]</span>
                       <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'success __<span style="color: #B380A8;">}</span> #f<span style="color: #797979;">]</span><span style="color: #696969;">))</span>
                   <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">map</span> <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">lambda</span> <span style="color: #696969;">(</span>bs0<span style="color: #696969;">)</span>
                          <span style="color: #696969;">(</span>cover-check/cedent
                           c al
                           <span style="color: #B380A8;">{</span>ds <span style="color: #696969;">(</span>append bs0 bs<span style="color: #696969;">)</span> ns<span style="color: #B380A8;">}</span><span style="color: #696969;">))</span>
                     bsl<span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span>
             <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> <span style="color: #696969;">(</span>null? report-list<span style="color: #696969;">)</span>
               <span style="color: #B380A8;">{</span>'success e<span style="color: #B380A8;">}</span>
               <span style="color: #B380A8;">{</span>'fail
                <span style="color: #B380A8;">{</span>`<span style="color: #696969;">(</span>cover-check
                   fail
                   <span style="color: #696969;">(</span>report-list: ,report-list:<span style="color: #696969;">))</span><span style="color: #B380A8;">}}</span><span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org338c7aa" class="outline-3">
<h3 id="org338c7aa"><span class="todo _gt__lt_">&gt;&lt;</span> cover-check/cedent</h3>
<div class="outline-text-3" id="text-org338c7aa">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">cover-check/cedent</span> c al e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> cedent <span style="color: #696969;">(</span>arrow ...<span style="color: #696969;">)</span> env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> report<span style="color: #696969;">)</span>
  <span style="color: #696969;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org1271f98" class="outline-3">
<h3 id="org1271f98"><span class="todo _gt__lt_">&gt;&lt;</span> </h3>
<div class="outline-text-3" id="text-org1271f98">
<div class="org-src-container">

<pre class="src src-scheme"></pre>
</div>
</div>
</div>

<div id="outline-container-org73d83be" class="outline-3">
<h3 id="org73d83be"><span class="todo note">note</span> alterdata</h3>
<div class="outline-text-3" id="text-org73d83be">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">type</span> alterdata
  <span style="color: #B380A8;">{</span>'altervar <span style="color: #696969;">(</span>var . <span style="color: #B380A8;">{</span>alterdata ...<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span><span style="color: #B380A8;">}</span>
  <span style="color: #B380A8;">{</span>'cons   <span style="color: #B380A8;">{</span>name <span style="color: #B380A8;">{</span>data ...<span style="color: #B380A8;">}}}</span>
  <span style="color: #B380A8;">{</span>'arrow  <span style="color: #B380A8;">{</span>cedent cedent<span style="color: #B380A8;">}}</span>
  <span style="color: #B380A8;">{</span>'lambda <span style="color: #B380A8;">{</span>arrow <span style="color: #B380A8;">{</span>arrow ...<span style="color: #B380A8;">}}}</span>
  <span style="color: #B380A8;">{</span>'trunk  <span style="color: #B380A8;">{</span>arrow tody <span style="color: #B380A8;">{</span>data ...<span style="color: #B380A8;">}</span> index<span style="color: #B380A8;">}}</span><span style="color: #696969;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org4e362bb" class="outline-3">
<h3 id="org4e362bb">data-gen</h3>
<div class="outline-text-3" id="text-org4e362bb">
<ul class="org-ul">
<li><p>this can be viewed as the reverse of infer</p><p>it generate data from type</p></li></ul>

<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">data-gen</span> ac acl e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> antecedent <span style="color: #696969;">(</span>antecedent ...<span style="color: #696969;">)</span> env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #696969;">(</span>cedent <span style="color: #696969;">(</span>bs ...<span style="color: #696969;">)))</span>
  <span style="color: #696969;">(</span>alter-expand <span style="color: #696969;">(</span>data-gen/cedent ac acl e<span style="color: #696969;">)))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org29881d3" class="outline-3">
<h3 id="org29881d3"><span class="todo _gt__lt_">&gt;&lt;</span> alter-expand</h3>
<div class="outline-text-3" id="text-org29881d3">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">alter-expand</span> alterdata-list<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> <span style="color: #696969;">(</span>alterdata ...<span style="color: #696969;">)</span> <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #696969;">((</span>data ...<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>bs ...<span style="color: #696969;">)))</span>
  <span style="color: #696969;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb0d7e4d" class="outline-3">
<h3 id="orgb0d7e4d">data-gen/cedent</h3>
<div class="outline-text-3" id="text-orgb0d7e4d">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">data-gen/cedent</span> c cl e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> cedent <span style="color: #696969;">(</span>cedent ...<span style="color: #696969;">)</span> env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> <span style="color: #696969;">(</span>alterdata ...<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> c
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{}</span> <span style="color: #B380A8;">{}</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #696969;">(</span>h . r<span style="color: #696969;">)</span>
     <span style="color: #696969;">(</span>cons <span style="color: #696969;">(</span>data-gen/data h <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">map</span> car cl<span style="color: #696969;">)</span> e<span style="color: #696969;">)</span>
           <span style="color: #696969;">(</span>data-gen/cedent r <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">map</span> cdr cl<span style="color: #696969;">)</span> e<span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org87bfc24" class="outline-3">
<h3 id="org87bfc24">data-gen/data</h3>
<div class="outline-text-3" id="text-org87bfc24">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">data-gen/data</span> d dl e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> data <span style="color: #696969;">(</span>data ...<span style="color: #696969;">)</span> env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> alterdata<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> d
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'var x<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>data-gen/var x dl e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'cons x<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>data-gen/cons x dl e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'arrow x<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>data-gen/arrow x dl e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'lambda x<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>data-gen/lambda x dl e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'trunk x<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>data-gen/trunk x dl e<span style="color: #696969;">)</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orga4aaf63" class="outline-3">
<h3 id="orga4aaf63"><span class="todo _gt__lt_">&gt;&lt;</span> data-gen/cons</h3>
<div class="outline-text-3" id="text-orga4aaf63">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">data-gen/cons</span> c dl e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> cons <span style="color: #696969;">(</span>data ...<span style="color: #696969;">)</span> env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> alterdata<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> c
    <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">c must be a type constructor</span>
    <span style="color: #FF8888;">;; </span><span style="color: #FF8888;">c must not be a data constructor</span>
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>n dl0<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> <span style="color: #696969;">(</span>list-any? <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">lambda</span> <span style="color: #696969;">(</span>x<span style="color: #696969;">)</span>
                      <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> x
                        <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>'var v<span style="color: #B380A8;">}</span> <span style="color: #696969;">(</span>var/fresh? v e<span style="color: #696969;">)</span><span style="color: #797979;">]</span>
                        <span style="color: #797979;">[</span>__ #f<span style="color: #797979;">]</span><span style="color: #696969;">))</span>
                    dl<span style="color: #696969;">)</span>
       <span style="color: #B380A8;">{</span>'altervar <span style="color: #696969;">(</span>cons <span style="color: #696969;">(</span>id/new <span style="color: #696969;">(</span>symbol-append n '<span style="color: #a6e22e;">:gen</span><span style="color: #696969;">)</span>
                                <span style="color: #B380A8;">{</span><span style="color: #696969;">(</span>cons 1 <span style="color: #B380A8;">{</span>'cons c<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span><span style="color: #B380A8;">}</span><span style="color: #696969;">)</span>
                        '<span style="color: #696969;">())</span><span style="color: #B380A8;">}</span>
       '<span style="color: #696969;">(</span>&gt;&lt; return an altervar

           whoes type is bind to the cons as type
           whoes alterdata-list is not empty

           the alterdata-list is generate by recursive call to data-gen/data

           from the type constructor c
           we get a list of data constructor

           each must be covered by the dl

           for each that is covered by the dl
           the antecedent of the type arrow of the data constructor
           is used to do a recursive call to data-gen/data<span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org3d9cfea" class="outline-3">
<h3 id="org3d9cfea"><span class="todo _gt__lt_">&gt;&lt;</span> data-gen/var</h3>
<div class="outline-text-3" id="text-org3d9cfea">
<ul class="org-ul">
<li><p>suppose we meet a var whose type is not bound</p></li>

<li><p>suppose we meet a var whose type is bound</p></li></ul>

<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">data-gen/var</span> v dl e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> var <span style="color: #696969;">(</span>data ...<span style="color: #696969;">)</span> env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> alterdata<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span>
     <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">if</span> <span style="color: #696969;">(</span>not <span style="color: #696969;">(</span>var/fresh? v e<span style="color: #696969;">))</span>
       <span style="color: #696969;">(</span>data-gen/data <span style="color: #696969;">(</span>bs/deep bs <span style="color: #B380A8;">{</span>'var v<span style="color: #B380A8;">}</span><span style="color: #696969;">)</span> dl e<span style="color: #696969;">)</span>
       '<span style="color: #696969;">(</span>&gt;&lt;&gt;&lt;&gt;&lt;<span style="color: #696969;">))</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf9da6a" class="outline-3">
<h3 id="orgf9da6a"><span class="todo _gt__lt_">&gt;&lt;</span> data-gen/arrow</h3>
<div class="outline-text-3" id="text-orgf9da6a">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">data-gen/arrow</span> a dl e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> arrow <span style="color: #696969;">(</span>data ...<span style="color: #696969;">)</span> env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> alterdata<span style="color: #696969;">)</span>
  <span style="color: #696969;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb65a78d" class="outline-3">
<h3 id="orgb65a78d"><span class="todo _gt__lt_">&gt;&lt;</span> data-gen/trunk</h3>
<div class="outline-text-3" id="text-orgb65a78d">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">data-gen/trunk</span> l dl e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> trunk <span style="color: #696969;">(</span>data ...<span style="color: #696969;">)</span> env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> alterdata<span style="color: #696969;">)</span>
  <span style="color: #696969;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org39ff141" class="outline-3">
<h3 id="org39ff141">data-gen/lambda</h3>
<div class="outline-text-3" id="text-org39ff141">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">data-gen/lambda</span> l dl e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> lambda <span style="color: #696969;">(</span>data ...<span style="color: #696969;">)</span> env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> alterdata<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">orz</span> 'data-gen/lambda
    <span style="color: #696969;">(</span><span style="color: #e6db74;">"can not generate data from lambda~%"</span><span style="color: #696969;">)</span>
    <span style="color: #696969;">(</span><span style="color: #e6db74;">"l : ~a~%"</span> l<span style="color: #696969;">)</span>
    <span style="color: #696969;">(</span><span style="color: #e6db74;">"dl : ~a~%"</span> dl<span style="color: #696969;">)))</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgce6e26" class="outline-2">
<h2 id="orgce6e26">recur-check</h2>
<div class="outline-text-2" id="text-orgce6e26">
</div><div id="outline-container-org659aca9" class="outline-3">
<h3 id="org659aca9"><span class="todo note">note</span> </h3>
<div class="outline-text-3" id="text-org659aca9">
<ul class="org-ul">
<li><p>recur-check is extensible</p></li></ul>
</div>
</div>

<div id="outline-container-org5adac58" class="outline-3">
<h3 id="org5adac58"><span class="todo _gt__lt_">&gt;&lt;</span> recur-check</h3>
<div class="outline-text-3" id="text-org5adac58">
<div class="org-src-container">

<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #a6e22e;">recur-check</span> n l e<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">:</span> name lambda env <span style="color: #66d9ef; font-weight: bold;">-&gt;</span> report<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #f92672; font-weight: bold;">match</span> e
    <span style="color: #797979;">[</span><span style="color: #B380A8;">{</span>ds bs ns<span style="color: #B380A8;">}</span>
     <span style="color: #B380A8;">{</span>'success e<span style="color: #B380A8;">}</span><span style="color: #797979;">]</span><span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
喪以不執 所執者喪 執喪相比 方死方生
</div>
</body>
</html>
